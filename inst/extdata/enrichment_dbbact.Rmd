---
title: "Enrichemnt with dbBact method"
output:
    html_document:
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugsigdbr)
library(bugphyzz)
library(dplyr)
library(purrr)
library(tidyr)
library(ggplot2)
library(tidyr)
```

# Define enrichment function

```{r}
dbEn <- function(s1, s2, t) {
    size1 <- length(s1)
    size2 <- length(s2)
    scores1 <- bpScores(t)[s1] |> 
        {\(y) y[!is.na(y)]}()
    scores2 <- bpScores(t)[s2] |> 
        {\(y) y[!is.na(y)]}()
    (sum(scores1) / size1) - (sum(scores2) / size2)
}
```


# Import data

Import BugSigDB:

```{r}
bsdb <- importBugSigDB() |> 
    filter(`Host species` == "Homo sapiens") |> 
    filter(`Abundance in Group 1` %in% c("increased", "decreased")) |> 
    filter(`Study design` == "case-control")
```

Import bugphyzz:

```{r}
bp <- importBugphyzz()
```

# Get/Make signatures

## Get BugSigDB signatures

First, I need to get the signatures that will have more than 10 bugs:

```{r}
bsdb_ids <- getSignatures(
    df = bsdb, tax.id.type = "ncbi", tax.level = "genus", min.size = 10
) |> names() |> 
    sub("^(bsdb:\\d+/\\d+/\\d+)_.*$", "\\1", x = _)
```

Then, I need two data.frames with experiments that only have two signatures
and these signatures are decreased and increased.

```{r, warning=FALSE}
dats <- bsdb |> 
    filter(`BSDB ID` %in% bsdb_ids) |>  
    group_by(Study, Experiment) |> 
    mutate(count = n()) |> 
    ungroup() |> 
    filter(count == 2) |> 
    group_by(Study, Experiment) |> 
    arrange(`Abundance in Group 1`) |> 
    mutate(comb = paste0(sort(`Abundance in Group 1`), collapse = "-")) |> 
    ungroup() |> 
    filter(comb == "decreased-increased") |> 
    arrange(`BSDB ID`) |> 
    {\(y) split(y, y$`Abundance in Group 1`)}()
```

Make sure all signatures share the same study, experiment, and condition

```{r}
cond1 <- all(dats$decreased$Condition == dats$increased$Condition)
cond2 <- all(dats$decreased$Study == dats$increased$Study)
cond3 <- all(dats$decreased$Experiment == dats$increased$Experiment)
all(c(cond1, cond2, cond3))
```

Finally, I get the list of signatures for both increased and decreased:

```{r}
sigs <- dats |> 
    map(~ {
        getSignatures(
            df = .x, tax.id.type = "ncbi", tax.level = "genus", min.size = 10
        )
    })
# We already made sure that Study and experiment are the same in the code
## lines above
names(sigs$decreased) <- sub(
    "^(bsdb:\\d+/\\d+)/\\d+_.*$", "\\1", names(sigs$decreased)
)
names(sigs$increased) <- sub(
    "^(bsdb:\\d+/\\d+)/\\d+_.*$", "\\1", names(sigs$increased)
)
```

# dats short

```{r}
select_cols <- c(
    "BSDB ID", 
    # "Study", "Experiment",
    "Condition", "Group 1 name", "Group 0 name",
    "Abundance in Group 1"
)
new_dat <- dats[[1]] |> 
    select(all_of(select_cols)) |> 
    mutate(`BSDB ID` = sub("/\\d+$", "", `BSDB ID`))
```


## Make bugphyzz signatures

```{r, warning=FALSE}
bpSigs <- map(bp, ~ {
    makeSignatures(
        dat = .x,  tax_id_type = "NCBI_ID", tax_level = "genus",
        min_size = 10
    )
}) |> 
    list_flatten(name_spec = "{inner}") |> 
    discard(is.null)
```


## Enrichment analysis

```{r}
res <- vector("list", length(bpSigs))
names(res) <- names(bpSigs)
for (i in seq_along(res)) {
    res[[i]] <- map2(sigs$increased, sigs$decreased, ~ {
        dbEn(s1 = .x, s2 = .y, t = bpSigs[[i]])
    })
}
x <- list_flatten(res, name_spec = "{outer}-----{inner}")
x <- unlist(x)

## Up are positives
## Down are negatives
enDF <- data.frame(
    x = names(x),
    score = unname(x)
) |>  
    separate(col = x, into = c("bugphyzz", "bsdb"), sep = "-----") |> 
    mutate(bugphyzz = sub("bugphyzz:", "", bugphyzz)) |> 
    # mutate(bsdb = sub("^(bsdb:\\d+/\\d+/\\d+).*$", "\\1", bsdb)) |> 
    left_join(new_dat, by = c("bsdb" = "BSDB ID"))
    # relocate(Condition, .after = score)
```

Print table

```{r}
enDF |> 
    filter(score > 0) |> 
    myDataTable()
```


Distribution of scores

```{r}
enDF |> 
    ggplot(aes(score)) +
    geom_histogram(binwidth = 0.1) +
    labs(y = "Frequency", x = "Enrichment scores") +
    theme_bw()
```


```{r, fig.height=9, fig.width=11}
min <- enDF |> 
    group_by(`Abundance in Group 1`) |> 
    slice_min(order_by = score, n = 20) |>
    arrange(score)
max <- enDF |> 
    group_by(`Abundance in Group 1`) |> 
    slice_max(order_by = score, n = 20) |> 
    arrange(score)
dat_for_plot <- bind_rows(min, max)
dat_for_plot |> 
    mutate(label = paste0(bugphyzz, "|", Condition)) |> 
    mutate(label = forcats::fct_inorder(label)) |>
    mutate(Direction = case_when(
        score > 0 ~ "Increased",
        score < 0 ~ "Decreased"
    )) |> 
    mutate(
        Direction = factor(Direction, levels = c("Increased", "Decreased"))
    ) |> 
    ggplot(aes(label, score)) +
    geom_col(aes(fill = Direction)) +
    labs(
        x = "Bugphyzz signature | Condition",
        y = "dbBact enrichment score",
        title = "Top 20 enriched terms in either direction"
    ) +
    theme_bw() +
    coord_flip()
```

# Session info

```{r}
sessioninfo::session_info()
```

