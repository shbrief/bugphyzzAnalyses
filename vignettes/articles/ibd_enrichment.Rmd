---
title: "BSEA control vs IBD in cMD for aerophilicity attributes"
output:
  html_document:
    toc: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

```{r packages, message=FALSE}
library(bugphyzz)
library(curatedMetagenomicData)
library(dplyr)
library(EnrichmentBrowser)
library(DT)
```

# Expected result

+ Enrichment of anaerobic bacteria in healthy samples (gut).
+ Enrichment of facultative anaerobic bacteria in IBD samples (gut).

# Data

Use the HMP_2019_bidmdb study in cMD:

```{r import tse, message=FALSE, warning=FALSE}
dataset_name <- "HallAB_2017.relative_abundance"
tse <- curatedMetagenomicData(
    pattern = dataset_name, 
    dryrun = FALSE, rownames = 'NCBI',
    counts = TRUE
)[[1]]
colData(tse)$GROUP <- ifelse(colData(tse)$study_condition == 'control', 0, 1)
## Filter taxa with at least 1 count as abundance in at least 20% of samples
min_n_samples <- round(ncol(tse) * 0.2)
tse_subset <- tse[rowSums(assay(tse) >= 1) >= min_n_samples,]
tse_subset
```
# bugphyzz data

```{r bp signatures species, message=FALSE}
bp <- importBugphyzz()
aer <- bp |> 
  filter(Attribute_group == 'aerophilicity')
sp_sigs <- getBugphyzzSignatures(
  df = aer, tax.id.type = 'NCBI_ID', tax.level = 'species',
  frequency = c('always', 'usually', 'sometimes')
)
```

DA:

```{r}
assay(tse_subset, 'relab_plus_1') <- assay(tse_subset, 'relative_abundance') + 1
edger <- deAna(
    expr = tse_subset, de.method = 'edgeR', padj.method = 'BH',
    filter.by.expr = FALSE, assay = 'relab_plus_1'
)
dim(edger)
```

## Enrichment (GSEA):

```{r, message=FALSE, warning=FALSE}
gsea <- sbea(
    method = 'gsea', se = edger, gs = sp_sigs, alpha = 0.1, perm = 1000,
    padj.method = 'BH', assay = 'relab_plus_1'
)
gsea_res <- as.data.frame(gsea$res.tbl)

caption1 <- c(
  'Table 1. GSEA results comparing the gut microbiome of subjects with
  a normal gut micriobiome (healthy controls) and subjects with IBD.
  ES = Enrichment score, NES = Normalized Enrichment Score. Positive and
  negative scores (ES and NES) indicate enrichment in the IBD and
  healthy control samples, respectively. Bug sets marked with an asterik (*) 
  indicate significant enrichment results (adjusted p-value < 0.1). 
  Benjamini & Hochberg (BH) was used for P value adjustment.'
)

datatable(
  data = gsea_res,
  filter = 'top',
  rownames = FALSE,
  extensions = 'Buttons',
  options = list(
    dom = 'Bft',
    buttons = list('copy', 'print'),
    iDisplayLength = 10,
    keys = TRUE,
    autoWidth = TRUE
  ),
  caption = htmltools::tags$caption(
    style = 'caption-side: top; text-align: left;',
    caption1
  )
)
```

# Session Information

```{r}
sessionInfo()
```
