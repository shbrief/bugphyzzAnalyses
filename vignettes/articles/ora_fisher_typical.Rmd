---
title: "Enrichment analysis of BugSigDB sets with bugphyzz signatures"
output:
  html_document:
    toc: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r load packages, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(purrr)
library(tidyr)
library(dplyr)
library(bugsigdbr)
library(taxPPro)
library(ggplot2)
```

# Some considerations

+ Use only signatures with reported as "Abundance in Group" in bsdb.
+ Some terms in bsdb were merged (skin, oral cavity, and vagina).

# Import data

## Import TypicalMicrobiomeSignatures

TypicalMicrobiomeSignatures will be used to create background sets.

```{r import typical microbiome signatures, message=FALSE}
tms <- importTidyTMS(prevalence_threshold = 0.01)
head(tms)
```

## Import BugSigDB

```{r import bsdb, message=FALSE}
bsdb <- importBugSigDB(version = 'devel') |> 
  as_tibble()
head(bsdb)
```

## Import bugphyzz

```{r import bp, message=FALSE, warning=FALSE}
bp <- importBugphyzz(version = 'devel') |> 
  as_tibble()
head(bp)
```

Which attribute groups (physiologies)

```{r}
unique(bp$Attribute_group)
```

Which attribute values

```{r}
head(unique(bp$Attribute))
```

## Get bugphyzz signatures

Species signatures

```{r}
bp_sigs_gn <- getBugphyzzSignatures(
  df = bp, tax.id.type = 'NCBI_ID', tax.level = 'genus',
  frequency = 'always', min.size = 10
)
lapply(bp_sigs_gn, head)
```

Genus signatures

```{r}
bp_sigs_sp <- getBugphyzzSignatures(
  df = bp, tax.id.type = 'NCBI_ID', tax.level = 'species',
  frequency = 'always', min.size = 10
)
lapply(bp_sigs_sp, head)
```

Define some functions to avoid too much repetition in the code:

```{r define functions}

## A function to plot enrichment results
plotEnrichmentRes <- function(res, body_site, tax_level) {
  dat <- res |>
    dplyr::filter(!is.na(`Abundance in Group 1`))
  
  if (!nrow(dat)) {
    warning('No results')
    return(NULL)
  }
  p <- dat |>  
    dplur::mutate(
      bugsigdb_sig = sub('^.*_(.*)_vs_.*$', '\\1', bugsigdb_sig),
      bp_sig = sub('^bugphyzz:', '', bp_sig),
      `Abundance in Group 1` = dplyr::case_when(
        `Abundance in Group 1` == 'increased' ~ 'Increased abundance in group 1',
        `Abundance in Group 1` == 'decreased' ~ 'Decreased abundance in group 1',
        TRUE ~ `Abundance in Group 1`
      ),
      `Abundance in Group 1` = forcats::fct_relevel(
          `Abundance in Group 1`, 'Increased abundance in group 1'
      )
    ) |>
    ggplot2::ggplot(ggplot2::aes(bp_sig, dplyr::reorder(bugsigdb_sig, -log10(p_value)))) +
      ggplot2::geom_point(
      ggplot2::aes(
        color = -log10(p_value),
        size = n_sig / n_background 
      )
    ) +
    ggplot2::scale_color_viridis_c(name = '-log10(p-value)', option = 'C') +
    ggplot2::scale_size(
      name = expression(
      frac('# annotated BugSigDB', '# annotated background')
      )
    ) +
    ggplot2::facet_wrap(~`Abundance in Group 1`, nrow = 2, scales = 'free_y') +
    ggplot2::labs(
      x = 'bugphyzz sets',
      y = 'BugSigDB sets - Group 1 name',
      title = 'Microbe set enrichment (ORA/Fisher\'s exact test)',
      subtitle = paste0(
        'Hypothesis: "greater"; FDR < 0.05;',
        body_site, '; ',  tax_level
      )
    ) +
    ggplot2::theme_bw()  +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
  return(p)
}
```

# Enrichment analysis - stool

**stool - genus**

```{r}
sets_stool_gn <- getSets(
  bsdb = bsdb, bsdb_body_site = 'Feces',
  tms = tms, tms_body_site = 'stool',
  tax_level = 'genus'
)
res_stool_gn <- runEnrichment(
  bsdb_sets = sets_stool_gn$bsdb_sets, 
  background_sets = sets_stool_gn$background_sets, 
  bp_sigs = bp_sigs_gn,
  bsdb = bsdb
)

```





```{r enrichment - stool - genus, fig.height=7, fig.width=15}
sets_stool_gn <- getSets(b = 'feces', t = 'stool', tax_level = 'genus')
res_stool_gn <- runEnrichment(
  bsdb_sets = sets_stool_gn$bsdb_sets, 
  background_sets = sets_stool_gn$background_sets, 
  bp_sigs = bp_sigs_gn
)
p_stool_gn <- plotEnrichmentRes(res_stool_gn, 'feces/stool', 'genus')
p_stool_gn
```

**stool - species**

```{r enrichment - stool - species, fig.width=15, fig.height=7}
sets_stool_sp <- getSets(b = 'feces', t = 'stool', tax_level = 'species')
res_stool_sp <- runEnrichment(
  bsdb_sets = sets_stool_sp$bsdb_sets, 
  background_sets = sets_stool_sp$background_sets, 
  bp_sigs = bp_sigs_sp
)
p_stool_sp <- plotEnrichmentRes(res_stool_sp, 'feces/stool', 'species')
p_stool_sp
```

# Enrichment analysis - vagina

Change vagina-related terms in bsdb

```{r change vagina-related terms}
vagina_terms <- c(
  'cervicovaginal secretion,posterior fornix of vagina',
  'endocervix', 'lower part of vagina', 'posterior fornix of vagina',
  'Posterior fornix of vagina', 'vagina', 'Vaginal fluid'
)
bsdb <- bsdb |> 
  mutate(
    `Body site` = ifelse(
      `Body site` %in% vagina_terms, 'vagina', `Body site`
    )
  )
dim(filter(bsdb, `Body site` == 'vagina'))
```

**vagina - genus**

```{r enrichemnt - vagina - genus, fig.height=4, fig.width=10}
sets_vagina_gn <- getSets(b = 'vagina', t = 'vagina', tax_level = 'genus')
res_vagina_gn <- runEnrichment(
  sets_vagina_gn$bsdb_sets, 
  sets_vagina_gn$background_sets, bp_sigs_gn
)
p_vagina_gn <- plotEnrichmentRes(res_vagina_gn, 'vagina', 'genus')
p_vagina_gn
```
 **vagina genus 2**
 
 A single study
 
```{r vagina genus 2}
bv_sig <- bsdb |> 
  filter(Study == 'Study 187', Experiment == 'Experiment 3') |> 
  getSignatures(tax.id.type = 'ncbi', min.size = 5)

tax_names <- taxize::id2name(bv_sig[[1]], db = 'ncbi') |> 
  map_chr(~.x$name)
names(bv_sig[[1]]) <- tax_names

bv_sig
```


```{r enrichment vagina genus 2}
res_vagina_gn_2 <- runEnrichment(
  bsdb_sets = sets_vagina_gn$bsdb_sets, 
  background_sets = sets_vagina_gn$background_sets, 
  bp_sigs = bp_sigs_gn
)

```





**vagina - species **

```{r enrichment - vagina - species, fig.height=4, fig.width=10}
sets_vagina_sp <- getSets(b = 'vagina', t = 'vagina', tax_level = 'species')
res_vagina_sp <- runEnrichment(
  bsdb_sets = sets_vagina_sp$bsdb_sets, 
  background_sets = sets_vagina_sp$background_sets, 
  bp_sigs = bp_sigs_sp
)
p_vagina_sp <- plotEnrichmentRes(res_vagina_sp, 'vagina', 'species')
p_vagina_sp
```

# Enrichment analysis - nasal cavity

** nasal cavity - genus**

```{r enrichment - nasal cavity - genus}
sets_nc_gn <- getSets(
  b = 'nasal cavity', t = 'nasalcavity', tax_level = 'genus'
)
res_nc_gn <- runEnrichment(
  sets_nc_gn$bsdb_sets, 
  sets_nc_gn$background_sets, bp_sigs_gn
)
p_nc_gn <- plotEnrichmentRes(res_nc_gn, 'nasal cavity', 'genus')
p_nc_gn
```

**nasal cavity - species**

```{r enrichment - nasal cavity - species}
sets_nc_sp <- getSets(
  b = 'nasal cavity', t = 'nasalcavity', tax_level = 'species'
)
res_nc_sp <- runEnrichment(
  bsdb_sets = sets_nc_sp$bsdb_sets, 
  background_sets = sets_nc_sp$background_sets, 
  bp_sigs = bp_sigs_sp
)
p_nc_sp <- plotEnrichmentRes(res_nc_sp, 'nasal cavity', 'species')
p_nc_sp
```

# Enrichment analysis - oral cavity

Some terms:

```{r change oral cavity-related terms}
oral_cavity_terms <- unique(c(
  'buccal mucosa', 'buccal mucosa, lower lip', 'dental plaque',
  'gingiva', 'mouth', 'oral gland', 'oropharynx', 'saliva', 
  'saliva-screting gland', 'subgingival dental plaque', 'throat',
  'tongue', 'Major salivary gland', 'hypopharinkx'
))

bsdb <- bsdb |> 
  mutate(
    `Body site` = ifelse(
      `Body site` %in% oral_cavity_terms, 'oral cavity', `Body site`
    )
  )

## spotum,mouth
```

**oral cavity/saliva - genus**

Maybe I need to combine several samples of oral cavity in bsdb

```{r enrichment - oral cavity - genus, fig.height=4, fig.width=10}
sets_oc_gn <- getSets(
  b = 'oral cavity', t = 'oralcavity', tax_level = 'genus'
)
res_oc_gn <- runEnrichment(
  sets_oc_gn$bsdb_sets, 
  sets_oc_gn$background_sets, bp_sigs_gn
)
p_oc_gn <- plotEnrichmentRes(res_oc_gn, 'oral cavity', 'genus')
p_oc_gn
```

**oral cavity/saliva - species **

```{r enrihcment - oral cavity - species, fig.width=10, fig.height=4}
sets_oc_sp <- getSets(
  b = 'oral cavity', t = 'oralcavity', tax_level = 'species'
)
res_oc_sp <- runEnrichment(
  bsdb_sets = sets_oc_sp$bsdb_sets, 
  background_sets = sets_oc_sp$background_sets, 
  bp_sigs = bp_sigs_sp
)
p_oc_sp <- plotEnrichmentRes(res_oc_sp, 'oral cavity', 'species')
p_oc_sp
```

# Enrichment analysis - skin

An adjustment to the bsdb data to include all types of skin:

```{r change skin-related terms}
skin_terms <- grep('skin', unique(bsdb$`Body site`), value = TRUE)
bsdb <- bsdb |> 
  mutate(
    `Body site` = ifelse(`Body site` %in% skin_terms, 'skin', `Body site`)
  )
```

**Skin - genus**

```{r enrichment - skin - genus, fig.width=7, fig.height=3}
sets_skin_gn <- getSets(
  b = 'skin', t = 'skin', tax_level = 'genus'
)
res_skin_gn <- runEnrichment(
  sets_skin_gn$bsdb_sets, 
  sets_skin_gn$background_sets, bp_sigs_gn
)
p_skin_gn <- plotEnrichmentRes(res_skin_gn, 'skin', 'genus')
p_skin_gn
```

**Skin - species**

```{r enrichment - skin - species, fig.height=4, fig.width=10}
sets_skin_sp <- getSets(
  b = 'skin', t = 'skin', tax_level = 'species'
)
res_skin_sp <- runEnrichment(
  sets_skin_sp$bsdb_sets, 
  sets_skin_sp$background_sets, bp_sigs_sp
)
## no results because Abundance in Group 1 are all NAs
p_skin_sp <- plotEnrichmentRes(res_skin_sp, 'skin', 'species')
p_skin_sp
```

# A step by step case

Get bsdb signatures

```{r get bsdb signatures}
bsdb_sets_ <- bsdb |> 
    filter(`Body site` == 'feces', `Host species` == 'Homo sapiens') |> 
    bugsigdbr::getSignatures(
        tax.id.type = 'ncbi', tax.level = 'genus', min.size = 5
    ) 
length(bsdb_sets_)
```

```{r}
lapply(bsdb_sets_[1:3], head)
```

Create background sets

```{r get typical set}
typical_set_ <- typical |> 
    filter(body_site == 'stool', rank == 'genus') |> 
    pull(taxid) |> 
    unique()
length(typical_set_) 
```

```{r}
head(typical_set_)
```

```{r get background sets}
background_sets_ <- lapply(bsdb_sets_, function(x) unique(c(x, typical_set_)))
length(background_sets_)
```

Create contingency tables

```{r example contingency tables}
taxa_name_ <- 'bsdb:237/1/1_chronic-hepatitis-C-virus-infection:cirrhosis-patients_vs_healthy-controls_UP'
ct <- bugphyzzAnalyses:::.contingencyTable(
    set = bsdb_sets_[[taxa_name_]],
    reference = background_sets_[[taxa_name_]],
    sig = bp_sigs_gn$`bugphyzz:aerophilicity|aerobic`
)
ct
```


Enrichment

```{r}
p_value_ <- stats::fisher.test(ct, alternative = 'g')$p.value
p_value_

```

# Session information

```{r session info}
sessioninfo::session_info()
```
