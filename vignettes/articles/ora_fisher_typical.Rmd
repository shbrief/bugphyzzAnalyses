---
title: "Enrichment analysis of BugSigDB sets with bugphyzz signatures"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(purrr)
library(tidyr)
library(dplyr)
library(bugsigdbr)
library(taxPPro)
library(ggplot2)
```

# Import TypicalMicrobiomeSignaures

TypicalMicrobiomeSignatures will be used as reference. See 
https://github.com/waldronlab/TypicalMicrobiomeSignatures and 
https://zenodo.org/record/7544550

```{r, message=FALSE}
temp_dir <- paste0(tempdir(), '/TypicalMicrobiomeSignatures')
dir.create(temp_dir, showWarnings = FALSE)
doi <- "10.5281/zenodo.7544550"
zen4R::download_zenodo(doi = doi, path = temp_dir, quiet = TRUE)
zip_file <- list.files(temp_dir, full.names = TRUE)
base_dir <- sub('\\.zip', '', zip_file)
unzip(zip_file, exdir = base_dir, )
extracted_dir <- paste0(base_dir, '/', list.files(base_dir))
fnames <- grep(
    '\\.csv', list.files(extracted_dir, full.names = TRUE), value = TRUE
)
tms <- map(fnames, read.csv)
names(tms) <- sub('^.*/matrix_(.*)\\.csv$', '\\1', fnames)
output <- vector('list', length(tms))
for (i in seq_along(output)) {
    output[[i]] <- tms[[i]] |> 
        pivot_longer(
            cols = ends_with('_prevalence'), names_to = 'body_site',
            values_to = 'pravalence'
        ) |> 
        mutate(body_site = sub('_prevalence$', '', body_site)) |> 
        separate(
            col = 'body_site', into = c('body_site', 'rank'), sep = '_'
        ) |> 
        rename(
            taxid = NCBI, taxon_name = name
        ) |> 
        mutate(age_range = sub('^.*_', '', names(tms)[i]))
}
typical <- do.call(rbind, output)
typical$prevalence <- round(typical$pravalence, 2)
typical <- typical[typical$pravalence > 0.01,] # prevalence >= 1%
glimpse(typical, width = 50)
```

# Import data from BugSigDB

We'll use the bugsigdbr package to import the main data.frame of signatures
(microbe sets) from BugSigDB.

```{r}
bsdb <- importBugSigDB()
id1 <- sub(".* ", "", bsdb$Study)
id2 <- sub(".* ", "", bsdb$Experiment)
id3 <- sub(".* ", "", bsdb$`Signature page name`)
bsdb$id <- paste0('bsdb:', id1, '/', id2, '/', id3)
bsdb <- relocate(bsdb, id)
head(as_tibble(bsdb))
```

# Import signatures from bugphyzz

## Import data.frames

```{r, message=FALSE, warning=FALSE}
exclude_phys <- c('antimicrobial resistance', 'isolation site')
phys <- physiologies(remove_false = TRUE) |> 
  keep(~ unique(.x$Attribute_type) == 'categorical') |> 
  {\(y) y[!names(y) %in% exclude_phys]}() |> 
  map(preSteps, tax.id.type = 'NCBI_ID', remove_false = TRUE)
```

## Propagate bugphyzz signatures

```{r, message=FALSE, warning=FALSE}
propagation <- vector('list', length(phys))
for (i in seq_along(propagation)) {
    names(propagation)[i] <- names(phys)[i]
    propagation[[i]] <- propagate(phys[[i]], max.tax.level = 'genus')
}
```

## Convert bugphyzz data.frames to signatures

```{r, message=FALSE, warning=FALSE}
bg_sigs_gn <- lapply(phys, function(x) {
  bugphyzz::getSignatures(
    df = x, tax.id.type = 'NCBI_ID', tax.level = 'genus', min.size = 5
  )
})

bg_sigs_gn <- flatten(bg_sigs_gn)
```

## Import pH signatures

pH is the only numeric signature that I will use right now.

```{r, message=FALSE}
ph <- physiologies('optimal ph')[[1]]
ph <- preSteps(ph, tax.id.type = 'NCBI_ID')
prop_ph <- propagate(ph)
```

Create some signatures for pH

```{r}
## Some thresholds
acidic <- prop_ph$Attribute_value[prop_ph$Attribute_value <= 5]
neutral <- prop_ph$Attribute_value[prop_ph$Attribute_value > 5 & prop_ph$Attribute_value <= 7]
alkaline <- prop_ph$Attribute_value[prop_ph$Attribute_value > 7 & prop_ph$Attribute_value <= 9.75]
very_alkaline <- prop_ph$Attribute_value[prop_ph$Attribute_value > 9.75] 

ph_sigs_gn <- vector('list', 4)
names(ph_sigs_gn)[1] <- paste0('bugphyzz:optimal ph|', 'acidic', '|', min(acidic), '-', max(acidic))
names(ph_sigs_gn)[2] <- paste0('bugphyzz:optimal ph|', 'neutral', '|', min(neutral), '-', max(neutral))
names(ph_sigs_gn)[3] <- paste0('bugphyzz:optimal ph|', 'alkaline', '|', min(alkaline), '-', max(alkaline))
names(ph_sigs_gn)[4] <- paste0('bugphyzz:optimal ph|', 'very alkaline', '|', min(very_alkaline), '-', max(very_alkaline))

ph_sigs_gn[[1]] <- prop_ph |> 
  filter(
    Rank == 'genus',
    Attribute_value %in% acidic 
  ) |> 
  pull(NCBI_ID) |> 
  unique()

ph_sigs_gn[[2]] <- prop_ph |> 
  filter(
    Rank == 'genus',
    Attribute_value %in% neutral 
  ) |> 
  pull(NCBI_ID) |> 
  unique()

ph_sigs_gn[[3]] <- prop_ph |> 
  filter(
    Rank == 'genus',
    Attribute_value %in% alkaline 
  ) |> 
  pull(NCBI_ID) |> 
  unique()

ph_sigs_gn[[4]] <- prop_ph |> 
  filter(
    Rank == 'genus',
    Attribute_value %in% very_alkaline 
  ) |> 
  pull(NCBI_ID) |> 
  unique()
```

## Final bugphyzz signatures

Combine signatures

```{r}
bg_sigs_gn <- c(bg_sigs_gn, ph_sigs_gn)
lapply(bg_sigs_gn[1:5], head)
```

# Enrichment analysis: stool - genus

## Create lists of BugSigDB microbe sets (feces/stool)

```{r}
bsdb_feces_gn <- bsdb |> 
    filter(`Body site` == 'feces', `Host species` == 'Homo sapiens') |> 
    bugsigdbr::getSignatures(
        tax.id.type = 'ncbi', tax.level = 'genus', min.size = 5
    )
lapply(bsdb_feces_gn[1:5], head)
```

## Get a reference set from TypicalMicrobiomeSignatures (feces/stool)

This step is accomplished by mergin the TypicalMicrobiomeSignatures with
a BugSigDB microbe set.

```{r}
typical_stool_gn <- typical |> 
    filter(body_site == 'stool', rank == 'genus') |> 
    pull(taxid) |> 
    unique()

reference_sigs_gn <- bsdb_feces_gn |> 
    lapply(function(x) unique(c(x, typical_stool_gn)))

lapply(reference_sigs_gn[1:5], head)
```
## Run microbe set enrichment (Fisher)

```{r, message=FALSE}
res_stool <- map2(
  .x = bsdb_feces_gn, 
  .y = reference_sigs_gn, 
  .f = ~ microbeSetEnrichment(.x, .y, bg_sigs_gn)
) |> 
  bind_rows(.id = 'bugsigdb_sig') |> 
  mutate(id = sub('_.*$', '', bugsigdb_sig)) |> 
  relocate(id) |> 
  rename(bp_sig = sig_name) |> 
  as_tibble() |> 
  left_join(as_tibble(bsdb), by = 'id')

res_stool_significant <- res_stool |> 
  filter(fdr < 0.05)

head(as_tibble(res_stool_significant))
```

```{r}
dim(res_stool_significant)
```


```{r}
p <- res_stool_significant |> 
  mutate(
    bugsigdb_sig = sub('^.*_(.*)_vs_.*$', '\\1', bugsigdb_sig),
    bp_sig = sub('^bugphyzz:', '', bp_sig),
    `Abundance in Group 1` = case_when(
      `Abundance in Group 1` == 'increased' ~ 'Increased abundance in group 1',
      `Abundance in Group 1` == 'decreased' ~ 'Decreased abundance in group 1',
      TRUE ~ `Abundance in Group 1`
    )
  ) |>
  ggplot(aes(bp_sig, bugsigdb_sig)) +
  geom_point(
    aes(
      color = -log10(p_value),
      size = n_sig / n_background 
    )
  ) +
  scale_color_viridis_c(name = '-log10(p-value)', option = 'B') +
  scale_size(
    name = expression(
    frac('# annotated BugSigDB', '# annotated background')
    )
  ) +
  facet_wrap(~`Abundance in Group 1`, ncol = 2, scales = 'free_x') +
  labs(
    x = 'bugphyzz sets',
    y = 'BugSigDB sets - Group 1 name',
    title = 'Microbe set enrichment (ORA/Fisher\'s exact test)',
    subtitle = 'Hypothesis: "greater"; FDR < 0.05; stool/feces; genus'
  ) +
  theme_bw()  +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p
# ggsave(filename = 'enrichment_stool.png', plot = p, width = 15, height = 7)
```


