---
title: "Enrichment analysis of BugSigDB sets with bugphyzz signatures"
output:
  html_document:
    toc: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r load packages, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(purrr)
library(tidyr)
library(dplyr)
library(bugsigdbr)
library(taxPPro)
library(ggplot2)
```

# Some considerations

+ Use only signatures with reported as "Abundance in Group" in bsdb.
+ Some terms in bsdb were merged (skin, oral cavity, and vagina).

# Import data

## Import TypicalMicrobiomeSignatures

TypicalMicrobiomeSignatures will be used to create background sets.

```{r import typical microbiome signatures, message=FALSE}
tms <- importTidyTMS(prevalence_threshold = 0.01)
head(tms)
```

## Import BugSigDB

```{r import bsdb, message=FALSE}
bsdb <- importBugSigDB(version = 'devel') |> 
  as_tibble()
head(bsdb)
```

## Import bugphyzz

```{r import bp, message=FALSE, warning=FALSE}
bp <- importBugphyzz(version = 'devel') |> 
  as_tibble()
head(bp)
```

Which attribute groups (physiologies)

```{r}
unique(bp$Attribute_group)
```

Which attribute values

```{r}
head(unique(bp$Attribute))
```

## Get bugphyzz signatures

Species signatures

```{r}
bp_sigs_gn <- getBugphyzzSignatures(
  df = bp, tax.id.type = 'NCBI_ID', tax.level = 'genus',
  frequency = 'always', min.size = 10
)
lapply(bp_sigs_gn, head)
```

Genus signatures

```{r}
bp_sigs_sp <- getBugphyzzSignatures(
  df = bp, tax.id.type = 'NCBI_ID', tax.level = 'species',
  frequency = 'always', min.size = 10
)
lapply(bp_sigs_sp, head)
```

# Enrichment analysis - stool

**stool - genus**

```{r}
sets_stool_gn <- getSets(
  bsdb = bsdb, bsdb_body_site = 'Feces',
  tms = tms, tms_body_site = 'stool',
  tax_level = 'genus'
)
res_stool_gn <- runEnrichment(
  bsdb_sets = sets_stool_gn$bsdb_sets, 
  background_sets = sets_stool_gn$background_sets, 
  bp_sigs = bp_sigs_gn,
  bsdb = bsdb
)
res_stool_gn <- res_stool_gn[res_stool_gn$fdr < 0.1,]
p_stool_gn <- plotEnrichmentRes(res_stool_gn, 'feces/stool', 'genus')
p_stool_gn
```

**stool - species**

```{r}
sets_stool_sp <- getSets(
  bsdb = bsdb, bsdb_body_site = 'Feces',
  tms = tms, tms_body_site = 'stool',
  tax_level = 'species'
)
res_stool_sp <- runEnrichment(
  bsdb_sets = sets_stool_sp$bsdb_sets, 
  background_sets = sets_stool_sp$background_sets, 
  bp_sigs = bp_sigs_sp,
  bsdb = bsdb
)
res_stool_sp <- res_stool_sp[res_stool_sp$fdr < 0.1,]
p_stool_sp <- plotEnrichmentRes(res_stool_sp, 'feces/stool', 'genus')
p_stool_sp
```

# Enrichment analysis - vagina

Change vagina-related terms in bsdb

```{r change vagina-related terms}
vagina_terms <- c(
  'cervicovaginal secretion', 'posterior fornix of vagina',
  'endocervix', 'lower part of vagina', 'posterior fornix of vagina',
  'Posterior fornix of vagina', 'vagina', 'Vaginal fluid'
)
bsdb <- bsdb |> 
  mutate(
    `Body site` = ifelse(
      `Body site` %in% vagina_terms, 'vagina', `Body site`
    )
  )
dim(filter(bsdb, `Body site` == 'vagina'))
```

**vagina - genus**

```{r enrichemnt - vagina - genus, fig.height=4, fig.width=10}
sets_vagina_gn <- getSets(
  bsdb = bsdb, bsdb_body_site = 'Vagina',
  tms = tms, tms_body_site = 'vagina',
  tax_level = 'genus'
)
res_vagina_gn <- runEnrichment(
  bsdb_sets = sets_vagina_gn$bsdb_sets, 
  background_sets = sets_vagina_gn$background_sets, 
  bp_sigs = bp_sigs_gn,
  bsdb = bsdb
)
# res_vagina_gn <- res_vagina_gn[res_vagina_gn$fdr < 0.1,]
p_vagina_gn <- plotEnrichmentRes(res_vagina_gn, 'vagina', 'genus')
p_vagina_gn
```
 **vagina genus 2**
 
 A single study
 
```{r vagina genus 2}
bv_sig <- bsdb |> 
  filter(Study == 'Study 187', Experiment == 'Experiment 3') |> 
  getSignatures(tax.id.type = 'ncbi', min.size = 5)

tax_names <- taxize::id2name(bv_sig[[1]], db = 'ncbi') |> 
  map_chr(~.x$name)
names(bv_sig[[1]]) <- tax_names

bv_sig
```


```{r enrichment vagina genus 2}
res_vagina_gn_2 <- runEnrichment(
  bsdb_sets = sets_vagina_gn$bsdb_sets, 
  background_sets = sets_vagina_gn$background_sets, 
  bp_sigs = bp_sigs_gn, bsdb = bsdb
)
res_vagina_gn_2
```

**vagina - species **

```{r enrichment - vagina - species, fig.height=4, fig.width=10, warning=FALSE}
sets_vagina_sp <- getSets(
  bsdb = bsdb, bsdb_body_site = 'Vagina',
  tms = tms, tms_body_site = 'vagina',
  tax_level = 'species'
)
res_vagina_sp <- runEnrichment(
  bsdb_sets = sets_vagina_sp$bsdb_sets, 
  background_sets = sets_vagina_sp$background_sets, 
  bp_sigs = bp_sigs_sp,
  bsdb = bsdb
)
res_vagina_sp <- res_vagina_sp[res_vagina_sp$fdr < 0.1,]
p_vagina_sp <- plotEnrichmentRes(res_vagina_sp, 'vagina', 'genus')
p_vagina_sp
```

# Enrichment analysis - nasal cavity

** nasal cavity - genus**

```{r enrichment - nasal cavity - genus}
sets_nc_gn <- getSets(
  bsdb = bsdb, bsdb_body_site = 'Nasal cavity',
  tms = tms, tms_body_site = 'nasalcavity',
  tax_level = 'genus'
)
res_nc_gn <- runEnrichment(
  bsdb_sets = sets_nc_gn$bsdb_sets, 
  background_sets = sets_nc_gn$background_sets, 
  bp_sigs = bp_sigs_gn,
  bsdb = bsdb
)
res_nc_gn <- res_nc_gn[res_nc_gn$fdr < 0.1,]
p_nc_gn <- plotEnrichmentRes(res_nc_gn, 'vagina', 'genus')
p_nc_gn
```

**nasal cavity - species**

```{r enrichment - nasal cavity - species}
sets_nc_sp <- getSets(
  bsdb = bsdb, bsdb_body_site = 'Nasal cavity',
  tms = tms, tms_body_site = 'nasalcavity',
  tax_level = 'species'
)
res_nc_sp <- runEnrichment(
  bsdb_sets = sets_nc_sp$bsdb_sets, 
  background_sets = sets_nc_sp$background_sets, 
  bp_sigs = bp_sigs_sp,
  bsdb = bsdb
)
res_nc_sp <- res_nc_sp[res_nc_sp$fdr < 0.1,]
p_nc_sp <- plotEnrichmentRes(res_nc_sp, 'vagina', 'species')
p_nc_sp
```

# Enrichment analysis - oral cavity

Some terms:

```{r change oral cavity-related terms}
oral_cavity_terms <- unique(c(
  'buccal mucosa', 'buccal mucosa, lower lip', 'dental plaque',
  'gingiva', 'mouth', 'oral gland', 'oropharynx', 'saliva', 
  'saliva-screting gland', 'subgingival dental plaque', 'throat',
  'tongue', 'Major salivary gland', 'hypopharinkx'
))

bsdb <- bsdb |> 
  mutate(
    `Body site` = ifelse(
      `Body site` %in% oral_cavity_terms, 'oral cavity', `Body site`
    )
  )

## spotum,mouth
```

**oral cavity/saliva - genus**

Maybe I need to combine several samples of oral cavity in bsdb

```{r enrichment - oral cavity - genus, fig.height=4, fig.width=10}
sets_oc_gn <- getSets(
  bsdb = bsdb, bsdb_body_site = 'Oral cavity',
  tms = tms, tms_body_site = 'oralcavity',
  tax_level = 'genus'
)
res_oc_gn <- runEnrichment(
  bsdb_sets = sets_oc_gn$bsdb_sets, 
  background_sets = sets_oc_gn$background_sets, 
  bp_sigs = bp_sigs_gn,
  bsdb = bsdb
)
res_oc_gn <- res_oc_gn[res_oc_gn$fdr < 0.1,]
p_oc_gn <- plotEnrichmentRes(res_oc_gn, 'vagina', 'species')
p_oc_gn
```

**oral cavity/saliva - species **

```{r enrihcment - oral cavity - species, fig.width=10, fig.height=4}
sets_oc_sp <- getSets(
  bsdb = bsdb, bsdb_body_site = 'Oral cavity',
  tms = tms, tms_body_site = 'oralcavity',
  tax_level = 'species'
)
res_oc_sp <- runEnrichment(
  bsdb_sets = sets_oc_sp$bsdb_sets, 
  background_sets = sets_oc_sp$background_sets, 
  bp_sigs = bp_sigs_sp,
  bsdb = bsdb
)
res_oc_sp <- res_oc_sp[res_oc_sp$fdr < 0.1,]
p_oc_sp <- plotEnrichmentRes(res_oc_sp, 'vagina', 'species')
p_oc_sp
```

# Enrichment analysis - skin

An adjustment to the bsdb data to include all types of skin:

```{r change skin-related terms}
skin_terms <- grep('skin', unique(bsdb$`Body site`), value = TRUE)
bsdb <- bsdb |> 
  mutate(
    `Body site` = ifelse(`Body site` %in% skin_terms, 'skin', `Body site`)
  )
```

**Skin - genus**

```{r enrichment - skin - genus, fig.width=7, fig.height=3}
sets_skin_gn <- getSets(
  b = 'skin', t = 'skin', tax_level = 'genus'
)
res_skin_gn <- runEnrichment(
  sets_skin_gn$bsdb_sets, 
  sets_skin_gn$background_sets, bp_sigs_gn
)
p_skin_gn <- plotEnrichmentRes(res_skin_gn, 'skin', 'genus')
p_skin_gn
```

**Skin - species**

```{r enrichment - skin - species, fig.height=4, fig.width=10}
sets_skin_sp <- getSets(
  b = 'skin', t = 'skin', tax_level = 'species'
)
res_skin_sp <- runEnrichment(
  sets_skin_sp$bsdb_sets, 
  sets_skin_sp$background_sets, bp_sigs_sp
)
## no results because Abundance in Group 1 are all NAs
p_skin_sp <- plotEnrichmentRes(res_skin_sp, 'skin', 'species')
p_skin_sp
```

# A step by step case

Get bsdb signatures

```{r get bsdb signatures}
bsdb_sets_ <- bsdb |> 
    filter(`Body site` == 'feces', `Host species` == 'Homo sapiens') |> 
    bugsigdbr::getSignatures(
        tax.id.type = 'ncbi', tax.level = 'genus', min.size = 5
    ) 
length(bsdb_sets_)
```

```{r}
lapply(bsdb_sets_[1:3], head)
```

Create background sets

```{r get typical set}
typical_set_ <- typical |> 
    filter(body_site == 'stool', rank == 'genus') |> 
    pull(taxid) |> 
    unique()
length(typical_set_) 
```

```{r}
head(typical_set_)
```

```{r get background sets}
background_sets_ <- lapply(bsdb_sets_, function(x) unique(c(x, typical_set_)))
length(background_sets_)
```

Create contingency tables

```{r example contingency tables}
taxa_name_ <- 'bsdb:237/1/1_chronic-hepatitis-C-virus-infection:cirrhosis-patients_vs_healthy-controls_UP'
ct <- bugphyzzAnalyses:::.contingencyTable(
    set = bsdb_sets_[[taxa_name_]],
    reference = background_sets_[[taxa_name_]],
    sig = bp_sigs_gn$`bugphyzz:aerophilicity|aerobic`
)
ct
```


Enrichment

```{r}
p_value_ <- stats::fisher.test(ct, alternative = 'g')$p.value
p_value_

```

# Session information

```{r session info}
sessioninfo::session_info()
```



Notes:

Smoking vs controls

