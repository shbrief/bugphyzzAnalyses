---
title: "High-througput BSEA of BugSigDB and bugphyzz sets"
output:
  html_document:
    toc: true
    code_folding: hide
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r load packages, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(purrr)
library(tidyr)
library(dplyr)
library(bugsigdbr)
library(taxPPro)
library(ggplot2)
library(ggbreak)
library(BiocParallel)
library(forcats)
library(stringr)
library(ComplexHeatmap)
## add a comment
```

# Some considerations

+ Use only signatures with differential abundance results in BugSigDB
('Abundance in group 1' columns).
+ Some terms in BugSigDB referring to body site were merged.
+ Some terms in BugSigDB referring to disease/condition were merged.
+ We'll use [TypicalMicrobiomeSignatures](https://zenodo.org/record/7622129) 
to create background sets.
+ For this analysis, only ORA (Fishers' exact test) was used.
+ Maybe use Fisher's exact test here.

# Data (bug sets)

## TMS sets

Use [TypicalMicrobiomeSignatures](https://zenodo.org/record/7622129) to create
background sets. Use a cutoff of 0.01 prevalence for filtering:

```{r import tms, message=FALSE}
tms <- importTidyTMS(prevalence_threshold = 0.01) |> 
  mutate(
    body_site = case_when(
      body_site == 'feces' ~ 'stool',
      body_site == 'nasalcavity' ~ 'nose',
      body_site == 'oralcavity' ~ 'mouth',
      TRUE ~ body_site
    )
  )
```

Create sets at the genus and species ranks for each of the body sites
(skin, vagina, oralcavity, nasalcavity, stool):

```{r tms sets}
body_sites <- c(
  mouth = 'mouth', vagina = 'vagina',  stool = 'feces', 
  nose = 'nose', skin = 'skin of body'
)
ranks <- c('genus', 'species')
l <- length(body_sites) * length(ranks)
tms_sets <- vector('list', l)
n <- 1
for (i in seq_along(body_sites)) {
  for (j in seq_along(ranks)) {
    names(tms_sets)[n] <- paste0(names(body_sites)[i], '__', ranks[j])
    tms_sets[[n]] <- tms |> 
      filter(body_site == names(body_sites)[i], rank == ranks[j]) |> 
      pull(taxid) |> 
      unique()
    n <- n + 1
  }
}
names(tms_sets)
```

## BugSigDB sets

Only use signatures with 'decreased' or 'increased' values in the
'Abundance in Group 1' column, i.e., signatures from experiments with
differential abundance results.

Five body sites: skin, vagina, oral cavity, stool, and nasal cavity.

```{r bsdb sets}
body_sites <- c(
  mouth = 'mouth', vagina = 'vagina',  stool = 'feces', 
  nose = 'nose', skin = 'skin of body'
)
bsdb <- importBugSigDB(version = 'devel') |> 
  filter(`Abundance in Group 1` %in% c('increased', 'decreased')) |> 
  filter(`Host species` == 'Homo sapiens')
ub <- getOntology('uberon')  
bsdb_sets <- vector('list', l)
n <- 1
for (i in seq_along(body_sites)) {
  for (j in seq_along(ranks)) {
    sub_bsdb <- subsetByOntology(
      df = bsdb, column = 'Body site', term = body_sites[i], ontology = ub
    )
  names(bsdb_sets)[n] <- paste0(names(body_sites)[i], '__', ranks[j])
  sig <- bugsigdbr::getSignatures(
      df = sub_bsdb, tax.id.type = 'ncbi', tax.level = ranks[j], min.size = 5
  )
  if (length(sig) > 0) {
    bsdb_sets[[n]] <- sig
  }
  n <- n + 1
  }
}
bsdb_sets <- discard(bsdb_sets, is.null)
names(bsdb_sets)
```

## Background sets

```{r}
tms_sets <- tms_sets[names(bsdb_sets)]
background_sets <- vector('list', length(bsdb_sets))
for (i in seq_along(background_sets)) {
  names(background_sets)[i] <- names(bsdb_sets)[i]
  background_sets[[i]] <- map(
    bsdb_sets[[names(bsdb_sets)[i]]], ~ {
      unique(c(.x, tms_sets[[ names(bsdb_sets)[i] ]]))
      }
    )
}
names(background_sets)
```

## bugphyzz sets

Import data:

```{r import bp, messsage = FALSE, warning = FALSE}
bp <- as_tibble(importBugphyzz(version = 'devel'))
```

Create signatures at the genus level:

```{r bugphyzz gn sigs, message=FALSE, warning=FALSE}
bp_sigs_gn <- getBugphyzzSignatures(
  df = bp, tax.id.type = 'NCBI_ID', tax.level = 'genus', min.size = 10
)
head(names(bp_sigs_gn))
```

Create signatures at the species level:

```{r bugphyzz sp sigs}
bp_sigs_sp <- getBugphyzzSignatures(
  df = bp, tax.id.type = 'NCBI_ID', tax.level = 'species', min.size = 10
)
head(names(bp_sigs_sp))
```

# Enrichment analysis

```{r run enrichment, message=FALSE}
nworkers <- parallel::detectCores()
enrichment_res <- bplapply(
    X = seq_along(bsdb_sets), 
    BPPARAM = MulticoreParam(workers = nworkers), 
    FUN = function(i) {
        if (grepl('genus', names(bsdb_sets)[i])) {
            res <- runEnrichment(
                bsdb_sets = bsdb_sets[[i]],
                background_sets = background_sets[[i]],
                bp_sigs = bp_sigs_gn,
                bsdb = bsdb, 
                fdr_ths = 0.1
            ) |> 
                mutate(comb = names(bsdb_sets)[[i]])
        } else if (grepl('species', names(bsdb_sets)[i])) {
            res <- runEnrichment(
                bsdb_sets = bsdb_sets[[i]],
                background_sets = background_sets[[i]],
                bp_sigs = bp_sigs_sp,
                bsdb = bsdb, 
                fdr_ths = 0.1
            ) |> 
                mutate(comb = names(bsdb_sets)[[i]])
        }
    return(res)
}) |> 
    discard(~ !nrow(.x))
enrichDF <- bind_rows(enrichment_res) |> 
    separate(col = 'comb', into = c('body_site', 'rank'), sep = '__') |> 
    mutate(Attribute_group = sub('^bp:(.*)\\|.*\\|\\w$', '\\1', bp_sig)) |> 
    mutate(Condition = str_to_lower(str_squish(Condition)))
count(enrichDF, body_site, rank)
```
# Enrichment plots

Prepare data about category:

```{r}
## Create another bsdb data.frame with body_site and condition category info
fname <- system.file(
    'extdata', 'condition2category.tsv', package = 'bugphyzzAnalyses',
    mustWork = TRUE
)
cond2cat <- read.table(fname, header = TRUE, sep = '\t')
bsdb2 <- map(body_sites, ~ {
    subsetByOntology(
        df = bsdb, column = 'Body site', term = .x, ontology = ub
    )
    }) |> 
    bind_rows(.id = 'body_site') |> 
    mutate(Condition = str_to_lower(str_squish(Condition))) |> 
    left_join(cond2cat, by = 'Condition') |> 
    rename(category = Category)

## Summary for top column barplot annotations -- condition category
summary_category_bsdb <- bsdb2 |> 
    filter(!is.na(category)) |> 
    count(category, name = 'category_total') |> 
    arrange(-category_total)
    # tibble::column_to_rownames(var = 'category')

## Summary for top column barplot annotations -- body site
summary_bodysite_bsdb <- bsdb2 |> 
    filter(!is.na(body_site)) |> 
    count(body_site, name = 'bodysite_total') |> 
    arrange(-bodysite_total)
    # tibble::column_to_rownames(var = 'body_site')

## Frequency for row annotations -- frequency of enriched physiologies (attrbute_group) by genus
summary_physiolgy_freqs_enrichDF <- enrichDF |>
    count(Attribute_group, rank) |> 
    pivot_wider(
        names_from = 'rank', values_from = 'n', values_fill = 0
    ) |> 
    mutate(freq = genus + species) |> 
    arrange(-freq) |> 
    mutate(Attribute_group = fct_inorder(Attribute_group)) |> 
    tibble::column_to_rownames(var = 'Attribute_group') |>
    select(-freq)

## Create first matrix with condition categories
mat_condition <- enrichDF |> 
    left_join(cond2cat, by = 'Condition') |> 
    filter(!is.na(Category)) |> 
    select(Attribute_group, Category, `BSDB ID`) |> 
    unique() |>  # so I wont' have a single sig twice becouse of rank (species and genus)
    count(Attribute_group, Category, name = 'n_enrich') |> 
    left_join(summary_category_bsdb, by = c('Category' = 'category')) |> 
    mutate(per = round((n_enrich / category_total) * 100)) |> 
    select(-n_enrich, -category_total) |> 
    pivot_wider(
        names_from = 'Category', values_from = 'per', values_fill = 0
    ) |> 
    as.data.frame() |> 
    tibble::column_to_rownames(var = 'Attribute_group') |> 
    as.matrix()
## Create second matrix with body sites
mat_bodysite <- enrichDF |> 
    left_join(cond2cat, by = 'Condition') |> 
    filter(!is.na(Category)) |> 
    select(Attribute_group, body_site, `BSDB ID`) |> 
    unique() |>
    count(Attribute_group, body_site, name = 'n_enrich') |> 
    left_join(summary_bodysite_bsdb, by = 'body_site') |> 
    mutate(per = round((n_enrich / bodysite_total) * 100)) |>
    select(-n_enrich, -bodysite_total) |>
    # select(-bodysite_total) |>
    pivot_wider(
        # names_from = 'body_site', values_from = 'n_enrich', values_fill = 0
        names_from = 'body_site', values_from = 'per', values_fill = 0
    ) |> 
    as.data.frame() |> 
    tibble::column_to_rownames(var = 'Attribute_group') |> 
    as.matrix()
```

Some variables for both heatmaps

```{r}
rownames_order <- rownames(summary_physiolgy_freqs_enrichDF)
summary_category_bsdb <- summary_category_bsdb |> 
    filter(category %in% colnames(mat_condition)) |> 
    tibble::column_to_rownames(var = 'category') 
summary_bodysite_bsdb <- summary_bodysite_bsdb |> 
    filter(body_site %in% colnames(mat_bodysite)) |> 
    tibble::column_to_rownames(var = 'body_site')
colnames_order_category <- rownames(summary_category_bsdb)
colnames_order_bodysite <- rownames(summary_bodysite_bsdb)

xrownames <- intersect(rownames(mat_condition), rownames(mat_bodysite))
xrownames <- xrownames[na.omit(match(rownames_order, xrownames))]
mat_condition <- mat_condition[xrownames, colnames_order_category]
mat_bodysite <- mat_bodysite[xrownames, colnames_order_bodysite]

# mat_condition <-  mat_condition[rownames_order, colnames_order_category]
# mat_bodysite <- mat_bodysite[rownames_order, colnames_order_bodysite]
```

```{r}
max_n <- max(max(mat_condition), max(mat_bodysite))
color_fun <- circlize::colorRamp2(
    breaks = c(0, max_n), colors = c('white', 'gray20')
)
lgd <- Legend(col_fun = color_fun, title = "%")
anno_width = unit(2, 'cm')
col_anno_category <- columnAnnotation(
    "# bsdb sigs" = anno_barplot(
        summary_category_bsdb, bar_width = 1, gp = gpar(fill = '#40B0A6'),
        height = anno_width),
    show_annotation_name = TRUE,
    annotation_name_side = "left"
)

col_anno_bodysite <- columnAnnotation(
    "bs" = anno_barplot(
        summary_bodysite_bsdb, bar_width = 1, gp = gpar(fill = '#40B0A6'),
        height = anno_width),
    show_annotation_name = FALSE
)


ht1 <- Heatmap(
    matrix = mat_condition,
    cluster_rows = FALSE, cluster_columns = FALSE,
    row_names_side = 'left',
    show_heatmap_legend = FALSE,
    col = color_fun,
    column_names_rot = 45,
    column_title = "Condition category",
    row_names_max_width = max_text_width(
        rownames(mat_condition),
        gp = gpar(fontsize = 12)
    ),
    top_annotation = col_anno_category
)

ht2 <- Heatmap(
    matrix = mat_bodysite,
    cluster_rows = FALSE, cluster_columns = FALSE,
    row_names_side = 'left',
    show_heatmap_legend = TRUE,
    name = '%',
    col = color_fun,
    column_names_rot = 45,
    column_title = "Body site",
    row_names_max_width = max_text_width(
        rownames(mat_bodysite),
        gp = gpar(fontsize = 12)
    ),
    top_annotation = col_anno_bodysite
)

rank_col <- c('#0C7BDC', '#FFC20A')

myRowAnnDF <- summary_physiolgy_freqs_enrichDF[rownames(mat_condition),]

row_anno <- rowAnnotation(
    "# bp sigs" = anno_barplot(
        myRowAnnDF, bar_width = 1,
        gp = gpar(fill = rank_col), width = unit(3, 'cm')),
    show_annotation_name = TRUE 
)

ht_list <- ht1 + ht2 + row_anno

lgd_list <- list(
    Legend(labels = c('genus', 'species'), title = "Rank", 
        legend_gp = gpar(fill = rank_col))
)

draw(
    ht_list, ht_gap = unit(c(1, 0.1), "cm"),
    heatmap_legend_side = 'right',
    heatmap_legend_list = lgd_list
)

```


Draw heatmap

```{r, echo=FALSE, eval=FALSE, include=FALSE}
png(
    filename = 'attr_bs_dt.png', width = 650, height = 800, units = 'px',
    bg = 'white'
)
draw(
    ht_list, ht_gap = unit(c(1, 0.1), "cm"),
    heatmap_legend_side = 'right',
    heatmap_legend_list = lgd_list
)
dev.off()
```






```{r session info}
sessioninfo::session_info()
```

#> top signatures by odds ratio
