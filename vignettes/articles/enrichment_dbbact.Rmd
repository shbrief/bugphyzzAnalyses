---
title: "Enrichment with dbBact approach"
output:
  html_document:
    toc: yes
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Setup

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugsigdbr)
library(bugphyzz)
library(purrr)
library(dplyr)
library(stringr)
library(tidyr)
library(ComplexHeatmap)

## Variables
body_sites <- c(
    skin = "skin", vagina = "vagina", mouth = "mouth", feces = "feces"
)
ranks <- c(genus = "genus", species = "species")
directions <- c(increased = "increased", decreased = "decreased")

score_opt <- "counts"
stat_test <- "wilcox.test"

permV <- 1000

min_prev <- 3
```

# Data

Import bugphyzz and create signatures at the genus and species levels:

```{r, warning=FALSE, message=FALSE}
bp <- importBugphyzz(
    version = "10.5281/zenodo.10980813", # v1.0.2
)

bpSigs_g <- map(bp, ~ {
    makeSignatures(
        dat = .x,  tax_id_type = "NCBI_ID", tax_level = "genus",
        min_size = 10
    )
}) |> 
    list_flatten(name_spec = "{inner}") |> 
    discard(is.null)

bpSigs_s <- map(bp, ~ {
    makeSignatures(
        dat = .x,  tax_id_type = "NCBI_ID", tax_level = "species",
        min_size = 10
    )
}) |> 
    list_flatten(name_spec = "{inner}") |> 
    discard(is.null)
```

Import BugSigDB:

```{r}
bsdb_doi <- "10.5281/zenodo.10627578" # v1.2.1
bsdb <- importBugSigDB(version = bsdb_doi)
bsdb <- bsdb |> 
    filter(`Host species` == "Homo sapiens") |> 
    filter(`Abundance in Group 1` %in% c("increased", "decreased")) |>
    filter(!is.na(`Body site`))
dim(bsdb)
```

Subset by body site:

```{r}
uberon <- getOntology(onto = "uberon")
bsdb_subsets_by_bodysite <- vector("list", length(body_sites))
names(bsdb_subsets_by_bodysite) <- body_sites
for (i in seq_along(bsdb_subsets_by_bodysite)) {
    if (body_sites[i] == "skin") { ## Didn't find an ontology for skin
        bsdb_subsets_by_bodysite[[i]] <- bsdb |> 
            filter(grepl(body_sites[i], `Body site`, ignore.case = TRUE))
    } else {
        bsdb_subsets_by_bodysite[[i]] <- subsetByOntology(
            bsdb, column = "Body site", term = body_sites[i], ontology = uberon 
        )
    }
}
```

Filter even experiments for genus:

```{r}
even_bsdb_g <- map(
    bsdb_subsets_by_bodysite, ~ filterEvenDat(.x, "genus", min_size = 1)
) |> 
    discard(~ !length(.x))
## Number of experiments with paired signatures:
map_int(even_bsdb_g, ~ nrow(.x[[1]]))
```

Types of studies:

```{r}
even_bsdb_g |> 
    list_flatten(name_spec = "{outer}") |> 
    bind_rows(.id = "bodysite") |> 
    count(bodysite, Condition) |> 
    mutate(Nexp = n / 2) |> 
    arrange(bodysite, -n) |> 
    myDataTable()
```

Filter even experiments for species:

```{r}
even_bsdb_s <- map(
    bsdb_subsets_by_bodysite, ~ filterEvenDat(.x, "species", min_size = 1)
) |> 
    discard(~ !length(.x))
## Number of experiments with paired signatures
map_int(even_bsdb_s, ~ nrow(.x[[1]]))
```

Types of studies:

```{r}
even_bsdb_s |> 
    list_flatten(name_spec = "{outer}") |> 
    bind_rows(.id = "bodysite") |> 
    count(bodysite, Condition) |> 
    mutate(n = n / 2) |> 
    arrange(bodysite, -n) |> 
    myDataTable()
```

Filter even signatures for genus:

```{r}
## filterEvenSignatures implements filterEvenExperiments
even_sigs_g <- map(
    bsdb_subsets_by_bodysite, ~ filterEvenSignatures(.x, "genus", min_size = 1)
) |> 
    discard(~ !length(.x))
map_lgl(even_sigs_g, ~ {
    all(names(.x$decreased) == names(.x$increased))
})
```

Filter even signatures for species:

```{r}
## filterEvenSignatures implements filterEvenExperiments
even_sigs_s <- map(
    bsdb_subsets_by_bodysite, ~ filterEvenSignatures(.x, "species", min_size = 1)
) |> 
    discard(~ !length(.x))
map_lgl(even_sigs_s, ~ {
    all(names(.x$decreased) == names(.x$increased))
})
```

Create concatenated signatures:

```{r}
## This step adds the number of experients for each concatenated
## signatures as an attributes
catSigs_g <- map(even_sigs_g, concatenateEvenSigs)
catSigs_s <- map(even_sigs_s, concatenateEvenSigs)
```

Run enrichment using dbBact approach:

```{r, warning=FALSE}
feces_enriched_g <- map2(
    .x = catSigs_g$feces$decreased,
    .y = catSigs_g$feces$increased,
    ~ dbEn2(
        control = .x, case = .y, term_list = bpSigs_g,
        perm = permV, freq = min_prev
    )
) |> 
    discard(is.null)
feces_enriched_s <- map2(
    .x = catSigs_s$feces$decreased,
    .y = catSigs_s$feces$increased,
    ~ dbEn2(
        control = .x, case = .y, term_list = bpSigs_s,
        perm = permV, freq = min_prev
    )
) |> 
    discard(is.null)
mouth_enriched_g <- map2(
    .x = catSigs_g$mouth$decreased,
    .y = catSigs_g$mouth$increased,
    ~ dbEn2(
        control = .x, case = .y, term_list = bpSigs_g,
        perm = permV, freq = min_prev
    )
) |> 
    discard(is.null)
mouth_enriched_s <- map2(
    .x = catSigs_s$mouth$decreased,
    .y = catSigs_s$mouth$increased,
    ~ dbEn2(
        control = .x, case = .y, term_list = bpSigs_s,
        perm = permV, freq = min_prev
    )
) |> 
    discard(is.null)
```

# Exploration of particular cases

## Colorectal cancer - genus

```{r, fig.height=12, fig.width=16}
crc_g <- dbHt(feces_enriched_g$`Colorectal-cancer`)
```

## Colorectal cancer - species

```{r, fig.height=15, fig.width=20}
crc_s <- dbHt(feces_enriched_s$`Colorectal-cancer`)
```

# COVID-19

```{r, fig.width=15, fig.height=15}
ht3 <- dbHt(feces_enriched_s$`COVID-19`)
```

# CRC - A single study

Study [544](https://bugsigdb.org/Study_544):

```{r}
s544_co <- even_bsdb_s$feces$decreased |> 
    filter(Study == "Study 544") |> 
    getSignatures(tax.id.type = "ncbi") |> 
    unlist()
attr(s544_co, "nexp") <- 1
    
s544_ca <- even_bsdb_s$feces$increased |> 
    filter(Study == "Study 544") |> 
    getSignatures(tax.id.type = "ncbi") |> 
    unlist()
attr(s544_ca, "nexp") <- 1
```

```{r, warning=FALSE, fig.width=12, fig.height=15}
se <- dbEn2(s544_co, s544_ca, term_list = bpSigs_s, f = stat_test,
            perm = 10000)
dbHt(se, pCol = "P_value")
```

```{r, fig.height=15}
dbHt(feces_enriched_s$`Multiple-myeloma`)

```

```{r, fig.width=15, fig.height=13}
dbHt(feces_enriched_g$Obesity)
```


```{r}
x <- c(feces = feces_enriched_g, mouth = mouth_enriched_g) |> 
    map(~ {
        rowData(.x) |> 
            as.data.frame() |> 
            tibble::rownames_to_column(var = "term") |> 
            as_tibble()
    }) |>
    bind_rows(.id = "var") |> 
    mutate(body_site = sub("^(feces|mouth)\\..*$", "\\1", var)) |> 
    mutate(condition = sub("^(feces|mouth)\\.(.*$)", "\\2", var)) |> 
    select(-var) |> 
    relocate(body_site, condition) |> 
    filter(!is.na(P_value)) |> 
    mutate(FDR = p.adjust(P_value, "fdr"))



y <- c(feces = feces_enriched_s, mouth = mouth_enriched_s) |> 
    map(~ {
        rowData(.x) |> 
            as.data.frame() |> 
            tibble::rownames_to_column(var = "term") |> 
            as_tibble()
    }) |>
    bind_rows(.id = "var") |> 
    mutate(body_site = sub("^(feces|mouth)\\..*$", "\\1", var)) |> 
    mutate(condition = sub("^(feces|mouth)\\.(.*$)", "\\2", var)) |> 
    select(-var) |> 
    relocate(body_site, condition) |> 
    filter(!is.na(P_value)) |> 
    mutate(FDR = p.adjust(P_value, "fdr"))
```


```{r, fig.height=15, fig.width=20}
dbHt(se)
```

# Session information

```{r}
sessioninfo::session_info()
```
