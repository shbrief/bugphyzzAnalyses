---
title: "Enrichment with dbBact approach"
output:
  html_document:
    toc: yes
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Setup

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugsigdbr)
library(bugphyzz)
library(purrr)
library(dplyr)
library(stringr)
library(tidyr)
library(ComplexHeatmap)

## Variables
body_sites <- c(
    skin = "skin", vagina = "vagina", mouth = "mouth", feces = "feces"
)
ranks <- c(genus = "genus", species = "species")
directions <- c(increased = "increased", decreased = "decreased")

perm_var <- 1000
freq_var <- 1
```

# Data

Import bugphyzz and create signatures at the genus and species levels:

```{r, warning=FALSE, message=FALSE}
bp <- importBugphyzz(
    version = "10.5281/zenodo.10980813", # v1.0.2
    v = 0.8
)
bpSigs_g <- map(bp, ~ {
    makeSignatures(
        dat = .x,  tax_id_type = "NCBI_ID", tax_level = "genus",
        min_size = 10
    )
}) |> 
    list_flatten(name_spec = "{inner}") |> 
    discard(is.null)

bpSigs_s <- map(bp, ~ {
    makeSignatures(
        dat = .x,  tax_id_type = "NCBI_ID", tax_level = "species",
        min_size = 10
    )
}) |> 
    list_flatten(name_spec = "{inner}") |> 
    discard(is.null)
```

Import BugSigDB:

```{r}
bsdb_doi <- "10.5281/zenodo.10627578" # v1.2.1
bsdb <- importBugSigDB(version = bsdb_doi)
bsdb <- bsdb |> 
    filter(`Host species` == "Homo sapiens") |> 
    filter(`Abundance in Group 1` %in% c("increased", "decreased")) |>
    filter(!is.na(`Body site`)) |> 
    # filter(`Study design` == "case-control") |> 
    mutate(exp = sub("^(bsdb:\\d+/\\d+)/\\d+", "\\1", `BSDB ID`))
dim(bsdb)
```

Subset by body site:

```{r}
uberon <- getOntology(onto = "uberon")
bsdb_subsets_by_bodysite <- vector("list", length(body_sites))
names(bsdb_subsets_by_bodysite) <- body_sites
for (i in seq_along(bsdb_subsets_by_bodysite)) {
    if (body_sites[i] == "skin") { ## Didn't find an ontology for skin
        bsdb_subsets_by_bodysite[[i]] <- bsdb |> 
            filter(grepl(body_sites[i], `Body site`, ignore.case = TRUE))
    } else {
        bsdb_subsets_by_bodysite[[i]] <- subsetByOntology(
            bsdb, column = "Body site", term = body_sites[i], ontology = uberon 
        )
    }
}
```

```{r}
dats <- map(bsdb_subsets_by_bodysite, filterEvenDat)
map_int(dats, ~ nrow(.x$decreased)) == map_int(dats, ~ nrow(.x$increased))
```

# Colorectal cancer

Get experiments and BSDB rows

```{r}
crc_exps <- crc_dat <- dats$feces$increased |> # It doesn't matter here if it's increased or decreased
    filter(Condition == "Colorectal cancer") |>
    filter(
        grepl("control", `Group 0 name`, ignore.case = TRUE) &
            grepl("(colorectal cancer|crc)", `Group 1 name`, ignore.case = TRUE)
    ) |> 
    pull(exp)
crc_dat_inc <- dats$feces$increased |> 
    filter(exp %in% crc_exps)
crc_dat_dec <- dats$feces$decreased |> 
    filter(exp %in% crc_exps)
length(crc_exps)
```

Get signatures:

```{r}
crc_sigs_s <- getPairedSigs(
    crc_dat_dec, crc_dat_inc, rank = "species", cat = TRUE
)
crc_sigs_g <- getPairedSigs(
    crc_dat_dec, crc_dat_inc, rank = "genus", cat = TRUE
)
```

Enrichment at the species level:

```{r, fig.height=12, fig.width=20}
crc_feces_enriched_s <- dbEn2(
    crc_sigs_s$dec, crc_sigs_s$inc, term_list = bpSigs_s,
    perm = perm_var, freq = 1
)
dbHt(crc_feces_enriched_s, scm = FALSE)
```

Enrichment at the genus level:

```{r, fig.height=8, fig.width=12, warning=FALSE}
crc_feces_enriched_g <- dbEn2(
    crc_sigs_g$dec, crc_sigs_g$inc, term_list = bpSigs_g,
    perm = perm_var, freq = 1
)
dbHt(crc_feces_enriched_g, scm = FALSE)
```

# Obesity

```{r}
obs_dat <- dats$feces$increased |> # It doesn't matter here if it's increased or decreased
    filter(Condition == "Obesity")

## Got these experiments with manual inspection of the data.frame
obs_exps = c(
    "bsdb:101/1",
    "bsdb:149/1",
    "bsdb:33/1",
    "bsdb:338/1",
    "bsdb:338/2",
    "bsdb:345/1",
    "bsdb:347/1",
    "bsdb:348/1",
    "bsdb:348/3",
    "bsdb:350/1",
    "bsdb:350/2",
    "bsdb:351/1",
    "bsdb:354/1",
    "bsdb:355/1",
    "bsdb:36/5",
    "bsdb:362/1",
    "bsdb:367/1",
    "bsdb:369/1",
    "bsdb:371/3",
    "bsdb:373/1",
    "bsdb:375/1",
    "bsdb:44/1",
    "bsdb:48/1",
    "bsdb:48/2",
    "bsdb:68/1",
    "bsdb:68/2",
    "bsdb:68/3",
    "bsdb:68/4",
    "bsdb:68/5",
    "bsdb:68/6",
    "bsdb:70/1",
    "bsdb:70/2",
    "bsdb:70/3",
    "bsdb:73/1",
    "bsdb:73/2",
    "bsdb:732/1",
    "bsdb:74/1",
    "bsdb:74/3",
    "bsdb:847/1",
    "bsdb:96/1",
    "bsdb:99/1"  
    
)

obs_dat_inc <- dats$feces$increased |> 
    filter(exp %in% obs_exps)
obs_dat_dec <- dats$feces$decreased |> 
    filter(exp %in% obs_exps)

length(obs_exps)
```

```{r}
obs_sigs_s <- getPairedSigs(obs_dat_dec, obs_dat_inc, rank = "species", cat = TRUE)
obs_sigs_g <- getPairedSigs(obs_dat_dec, obs_dat_inc, rank = "genus", cat = TRUE)
```

Enrichment at the species level:

```{r, fig.height=12, fig.width=20}
obs_feces_enriched_s <- dbEn2(
    obs_sigs_s$dec, obs_sigs_s$inc, term_list = bpSigs_s,
    perm = perm_var, freq = 1
)
dbHt(obs_feces_enriched_s, scm = FALSE)
```


```{r, fig.width=20, fig.height=10}
obs_feces_enriched_g <- dbEn2(
    obs_sigs_g$dec, obs_sigs_g$inc, term_list = bpSigs_g,
    perm = perm_var, freq = 1
)
dbHt(obs_feces_enriched_g, scm = FALSE)
```

# COVID-19

```{r}
covid_dat <- dats$feces$increased |> # It doesn't matter here if it's increased or decreased
    filter(Condition == "COVID-19")

## Manual inspection
covid_exps <- c(
    "bsdb:734/1",
    "bsdb:428/1",
    "bsdb:441/1",
    "bsdb:464/3",
    "bsdb:481/1",
    "bsdb:486/1",
    "bsdb:486/2",
    "bsdb:486/3",
    "bsdb:487/3",
    "bsdb:496/1",
    "bsdb:511/4",
    "bsdb:511/5",
    "bsdb:453/4",
    "bsdb:782/3"
)

covid_dat_inc <- dats$feces$increased |> 
    filter(exp %in% covid_exps)
covid_dat_dec <- dats$feces$decreased |> 
    filter(exp %in% covid_exps)
# covid_dat |> 
#     relocate(exp, `Group 0 name`, `Group 1 name`) |> 
#     View()
```

Concatenate signatures:

```{r}
covid_sigs_s <- getPairedSigs(covid_dat_dec, covid_dat_inc, rank = "species", cat = TRUE)
covid_sigs_g <- getPairedSigs(covid_dat_dec, covid_dat_inc, rank = "genus", cat = TRUE)
```

Enrichment at the species level:

```{r, fig.height=12, fig.width=20}
covid_feces_enriched_s <- dbEn2(
    covid_sigs_s$dec, covid_sigs_s$inc, term_list = bpSigs_s,
    perm = perm_var, freq = 1
)
dbHt(covid_feces_enriched_s, scm = FALSE)
```

```{r, fig.height=12, fig.width=20}
covid_feces_enriched_g <- dbEn2(
    covid_sigs_g$dec, covid_sigs_g$inc, term_list = bpSigs_g,
    perm = perm_var, freq = 1
)
dbHt(covid_feces_enriched_g, scm = FALSE)
```

## Smoking 

```{r}
smo_dat <- dats$mouth$increased |> # It doesn't matter here if it's increased or decreased
        filter(Condition == "Smoking behavior")
smo_exps <- smo_dat |> 
    filter(exp != "bsdb:368/1") |> 
    pull(exp)
smo_dat_inc <- dats$mouth$increased |> 
    filter(exp %in% smo_exps)
smo_dat_dec <- dats$mouth$decreased |> 
    filter(exp %in% smo_exps)
# smo_dat |>
#     relocate(exp, `Group 0 name`, `Group 1 name`) |>
#     View()
```

Get concatenated signatures:

```{r}
smo_sigs_s <- getPairedSigs(smo_dat_dec, smo_dat_inc, rank = "species", cat = TRUE)
smo_sigs_g <- getPairedSigs(smo_dat_dec, smo_dat_inc, rank = "genus", cat = TRUE)
```

```{r, fig.height=12, fig.width=20}
smo_mouth_enriched_s <- dbEn2(
    smo_sigs_s$dec, smo_sigs_s$inc, term_list = bpSigs_s,
    perm = perm_var, freq = 1
)
dbHt(smo_mouth_enriched_s, scm = FALSE)
```

```{r, fig.height=12, fig.width=20}
smo_mouth_enriched_g <- dbEn2(
    smo_sigs_g$dec, smo_sigs_g$inc, term_list = bpSigs_g,
    perm = perm_var, freq = 1
)
dbHt(smo_mouth_enriched_g, scm = FALSE)
```

## IBD

```{r}
ibs_dat <- dats$feces$increased |> # It doesn't matter here if it's increased or decreased
        filter(Condition == "Irritable bowel syndrome")
ibs_exps <- ibs_dat |> 
    pull(exp)
ibs_dat_inc <- dats$feces$increased |> 
    filter(exp %in% ibs_exps)
ibs_dat_dec <- dats$feces$decreased |> 
    filter(exp %in% ibs_exps)

# ibs_dat |> 
#     relocate(exp, `Group 0 name`, `Group 1 name`) |> 
#     View()
```

```{r}
ibs_sigs_s <- getPairedSigs(ibs_dat_dec, ibs_dat_inc, rank = "species", cat = TRUE)
ibs_sigs_g <- getPairedSigs(ibs_dat_dec, ibs_dat_inc, rank = "genus", cat = TRUE)
```

```{r, fig.height=15, fig.width=20}
ibs_feces_enriched_s <- dbEn2(
    ibs_sigs_s$dec, ibs_sigs_s$inc, term_list = bpSigs_s,
    perm = perm_var, freq = 1
)
dbHt(ibs_feces_enriched_s, scm = FALSE)
```

```{r, fig.width=25, fig.height=15}
ibs_feces_enriched_g <- dbEn2(
    ibs_sigs_g$dec, ibs_sigs_g$inc, term_list = bpSigs_g,
    perm = perm_var, freq = 1
)
dbHt(ibs_feces_enriched_g, scm = FALSE)
```

# Summary table

```{r, eval=FALSE}
## genus
x <- c(
    feces = feces_enriched_g, mouth = mouth_enriched_g,
    vagina = vagina_enriched_g, skin = skin_enriched_g
    ) |> 
    map(~ {
        rowData(.x) |> 
            as.data.frame() |> 
            tibble::rownames_to_column(var = "term") |> 
            as_tibble()
    }) |>
    bind_rows(.id = "var") |> 
    mutate(body_site = sub("^(feces|mouth)\\..*$", "\\1", var)) |> 
    mutate(condition = sub("^(feces|mouth)\\.(.*$)", "\\2", var)) |> 
    select(-var) |> 
    relocate(body_site, condition) |> 
    filter(!is.na(P_value)) |> 
    mutate(FDR = p.adjust(P_value, "fdr")) |> 
    arrange(FDR)

## species
y <- c(
    feces = feces_enriched_s, mouth = mouth_enriched_s,
    vagina = vagina_enriched_g, skin = skin_enriched_g
    ) |> 
    map(~ {
        rowData(.x) |> 
            as.data.frame() |> 
            tibble::rownames_to_column(var = "term") |> 
            as_tibble()
    }) |>
    bind_rows(.id = "var") |> 
    mutate(body_site = sub("^(feces|mouth)\\..*$", "\\1", var)) |> 
    mutate(condition = sub("^(feces|mouth)\\.(.*$)", "\\2", var)) |> 
    select(-var) |> 
    relocate(body_site, condition) |> 
    filter(!is.na(P_value)) |> 
    mutate(FDR = p.adjust(P_value, "fdr")) |> 
    arrange(FDR)
```

# Session information

```{r}
sessioninfo::session_info()
```
