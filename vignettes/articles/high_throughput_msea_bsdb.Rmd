---
title: "High-througput MSEA of BugSigDB and bugphyzz sets"
output:
  html_document:
    toc: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r load packages, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(purrr)
library(tidyr)
library(dplyr)
library(bugsigdbr)
library(taxPPro)
library(ggplot2)
library(ggbreak)
## add a comment
```

# Some considerations

+ Use only signatures with differential abundance results in BugSigDB
('Abundance in group 1' columns).
+ Some terms in BugSigDB referring to body site were merged.
+ Some terms in BugSigDB referring to disease/condition were merged.
+ We'll use [TypicalMicrobiomeSignatures](https://zenodo.org/record/7622129) 
to create background sets.
+ For this analysis, only ORA (Fishers' exact test) was used.
+ Maybe use Fisher's exact test here.

# Data

## Background sets

Use [TypicalMicrobiomeSignatures](https://zenodo.org/record/7622129) to create
background sets. Use a cutoff of 0.01 prevalence for filtering.

```{r import tms, message=FALSE}
tms <- importTidyTMS(prevalence_threshold = 0.01) |> 
  mutate(
    body_site = case_when(
      body_site == 'feces' ~ 'stool',
      body_site == 'nasalcavity' ~ 'nose',
      body_site == 'oralcavity' ~ 'mouth',
      TRUE ~ body_site
    )
  )
glimpse(tms, width = 70)
```

Create sets for tms at the genus and species ranks for each of the body sites
(skin, vagina, oralcavity, nasalcavity, stool):

```{r tms sets}
body_sites <- c('skin', 'vagina', 'mouth', 'nose', 'stool')
ranks <- c('genus', 'species')
l <- length(body_sites) * length(ranks)
tms_sets <- vector('list', l)
n <- 1
for (i in seq_along(body_sites)) {
  for (j in seq_along(ranks)) {
    names(tms_sets)[n] <- paste0(body_sites[i], '__', ranks[j])
    tms_sets[[n]] <- tms |> 
      filter(body_site == body_sites[i], rank == ranks[j]) |> 
      pull(taxid) |> 
      unique()
    n <- n + 1
  }
}
map(tms_sets, head)
```

## BugSigDB sets

Just consider signatures with 'decreased' or 'increased' values in the
'Abundance in Group 1' column, i.e., signatures from experiments with
differential abundance results.

I need five body sites, skin, vagina, oral cavity, stool, and nasal cavity,
because these would match TypicalMicrobiomeSignatures to create a background
dataset.


```{r bsdb sets}
body_sites <- c(
  mouth = 'mouth', vagina = 'vagina',  stool = 'feces', 
  nose = 'nose', skin = 'skin of body'
)
bsdb <- importBugSigDB() |> 
  filter(`Abundance in Group 1` %in% c('increased', 'decreased')) |> 
  filter(`Host species` == 'Homo sapiens')
ub <- getOntology(onto = 'uberon')  
bsdb_sets <- vector('list', l)
n <- 1
for (i in seq_along(body_sites)) {
  for (j in seq_along(ranks)) {
    sub_bsdb <- subsetByOntology(
      df = bsdb, column = 'Body site', term = body_sites[i], ontology = ub
    )
  names(bsdb_sets)[n] <- paste0(names(body_sites)[i], '__', ranks[j])
  sig <- bugsigdbr::getSignatures(
      df = sub_bsdb, tax.id.type = 'ncbi', tax.level = ranks[j], min.size = 5
  )
  if (length(sig) > 0) {
    bsdb_sets[[n]] <- sig
  }
  n <- n + 1
  }
}
bsdb_sets <- discard(bsdb_sets, is.null)
map(bsdb_sets, length)
```

## Background sets

```{r}
tms_sets <- tms_sets[names(bsdb_sets)]
background_sets <- vector('list', length(bsdb_sets))
for (i in seq_along(background_sets)) {
  names(background_sets)[i] <- names(bsdb_sets)[i]
  background_sets[[i]] <- map(
    bsdb_sets[[names(bsdb_sets)[i]]], ~ {
      unique(c(.x, tms_sets[[ names(bsdb_sets)[i] ]]))
      }
    )
}
map(background_sets, length) # length should be the same as bsdb_sets
```
## bugphyzz sets

```{r import bp, message=FALSE, warning=FALSE}
bp <- as_tibble(importBugphyzz(version = 'devel'))
glimpse(bp, width = 70)
```
Genus signatures

```{r bp gn sets}
bp_sigs_gn <- getBugphyzzSignatures(
  df = bp, tax.id.type = 'NCBI_ID', tax.level = 'genus', min.size = 10
)
head(map(bp_sigs_gn, head))
```
Species signatures

```{r bp sp sets}
bp_sigs_sp <- getBugphyzzSignatures(
  df = bp, tax.id.type = 'NCBI_ID', tax.level = 'species', min.size = 10
)
head(map(bp_sigs_sp, head))
```

# Enrichment analysis

```{r run enrichment, message=FALSE}
if (!'BSDB ID' %in% colnames(bsdb)) {
  bsdb <- bsdb |> 
    mutate(
      `BSDB ID`  = paste0(
        'bsdb:',
        sub('^.* ', '', Study), '/', 
        sub('^.* ', '', Experiment), '/', 
        sub('^.* ', '', `Signature page name`)
      )
    ) |> 
    relocate(`BSDB ID`)
}

enrichment_res <- vector('list', length(bsdb_sets))
for (i in seq_along(bsdb_sets)) {
  message('Running enrichment for bsdb ', names(bsdb_sets)[i], '.')
  names(enrichment_res)[i] <- names(bsdb_sets)[i]
  if (grepl('genus', names(bsdb_sets)[i])) {
    res <- runEnrichment(
      bsdb_sets = bsdb_sets[[i]],
      background_sets = background_sets[[i]],
      bp_sigs = bp_sigs_gn,
      bsdb = bsdb, 
      fdr_ths = 0.1
    )
  } else if (grepl('species', names(bsdb_sets)[i])) {
    res <- runEnrichment(
      bsdb_sets = bsdb_sets[[i]],
      background_sets = background_sets[[i]],
      bp_sigs = bp_sigs_sp,
      bsdb = bsdb, 
      fdr_ths = 0.1
    )
  }
  enrichment_res[[i]] <- res
}
enrichment_res <- discard(enrichment_res, ~ !nrow(.x))
map(enrichment_res, nrow)
## top hits by odds ratio
```



```{r}
df <- bind_rows(enrichment_res, .id = 'comb') |> 
  separate(col = 'comb', into = c('body_site', 'rank'), sep = '__')



bp1 <- df |> 
  select(body_site, rank, bugsigdb_sig) |> 
  unique() |> 
  count(body_site, rank, name = 'bugsigdb')

bp2 <- df |> 
  select(body_site, rank, bp_sig) |> 
  count(body_site, rank, name = 'bp')

myPlot <- left_join(bp1, bp2, by = c('body_site', 'rank')) |> 
  pivot_longer(
    names_to = 'type_sig', values_to = 'n', cols = c(bugsigdb, bp)
  ) |> 
  ggplot(aes(body_site, n)) +
  geom_col(aes(fill = type_sig), position = 'dodge') +
  scale_fill_discrete(name = 'sig. source') +
  scale_y_cut(breaks = c(10)) +
  facet_wrap(~rank, ncol = 2) +
  labs(
    x = 'Body site', y = '# signatures'
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
  



```




```{r create plots, warning=FALSE}
plots <- vector('list', length(enrichment_res))
for (i in seq_along(plots)) {
  b <- sub('^(.*)__.*$', '\\1', names(enrichment_res)[i])
  r <- sub('^.*__(.*)$', '\\1', names(enrichment_res)[i])
  names(plots)[i] <- names(enrichment_res)[i]
  plots[[i]] <- plotEnrichmentRes(enrichment_res[[i]], b, r)
}
```

# A single case (step by step)

Get bsdb signatures

```{r get bsdb signatures}
bsdb_sets_ <- bsdb |> 
    filter(`Body site` == 'feces', `Host species` == 'Homo sapiens') |> 
    bugsigdbr::getSignatures(
      tax.id.type = 'ncbi', tax.level = 'genus', min.size = 5
    ) 
length(bsdb_sets_)
```

```{r}
lapply(bsdb_sets_[1:3], head)
```

Create background sets

```{r get typical set}
typical_set_ <- tms |> 
    filter(body_site == 'stool', rank == 'genus') |> 
    pull(taxid) |> 
    unique()
length(typical_set_) 
```

```{r}
head(typical_set_)
```

```{r get background sets}
background_sets_ <- lapply(bsdb_sets_, function(x) unique(c(x, typical_set_)))
length(background_sets_)
```

Create contingency tables

```{r example contingency tables}
taxa_name_ <- 'bsdb:237/1/1_chronic-hepatitis-C-virus-infection:cirrhosis-patients_vs_healthy-controls_UP'
ct <- bugphyzzAnalyses:::.contingencyTable(
    set = bsdb_sets_[[taxa_name_]],
    reference = background_sets_[[taxa_name_]],
    sig = bp_sigs_gn$`aerophilicity:aerobic`
)
ct
```


Enrichment

```{r}
p_value_ <- stats::fisher.test(ct, alternative = 'g')$p.value
p_value_
```

# Session information

```{r session info}
sessioninfo::session_info()
```
