---
title: "High-througput MSEA of BugSigDB and bugphyzz sets"
output:
  html_document:
    toc: true
    code_folding: hide
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r load packages, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(purrr)
library(tidyr)
library(dplyr)
library(bugsigdbr)
library(taxPPro)
library(ggplot2)
library(ggbreak)
library(BiocParallel)
library(forcats)
## add a comment
```

# Some considerations

+ Use only signatures with differential abundance results in BugSigDB
('Abundance in group 1' columns).
+ Some terms in BugSigDB referring to body site were merged.
+ Some terms in BugSigDB referring to disease/condition were merged.
+ We'll use [TypicalMicrobiomeSignatures](https://zenodo.org/record/7622129) 
to create background sets.
+ For this analysis, only ORA (Fishers' exact test) was used.
+ Maybe use Fisher's exact test here.

# Data (bug sets)

## TMS sets

Use [TypicalMicrobiomeSignatures](https://zenodo.org/record/7622129) to create
background sets. Use a cutoff of 0.01 prevalence for filtering:

```{r import tms, message=FALSE}
tms <- importTidyTMS(prevalence_threshold = 0.01) |> 
  mutate(
    body_site = case_when(
      body_site == 'feces' ~ 'stool',
      body_site == 'nasalcavity' ~ 'nose',
      body_site == 'oralcavity' ~ 'mouth',
      TRUE ~ body_site
    )
  )
```

Create sets at the genus and species ranks for each of the body sites
(skin, vagina, oralcavity, nasalcavity, stool):

```{r tms sets}
body_sites <- c(
  mouth = 'mouth', vagina = 'vagina',  stool = 'feces', 
  nose = 'nose', skin = 'skin of body'
)
ranks <- c('genus', 'species')
l <- length(body_sites) * length(ranks)
tms_sets <- vector('list', l)
n <- 1
for (i in seq_along(body_sites)) {
  for (j in seq_along(ranks)) {
    names(tms_sets)[n] <- paste0(names(body_sites)[i], '__', ranks[j])
    tms_sets[[n]] <- tms |> 
      filter(body_site == names(body_sites)[i], rank == ranks[j]) |> 
      pull(taxid) |> 
      unique()
    n <- n + 1
  }
}
names(tms_sets)
```

## BugSigDB sets

Only use signatures with 'decreased' or 'increased' values in the
'Abundance in Group 1' column, i.e., signatures from experiments with
differential abundance results.

Five body sites: skin, vagina, oral cavity, stool, and nasal cavity.

```{r bsdb sets}
body_sites <- c(
  mouth = 'mouth', vagina = 'vagina',  stool = 'feces', 
  nose = 'nose', skin = 'skin of body'
)
bsdb <- importBugSigDB(version = 'devel') |> 
  filter(`Abundance in Group 1` %in% c('increased', 'decreased')) |> 
  filter(`Host species` == 'Homo sapiens')
ub <- getOntology('uberon')  
bsdb_sets <- vector('list', l)
n <- 1
for (i in seq_along(body_sites)) {
  for (j in seq_along(ranks)) {
    sub_bsdb <- subsetByOntology(
      df = bsdb, column = 'Body site', term = body_sites[i], ontology = ub
    )
  names(bsdb_sets)[n] <- paste0(names(body_sites)[i], '__', ranks[j])
  sig <- bugsigdbr::getSignatures(
      df = sub_bsdb, tax.id.type = 'ncbi', tax.level = ranks[j], min.size = 5
  )
  if (length(sig) > 0) {
    bsdb_sets[[n]] <- sig
  }
  n <- n + 1
  }
}
bsdb_sets <- discard(bsdb_sets, is.null)
names(bsdb_sets)
```

## Background sets

```{r}
tms_sets <- tms_sets[names(bsdb_sets)]
background_sets <- vector('list', length(bsdb_sets))
for (i in seq_along(background_sets)) {
  names(background_sets)[i] <- names(bsdb_sets)[i]
  background_sets[[i]] <- map(
    bsdb_sets[[names(bsdb_sets)[i]]], ~ {
      unique(c(.x, tms_sets[[ names(bsdb_sets)[i] ]]))
      }
    )
}
names(background_sets)
```

## bugphyzz sets

Import data:

```{r import bp, messsage = FALSE, warning = FALSE}
bp <- as_tibble(importBugphyzz(version = 'devel'))
```

Create signatures at the genus level:

```{r bugphyzz gn sigs, message=FALSE, warning=FALSE}
bp_sigs_gn <- getBugphyzzSignatures(
  df = bp, tax.id.type = 'NCBI_ID', tax.level = 'genus', min.size = 10
)
head(names(bp_sigs_gn))
```

Create signatures at the species level:

```{r bugphyzz sp sigs}
bp_sigs_sp <- getBugphyzzSignatures(
  df = bp, tax.id.type = 'NCBI_ID', tax.level = 'species', min.size = 10
)
head(names(bp_sigs_sp))
```

# Enrichment analysis

#> top signatures by odds ratio

```{r run enrichment, message=FALSE}
nworkers <- parallel::detectCores()
enrichment_res <- bplapply(
    X = seq_along(bsdb_sets), 
    BPPARAM = MulticoreParam(workers = nworkers), 
    FUN = function(i) {
        if (grepl('genus', names(bsdb_sets)[i])) {
            res <- runEnrichment(
                bsdb_sets = bsdb_sets[[i]],
                background_sets = background_sets[[i]],
                bp_sigs = bp_sigs_gn,
                bsdb = bsdb, 
                fdr_ths = 0.1
            ) |> 
                mutate(comb = names(bsdb_sets)[[i]])
        } else if (grepl('species', names(bsdb_sets)[i])) {
            res <- runEnrichment(
                bsdb_sets = bsdb_sets[[i]],
                background_sets = background_sets[[i]],
                bp_sigs = bp_sigs_sp,
                bsdb = bsdb, 
                fdr_ths = 0.1
            ) |> 
                mutate(comb = names(bsdb_sets)[[i]])
        }
    return(res)
}) |> 
    discard(~ !nrow(.x))
enrichDF <- bind_rows(enrichment_res) |> 
    separate(col = 'comb', into = c('body_site', 'rank'), sep = '__') |> 
    mutate(Attribute_group = sub('^bp:(.*)\\|.*\\|\\w$', '\\1', bp_sig))
count(enrichDF, body_site, rank)
```

## Plot frequency of signatures

```{r}
summary1 <- enrichDF |> 
    count(Attribute_group, rank) |> 
    group_by(Attribute_group) |> 
    mutate(total_n = sum(n)) |> 
    ungroup() |> 
    arrange(total_n) |> 
    mutate(Attribute_group = fct_inorder(Attribute_group)) 
plot1 <- summary1 |> 
    ggplot(aes(Attribute_group, n)) +
    geom_col(aes(fill = rank)) +
    scale_fill_discrete(name = 'Rank') +
    labs(
        x = 'Attribute group', y = 'Frequency'
    ) +
    theme_bw() +
    coord_flip()
plot1
```

```{r}
attr_grp_nms <- unique(summary1$Attribute_group)
```


```{r}

```














```{r, eval=FALSE}
bp1 <- df |> 
  select(body_site, rank, bugsigdb_sig) |> 
  unique() |> 
  count(body_site, rank, name = 'bugsigdb')

bp2 <- df |> 
  select(body_site, rank, bp_sig) |> 
  count(body_site, rank, name = 'bp')

myPlot <- left_join(bp1, bp2, by = c('body_site', 'rank')) |> 
  pivot_longer(
    names_to = 'type_sig', values_to = 'n', cols = c(bugsigdb, bp)
  ) |> 
  ggplot(aes(body_site, n)) +
  geom_col(aes(fill = type_sig), position = 'dodge') +
  scale_fill_discrete(name = 'sig. source') +
  scale_y_cut(breaks = c(10)) +
  facet_wrap(~rank, ncol = 2) +
  labs(
    x = 'Body site', y = '# signatures'
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```



```{r create plots, warning=FALSE, eval=FALSE}
plots <- vector('list', length(enrichment_res))
for (i in seq_along(plots)) {
  b <- sub('^(.*)__.*$', '\\1', names(enrichment_res)[i])
  r <- sub('^.*__(.*)$', '\\1', names(enrichment_res)[i])
  names(plots)[i] <- names(enrichment_res)[i]
  plots[[i]] <- plotEnrichmentRes(enrichment_res[[i]], b, r)
}
```

# Session information

```{r session info}
sessioninfo::session_info()
```
