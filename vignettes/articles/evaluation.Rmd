---
title: "Evaluation of predicted annotations (aerophilicity)"
output:
    html_document:
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(dplyr)
library(tidyr)
library(purrr)
library(pROC)
library(ggplot2)
```

# Definition of TP, TN, FP, FN

```{r}
## Threshold: 0.5
data <- tribble(
    ~ NCBI_ID, ~ Attribute, ~ test_score, ~ predicted_score, ~ test_value, ~ predicted_value, ~ label,
    '1', 'Aerobic', 0.5, 0.5, 1, 1, "TP",
    '1', 'Anaerobic', 0.5, 0, 1, 0, "FN",
    '1', 'Facultatibe anaerobic', 0, 0, 0, 0, "TN",
    '1', 'Aerotolerant', 0, 0.5, 0, 1, 'FP'
)
data
```

Import test set

```{r, message=FALSE}
link <- 'https://github.com/sdgamboa/taxPPro/raw/asr2-rep1/vignettes/articles/test_set.csv.bz2'
fname <- tempfile()
download.file(url = link, destfile = fname)
test <- read.csv(fname)
# test$NCBI_ID <- sub('^.__', '', test$NCBI_ID)
# test_aer <- filter(test, Attribute_group == 'aerophilicity')
test_aer <- test
```

Import predicted set

```{r, message=FALSE}
link <- 'https://github.com/sdgamboa/taxPPro/raw/asr2-rep1/vignettes/articles/full_dump.csv.bz2'
fname <- tempfile()
download.file(url = link, destfile = fname)
bp <- read.csv(fname)
# predicted_aer <- filter(bp, Attribute_group == 'aerophilicity')
predicted_aer <- bp
```

Percentage of NCBI_IDs in the test set that were predicted

```{r}
paste0(mean(unique(test_aer$NCBI_ID) %in% unique(predicted_aer$NCBI_ID)) * 100, "%")
```

Combine test and predicted set

```{r}
## get test set
test_set <- test_aer |> 
    select(NCBI_ID, Attribute, Score) |> 
    arrange(NCBI_ID) |> 
    unique() |> 
    pivot_wider(
        names_from = 'Attribute', values_from = 'Score',
        values_fill = 0
    ) |> 
    mutate(aerotolerant = 0) |>
    pivot_longer(
        cols = 2:last_col(), names_to = 'Attribute', values_to = 'Score'
    ) |> 
    rename(t_score = Score)

## get predicted set
predicted_set <- predicted_aer |> 
    select(NCBI_ID, Attribute, Score) |> 
    arrange(NCBI_ID) |> 
    unique() |> 
    rename(p_score = Score) |> 
    mutate(NCBI_ID = as.character(NCBI_ID)) |> 
    mutate(Attribute = sub('^.*:', '', Attribute)) |> 
    mutate(Attribute = sub('_', ' ', Attribute))

result <- left_join(test_set, predicted_set, by = c('NCBI_ID', 'Attribute')) |> 
    mutate(p_score = ifelse(is.na(p_score), 0, p_score))
```

# Thresholds

```{r}
tr <- seq(0, 1, 0.1)
output <- vector('list', length(tr))
names(output) <- as.character(tr)
for (i in seq_along(output)) {
  t_val <- ifelse(result$t_score > 0, 1, 0)
  p_val <- ifelse(result$p_score >= tr[i], 1, 0)
  label <- case_when(
    t_val == 1 & p_val == 1 ~ 'TP',
    t_val == 1 & p_val == 0 ~ 'FN',
    t_val == 0 & p_val == 0 ~ 'TN',
    t_val == 0 & p_val == 1 ~ 'FP'
  )
  output[[i]] <- data.frame(
    t_val = t_val, p_val = p_val, label = label,
    t_score = result$t_score, p_score = result$p_score,
    th = as.character(tr)[i]
  )
}


pred_scores <- map(output, calcPredStats)
sensitivity <- map_dbl(pred_scores, ~ {
  pull(filter(.x, stat == 'sensitivity (recall)'), value)
})

FPR <- map_dbl(pred_scores, ~ {
  pull(filter(.x, stat == 'FPR'), value)
})

```

```{r}
df <- data.frame(FPR = FPR, Sensitivity = sensitivity, th = tr) |> 
  arrange(th)
df |> 
  ggplot(aes(x = FPR, y = Sensitivity)) +
  geom_point() +
  geom_line() +
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  geom_label(aes(label = th)) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_bw()
  
```



```{r}
par(pty = 's')
roc_obj <- roc(
  output[[1]]$t_val, output[[1]]$p_score
)
```



```{r, message=FALSE, warning=FALSE}
ggroc(list(roc_obj, roc_obj), legacy.axes = TRUE) +
  labs(x = 'FPR', y = 'TPR') +
  geom_abline(intercept = 0, slope = 1, linetype = 2) +
  scale_x_continuous(limits = c(0, 1), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0)) +
  scale_color_discrete(name = 'Ranks') + 
  theme_bw() 
```




