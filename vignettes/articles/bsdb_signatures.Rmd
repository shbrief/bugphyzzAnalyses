---
title: "High-throughput ORA with BSDB signatures"
output:
    html_document:
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(bugsigdbr)
library(dplyr)
library(purrr)
library(tidyr)
library(ComplexHeatmap)
library(gridExtra)
library(ggplot2)

body_sites <- c(
    skin = "skin", vagina = "vagina", mouth = "mouth", feces = "feces"
)
ranks <- c(genus = "genus", species = "species")
directions <- c(increased = "increased", decreased = "decreased")
```

# Introduction

This document aims at running a high-throughput over-representation analysis
(ORA) to discover bugphyzz signatures enriched in BugSigDB sets and
meta-signatures.

A few backgrounds will be used for the enrichment analysis:
1. _TMS\_BSDB_. Union of all of the taxa in the TypicalMicrobiomeSignatures
(TMS) dataset and BugSigDB.
2. _TMS\_BSDB\_BS_. Union of all taxa in the TMS dataset and BugSigDB by
body site.
3. _BSDB_. Union of all taxa in BugSigDB.
4. _BSDB\_BS_. Union of all taxa in BugSigDB by body site.
5. _TMS\_1BSDB\_BS_. Union of all of the taxa in the TMS dataset by body site
plus a target BugSigDB signature.
6. _TMS\_BSDB\_intersect_. Intersection of all of the taxa in the TMS dataset
and BugSigDB.
7. _TMS\_BSDB\_BS\_intersect_. Intersection of all of the taxa in the TMS
dataset and BugSigDB by body site.

ORA will be performed using a one-sided Fisher's exact test and the odds
ratio and CI will be calculated as well.

# Data

Import TypicalMicrobiomeSignatures (TMS):

```{r, message=FALSE}
tms <- importTMS() |> 
    filter(`Age group` == "adult")
glimpse(tms, 50)
```

Import BugSigDB v1.2.1:

```{r, message=FALSE}
bsdb_doi <- "10.5281/zenodo.10627578" # v1.2.1
# bsdb_doi <-  "10.5281/zenodo.10407666" #v1.2.0
# bsdb_doi <-  "10.5281/zenodo.6468009" #v1.1.0
bsdb <- importBugSigDB(version = bsdb_doi)
bsdb <- bsdb |> 
    filter(`Host species` == "Homo sapiens") |> 
    filter(!is.na(`Abundance in Group 1`)) |> 
    filter(!is.na(`Body site`)) |> 
    filter(`Study design` == "case-control" ) |> 
    filter(
        !grepl("(child|infant)", `Group 1 name`, ignore.case = TRUE)
    )
dim(bsdb)
```

BugSigDB subsets by body site:

```{r, message=FALSE}
uberon <- getOntology(onto = "uberon")
bsdb_subsets_by_bodysite <- vector("list", length(body_sites))
names(bsdb_subsets_by_bodysite) <- body_sites
for (i in seq_along(bsdb_subsets_by_bodysite)) {
    if (body_sites[i] == "skin") {
        bsdb_subsets_by_bodysite[[i]] <- bsdb |> 
            filter(grepl(body_sites[i], `Body site`, ignore.case = TRUE))
    } else {
        bsdb_subsets_by_bodysite[[i]] <- subsetByOntology(
            bsdb, column = "Body site", term = body_sites[i], ontology = uberon 
        )
    }
}
```

Bugphyzz:

```{r, message=FALSE}
bp <- importBugphyzz()
names(bp)
```

# Signatures

Typical Microbiome Signatures:

```{r}
thrs <- elbows()
thrs[] <- 0.2 # Change to 25
tms_sigs <- vector("list", length(body_sites) * length(ranks))
counter <- 1
for (i in seq_along(body_sites)) {
    for (j in seq_along(ranks)) {
        tms_name <- paste0(body_sites[i], "_", ranks[j])
        names(tms_sigs)[counter] <- tms_name
        tms_sigs[[counter]] <- tms |> 
            filter(`Body site` == body_sites[i], Rank == ranks[j]) |> 
            filter(Prevalence >= thrs[tms_name]) |> 
            pull(`NCBI ID`) |> 
            unique()
        counter <- counter + 1
    }
}
tms_sigs_BS_gn <- tms_sigs[grep("genus", names(tms_sigs))]
tms_sigs_BS_sp <- tms_sigs[grep("species", names(tms_sigs))]
names(tms_sigs_BS_gn) <- sub("_genus", "", names(tms_sigs_BS_gn))
names(tms_sigs_BS_sp) <- sub("_species", "", names(tms_sigs_BS_sp))

print("Number of taxa")
list(
    tms_sigs_BS_gn = lengths(tms_sigs_BS_gn),
    tms_sigs_BS_sp = lengths(tms_sigs_BS_sp)
)
```

BugSigDB signatures:

```{r}
vec_len <- length(body_sites) * length(ranks) * length(directions)
bsdb_sigs <- vector("list", vec_len)
counter <- 1
for (i in seq_along(body_sites)) {
    for (j in seq_along(ranks)) {
        for (k in seq_along(directions)) {
            dat <- bsdb_subsets_by_bodysite[[i]] |> 
                filter(`Abundance in Group 1` == directions[k])
            sigs <- getSignatures(
                df = dat,
                tax.id.type = "ncbi", tax.level = ranks[j],
                exact.tax.level = FALSE, min.size = 5
            ) |>  
                discard(~ length(.x) < 5)
            if (!length(sigs)) {
                counter <- counter + 1
                next
            }
            bsdb_id <- sub(
                pattern = "^(bsdb:[0-9]+/[0-9]+/[0-9]+)_.*$",
                replacement = "\\1",
                x = names(sigs)
            )
            pos <- map_int(bsdb_id, ~ which(dat$`BSDB ID` == .x))
            new_sigs_names <- paste0(
                body_sites[i], "-%-%-", ranks[j], "-%-%-", directions[k],
                "-%-%-", tolower(dat$Condition[pos]), "-%-%-",
                names(sigs)
            )
            names(sigs) <- new_sigs_names
            bsdb_sigs[[counter]] <- sigs
            counter <- counter + 1
        }
    }
}
bsdb_sigs <- list_flatten(bsdb_sigs)
bsdb_sigs <- discard(bsdb_sigs, is.null)

bsdb_sigs_gn <- bsdb_sigs[grep("-%-%-genus-%-%-", names(bsdb_sigs))]
bsdb_sigs_sp <- bsdb_sigs[grep("-%-%-species-%-%-", names(bsdb_sigs))]

bsdb_sigs_BS_gn <- map(body_sites, ~ {
    re <- paste0("^", .x, "-%-%-")
    bsdb_sigs_gn[grep(re, names(bsdb_sigs_gn))]
})

bsdb_sigs_BS_sp <- map(body_sites, ~ {
    re <- paste0("^", .x, "-%-%-")
    bsdb_sigs_sp[grep(re, names(bsdb_sigs_sp))]
})

print("Number of signatures")
list(
    bsdb_sigs = length(bsdb_sigs),
    bsdb_sigs_gn = length(bsdb_sigs_gn), 
    bsdb_sigs_sp =length(bsdb_sigs_sp),
    bsdb_sigs_BS_gn = lengths(bsdb_sigs_BS_gn),
    bsdb_sigs_BS_sp = lengths(bsdb_sigs_BS_sp)
)
```
bugphyzz signatures:

```{r, warning=FALSE}
bp_sigs_gn <- map(bp, ~ {
    makeSignatures(
        dat = .x, tax_id_type = "NCBI_ID", tax_level = "genus", min_size = 5,
        evidence = c("exp", "igc", "nas", "tas", "tax", "asr")
    )
}) |> 
    discard(is.null) |> 
    list_flatten(name_spec = "{inner}") |> 
    map(as.character)
names(bp_sigs_gn) <- paste0(names(bp_sigs_gn), "|genus")
    
bp_sigs_sp <- map(bp, ~ {
    makeSignatures(
        dat = .x, tax_id_type = "NCBI_ID", tax_level = "species", min_size = 5,
        evidence = c("exp", "igc", "nas", "tas", "tax", "asr")
    )
}) |> 
    discard(is.null) |> 
    list_flatten(name_spec = "{inner}") |> 
    map(as.character)
names(bp_sigs_sp) <- paste0(names(bp_sigs_sp), "|species")
bp_sigs <- c(bp_sigs_gn, bp_sigs_sp)
length(bp_sigs)
```

# Meta-signatures

Meta-signatures:

```{r}
metasigs_gn_up <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "UP", tax.level = "genus",
        min.studies = 1, exact.tax.level = FALSE
    )
}) |> 
    list_flatten(
        name_spec = "{outer}-%-%-genus-%-%-increased-%-%-{inner}"
    ) |> 
    map(~ names(.x))
metasigs_gn_down <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "DOWN",
        tax.level = "genus", exact.tax.level = FALSE, min.studies = 1
    )
}) |> 
    list_flatten(
        name_spec = "{outer}-%-%-genus-%-%-decreased-%-%-{inner}"
    ) |> 
    map(~ names(.x))

metasigs_sp_up <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "UP",
        tax.level = "species", exact.tax.level = FALSE, min.studies = 1
    ) 
}) |> 
    list_flatten(
        name_spec = "{outer}-%-%-species-%-%-increased-%-%-{inner}"
    ) |> 
    map(~ names(.x))

metasigs_sp_down <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "DOWN",
        tax.level = "species", exact.tax.level = FALSE, min.studies = 1
    ) 
}) |> 
    list_flatten(
        name_spec = "{outer}-%-%-species-%-%-decreased-%-%-{inner}"
    ) |> 
    map(~ names(.x))
metasigs_gn <- c(metasigs_gn_up, metasigs_gn_down)
metasigs_sp <- c(metasigs_sp_up, metasigs_sp_down)
```

# Meta-sigantures without intersection

```{r, message=FALSE}
removeRepeatedTaxa <- function(up, down) {
    x <- map(down, ~ tibble(down = paste0(.x, collapse = ";"))) |> 
        bind_rows(.id = "name") |> 
        separate(
            col = "name",
            into = c("body_site", "rank", "direction", "condition"),
            sep = "-%-%-"
        ) |> 
        select(-direction) |> 
        mutate(down = strsplit(down, ";"))
    
    y <- map(up, ~ tibble(up = paste0(.x, collapse = ";"))) |> 
        bind_rows(.id = "name") |> 
        separate(
            col = "name",
            into = c("body_site", "rank", "direction", "condition"),
            sep = "-%-%-"
        ) |> 
        select(-direction) |> 
        mutate(up = strsplit(up, ";"))
    
    z <- full_join(x, y)
    
    a <- z |> 
        rowwise() |> 
        mutate(intersect = list(intersect(up, down))) |> 
        mutate(up_unique = list(setdiff(up, intersect))) |> 
        mutate(down_unique = list(setdiff(down, intersect))) |> 
        ungroup() |> 
        select(-down, -up, -intersect)
    
    b <- a |> 
        rowwise() |> 
        filter(length(up_unique) > 0) |> 
        mutate(name = paste0(
            body_site, "-%-%-", rank, "-%-%-increased-%-%-", condition
        )) |> 
        ungroup() |> 
        select(name, up_unique)
    
    c <- a |> 
        rowwise() |> 
        filter(length(down_unique) > 0) |> 
        mutate(name = paste0(
            body_site, "-%-%-", rank, "-%-%-decreased-%-%-", condition
        )) |> 
        ungroup() |> 
        select(name, down_unique)
    
    output1 <- vector("list", nrow(b))
    for (i in seq_along(output1)) {
        output1[[i]] <- b |> 
            slice(i) |> 
            pull(up_unique) |> 
            unlist()
        names(output1)[[i]] <- b |> 
            slice(i) |> 
            pull(name)
    }
    
    output2 <- vector("list", nrow(c))
    for (i in seq_along(output2)) {
        output2[[i]] <- c |> 
            slice(i) |> 
            pull(down_unique) |> 
            unlist()
        names(output2)[[i]] <- c |> 
            slice(i) |> 
            pull(name)
    }
    
    list(up = output1, down = output2)
}

umetasigs_gn_list <- removeRepeatedTaxa(metasigs_gn_up, metasigs_gn_down)
umetasigs_gn <- umetasigs_gn_list |> 
    list_flatten(name_spec = "{inner}")
umetasigs_gn_up <- umetasigs_gn_list$up
umetasigs_gn_down <- umetasigs_gn_list$down

umetasigs_sp_list <- removeRepeatedTaxa(metasigs_sp_up, metasigs_sp_down)
umetasigs_sp <- umetasigs_sp_list |> 
    list_flatten(name_spec = "{inner}")
umetasigs_sp_up <- umetasigs_sp_list$up
umetasigs_sp_down <- umetasigs_sp_list$down
```

# ORA with BSDB signatures

Define a function to format the enrichment results for signatures:

```{r}
formatEnSigs <- function(l) {
    ## Name is short for: Format Enriched Signatures
    ## l is the output of microbeSetEnrichment
    l |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        )) |> 
        {\(y) set_names(y, sub("Set", "BSDB", colnames(y)))}()
}
```

## Background: TMS_BSDB

Background: Union of all taxa in BSDB and TMS by rank

```{r}
bk_TMS_BSDB_gn <- unique(c(
    unlist(tms_sigs_BS_gn),
    unlist(bsdb_sigs_BS_gn)
))
bk_TMS_BSDB_sp <- unique(c(
    unlist(tms_sigs_BS_sp),
    unlist(bsdb_sigs_BS_sp)
))
```

Enrichment at the genus level:

```{r}
## TODO investigate warnings
system.time({
    en_TMS_BSDB_gn <- map(
        .x = bsdb_sigs_gn,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_gn, bp_sigs_gn)
    ) |> 
        formatEnSigs()
})
```

Enrichment at the species level:

```{r}
system.time({
    en_TMS_BSDB_sp <- map(
        .x = bsdb_sigs_sp,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_sp, bp_sigs_sp)
        ) |> 
        formatEnSigs()
})
```

Combine results:

```{r}
en_TMS_BSDB <- bind_rows(en_TMS_BSDB_gn, en_TMS_BSDB_sp)
```

## Background: TMS_BSDB_BS

Backgrounds:

```{r}
bk_TMS_BSDB_BS_gn <- map(body_sites, ~ {
    tms_taxa <- tms_sigs_BS_gn[[.x]]
    bsdb_taxa <- unlist(bsdb_sigs_BS_gn[[.x]])
    unique(c(tms_taxa, bsdb_taxa))
})

bk_TMS_BSDB_BS_sp <- map(body_sites, ~ {
    tms_taxa <- tms_sigs_BS_sp[[.x]]
    bsdb_taxa <- unlist(bsdb_sigs_BS_sp[[.x]])
    unique(c(tms_taxa, bsdb_taxa))
})
```

Enrichment at the genus level:

```{r}
system.time({
    en_TMS_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_gn[[body_sites[i]]]
        sigL <- bsdb_sigs_BS_gn[[body_sites[i]]]
        res <- map(sigL, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnSigs()
        en_TMS_BSDB_BS_gn[[i]] <- res
    }
    en_TMS_BSDB_BS_gn <- bind_rows(en_TMS_BSDB_BS_gn)
})
```

Enrichment at the species level:

```{r}
system.time({
    en_TMS_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_sp[[body_sites[i]]]
        sigList <- bsdb_sigs_BS_sp[[body_sites[i]]]
        res <- map(sigList, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnSigs()
        en_TMS_BSDB_BS_sp[[i]] <- res
    }
    en_TMS_BSDB_BS_sp <- bind_rows(en_TMS_BSDB_BS_sp)
})
```

Combine results:

```{r}
en_TMS_BSDB_BS <- bind_rows(en_TMS_BSDB_BS_gn, en_TMS_BSDB_BS_sp)
```

## Background: BSDB

BSDB: Union of all BSDB signatures by rank

```{r}
bk_BSDB_gn <- unique(unlist(bsdb_sigs_gn))
bk_BSDB_sp <- unique(unlist(bsdb_sigs_sp))
```

ORA at the genus level:

```{r}
system.time({
    en_BSDB_gn <- map(
        .x = bsdb_sigs_gn,
        .f = ~ microbeSetEnrichment(.x, bk_BSDB_gn, bp_sigs_gn)
    ) |> 
        formatEnSigs()
})
```

ORA at the species level:

```{r}
system.time({
    en_BSDB_sp <- map(
        .x = bsdb_sigs_sp,
        .f = ~ microbeSetEnrichment(.x, bk_BSDB_sp, bp_sigs_sp)
    ) |> 
        formatEnSigs()
})
```

Combine results:

```{r}
en_BSDB <- bind_rows(en_BSDB_gn, en_BSDB_sp)
```

## Background: BSDB_BS

Union of all BSDB signatures by body site by rank.

Create backgrounds:

```{r}
bk_BSDB_BS_gn <- map(bsdb_sigs_BS_gn, ~ unique(unlist(.x))) |> 
    discard(is.null)

bk_BSDB_BS_sp <- map(bsdb_sigs_BS_sp, ~ unique(unlist(.x))) |> 
    discard(is.null)
```

Enrichment at the genus level:

```{r}
system.time({
    en_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_gn[[body_sites[i]]]
        sigL <- bsdb_sigs_BS_gn[[body_sites[i]]]
        res <- map(sigL, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnSigs()
        en_BSDB_BS_gn[[i]] <- res
    }
    en_BSDB_BS_gn <- bind_rows(en_BSDB_BS_gn)
})
```

Enrichment at the species level:

```{r}
system.time({
    en_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_sp[[body_sites[i]]]
        re <- paste0("^", body_sites[i], "-%-%-")
        sigL <- bsdb_sigs_sp[grep(re, names(bsdb_sigs_sp))]
        res <- map(sigL, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnSigs()
        en_BSDB_BS_sp[[i]] <- res
    }
    en_BSDB_BS_sp <- bind_rows(en_BSDB_BS_sp)
})
```

Combine results

```{r}
en_BSDB_BS <- bind_rows(en_BSDB_BS_gn, en_BSDB_BS_sp)
```

## Background: TMS_1BSDB_BS

Background(s):

```{r}
bk_TMS_1BSDB_BS <- vector("list", length(bsdb_sigs)) 
for (i in seq_along(bk_TMS_1BSDB_BS)) {
    sig_name <- names(bsdb_sigs)[i]
    names(bk_TMS_1BSDB_BS)[i] <- sig_name
    bodysite_name <- sub(
        "^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\1", sig_name
    )
    rank_name <- sub(
        "^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\2", sig_name
    )
    tms_sig_name <- paste0(bodysite_name, "_", rank_name)
    bk_TMS_1BSDB_BS[[i]] <- unique(
        c(as.character(bsdb_sigs[[i]]), as.character(tms_sigs[[tms_sig_name]]))
    )
}
```

Enrichment at the genus level:

```{r}
system.time({
    bk_TMS_1BSDB_BS_gn <- bk_TMS_1BSDB_BS[names(bsdb_sigs_gn)]
    en_TMS_1BSDB_BS_gn <- map2(bsdb_sigs_gn, bk_TMS_1BSDB_BS_gn, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_gn)
    }) |> 
        formatEnSigs()
})
```

Enrichment at the species level:

```{r}
system.time({
    bk_TMS_1BSDB_BS_sp <- bk_TMS_1BSDB_BS[names(bsdb_sigs_sp)]
    en_TMS_1BSDB_BS_sp <- map2(bsdb_sigs_sp, bk_TMS_1BSDB_BS_sp, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_sp)
    }) |> 
        formatEnSigs()
})
```

```{r}
en_TMS_1BSDB_BS <- bind_rows(en_TMS_1BSDB_BS_gn, en_TMS_1BSDB_BS_sp)
```

## Background: TMS_BSDB_intersect

Intersection at the genus level:

```{r}
tms_gn_x = unique(unlist(tms_sigs_BS_gn))
bsdb_gn_y = unique(unlist(bsdb_sigs_BS_gn))
bk_TMS_BSDB_intersect_gn <- intersect(tms_gn_x, bsdb_gn_y)
data.frame(
    tms_genus_only = length(setdiff(tms_gn_x, bk_TMS_BSDB_intersect_gn)),
    bsdb_genus_only = length(setdiff(bsdb_gn_y, bk_TMS_BSDB_intersect_gn)),
    tms_bsdb_genus_intersect = length(bk_TMS_BSDB_intersect_gn)
) |> 
    knitr::kable()
```

Intersection at the species level:

```{r}
tms_sp_x = unique(unlist(tms_sigs_BS_sp))
bsdb_sp_y = unique(unlist(bsdb_sigs_BS_sp))
bk_TMS_BSDB_intersect_sp <- intersect(tms_sp_x, bsdb_sp_y)
data.frame(
    tms_species_only = length(setdiff(tms_sp_x, bk_TMS_BSDB_intersect_sp)),
    bsdb_species_only = length(setdiff(bsdb_sp_y, bk_TMS_BSDB_intersect_sp)),
    tms_bsdb_species_intersect = length(bk_TMS_BSDB_intersect_sp)
) |> 
    knitr::kable()
```

Enrichment at the genus level:

```{r}
system.time({
    en_TMS_BSDB_intersect_gn <- map(
        bsdb_sigs_gn,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_gn, bp_sigs_gn)
        ) |> 
        formatEnSigs()
})
```

Enrichment at the species level:

```{r}
system.time({
    en_TMS_BSDB_intersect_sp <- map(
        bsdb_sigs_sp,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_sp, bp_sigs_sp)
        ) |> 
        formatEnSigs()
})
```

Combine results

```{r}
en_TMS_BSDB_intersect <- bind_rows(
    en_TMS_BSDB_intersect_gn, en_TMS_BSDB_intersect_sp
)
```

## Background: TMS_BSDB_BS_intersect

Intersection by body site at the genus level:

```{r}
l1 <- map(body_sites, ~ {
    x <- unique(unlist(bsdb_sigs_BS_gn[[.x]]))
    y <- tms_sigs_BS_gn[[.x]]
    xy <- intersect(x, y)
    x_ <- setdiff(x, xy)
    y_ <- setdiff(y, xy)
    list(
        bsdb_only = x_,
        tms_only = y_,
        both = xy
    )
}) 
bk_TMS_BSDB_BS_intersect_gn <- map(l1, ~ .x$both)
l1 |> 
    map(~ as.data.frame(matrix(map_int(.x, length), nrow = 1))) |> 
    bind_rows(.id = "body_site") |> 
    set_names(c("body_site", "bsdb_genus_only", "tms_genus_only", "genus_both"))
```

Intersection by body site at the species level:

```{r}
l2 <- map(body_sites, ~ {
    x <- unique(unlist(bsdb_sigs_BS_sp[[.x]]))
    y <- tms_sigs_BS_sp[[.x]]
    xy <- intersect(x, y)
    x_ <- setdiff(x, xy)
    y_ <- setdiff(y, xy)
    list(
        bsdb_only = x_,
        tms_only = y_,
        both = xy
    )
})
bk_TMS_BSDB_BS_intersect_sp <- map(l2, ~ .x$both)
l2 |> 
    map(~ as.data.frame(matrix(map_int(.x, length), nrow = 1))) |> 
    bind_rows(.id = "body_site") |> 
    set_names(
        c("body_site", "bsdb_species_only", "tms_species_only", "species_both")
    )
```

Enrichment at the genus level:

```{r}
system.time({
    en_TMS_BSDB_BS_intersect_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_intersect_gn[[body_sites[i]]]
        sigL <- bsdb_sigs_BS_gn[[body_sites[i]]]
        res <- map(sigL, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnSigs()
        en_TMS_BSDB_BS_intersect_gn[[i]] <- res
    }
    en_TMS_BSDB_BS_intersect_gn <- bind_rows(en_TMS_BSDB_BS_intersect_gn)
})
```

Enrichment at the species level:

```{r}
system.time({
    en_TMS_BSDB_BS_intersect_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_intersect_sp[[body_sites[i]]]
        sigL <- bsdb_sigs_BS_sp[[body_sites[i]]]
        res <- map(sigL, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnSigs()
        en_TMS_BSDB_BS_intersect_sp[[i]] <- res
    }
    en_TMS_BSDB_BS_intersect_sp <- bind_rows(en_TMS_BSDB_BS_intersect_sp)
})
```

```{r}
en_TMS_BSDB_BS_intersect <- bind_rows(
    en_TMS_BSDB_BS_intersect_gn, en_TMS_BSDB_BS_intersect_sp
)
```

## Combine ORA results

Store all results in a single list:

```{r}
results <- list(
    TMS_BSDB = en_TMS_BSDB,
    TMS_BSDB_BS = en_TMS_BSDB_BS,
    BSDB = en_BSDB,
    BSDB_BS = en_BSDB_BS,
    TMS_1BSDB_BS = en_TMS_1BSDB_BS,
    TMS_BSDB_intersect = en_TMS_BSDB_intersect,
    TMS_BSDB_BS_intersect = en_TMS_BSDB_BS_intersect
) |> 
    map(~ mutate(.x, fdr = p.adjust(p_value))) |> 
    map(~ mutate(.x, combination = paste0(
        body_site, "-#-#-", direction, "-#-#-", rank, "-#-#-",
        condition, "-#-#-", sig_name, "-#-#-", bsdb_sig)
    ))
```

Adjust FDR and filter:

```{r}
filtered_results <- map(results, ~ filter(.x, fdr < 0.1))
map(filtered_results, dim)
```

## Visualization

Define functions:

```{r}
createMat <- function(dat, fdr_th = 0.1, dir) {
   dat <- dat |> 
       dplyr::filter(
           .data$fdr < fdr_th, .data$direction == dir 
       )
   output <- dat |> 
       count(
           body_site, direction, condition, sig_name
       ) |> 
       {\(y) split(y, y$direction)}() |> 
       map(~ split(.x, .x$body_site)) |> 
       list_flatten() |>
       discard(~ !nrow(.x)) |>
       bind_rows() |> 
       mutate(sig_name = factor(sig_name), condition = factor(condition)) |> 
       {\(y) split(y, y$body_site)}() |> 
       map(~ {
           mat <- .x |> 
               select(-body_site, -direction) |> 
               complete(sig_name, condition, fill = list(n = 0)) |> 
               pivot_wider(
                   names_from = "condition", values_from = "n", values_fill = 0
               ) |>
               tibble::column_to_rownames(var = "sig_name") |>
               as.matrix()
           select_cols <- which(as.logical(colSums(mat)))
           mat[, select_cols, drop = FALSE]
           
       })
   output
}

createHt <- function(x, max_count) {
    color_fun <- circlize::colorRamp2(
        breaks = c(0, max_count), 
        colors = c("white", "brown")
    )
    lht <- vector("list", length(x))
    for (i in seq_along(x)) {
        xmat <- x[[i]]
        xmat <- xmat[sort(rownames(xmat)),, drop = FALSE]
        xmat <- xmat[,sort(colnames(xmat)), drop = FALSE]
        if (i == length(lht)) {
            lht[[i]] <- Heatmap(
                matrix = xmat,
                col = color_fun,
                show_column_dend = FALSE,
                show_row_dend = FALSE,
                name = "# sigs",
                border = TRUE,
                column_title = names(x)[i],
                row_names_side = "left", 
                column_title_rot = 45,
                column_names_rot = 45,
                row_order = rownames(xmat),
                # column_order = colnames(xmat),
                row_names_max_width = max_text_width(
                    rownames(xmat),
                    gp = gpar(fontsize = 12)
                ),
                rect_gp = gpar(col = "gray60", lwd = 1)
            )
        } else {
            lht[[i]] <- Heatmap(
                matrix = xmat,
                col = color_fun,
                show_column_dend = FALSE,
                show_row_dend = FALSE,
                border = TRUE,
                show_heatmap_legend = FALSE,
                column_title = names(x)[i],
                row_names_side = "left",
                column_title_rot = 45,
                column_names_rot = 45,
                row_order = rownames(xmat),
                # column_order = colnames(xmat),
                row_names_max_width = max_text_width(
                    rownames(xmat),
                    gp = gpar(fontsize = 12)
                ),
                rect_gp = gpar(col = "gray60", lwd = 1)
            )
        }
    }
    reduce(lht, `+`)
}

myFun <- function(x) {
    x |> 
        as.data.frame() |> 
        tibble::rownames_to_column("sig") |> 
        pivot_longer(
            names_to = "condition", values_to = "presence", cols = 2:last_col()
        ) |> 
        filter(presence > 0) |> 
        unite(col = "combination", sep = " |---| ", sig, condition)
}

combinationHt <- function(l, max_count) {
    color_fun <- circlize::colorRamp2(
        breaks = c(0, max_count), 
        colors = c("white", "brown")
    )
    xvar <- l |> 
        map(~ map(.x, function(x) myFun(x))) |> 
        map(~ distinct(bind_rows(.x, .id = "bs"))) |> 
        bind_rows(.id = "bk") |> 
        mutate(
            bs = factor(bs), combination = factor(combination),
            bk = factor(bk)
        ) |> 
        {\(y) split(y, y$bs)}() |> 
        map(~select(.x, -bs)) |> 
        map(~ {
            .x |> 
                complete(combination, bk, fill = list(presence = 0)) |> 
                pivot_wider(
                    names_from = "bk", values_from = "presence", values_fill = 0
                ) |>
                tibble::column_to_rownames(var = "combination") |>
                as.matrix()
        }) |> 
        map(~ {
            select_row <- which(rowSums(.x) > 0)
            .x[select_row, , drop = FALSE]
        }) |>
        imap(~{
            .x <- .x[sort(rownames(.x)), , drop = FALSE]
            order_of_columns <- c(
                "TMS_BSDB", "TMS_BSDB_BS", "BSDB", "BSDB_BS",
                "TMS_1BSDB_BS", "TMS_BSDB_intersect",
                "TMS_BSDB_BS_intersect"
            )
            Heatmap(
                matrix = .x,
                show_row_names = TRUE,
                show_row_dend = FALSE,
                show_column_dend = FALSE,
                row_dend_reorder = FALSE,
                column_dend_reorder = FALSE,
                row_title = .y,
                col = color_fun,
                name = "# sigs",
                row_order = rownames(.x),
                column_order = order_of_columns,
                row_names_max_width = max_text_width(
                    rownames(.x),
                    gp = gpar(fontsize = 12)
                ),
                rect_gp = gpar(col = "gray60", lwd = 1),
                border = TRUE
            )
        })
    reduce(xvar, ~ .x %v% .y)
}
```

Create matrices

```{r}
lmat_down = map(results, ~ createMat(.x, dir = "decreased"))
lmat_up = map(results, ~ createMat(.x, dir = "increased"))

## This variables are used in the functions defined above
maxCountSig <- max(unlist(c(lmat_down, lmat_up)))

## Create heatmaps, but don't display them unless it's required
# l_ht_down <- map(lmat_down, createHt)
# l_ht_up <- map(lmat_up, createHt)
```

```{r, fig.height=30, fig.width=10, warning=FALSE}
ht_comb_up <- combinationHt(lmat_up, maxCountSig)
draw(ht_comb_up, column_title = "Increased")
```

```{r, fig.height=30, fig.width=10, warning=FALSE}
ht_comb_down <- combinationHt(lmat_down, maxCountSig)
draw(ht_comb_down, column_title = "Decreased")
```

# ORA with BSDB meta-signatures

Define function for formatting enrichment results with meta-signatures: 

```{r}
formatEnMetSig <- function(l) {
    l |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c(
                "body_site", "rank", "direction", "condition"
            ), sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        )) |> 
        {\(y) set_names(y, sub("Set", "BSDB", colnames(y)))}()
}
```

## Background: BSDB

```{r}
system.time({
    en_meta_BSDB_gn <- map(
        metasigs_gn, ~ microbeSetEnrichment(.x, bk_BSDB_gn, bp_sigs_gn)
    ) |> 
        formatEnMetSig()
})
```

```{r}
system.time({
    en_meta_BSDB_sp <- map(
        metasigs_sp, ~ microbeSetEnrichment(.x, bk_BSDB_sp, bp_sigs_sp)
    ) |> 
        formatEnMetSig()
})
```

```{r}
en_meta_BSDB <- bind_rows(en_meta_BSDB_gn, en_meta_BSDB_sp) 
```

## Background: BSDB_BS

genus:

```{r}
system.time({
    en_meta_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sigL <- metasigs_gn[grep(rx, names(metasigs_gn))]
        res <- map(sigL, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnMetSig()
        en_meta_BSDB_BS_gn[[i]] <- res
    }
    en_meta_BSDB_BS_gn <- bind_rows(en_meta_BSDB_BS_gn)
})
```

species:

```{r}
system.time({
    en_meta_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_sp[grep(rx, names(metasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |>  
            formatEnMetSig()
        en_meta_BSDB_BS_sp[[i]] <- res
    }
    en_meta_BSDB_BS_sp <- bind_rows(en_meta_BSDB_BS_sp)
})
```


```{r}
en_meta_BSDB_BS <- bind_rows(en_meta_BSDB_BS_gn, en_meta_BSDB_BS_sp)
```

## Background: TMS_BSDB


```{r}
system.time({
    en_meta_TMS_BSDB_gn <- map(
        .x = metasigs_gn,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_gn, bp_sigs_gn)
    ) |> 
        formatEnMetSig()
})
```

Enrichment at the species level:

```{r}
system.time({
    en_meta_TMS_BSDB_sp <- map(
        .x = metasigs_sp,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_sp, bp_sigs_sp)
        ) |> 
        formatEnMetSig()
})
```

```{r}
en_meta_TMS_BSDB <- bind_rows(en_meta_TMS_BSDB_gn, en_meta_TMS_BSDB_sp)
```

## Background: TMS_BSDB_BS

```{r}
system.time({
    en_meta_TMS_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_gn[grep(rx, names(metasigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnMetSig()
        en_meta_TMS_BSDB_BS_gn[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_gn <- bind_rows(en_meta_TMS_BSDB_BS_gn)
})

```


```{r}
system.time({
    en_meta_TMS_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_sp[grep(rx, names(metasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnMetSig()
        en_meta_TMS_BSDB_BS_sp[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_sp <- bind_rows(en_meta_TMS_BSDB_BS_sp)
})
```

```{r}
en_meta_TMS_BSDB_BS <- bind_rows(
    en_meta_TMS_BSDB_BS_gn, en_meta_TMS_BSDB_BS_sp
    ) 
```

## Background: TMS_BSDB_intersect

```{r, echo=FALSE}
# meta_bsdb_gn_y = unique(unlist(metasigs_gn))
# bk_meta_TMS_BSDB_intersect_gn <- intersect(tms_gn_x, meta_bsdb_gn_y)
# 
# meta_bsdb_sp_y = unique(unlist(metasigs_sp))
# bk_meta_TMS_BSDB_intersect_sp <- intersect(tms_sp_x, meta_bsdb_sp_y)
```

genus:

```{r}
system.time({
    en_meta_TMS_BSDB_intersect_gn <- map(
        metasigs_gn,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_gn, bp_sigs_gn)
        ) |> 
        formatEnMetSig()
})
```

species:

```{r}
system.time({
    en_meta_TMS_BSDB_intersect_sp <- map(
        metasigs_sp,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_sp, bp_sigs_sp)
        ) |> 
        formatEnMetSig()
})
```

```{r}
en_meta_TMS_BSDB_intersect <- bind_rows(
    en_meta_TMS_BSDB_intersect_gn, en_meta_TMS_BSDB_intersect_sp
    )
```

## Bacgkround: TMS_BSDB_BS_intersect

```{r, echo=FALSE}
# metasigs_BS_gn <- vector("list", length(body_sites))
# for (i in seq_along(metasigs_BS_gn)) {
#    rx <- paste0("^", body_sites[i], "-%-%-", "genus")
#    sigsL <- metasigs_gn[grep(rx, names(metasigs_gn))]
#    names(sigsL) <- names(metasigs_gn)[grep(rx, names(metasigs_gn))]
#    if (is.null(sigsL)) {
#        next
#    }
#    metasigs_BS_gn[[i]] <- sigsL
#    names(metasigs_BS_gn)[i] <- body_sites[i]
# }
# metasigs_BS_gn <- discard(metasigs_BS_gn, is.null)
#         
# metasigs_BS_sp <- vector("list", length(body_sites))
# for (i in seq_along(metasigs_BS_sp)) {
#    rx <- paste0("^", body_sites[i], "-%-%-", "species")
#    sigsL <- metasigs_sp[grep(rx, names(metasigs_sp))]
#    names(sigsL) <- names(metasigs_sp)[grep(rx, names(metasigs_sp))]
#    if (is.null(sigsL)) {
#        next
#    }
#    metasigs_BS_sp[[i]] <- sigsL
#    names(metasigs_BS_sp)[i] <- body_sites[i]
# }
# metasigs_BS_sp <- discard(metasigs_BS_sp, is.null)
```

```{r, echo=FALSE}
# bk_meta_TMS_BSDB_BS_intersect_gn <- map(body_sites, ~ {
#     x <- unique(unlist(metasigs_BS_gn[[.x]]))
#     y <- tms_sigs_BS_gn[[.x]]
#     xy <- intersect(x, y)
#     x_ <- setdiff(x, xy)
#     y_ <- setdiff(y, xy)
#     list(
#         bsdb_only = x_,
#         tms_only = y_,
#         both = xy
#     )
# }) |> 
#     set_names(body_sites) |> 
#     map(~ .x$both)
# 
# bk_meta_TMS_BSDB_BS_intersect_sp <- map(body_sites, ~ {
#     x <- unique(unlist(metasigs_BS_sp[[.x]]))
#     y <- tms_sigs_BS_sp[[.x]]
#     xy <- intersect(x, y)
#     x_ <- setdiff(x, xy)
#     y_ <- setdiff(y, xy)
#     list(
#         bsdb_only = x_,
#         tms_only = y_,
#         both = xy
#     )
# }) |> 
#     set_names(body_sites) |> 
#     map(~ .x$both)
```

```{r}
system.time({
    en_meta_TMS_BSDB_BS_intersect_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_intersect_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_gn[grep(rx, names(metasigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnMetSig()
        en_meta_TMS_BSDB_BS_intersect_gn[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_intersect_gn <- bind_rows(
        en_meta_TMS_BSDB_BS_intersect_gn
    )
})
```

```{r}
system.time({
    en_meta_TMS_BSDB_BS_intersect_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_intersect_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_sp[grep(rx, names(metasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnMetSig()
        en_meta_TMS_BSDB_BS_intersect_sp[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_intersect_sp <- bind_rows(
        en_meta_TMS_BSDB_BS_intersect_sp
    )
})
```

```{r}
en_meta_TMS_BSDB_BS_intersect <- bind_rows(
    en_meta_TMS_BSDB_BS_intersect_gn, en_meta_TMS_BSDB_BS_intersect_sp
    ) 
```

## Background: TMS_1BSDB_BS

```{r}
metasigs <- c(metasigs_gn, metasigs_sp)
bk_meta_TMS_1BSDB_BS <- vector("list", length(metasigs)) 
for (i in seq_along(bk_meta_TMS_1BSDB_BS)) {
    sig_name <- names(metasigs)[i]
    names(bk_TMS_1BSDB_BS)[i] <- sig_name
    bodysite_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\1", sig_name)
    rank_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\2", sig_name)
    tms_sig_name <- paste0(bodysite_name, "_", rank_name)
    bk_TMS_1BSDB_BS[[i]] <- unique(
        c(as.character(bsdb_sigs[[i]]), as.character(tms_sigs[[tms_sig_name]]))
    )
}
```

Enrichment at the genus level:

```{r}
system.time({
    bk_TMS_1BSDB_BS_gn <- bk_TMS_1BSDB_BS[names(metasigs_gn)]
    en_meta_TMS_1BSDB_BS_gn <- map2(metasigs_gn, bk_TMS_1BSDB_BS_gn, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_gn)
    }) |> 
        formatEnMetSig()
})
```

Enrichment at the species level:

```{r}
system.time({
    bk_TMS_1BSDB_BS_sp <- bk_TMS_1BSDB_BS[names(metasigs_sp)]
    en_meta_TMS_1BSDB_BS_sp <- map2(metasigs_sp, bk_TMS_1BSDB_BS_sp, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_sp)
    }) |> 
        formatEnMetSig()
})
```

```{r}
en_meta_TMS_1BSDB_BS <- bind_rows(
    en_meta_TMS_1BSDB_BS_gn, en_meta_TMS_1BSDB_BS_sp
    )
```

## Combine ORA results

```{r}
meta_results <- list(
    BSDB = en_meta_BSDB,
    BSDB_BS = en_meta_BSDB_BS,
    TMS_BSDB = en_meta_TMS_BSDB,
    TMS_BSDB_BS = en_meta_TMS_BSDB_BS,
    TMS_BSDB_intersect = en_meta_TMS_BSDB_intersect,
    TMS_BSDB_BS_intersect = en_meta_TMS_BSDB_BS_intersect,
    TMS_1BSDB_BS = en_meta_TMS_1BSDB_BS 
) |> 
    map(~ mutate(.x, fdr = p.adjust(p_value))) |> 
    map(~ mutate(.x, combination = paste0(
        body_site, "-#-#-", direction, "-#-#-", rank, "-#-#-",
        condition, "-#-#-", sig_name)
    ))
```


Adjust p-value and filter by FDR:

```{r}
filtered_meta_results <- map(meta_results, ~ filter(.x, fdr < 0.1))
map(filtered_meta_results, dim)

```

## Visualization

```{r}
meta_lmat_down = map(filtered_meta_results, ~ createMat(.x, dir = "decreased"))
meta_lmat_up = map(filtered_meta_results, ~ createMat(.x, dir = "increased"))
maxCountMeta <- max(unlist(c(meta_lmat_down, meta_lmat_up)))
```

```{r, warning=FALSE, fig.height=30, fig.width=10}
meta_ht_comb_up <- combinationHt(meta_lmat_up, maxCountMeta)
draw(meta_ht_comb_up, column_title = "Increased")
```

```{r, warning=FALSE, fig.height=30, fig.width=10}
meta_ht_comb_down <- combinationHt(meta_lmat_down, maxCountMeta)
draw(meta_ht_comb_down, column_title = "decreased")
```

# ORA with BSDB unique meta-signatures

## Background: BSDB

```{r}
system.time({
    en_umeta_BSDB_gn <- map(
        umetasigs_gn, ~ microbeSetEnrichment(.x, bk_BSDB_gn, bp_sigs_gn)
    ) |> 
        formatEnMetSig()
})
```

```{r}
system.time({
    en_umeta_BSDB_sp <- map(
        umetasigs_sp, ~ microbeSetEnrichment(.x, bk_BSDB_sp, bp_sigs_sp)
    ) |> 
        formatEnMetSig()
})
```

```{r}
en_umeta_BSDB <- bind_rows(en_umeta_BSDB_gn, en_umeta_BSDB_sp)
```

## Background: BSDB_BS

genus:

```{r}
system.time({
    en_umeta_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- umetasigs_gn[grep(rx, names(umetasigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnMetSig()
        en_umeta_BSDB_BS_gn[[i]] <- res
    }
    en_umeta_BSDB_BS_gn <- bind_rows(en_umeta_BSDB_BS_gn)
})
```

species:

```{r}
system.time({
    en_umeta_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- umetasigs_sp[grep(rx, names(umetasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |>  
            formatEnMetSig()
        en_umeta_BSDB_BS_sp[[i]] <- res
    }
    en_umeta_BSDB_BS_sp <- bind_rows(en_umeta_BSDB_BS_sp)
})
```


```{r}
en_umeta_BSDB_BS <- bind_rows(en_umeta_BSDB_BS_gn, en_umeta_BSDB_BS_sp)
```

## Background: TMS_BSDB

```{r}
system.time({
    en_umeta_TMS_BSDB_gn <- map(
        .x = umetasigs_gn,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_gn, bp_sigs_gn)
    ) |> 
        formatEnMetSig()
})
```

Enrichment at the species level:

```{r}
system.time({
    en_umeta_TMS_BSDB_sp <- map(
        .x = umetasigs_sp,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_sp, bp_sigs_sp)
        ) |> 
        formatEnMetSig()
})
```

```{r}
en_umeta_TMS_BSDB <- bind_rows(en_umeta_TMS_BSDB_gn, en_umeta_TMS_BSDB_sp)
```

## Background: TMS_BSDB_BS

```{r}
system.time({
    en_umeta_TMS_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- umetasigs_gn[grep(rx, names(umetasigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnMetSig()
        en_umeta_TMS_BSDB_BS_gn[[i]] <- res
    }
    en_umeta_TMS_BSDB_BS_gn <- bind_rows(en_umeta_TMS_BSDB_BS_gn)
})

```


```{r}
system.time({
    en_umeta_TMS_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- umetasigs_sp[grep(rx, names(umetasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnMetSig()
        en_umeta_TMS_BSDB_BS_sp[[i]] <- res
    }
    en_umeta_TMS_BSDB_BS_sp <- bind_rows(en_umeta_TMS_BSDB_BS_sp)
})
```

```{r}
en_umeta_TMS_BSDB_BS <- bind_rows(
    en_umeta_TMS_BSDB_BS_gn, en_umeta_TMS_BSDB_BS_sp
    )
```

## Background: TMS_BSDB_intersect

```{r, echo=FALSE}
# umeta_bsdb_gn_y = unique(unlist(umetasigs_gn))
# bk_umeta_TMS_BSDB_intersect_gn <- intersect(tms_gn_x, umeta_bsdb_gn_y)
# 
# umeta_bsdb_sp_y = unique(unlist(umetasigs_sp))
# bk_umeta_TMS_BSDB_intersect_sp <- intersect(tms_sp_x, umeta_bsdb_sp_y)
```

genus:

```{r}
system.time({
    en_umeta_TMS_BSDB_intersect_gn <- map(
        umetasigs_gn,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_gn, bp_sigs_gn)
        ) |> 
        formatEnMetSig()
})
```

species:

```{r}
system.time({
    en_umeta_TMS_BSDB_intersect_sp <- map(
        umetasigs_sp,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_sp, bp_sigs_sp)
        ) |> 
        formatEnMetSig()
})
```

```{r}
en_umeta_TMS_BSDB_intersect <- bind_rows(
    en_umeta_TMS_BSDB_intersect_gn, en_umeta_TMS_BSDB_intersect_sp
    )
```

## Bacgkround: TMS_BSDB_BS_intersect

```{r, echo=FALSE}
# umetasigs_BS_gn <- vector("list", length(body_sites))
# for (i in seq_along(umetasigs_BS_gn)) {
#    rx <- paste0("^", body_sites[i], "-%-%-", "genus")
#    sigsL <- umetasigs_gn[grep(rx, names(umetasigs_gn))]
#    names(sigsL) <- names(umetasigs_gn)[grep(rx, names(umetasigs_gn))]
#    if (is.null(sigsL)) {
#        next
#    }
#    umetasigs_BS_gn[[i]] <- sigsL
#    names(umetasigs_BS_gn)[i] <- body_sites[i]
# }
# umetasigs_BS_gn <- discard(umetasigs_BS_gn, is.null)
#         
# umetasigs_BS_sp <- vector("list", length(body_sites))
# for (i in seq_along(umetasigs_BS_sp)) {
#    rx <- paste0("^", body_sites[i], "-%-%-", "species")
#    sigsL <- umetasigs_sp[grep(rx, names(umetasigs_sp))]
#    names(sigsL) <- names(umetasigs_sp)[grep(rx, names(umetasigs_sp))]
#    if (is.null(sigsL)) {
#        next
#    }
#    umetasigs_BS_sp[[i]] <- sigsL
#    names(umetasigs_BS_sp)[i] <- body_sites[i]
# }
# umetasigs_BS_sp <- discard(umetasigs_BS_sp, is.null)
```

```{r, echo=FALSE}
# bk_umeta_TMS_BSDB_BS_intersect_gn <- map(body_sites, ~ {
#     x <- unique(unlist(umetasigs_BS_gn[[.x]]))
#     y <- tms_sigs_BS_gn[[.x]]
#     xy <- intersect(x, y)
#     x_ <- setdiff(x, xy)
#     y_ <- setdiff(y, xy)
#     list(
#         bsdb_only = x_,
#         tms_only = y_,
#         both = xy
#     )
# }) |> 
#     set_names(body_sites) |> 
#     map(~ .x$both)
# 
# bk_umeta_TMS_BSDB_BS_intersect_sp <- map(body_sites, ~ {
#     x <- unique(unlist(umetasigs_BS_sp[[.x]]))
#     y <- tms_sigs_BS_sp[[.x]]
#     xy <- intersect(x, y)
#     x_ <- setdiff(x, xy)
#     y_ <- setdiff(y, xy)
#     list(
#         bsdb_only = x_,
#         tms_only = y_,
#         both = xy
#     )
# }) |> 
#     set_names(body_sites) |> 
#     map(~ .x$both)
```

```{r}
system.time({
    en_umeta_TMS_BSDB_BS_intersect_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_intersect_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- umetasigs_gn[grep(rx, names(umetasigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnMetSig()
        en_umeta_TMS_BSDB_BS_intersect_gn[[i]] <- res
    }
    en_umeta_TMS_BSDB_BS_intersect_gn <- bind_rows(
        en_umeta_TMS_BSDB_BS_intersect_gn
    )
})
```

```{r}
system.time({
    en_umeta_TMS_BSDB_BS_intersect_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_intersect_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- umetasigs_sp[grep(rx, names(umetasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnMetSig()
        en_umeta_TMS_BSDB_BS_intersect_sp[[i]] <- res
    }
    en_umeta_TMS_BSDB_BS_intersect_sp <- bind_rows(
        en_umeta_TMS_BSDB_BS_intersect_sp
    )
})
```

```{r}
en_umeta_TMS_BSDB_BS_intersect <- bind_rows(
    en_umeta_TMS_BSDB_BS_intersect_gn, en_umeta_TMS_BSDB_BS_intersect_sp
    )
```

## Background: TMS_1BSDB_BS

```{r}
umetasigs <- c(umetasigs_gn, umetasigs_sp)
bk_umeta_TMS_1BSDB_BS <- vector("list", length(umetasigs)) 
for (i in seq_along(bk_umeta_TMS_1BSDB_BS)) {
    sig_name <- names(umetasigs)[i]
    names(bk_umeta_TMS_1BSDB_BS)[i] <- sig_name
    bodysite_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\1", sig_name)
    rank_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\2", sig_name)
    tms_sig_name <- paste0(bodysite_name, "_", rank_name)
    bk_umeta_TMS_1BSDB_BS[[i]] <- unique(
        c(as.character(bsdb_sigs[[i]]), as.character(tms_sigs[[tms_sig_name]]))
    )
}
```

Enrichment at the genus level:

```{r}
system.time({
    bk_umeta_TMS_1BSDB_BS_gn <- bk_umeta_TMS_1BSDB_BS[names(umetasigs_gn)]
    en_umeta_TMS_1BSDB_BS_gn <- map2(umetasigs_gn, bk_umeta_TMS_1BSDB_BS_gn, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_gn)
    }) |> 
        formatEnMetSig()
})
```

Enrichment at the species level:

```{r}
system.time({
    bk_umeta_TMS_1BSDB_BS_sp <- bk_umeta_TMS_1BSDB_BS[names(umetasigs_sp)]
    en_umeta_TMS_1BSDB_BS_sp <- map2(umetasigs_sp, bk_umeta_TMS_1BSDB_BS_sp, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_sp)
    }) |> 
        formatEnMetSig()
})
```

```{r}
en_umeta_TMS_1BSDB_BS <- bind_rows(
    en_umeta_TMS_1BSDB_BS_gn, en_umeta_TMS_1BSDB_BS_sp
    )
```

## Combine ORA results

```{r}
umeta_results <- list(
    BSDB = en_umeta_BSDB,
    BSDB_BS = en_umeta_BSDB_BS,
    TMS_BSDB = en_umeta_TMS_BSDB,
    TMS_BSDB_BS = en_umeta_TMS_BSDB_BS,
    TMS_BSDB_intersect = en_umeta_TMS_BSDB_intersect,
    TMS_BSDB_BS_intersect = en_umeta_TMS_BSDB_BS_intersect,
    TMS_1BSDB_BS = en_umeta_TMS_1BSDB_BS 
) |> 
    map(~ mutate(.x, fdr = p.adjust(p_value))) |>
    map(~ mutate(.x, combination = paste0(
        body_site, "-#-#-", direction, "-#-#-", rank, "-#-#-",
        condition, "-#-#-", sig_name)
    ))
```


Filter results

```{r}
filtered_umeta_results <- map(umeta_results, ~ filter(.x, fdr < 0.1))
map(filtered_umeta_results, dim)
```

## Visualization

```{r}
umeta_lmat_down = map(
    filtered_umeta_results, ~ createMat(.x, dir = "decreased")
)
umeta_lmat_up = map(
    filtered_umeta_results, ~ createMat(.x, dir = "increased")
)
maxCountumeta <- max(unlist(c(umeta_lmat_down, umeta_lmat_up)))
```

```{r, warning=FALSE, fig.height=30, fig.width=10}
umeta_ht_comb_up <- combinationHt(umeta_lmat_up, maxCountumeta)
draw(umeta_ht_comb_up, column_title = "Increased")
```

```{r, warning=FALSE, fig.height=30, fig.width=10}
umeta_ht_comb_down <- combinationHt(umeta_lmat_down, maxCountumeta)
draw(umeta_ht_comb_down, column_title = "decreased")
```

# Tables

Results of enrichment using signatures

```{r}
resDF <- filtered_results |> 
    bind_rows(.id = "background")
myDataTable(resDF)
```

Results of enrichment using meta-signatures

```{r}
metaResDF <- filtered_meta_results |> 
    bind_rows(.id = "background")
myDataTable(metaResDF)
```

Results of enrichment using unique meta-signatures

```{r}
umetaResDF <- filtered_umeta_results |> 
    bind_rows(.id = "background") 
myDataTable(umetaResDF)
```

# Session info

```{r}
sessioninfo::session_info()
```
