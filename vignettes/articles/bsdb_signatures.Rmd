---
title: "High-throughput ORA with BSDB signatures"
output:
    html_document:
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(bugsigdbr)
library(dplyr)
library(purrr)
library(tidyr)
library(ComplexHeatmap)
library(gridExtra)
library(ggplot2)

body_sites <- c("skin", "vagina", "mouth", "feces")
ranks <- c("genus", "species")
```

# Data

TypicalMicrobiomeSignatures:

```{r, message=FALSE}
tms <- importTMS() |> 
    filter(`Age group` == "adult")
glimpse(tms, 50)
```

BugSigDB:

```{r, message=FALSE}
bsdb_doi <- "10.5281/zenodo.10627578" # v1.2.1
# bsdb_doi <-  "10.5281/zenodo.10407666" #v1.2.0
# bsdb_doi <-  "10.5281/zenodo.6468009" #v1.1.0
bsdb <- importBugSigDB(version = bsdb_doi)
bsdb <- bsdb |> 
    filter(`Host species` == "Homo sapiens") |> 
    filter(!is.na(`Abundance in Group 1`)) |> 
    filter(!is.na(`Body site`)) |> 
    filter(`Study design` == "case-control" ) |> 
    filter(
        !grepl("(child|infant)", `Group 1 name`, ignore.case = TRUE)
    )
dim(bsdb)
```

BugSigDB subsets by body site:

```{r, message=FALSE}
uberon <- getOntology(onto = "uberon")
body_sites <- unique(tms$`Body site`)
bsdb_subsets_by_bodysite <- vector("list", length(body_sites))
names(bsdb_subsets_by_bodysite) <- body_sites
for (i in seq_along(bsdb_subsets_by_bodysite)) {
    if (body_sites[i] == "skin") {
        bsdb_subsets_by_bodysite[[i]] <- bsdb |> 
            filter(grepl(body_sites[i], `Body site`, ignore.case = TRUE))
    } else {
        bsdb_subsets_by_bodysite[[i]] <- subsetByOntology(
            bsdb, column = "Body site", term = body_sites[i], ontology = uberon 
        )
        
    }
}
```

Bugphyzz:

```{r, message=FALSE}
bp <- importBugphyzz()
names(bp)
```

# Signatures

BugSigDB signatures:

```{r}
directions <- c("increased", "decreased")
bsdb_sigs <- vector(
    mode = "list", 
    length = length(body_sites) * length(ranks) * length(directions)
)
counter <- 1
for (i in seq_along(body_sites)) {
    for (j in seq_along(ranks)) {
        for (k in seq_along(directions)) {
            myDF <- bsdb_subsets_by_bodysite[[i]] |> 
                filter(`Abundance in Group 1` == directions[k])
            sigs <- getSignatures(
                df = myDF,
                tax.id.type = "ncbi", tax.level = ranks[j],
                exact.tax.level = FALSE, min.size = 5
            ) |>  
                discard(~ length(.x) < 5)
            if (!length(sigs)) {
                counter <- counter + 1
                next
            }
            bsdb_id <- sub(
                pattern = "^(bsdb:[0-9]+/[0-9]+/[0-9]+)_.*$",
                replacement = "\\1",
                x = names(sigs)
            )
            
            pos <- map_int(bsdb_id, ~ which(myDF$`BSDB ID` == .x))
            new_sigs_names <- paste0(
                body_sites[i], "-%-%-", ranks[j], "-%-%-", directions[k], "-%-%-",
                tolower(myDF$Condition[pos]), "-%-%-",
                names(sigs)
            )
            names(sigs) <- new_sigs_names
            bsdb_sigs[[counter]] <- sigs
            counter <- counter + 1
        }
    }
}
bsdb_sigs <- list_flatten(bsdb_sigs)
bsdb_sigs <- discard(bsdb_sigs, is.null)
```

Separate BSDB signatures by body site and rank:

```{r}
bsdb_sigs_BS_gn <- vector("list", length(body_sites))
for (i in seq_along(bsdb_sigs_BS_gn)) {
   rx <- paste0("^", body_sites[i], "-%-%-", "genus")
   sigsL <- bsdb_sigs[grep(rx, names(bsdb_sigs))]
   names(sigsL) <- names(bsdb_sigs)[grep(rx, names(bsdb_sigs))]
   if (is.null(sigsL)) {
       next
   }
   bsdb_sigs_BS_gn[[i]] <- sigsL
   names(bsdb_sigs_BS_gn)[i] <- body_sites[i]
}

bsdb_sigs_BS_sp <- vector("list", length(body_sites))
for (i in seq_along(bsdb_sigs_BS_sp)) {
   rx <- paste0("^", body_sites[i], "-%-%-", "species")
   sigsL <- bsdb_sigs[grep(rx, names(bsdb_sigs))]
   names(sigsL) <- names(bsdb_sigs)[grep(rx, names(bsdb_sigs))]
   if (is.null(sigsL)) {
       next
   }
   bsdb_sigs_BS_sp[[i]] <- sigsL
   names(bsdb_sigs_BS_sp)[i] <- body_sites[i]
}
```

bugphyzz signatures:

```{r, warning=FALSE}
bp_sigs_gn <- map(bp, ~ {
    makeSignatures(
        dat = .x, tax_id_type = "NCBI_ID", tax_level = "genus", min_size = 5,
        evidence = c("exp", "igc", "nas", "tas", "tax", "asr")
    )
}) |> 
    discard(is.null) |> 
    list_flatten(name_spec = "{inner}") |> 
    map(as.character)
names(bp_sigs_gn) <- paste0(names(bp_sigs_gn), "|genus")
    
bp_sigs_sp <- map(bp, ~ {
    makeSignatures(
        dat = .x, tax_id_type = "NCBI_ID", tax_level = "species", min_size = 5,
        evidence = c("exp", "igc", "nas", "tas", "tax", "asr")
    )
}) |> 
    discard(is.null) |> 
    list_flatten(name_spec = "{inner}") |> 
    map(as.character)
names(bp_sigs_sp) <- paste0(names(bp_sigs_sp), "|species")
bp_sigs <- c(bp_sigs_gn, bp_sigs_sp)
```

Typical Microbiome Signatures:

```{r}
thrs <- elbows()
tms_sigs <- vector("list", length(body_sites) * length(ranks))
counter <- 1
for (i in seq_along(body_sites)) {
    for (j in seq_along(ranks)) {
        tms_name <- paste0(body_sites[i], "_", ranks[j])
        names(tms_sigs)[counter] <- tms_name
        print(tms_name)
        tms_sigs[[counter]] <- tms |> 
            filter(`Body site` == body_sites[i], Rank == ranks[j]) |> 
            filter(Prevalence >= thrs[tms_name]) |> 
            pull(`NCBI ID`)
        counter <- counter + 1
    }
}

tms_sigs_gn <- tms_sigs[grep("genus", names(tms_sigs))]
tms_sigs_sp <- tms_sigs[grep("species", names(tms_sigs))]

names(tms_sigs_gn) <- sub("_genus", "", names(tms_sigs_gn))
names(tms_sigs_sp) <- sub("_species", "", names(tms_sigs_sp))
```






















## Enrichment - Background: BSDB

Background:

```{r}
bsdb_sigs_gn <- bsdb_sigs[grep("-%-%-genus-%-%-", names(bsdb_sigs))]
bsdb_sigs_sp <- bsdb_sigs[grep("-%-%-species-%-%-", names(bsdb_sigs))]
bk_BSDB_gn <- unique(unlist(bsdb_sigs_gn))
bk_BSDB_sp <- unique(unlist(bsdb_sigs_sp))
```

Enrichment at the genus level:

```{r}
system.time({
    en_BSDB_gn <- map(
        .x = bsdb_sigs_gn,
        .f = ~ microbeSetEnrichment(.x, bk_BSDB_gn, bp_sigs_gn)
    ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
        # filter(fdr < 0.1)
    colnames(en_BSDB_gn) <- sub("Set", "BSDB", colnames(en_BSDB_gn))
})
```

Enrichment at the species level:

```{r}
system.time({
    en_BSDB_sp <- map(
        .x = bsdb_sigs_sp,
        .f = ~ microbeSetEnrichment(.x, bk_BSDB_sp, bp_sigs_sp)
    ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
        # filter(fdr < 0.1)
    colnames(en_BSDB_sp) <- sub("Set", "BSDB", colnames(en_BSDB_sp))
})
```

```{r}
en_BSDB <- bind_rows(en_BSDB_gn, en_BSDB_sp)
```

## Enrichment - Background: BSDB by Body site

Enrichment at the genus level:

```{r}
bk_BSDB_BS_gn <- vector("list", length(body_sites))
names(bk_BSDB_BS_gn) <- body_sites
for (i in seq_along(bk_BSDB_BS_gn)) {
    res <- bsdb_sigs_gn[grepl(body_sites[[i]], names(bsdb_sigs_gn))]
    if (is.null(res)) {
        next
    }
    bk_BSDB_BS_gn[[i]] <- unique(unlist(res))
}

system.time({
    en_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_gn[grep(rx, names(bsdb_sigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition", "bsdb_sig"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_BSDB_BS_gn[[i]] <- res
    }
    en_BSDB_BS_gn <- bind_rows(en_BSDB_BS_gn)
})
```

Enrichment at the species level:

```{r}
bk_BSDB_BS_sp <- vector("list", length(body_sites))
names(bk_BSDB_BS_sp) <- body_sites
for (i in seq_along(bk_BSDB_BS_sp)) {
    res <- bsdb_sigs_sp[grepl(body_sites[[i]], names(bsdb_sigs_sp))]
    if (is.null(res)) {
        next
    }
    bk_BSDB_BS_sp[[i]] <- unique(unlist(res))
}

system.time({
    en_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_sp[grep(rx, names(bsdb_sigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition", "bsdb_sig"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_BSDB_BS_sp[[i]] <- res
    }
    en_BSDB_BS_sp <- bind_rows(en_BSDB_BS_sp)
})
```

```{r}
en_BSDB_BS <- bind_rows(en_BSDB_BS_gn, en_BSDB_BS_sp)
```

## Enrichemnt - Background: TMS + BSDB

Enrichment at the genus level:

```{r}
system.time({
    bk_TMS_BSDB_gn <- unique(unlist(c(tms_sigs_gn, bsdb_sigs_gn)))
    en_TMS_BSDB_gn <- map(
        .x = bsdb_sigs_gn,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_gn, bp_sigs_gn)
    ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
    colnames(en_TMS_BSDB_gn) <- sub("Set", "BSDB", colnames(en_TMS_BSDB_gn))
})
```

Enrichment at the species level:

```{r}
system.time({
    bk_TMS_BSDB_sp <- unique(unlist(c(tms_sigs_sp, bsdb_sigs_sp)))
    en_TMS_BSDB_sp <- map(
        .x = bsdb_sigs_sp,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_sp, bp_sigs_sp)
        ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
    colnames(en_TMS_BSDB_sp) <- sub("Set", "BSDB", colnames(en_TMS_BSDB_sp))
})
```

```{r}
en_TMS_BSDB <- bind_rows(en_TMS_BSDB_gn, en_TMS_BSDB_sp)
```

## Enrichment - Background: TMS + BSDB by body site

Enrichment at the genus level:

```{r}
bk_TMS_BSDB_BS_gn <- map2(
    tms_sigs_gn[body_sites], bk_BSDB_BS_gn[body_sites], ~ unique(c(.x, .y))
)
system.time({
    en_TMS_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_gn[grep(rx, names(bsdb_sigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition", "bsdb_sig"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_TMS_BSDB_BS_gn[[i]] <- res
    }
    en_TMS_BSDB_BS_gn <- bind_rows(en_TMS_BSDB_BS_gn)
})
```

Enrichment at the species level:

```{r}
bk_TMS_BSDB_BS_sp <- map2(
    tms_sigs_sp[body_sites], bk_BSDB_BS_sp[body_sites], ~ unique(c(.x, .y))
)
system.time({
    en_TMS_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_sp[grep(rx, names(bsdb_sigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition", "bsdb_sig"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_TMS_BSDB_BS_sp[[i]] <- res
    }
    en_TMS_BSDB_BS_sp <- bind_rows(en_TMS_BSDB_BS_sp)
})
```

```{r}
en_TMS_BSDB_BS <- bind_rows(en_TMS_BSDB_gn, en_TMS_BSDB_sp)
```

## Enrichment - Background: TMS + BSDB intersect

Intersection at the genus level:

```{r}
tms_gn_x = unique(unlist(tms_sigs_gn))
bsdb_gn_y = unique(unlist(bsdb_sigs_gn))
tms_bsdb_gn_xy <- intersect(tms_gn_x, bsdb_gn_y)
data.frame(
    tms_genus_only = length(setdiff(tms_gn_x, tms_bsdb_gn_xy)),
    bsdb_genus_only = length(setdiff(bsdb_gn_y, tms_bsdb_gn_xy)),
    tms_bsdb_genus_intersect = length(tms_bsdb_gn_xy)
)
```

Enrichment at the genus level:

```{r}
bk_TMS_BSDB_intersect_gn <- tms_bsdb_gn_xy
system.time({
    en_TMS_BSDB_intersect_gn <- map(
        bsdb_sigs_gn,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_gn, bp_sigs_gn)
        ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        )) 
        # filter(fdr < 0.1)
    colnames(en_TMS_BSDB_intersect_gn) <- sub(
        "Set", "BSDB", colnames(en_TMS_BSDB_intersect_gn)
    )
})
```

Intersection at the species level

```{r}
tms_sp_x = unique(unlist(tms_sigs_sp))
bsdb_sp_y = unique(unlist(bsdb_sigs_sp))
tms_bsdb_sp_xy <- intersect(tms_sp_x, bsdb_sp_y)
data.frame(
    tms_species_only = length(setdiff(tms_sp_x, tms_bsdb_sp_xy)),
    bsdb_species_only = length(setdiff(bsdb_sp_y, tms_bsdb_sp_xy)),
    tms_bsdb_species_intersect = length(tms_bsdb_sp_xy)
)
```

Enrichment at the species level:

```{r}
bk_TMS_BSDB_intersect_sp <- tms_bsdb_sp_xy
system.time({
    en_TMS_BSDB_intersect_sp <- map(
        bsdb_sigs_sp,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_sp, bp_sigs_sp)
        ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
        # filter(fdr < 0.1)
    colnames(en_TMS_BSDB_intersect_sp) <- sub(
        "Set", "BSDB", colnames(en_TMS_BSDB_intersect_sp)
    )
})
```

```{r}
en_TMS_BSDB_intersect <- bind_rows(
    en_TMS_BSDB_intersect_gn, en_TMS_BSDB_intersect_sp
)
```

## Enrichment - Background: TMS + BSDB intersect by body site

Intersection by body site at the genus level:

```{r}
l1 <- map(body_sites, ~ {
    x <- unique(unlist(bsdb_sigs_BS_gn[[.x]]))
    y <- tms_sigs_gn[[.x]]
    xy <- intersect(x, y)
    x_ <- setdiff(x, xy)
    y_ <- setdiff(y, xy)
    list(
        bsdb_only = x_,
        tms_only = y_,
        both = xy
    )
})
names(l1) <- body_sites
bk_TMS_BSDB_BS_intersect_gn <- map(l1, ~ .x$both)
l1 |> 
    map(~ as.data.frame(matrix(map_int(.x, length), nrow = 1))) |> 
    bind_rows() |> 
    set_names(c("bsdb_only", "tms_only", "both"))
```

Enrichment at the genus level:

```{r}
system.time({
    en_TMS_BSDB_BS_intersect_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_intersect_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_gn[grep(rx, names(bsdb_sigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition", "bsdb_sig"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_TMS_BSDB_BS_intersect_gn[[i]] <- res
    }
    en_TMS_BSDB_BS_intersect_gn <- bind_rows(en_TMS_BSDB_BS_intersect_gn)
})
```

Intersection by body site at the species level:

```{r}
l2 <- map(body_sites, ~ {
    x <- unique(unlist(bsdb_sigs_BS_sp[[.x]]))
    y <- tms_sigs_sp[[.x]]
    xy <- intersect(x, y)
    x_ <- setdiff(x, xy)
    y_ <- setdiff(y, xy)
    list(
        bsdb_only = x_,
        tms_only = y_,
        both = xy
    )
})
names(l2) <- body_sites
bk_TMS_BSDB_BS_intersect_sp <- map(l2, ~ .x$both)
l2 |> 
    map(~ as.data.frame(matrix(map_int(.x, length), nrow = 1))) |> 
    bind_rows() |> 
    set_names(c("bsdb_only", "tms_only", "both"))
```

Enrichment at the species level:

```{r}
system.time({
    en_TMS_BSDB_BS_intersect_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_intersect_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_sp[grep(rx, names(bsdb_sigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition", "bsdb_sig"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_TMS_BSDB_BS_intersect_sp[[i]] <- res
    }
    en_TMS_BSDB_BS_intersect_sp <- bind_rows(en_TMS_BSDB_BS_intersect_sp)
})
```

```{r}
en_TMS_BSDB_BS_intersect <- bind_rows(
    en_TMS_BSDB_BS_intersect_gn, en_TMS_BSDB_BS_intersect_sp
)
```

## Enrichment - Background: TMS + 1BSDB by body site

Background(s):

```{r}
bk_TMS_1BSDB_BS <- vector("list", length(bsdb_sigs)) 
for (i in seq_along(bk_TMS_1BSDB_BS)) {
    sig_name <- names(bsdb_sigs)[i]
    names(bk_TMS_1BSDB_BS)[i] <- sig_name
    bodysite_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\1", sig_name)
    rank_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\2", sig_name)
    tms_sig_name <- paste0(bodysite_name, "_", rank_name)
    bk_TMS_1BSDB_BS[[i]] <- unique(
        c(as.character(bsdb_sigs[[i]]), as.character(tms_sigs[[tms_sig_name]]))
    )
}
```

Enrichment at the genus level:

```{r}
system.time({
    bk_TMS_1BSDB_BS_gn <- bk_TMS_1BSDB_BS[names(bsdb_sigs_gn)]
    en_TMS_1BSDB_BS_gn <- map2(bsdb_sigs_gn, bk_TMS_1BSDB_BS_gn, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_gn)
    }) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c(
                "body_site", "rank", "direction", "condition", "bsdb_sig"
            ), sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
    colnames(en_TMS_1BSDB_BS_gn) <- sub(
        "Set", "BSDB", colnames(en_TMS_1BSDB_BS_gn)
    )
})
```

Enrichment at the species level:

```{r}
system.time({
    bk_TMS_1BSDB_BS_sp <- bk_TMS_1BSDB_BS[names(bsdb_sigs_sp)]
    en_TMS_1BSDB_BS_sp <- map2(bsdb_sigs_sp, bk_TMS_1BSDB_BS_sp, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_sp)
    }) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c(
                "body_site", "rank", "direction", "condition", "bsdb_sig"
            ), sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
    colnames(en_TMS_1BSDB_BS_sp) <- sub(
        "Set", "BSDB", colnames(en_TMS_1BSDB_BS_sp)
    )
})
```

```{r}
en_TMS_1BSDB_BS <- bind_rows(en_TMS_1BSDB_BS_gn, en_TMS_1BSDB_BS_sp)
```

## Combine results

merge all results in a single list:

```{r}
results <- list(
    ## Union of all BugSigDB signatures
    BSDB = en_BSDB,
    ## Union of all BugSigDB signatures by body site
    BSDB_BS = en_BSDB_BS,
    ## Union of all typical and BugSigDB signatures
    TMS_BSDB = en_TMS_BSDB,
    ## Union of all typical and BugSigDB signatures by body site
    TMS_BSDB_BS = en_TMS_BSDB_BS,
    ## Intersection of all typicial and BugSigDB signatures 
    TMS_BSDB_intersect = en_TMS_BSDB_intersect,
    ## Intersection of all typical and BugSigDB signatures by body site
    TMS_BSDB_BS_intersect = en_TMS_BSDB_BS_intersect,
    ## Intersection of typical and target signature by body site
    TMS_1BSDB_BS = en_TMS_1BSDB_BS 
) |> 
    map(~ mutate(.x, fdr = p.adjust(p_value))) |> 
    map(~ mutate(.x, combination = paste0(
        body_site, "-#-#-", direction, "-#-#-", rank, "-#-#-",
        condition, "-#-#-", sig_name, "-#-#-", bsdb_sig)
    ))
```

Adjust FDR and filter:

```{r}
filtered_results <- map(results, ~ filter(.x, fdr < 0.1))
map(filtered_results, dim)
```

Check which signatures are more frequent among the background options

```{r}
x <- filtered_results |> 
    map(~ .x[,"combination", drop = FALSE]) |> 
    bind_rows(.id  = "background")
  
y <- count(x, combination, name = "freq") |> 
    arrange(-freq) |> 
    separate(
        col = combination,
        into = c(
            "body_site", "direction", "rank", "condition", "sig_name",
            "bsdb_sig"
        ), 
        sep = "-#-#-"
    ) |> 
    relocate(freq, .after = sig_name)

y |> 
    count(freq, name = "n_sigs") |> 
    mutate(freq = factor(as.character(freq))) |> 
    ggplot(aes(freq, n_sigs)) +
    labs(
        x = "Frequency", y = "Number of signatures"
    ) +
    geom_point(shape = 21, size = 5, fill = "firebrick4", alpha = 0.7) +
    theme_bw()
```

```{r}
z <- x |> 
    mutate(present = 1) |> 
    pivot_wider(
        names_from = "background", values_from = "present", values_fill = 0
    )

m <- z |> 
    tibble::column_to_rownames(var = "combination") |> 
    as.matrix()

```

```{r, warning=FALSE, fig.height=10, fig.width=5}
col_fun <- circlize::colorRamp2(
    breaks = c(0, 1), colors = c("white", "gray25")
)
ht <- Heatmap(
    matrix = m,
    show_row_names = FALSE,
    col = col_fun,
    name = "presence/absence"
)
ht
```

## Heatmaps

Define funcions:

```{r}
createMat <- function(dat, fdr_th = 0.1, dir) {
   dat <- dat |> 
       dplyr::filter(
           .data$fdr < fdr_th, .data$direction == dir 
       )
   output <- dat |> 
       count(
           body_site, direction, condition, sig_name
       ) |> 
       {\(y) split(y, y$direction)}() |> 
       map(~ split(.x, .x$body_site)) |> 
       list_flatten() |>
       discard(~ !nrow(.x)) |>
       bind_rows() |> 
       mutate(sig_name = factor(sig_name), condition = factor(condition)) |> 
       {\(y) split(y, y$body_site)}() |> 
       map(~ {
           mat <- .x |> 
               select(-body_site, -direction) |> 
               complete(sig_name, condition, fill = list(n = 0)) |> 
               pivot_wider(
                   names_from = "condition", values_from = "n", values_fill = 0
               ) |>
               tibble::column_to_rownames(var = "sig_name") |>
               as.matrix()
           select_cols <- which(as.logical(colSums(mat)))
           mat[, select_cols, drop = FALSE]
           
       })
   output
}

createHt <- function(x) {
    lht <- vector("list", length(x))
    for (i in seq_along(x)) {
        xmat <- x[[i]]
        xmat <- xmat[sort(rownames(xmat)),, drop = FALSE]
        xmat <- xmat[,sort(colnames(xmat)), drop = FALSE]
        if (i == length(lht)) {
            lht[[i]] <- Heatmap(
                matrix = xmat,
                col = color_fun,
                show_column_dend = FALSE,
                show_row_dend = FALSE,
                name = "# sigs",
                border = TRUE,
                column_title = names(x)[i],
                row_names_side = "left", 
                column_title_rot = 45,
                column_names_rot = 45,
                row_order = rownames(xmat),
                # column_order = colnames(xmat),
                row_names_max_width = max_text_width(
                    rownames(xmat),
                    gp = gpar(fontsize = 12)
                ),
                rect_gp = gpar(col = "gray70", lwd = 1)
            )
        } else {
            lht[[i]] <- Heatmap(
                matrix = xmat,
                col = color_fun,
                show_column_dend = FALSE,
                show_row_dend = FALSE,
                border = TRUE,
                show_heatmap_legend = FALSE,
                column_title = names(x)[i],
                row_names_side = "left",
                column_title_rot = 45,
                column_names_rot = 45,
                row_order = rownames(xmat),
                # column_order = colnames(xmat),
                row_names_max_width = max_text_width(
                    rownames(xmat),
                    gp = gpar(fontsize = 12)
                ),
                rect_gp = gpar(col = "gray70", lwd = 1)
            )
        }
    }
    reduce(lht, `+`)
}
```

```{r}
lmat_down = map(results, ~ createMat(.x, dir = "decreased"))
lmat_up = map(results, ~ createMat(.x, dir = "increased"))
max_count <- max(unlist(c(lmat_down, lmat_up)))
color_fun <- circlize::colorRamp2(
    breaks = c(0, seq(1, max_count)), 
    colors = c("white", viridis::viridis(max_count))
)
```

```{r}
l_ht_down <- map(lmat_down, createHt)
l_ht_up <- map(lmat_up, createHt)
```

### BSDB

up:

```{r, fig.height=16, fig.width=16}
draw(
    l_ht_up$BSDB,
    column_title = 
        "Background: union of BSDB signatures - Direction: increased"
)
```

down:

```{r, fig.height=10, fig.width=15}
draw(
    l_ht_down$BSDB,
    column_title =
        "Background: union of BSDB signatures - direction: decreased"
)
```

### BSDB by BS

up:

```{r, fig.height=16, fig.width=12}
draw(
    l_ht_up$BSDB_BS,
    column_title =
        "Background: union of BSDB sigs by body site - Direction: increased"
)
```

down:

```{r, fig.height=8, fig.width=12}
draw(
    l_ht_down$BSDB_BS,
    column_title = "Background:Union of BSDB sigs by body site - Direction: decreased"
)
```

### TMS + BSDB

up:

```{r, fig.height=16, fig.width=13}
draw(
    l_ht_up$TMS_BSDB,
    column_title = 
        "Background: union of BSDB and TMS signatures - Direction: increased"
)
```

down:

```{r, fig.height=9, fig.width=14}
draw(
    l_ht_down$TMS_BSDB,
    column_title = "Background: Union of BSDB and TMS signatures - Direction: decreased"
)
```

### TMS + BSDB by BS

up:

```{r, fig.height=15, fig.width=12}
draw(
    l_ht_up$TMS_BSDB_BS,
    column_title = "Background: Union of BSDB and TMS sigs by body site - Direction: increased"
)
```

down:

```{r, fig.height=8, fig.width=12}
draw(
    l_ht_down$TMS_BSDB_BS,
    column_title =
        "Background: union of BSDB and TMS sigs by body site - Direction: decreased"
)
```

### TMS interesct BSDB

up:

```{r, fig.height=6, fig.width=6}
draw(
    l_ht_up$TMS_BSDB_intersect,
    column_title =
        "Background: intersection of BSDB and TMS sigs - Direction: increased"
)
```

down:

No results

```{r, eval=FALSE}
draw(
    l_ht_down$TMS_BSD,
    column_title = "Background: Intersection of BSDB and TMS sigs - Direction: decreased"
)
```

### TMS intersect BSDB by BS

up: No results

```{r, eval=FALSE}
draw(
    l_ht_up$TMS_BSDB_BS_interesct,
    column_title = "Background: Intersection of BSDB and TMS sigs by body site - Direction: increased"
)
```

down:

```{r}
draw(
    l_ht_down$TMS_BSDB_BS_intersect,
    column_title =
        "Background: intersection of BSDB adn TMS sigs by body site - Direction: decreased"
)

```

### TMS + 1BSDB

up:

```{r, fig.height=10, fig.width=9}
draw(
    l_ht_up$TMS_1BSDB,
    column_title =
        "Background: union of TMS and one target BSDB signature - Direction: increased"
)
```

down:

```{r, fig.height=9, fig.width=10}
draw(
    l_ht_down$TMS_1BSDB,
    column_title =
        "Background: union of TMS and one target BSDB signature - Direction: decreased"
)
```


## Comparison of conditions and signatures across backgrounds

Define functions:

```{r}
globalHt <- function(l, what) {
    mat_ <- l |> 
        map(~ map(.x, function(x) do.call(what, list(x)))) |> 
        map(~ data.frame(sig = unique(unlist(.x)), y = 1)) |> 
        {\(y) map2(.x = y, .y = names(y), ~ {colnames(.x)[2] <- .y; .x})}() |> 
        reduce(~ left_join(.x, .y, by = "sig") ) |> 
        {\(y) {y[is.na(y)] <- 0; y}}() |> 
        tibble::column_to_rownames(var = "sig") |> 
        as.matrix()
    ht_ <- Heatmap(
        matrix = mat_,
        show_row_names = TRUE,
        col = circlize::colorRamp2(c(0, 1), c("white", "gray25")),
        name = "presence/absence",
        row_names_max_width = max_text_width(
            rownames(mat_),
        gp = gpar(fontsize = 12)
        ),
        rect_gp = gpar(col = "gray70", lwd = 1)
    )
    ht_
}
```


Conditions - UP:

```{r, fig.height=9, fig.width=8}
ht_cond_up <- globalHt(lmat_up, "colnames")
draw(ht_cond_up, column_title = "Conditions - Increased")
```

Conditions - Down

```{r, fig.height=9, fig.width=8}
ht_cond_down <- globalHt(lmat_down, "colnames")
draw(ht_cond_down, column_title = "Conditions - decreased")

```

Signatures - UP

```{r, fig.height=12, fig.width=9}
ht_cond_up <- globalHt(lmat_up, "rownames")
draw(ht_cond_up, column_title = "BP Signatures - Increased")

```

Signatures - Down

```{r, fig.height=12, fig.width=9}
ht_cond_down <- globalHt(lmat_down, "rownames")
draw(ht_cond_down)
```

## Combinations

Define function


```{r}
myFun <- function(x) {
    x |> 
        as.data.frame() |> 
        tibble::rownames_to_column("sig") |> 
        pivot_longer(
            names_to = "condition", values_to = "presence", cols = 2:last_col()
        ) |> 
        filter(presence > 0) |> 
        unite(col = "combination", sep = " |---| ", sig, condition)
        # mutate(presence = 1) 
}

combinationHt <- function(l) {
    xvar <- l |> 
        map(~ map(.x, function(x) myFun(x))) |> 
        map(~ distinct(bind_rows(.x, .id = "bs"))) |> 
        bind_rows(.id = "bk") |> 
        mutate(
            bs = factor(bs), combination = factor(combination),
            bk = factor(bk)
        ) |> 
        {\(y) split(y, y$bs)}() |> 
        map(~select(.x, -bs)) |> 
        map(~ {
            .x |> 
                complete(combination, bk, fill = list(presence = 0)) |> 
                pivot_wider(
                    names_from = "bk", values_from = "presence", values_fill = 0
                ) |>
                tibble::column_to_rownames(var = "combination") |>
                as.matrix()
        }) |> 
        map(~ {
            select_row <- which(rowSums(.x) > 0)
            .x[select_row, , drop = FALSE]
            # .x[sort(rownames(.x)), , drop = FALSE]
            
        }) |>
        imap(~{
            .x <- .x[sort(rownames(.x)), , drop = FALSE]
            order_of_columns <- c(
                "TMS_BSDB", "TMS_BSDB_BS", "BSDB", "BSDB_BS",
                "TMS_1BSDB_BS", "TMS_BSDB_intersect",
                "TMS_BSDB_BS_intersect"
            )
            Heatmap(
                matrix = .x,
                show_row_names = TRUE,
                show_row_dend = FALSE,
                show_column_dend = FALSE,
                row_dend_reorder = FALSE,
                column_dend_reorder = FALSE,
                row_title = .y,
                col = color_fun,
                name = "# sigs",
                row_order = rownames(.x),
                column_order = order_of_columns,
                row_names_max_width = max_text_width(
                    rownames(.x),
                    gp = gpar(fontsize = 12)
                ),
                rect_gp = gpar(col = "gray70", lwd = 1),
                border = TRUE
            )
        })
    reduce(xvar, ~ .x %v% .y)
}
```

```{r, fig.height=30, fig.width=10, warning=FALSE}
ht_comb_up <- combinationHt(lmat_up)
draw(ht_comb_up, column_title = "Increased")
```

```{r, fig.height=30, fig.width=10, warning=FALSE}
ht_comb_down <- combinationHt(lmat_down)
draw(ht_comb_down, column_title = "Decreased")
```

# Metasignatures

Metasignatures

```{r}
metasigs_gn_up <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "UP", tax.level = "genus",
        min.studies = 1, exact.tax.level = FALSE
    )
}) |> 
    list_flatten(name_spec = "{outer}-%-%-genus-%-%-increased-%-%-{inner}") |> 
    map(~ names(.x))

metasigs_gn_down <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "DOWN", tax.level = "genus",
        exact.tax.level = FALSE, min.studies = 1
    )
}) |> 
    list_flatten(name_spec = "{outer}-%-%-genus-%-%-decreased-%-%-{inner}") |> 
    map(~ names(.x))

metasigs_sp_up <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "UP", tax.level = "species",
        exact.tax.level = FALSE, min.studies = 1
    ) 
}) |> 
    list_flatten(name_spec = "{outer}-%-%-species-%-%-increased-%-%-{inner}") |> 
    map(~ names(.x))

metasigs_sp_down <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "DOWN", tax.level = "species",
        exact.tax.level = FALSE, min.studies = 1
    ) 
}) |> 
    list_flatten(name_spec = "{outer}-%-%-species-%-%-decreased-%-%-{inner}") |> 
    map(~ names(.x))

metasigs_gn <- c(metasigs_gn_up, metasigs_gn_down)
metasigs_sp <- c(metasigs_sp_up, metasigs_sp_down)
```

## Enrichment metasignatures - Background: BSDB

```{r}
system.time({
    en_meta_BSDB_gn <- map(
        metasigs_gn, ~ microbeSetEnrichment(.x, bk_BSDB_gn, bp_sigs_gn)
    ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c(
                "body_site", "rank", "direction", "condition"
            ), sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
    colnames(en_meta_BSDB_gn) <- sub(
        "Set", "BSDB", colnames(en_meta_BSDB_gn)
    )
})
```


```{r}
system.time({
    en_meta_BSDB_sp <- map(
        metasigs_sp, ~ microbeSetEnrichment(.x, bk_BSDB_sp, bp_sigs_sp)
    ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c(
                "body_site", "rank", "direction", "condition"
            ), sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
    colnames(en_meta_BSDB_sp) <- sub(
        "Set", "BSDB", colnames(en_meta_BSDB_sp)
    )
    
})
```

```{r}
en_meta_BSDB <- bind_rows(en_meta_BSDB_gn, en_meta_BSDB_sp) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```


## Enrichment metasignatures - Background: BSDB by body site

genus:

```{r}
system.time({
    en_meta_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_gn[grep(rx, names(metasigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_meta_BSDB_BS_gn[[i]] <- res
    }
    en_meta_BSDB_BS_gn <- bind_rows(en_meta_BSDB_BS_gn)
})
```

species:

```{r}
system.time({
    en_meta_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_sp[grep(rx, names(metasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |>  
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_meta_BSDB_BS_sp[[i]] <- res
    }
    en_meta_BSDB_BS_sp <- bind_rows(en_meta_BSDB_BS_sp)
})
```


```{r}
en_meta_BSDB_BS <- bind_rows(en_meta_BSDB_BS_gn, en_meta_BSDB_BS_sp) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```

## Enrichment metasignatures - Background: TMS + BSDB

```{r}
system.time({
    en_meta_TMS_BSDB_gn <- map(
        .x = metasigs_gn,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_gn, bp_sigs_gn)
    ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
    colnames(en_meta_TMS_BSDB_gn) <- sub("Set", "BSDB", colnames(en_meta_TMS_BSDB_gn))
})
```

Enrichment at the species level:

```{r}
system.time({
    en_meta_TMS_BSDB_sp <- map(
        .x = metasigs_sp,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_sp, bp_sigs_sp)
        ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
    colnames(en_meta_TMS_BSDB_sp) <- sub("Set", "BSDB", colnames(en_meta_TMS_BSDB_sp))
})
```

```{r}
en_meta_TMS_BSDB <- bind_rows(en_meta_TMS_BSDB_gn, en_meta_TMS_BSDB_sp) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```


## Enrichment metasignatures - Background: TMS + BSDB by body site

```{r}
system.time({
    en_meta_TMS_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_gn[grep(rx, names(metasigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_meta_TMS_BSDB_BS_gn[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_gn <- bind_rows(en_meta_TMS_BSDB_BS_gn)
})

```


```{r}
system.time({
    en_meta_TMS_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_sp[grep(rx, names(metasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_meta_TMS_BSDB_BS_sp[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_sp <- bind_rows(en_meta_TMS_BSDB_BS_sp)
})
```

```{r}
en_meta_TMS_BSDB_BS <- bind_rows(en_meta_TMS_BSDB_BS_gn, en_meta_TMS_BSDB_BS_sp) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```

## Enrichment metasignatures - Background: TMS + BSDB intersect

```{r}
meta_bsdb_gn_y = unique(unlist(metasigs_gn))
meta_bsdb_gn_xy <- intersect(tms_gn_x, meta_bsdb_gn_y)
bk_meta_TMS_BSDB_intersect_gn <- meta_bsdb_gn_xy

meta_bsdb_sp_y = unique(unlist(metasigs_sp))
meta_bsdb_sp_xy <- intersect(tms_sp_x, meta_bsdb_sp_y)
bk_meta_TMS_BSDB_intersect_sp <- meta_bsdb_sp_xy
```

genus:

```{r}
system.time({
    en_meta_TMS_BSDB_intersect_gn <- map(
        metasigs_gn,
        ~ microbeSetEnrichment(.x, bk_meta_TMS_BSDB_intersect_gn, bp_sigs_gn)
        ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        )) 
        # filter(fdr < 0.1)
    colnames(en_meta_TMS_BSDB_intersect_gn) <- sub(
        "Set", "BSDB", colnames(en_meta_TMS_BSDB_intersect_gn)
    )
})
```

species:

```{r}
system.time({
    en_meta_TMS_BSDB_intersect_sp <- map(
        metasigs_sp,
        ~ microbeSetEnrichment(.x, bk_meta_TMS_BSDB_intersect_sp, bp_sigs_sp)
        ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        )) 
        # filter(fdr < 0.1)
    colnames(en_meta_TMS_BSDB_intersect_sp) <- sub(
        "Set", "BSDB", colnames(en_meta_TMS_BSDB_intersect_sp)
    )
})
```

```{r}
en_meta_TMS_BSDB_intersect <- bind_rows(
    en_meta_TMS_BSDB_intersect_gn, en_meta_TMS_BSDB_intersect_sp
    ) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```

## Enrichment metasignatures - Bacgkround: TMS + BSDB intersect by body site

```{r}
metasigs_BS_gn <- vector("list", length(body_sites))
for (i in seq_along(metasigs_BS_gn)) {
   rx <- paste0("^", body_sites[i], "-%-%-", "genus")
   sigsL <- metasigs_gn[grep(rx, names(metasigs_gn))]
   names(sigsL) <- names(metasigs_gn)[grep(rx, names(metasigs_gn))]
   if (is.null(sigsL)) {
       next
   }
   metasigs_BS_gn[[i]] <- sigsL
   names(metasigs_BS_gn)[i] <- body_sites[i]
}

metasigs_BS_sp <- vector("list", length(body_sites))
for (i in seq_along(metasigs_BS_sp)) {
   rx <- paste0("^", body_sites[i], "-%-%-", "species")
   sigsL <- metasigs_sp[grep(rx, names(metasigs_sp))]
   names(sigsL) <- names(metasigs_sp)[grep(rx, names(metasigs_sp))]
   if (is.null(sigsL)) {
       next
   }
   metasigs_BS_sp[[i]] <- sigsL
   names(metasigs_BS_sp)[i] <- body_sites[i]
}
```


```{r}
meta_l1 <- map(body_sites, ~ {
    x <- unique(unlist(metasigs_BS_gn[[.x]]))
    y <- tms_sigs_gn[[.x]]
    xy <- intersect(x, y)
    x_ <- setdiff(x, xy)
    y_ <- setdiff(y, xy)
    list(
        bsdb_only = x_,
        tms_only = y_,
        both = xy
    )
})
names(meta_l1) <- body_sites
bk_meta_TMS_BSDB_BS_intersect_gn <- map(meta_l1, ~ .x$both)

meta_l2 <- map(body_sites, ~ {
    x <- unique(unlist(metasigs_BS_sp[[.x]]))
    y <- tms_sigs_sp[[.x]]
    xy <- intersect(x, y)
    x_ <- setdiff(x, xy)
    y_ <- setdiff(y, xy)
    list(
        bsdb_only = x_,
        tms_only = y_,
        both = xy
    )
})
names(meta_l2) <- body_sites
bk_meta_TMS_BSDB_BS_intersect_sp <- map(meta_l2, ~ .x$both)
```

```{r}
system.time({
    en_meta_TMS_BSDB_BS_intersect_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_meta_TMS_BSDB_BS_intersect_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_gn[grep(rx, names(metasigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_meta_TMS_BSDB_BS_intersect_gn[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_intersect_gn <- bind_rows(en_meta_TMS_BSDB_BS_intersect_gn)
})
```

```{r}
system.time({
    en_meta_TMS_BSDB_BS_intersect_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_meta_TMS_BSDB_BS_intersect_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_sp[grep(rx, names(metasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c(
                    "body_site", "rank", "direction", "condition"
                ),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"),
                .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub(
                "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
            ))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_meta_TMS_BSDB_BS_intersect_sp[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_intersect_sp <- bind_rows(en_meta_TMS_BSDB_BS_intersect_sp)
})
```

```{r}
en_meta_TMS_BSDB_BS_intersect <- bind_rows(
    en_meta_TMS_BSDB_BS_intersect_gn, en_meta_TMS_BSDB_BS_intersect_sp
    ) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```


## Enrichment metasignatures - Background: TMS + 1BSDB by body site

```{r}
metasigs <- c(metasigs_gn, metasigs_sp)
bk_meta_TMS_1BSDB_BS <- vector("list", length(metasigs)) 
for (i in seq_along(bk_meta_TMS_1BSDB_BS)) {
    sig_name <- names(metasigs)[i]
    names(bk_meta_TMS_1BSDB_BS)[i] <- sig_name
    bodysite_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\1", sig_name)
    rank_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\2", sig_name)
    tms_sig_name <- paste0(bodysite_name, "_", rank_name)
    bk_meta_TMS_1BSDB_BS[[i]] <- unique(
        c(as.character(bsdb_sigs[[i]]), as.character(tms_sigs[[tms_sig_name]]))
    )
}
```

Enrichment at the genus level:

```{r}
system.time({
    bk_meta_TMS_1BSDB_BS_gn <- bk_meta_TMS_1BSDB_BS[names(metasigs_gn)]
    en_meta_TMS_1BSDB_BS_gn <- map2(metasigs_gn, bk_meta_TMS_1BSDB_BS_gn, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_gn)
    }) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c(
                "body_site", "rank", "direction", "condition"
            ), sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
    colnames(en_meta_TMS_1BSDB_BS_gn) <- sub(
        "Set", "BSDB", colnames(en_meta_TMS_1BSDB_BS_gn)
    )
})
```

Enrichment at the species level:

```{r}
system.time({
    bk_meta_TMS_1BSDB_BS_sp <- bk_meta_TMS_1BSDB_BS[names(metasigs_sp)]
    en_meta_TMS_1BSDB_BS_sp <- map2(metasigs_sp, bk_meta_TMS_1BSDB_BS_sp, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_sp)
    }) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c(
                "body_site", "rank", "direction", "condition"
            ), sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        ))
    colnames(en_meta_TMS_1BSDB_BS_sp) <- sub(
        "Set", "BSDB", colnames(en_meta_TMS_1BSDB_BS_sp)
    )
})
```

```{r}
en_meta_TMS_1BSDB_BS <- bind_rows(
    en_meta_TMS_1BSDB_BS_gn, en_meta_TMS_1BSDB_BS_sp
    ) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```

## Combine results metasigantures

```{r}
meta_results <- list(
    ## Union of all BugSigDB signatures
    BSDB = en_meta_BSDB,
    ## Union of all BugSigDB signatures by body site
    BSDB_BS = en_meta_BSDB_BS,
    ## Union of all typical and BugSigDB signatures
    TMS_BSDB = en_meta_TMS_BSDB,
    ## Union of all typical and BugSigDB signatures by body site
    TMS_BSDB_BS = en_meta_TMS_BSDB_BS,
    ## Intersection of all typicial and BugSigDB signatures 
    TMS_BSDB_intersect = en_meta_TMS_BSDB_intersect,
    ## Intersection of all typical and BugSigDB signatures by body site
    TMS_BSDB_BS_intersect = en_meta_TMS_BSDB_BS_intersect,
    ## Intersection of typical and target signature by body site
    TMS_1BSDB_BS = en_meta_TMS_1BSDB_BS 
) |> 
    # map(~ mutate(.x, fdr = p.adjust(p_value))) |> 
    map(~ mutate(.x, combination = paste0(
        body_site, "-#-#-", direction, "-#-#-", rank, "-#-#-",
        condition, "-#-#-", sig_name)
    ))

```

## Heatmaps metasignatures

```{r}
meta_lmat_down = map(meta_results, ~ createMat(.x, dir = "decreased"))
meta_lmat_up = map(meta_results, ~ createMat(.x, dir = "increased"))
max_count <- max(unlist(c(meta_lmat_down, meta_lmat_up)))
color_fun <- circlize::colorRamp2(
    breaks = c(0, seq(1, max_count)), 
    colors = c("white", viridis::viridis(max_count))
)
```

```{r, warning=FALSE, fig.height=30, fig.width=10}
meta_ht_comb_up <- combinationHt(meta_lmat_up)
draw(meta_ht_comb_up, column_title = "Increased")
```

```{r, warning=FALSE, fig.height=30, fig.width=10}
meta_ht_comb_down <- combinationHt(meta_lmat_down)
draw(meta_ht_comb_down, column_title = "decreased")
```

# Extra functions


# Session info

```{r}
sessioninfo::session_info()
```
