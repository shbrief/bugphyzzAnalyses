---
title: "High-throughput ORA with BSDB signatures"
output:
    html_document:
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(bugsigdbr)
library(dplyr)
library(purrr)
library(tidyr)
library(ComplexHeatmap)
library(gridExtra)
```

## Data

TypicalMicrobiomeSignatures:


```{r, message=FALSE}
tms <- importTMS() |> 
    filter(`Age group` == "adult")
glimpse(tms, 50)
```

BugSigDB:

```{r, message=FALSE}
bsdb_doi <- "10.5281/zenodo.10627578" # v1.2.1
# bsdb_doi <-  "10.5281/zenodo.10407666" #v1.2.0
# bsdb_doi <-  "10.5281/zenodo.6468009" #v1.1.0
bsdb <- importBugSigDB(version = bsdb_doi)
bsdb <- bsdb |> 
    filter(`Host species` == "Homo sapiens") |> 
    filter(!is.na(`Abundance in Group 1`)) |> 
    filter(!is.na(`Body site`)) |> 
    filter(`Study design` == "case-control" ) |> 
    filter(
        !grepl("(child|infant)", `Group 1 name`, ignore.case = TRUE)
    )
dim(bsdb)
```

BugSigDB subsets by body site:

```{r, message=FALSE}
uberon <- getOntology(onto = "uberon")
body_sites <- unique(tms$`Body site`)
bsdb_subsets_by_bodysite <- vector("list", length(body_sites))
names(bsdb_subsets_by_bodysite) <- body_sites
for (i in seq_along(bsdb_subsets_by_bodysite)) {
    if (body_sites[i] == "skin") {
        bsdb_subsets_by_bodysite[[i]] <- bsdb |> 
            filter(grepl(body_sites[i], `Body site`, ignore.case = TRUE))
    } else {
        bsdb_subsets_by_bodysite[[i]] <- subsetByOntology(
            bsdb, column = "Body site", term = body_sites[i], ontology = uberon 
        )
        
    }
}
```

Bugphyzz:

```{r, message=FALSE}
bp <- importBugphyzz()
names(bp)
```

## Signatures

BugSigDB signatures:

```{r}
ranks <- c("genus", "species")
directions <- c("increased", "decreased")
bsdb_sigs <- vector(
    mode = "list", 
    length = length(body_sites) * length(ranks) * length(directions)
)
counter <- 1
for (i in seq_along(body_sites)) {
    for (j in seq_along(ranks)) {
        for (k in seq_along(directions)) {
            myDF <- bsdb_subsets_by_bodysite[[i]] |> 
                filter(`Abundance in Group 1` == directions[k])
            sigs <- getSignatures(
                df = myDF,
                tax.id.type = "ncbi", tax.level = ranks[j],
                exact.tax.level = FALSE, min.size = 5
            ) |>  
                discard(~ length(.x) < 5)
            if (!length(sigs)) {
                counter <- counter + 1
                next
            }
            bsdb_id <- sub(
                pattern = "^(bsdb:[0-9]+/[0-9]+/[0-9]+)_.*$",
                replacement = "\\1",
                x = names(sigs)
            )
            
            pos <- map_int(bsdb_id, ~ which(myDF$`BSDB ID` == .x))
            new_sigs_names <- paste0(
                body_sites[i], "-%-%-", ranks[j], "-%-%-", directions[k], "-%-%-",
                tolower(myDF$Condition[pos]), "-%-%-",
                names(sigs)
            )
            names(sigs) <- new_sigs_names
            bsdb_sigs[[counter]] <- sigs
            counter <- counter + 1
        }
    }
}
bsdb_sigs <- list_flatten(bsdb_sigs)
bsdb_sigs <- discard(bsdb_sigs, is.null)
```

bugphyzz signatures:

```{r, warning=FALSE}
bp_sigs_gn <- map(bp, ~ {
    makeSignatures(
        dat = .x, tax_id_type = "NCBI_ID", tax_level = "genus", min_size = 5,
        evidence = c("exp", "igc", "nas", "tas", "tax", "asr")
    )
}) |> 
    discard(is.null) |> 
    list_flatten(name_spec = "{inner}") |> 
    map(as.character)
names(bp_sigs_gn) <- paste0(names(bp_sigs_gn), "|genus")
    
bp_sigs_sp <- map(bp, ~ {
    makeSignatures(
        dat = .x, tax_id_type = "NCBI_ID", tax_level = "species", min_size = 5,
        evidence = c("exp", "igc", "nas", "tas", "tax", "asr")
    )
}) |> 
    discard(is.null) |> 
    list_flatten(name_spec = "{inner}") |> 
    map(as.character)
names(bp_sigs_sp) <- paste0(names(bp_sigs_sp), "|species")
bp_sigs <- c(bp_sigs_gn, bp_sigs_sp)
```

Typical Microbiome Signatures:

```{r}
body_sites <- c("skin", "vagina", "mouth", "feces")
ranks <- c("genus", "species")
thrs <- elbows()
tms_sigs <- vector("list", length(body_sites) * length(ranks))
counter <- 1
for (i in seq_along(body_sites)) {
    for (j in seq_along(ranks)) {
        tms_name <- paste0(body_sites[i], "_", ranks[j])
        names(tms_sigs)[counter] <- tms_name
        print(tms_name)
        tms_sigs[[counter]] <- tms |> 
            filter(`Body site` == body_sites[i], Rank == ranks[j]) |> 
            filter(Prevalence >= thrs[tms_name]) |> 
            pull(`NCBI ID`)
        counter <- counter + 1
    }
}

tms_sigs_gn <- tms_sigs[grep("genus", names(tms_sigs))]
tms_sigs_sp <- tms_sigs[grep("species", names(tms_sigs))]

names(tms_sigs_gn) <- sub("_genus", "", names(tms_sigs_gn))
names(tms_sigs_sp) <- sub("_species", "", names(tms_sigs_sp))
```

## Enrichment | Background = BSDB

Background:

```{r}
bsdb_sigs_gn <- bsdb_sigs[grep("-%-%-genus-%-%-", names(bsdb_sigs))]
bsdb_sigs_sp <- bsdb_sigs[grep("-%-%-species-%-%-", names(bsdb_sigs))]
bk_BSDB_gn <- unique(unlist(bsdb_sigs_gn))
bk_BSDB_sp <- unique(unlist(bsdb_sigs_sp))
```

Enrichment at the genus level:

```{r}
system.time({
    en_BSDB_gn <- map(bsdb_sigs_gn, ~ microbeSetEnrichment(.x, bk_BSDB_gn, bp_sigs_gn)) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name)) |> 
        filter(fdr < 0.1)
    colnames(en_BSDB_gn) <- sub("Set", "BSDB", colnames(en_BSDB_gn))
})
```

Enrichment at the species level:

```{r}
system.time({
    en_BSDB_sp <- map(bsdb_sigs_sp, ~ microbeSetEnrichment(.x, bk_BSDB_sp, bp_sigs_sp)) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name)) |> 
        filter(fdr < 0.1)
    colnames(en_BSDB_sp) <- sub("Set", "BSDB", colnames(en_BSDB_sp))
})
```

## Enrichment | Background = BSDB by Body site

Enrichment at the genus level:

```{r}
system.time({
    bk_BSDB_BS_sp <- vector("list", length(body_sites))
    names(bk_BSDB_BS_sp) <- body_sites
    for (i in seq_along(bk_BSDB_BS_sp)) {
        res <- bsdb_sigs_sp[grepl(body_sites[[i]], names(bsdb_sigs_sp))]
        if (is.null(res)) {
            next
        }
        bk_BSDB_BS_sp[[i]] <- unique(unlist(res))
    }
    
    en_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_sp[grep(rx, names(bsdb_sigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_BSDB_BS_sp[[i]] <- res
    }
    en_BSDB_BS_sp <- bind_rows(en_BSDB_BS_sp)
})
```

Enrichment at the genus level:

```{r}
system.time({
    bk_BSDB_BS_gn <- vector("list", length(body_sites))
    names(bk_BSDB_BS_gn) <- body_sites
    for (i in seq_along(bk_BSDB_BS_gn)) {
        res <- bsdb_sigs_gn[grepl(body_sites[[i]], names(bsdb_sigs_gn))]
        if (is.null(res)) {
            next
        }
        bk_BSDB_BS_gn[[i]] <- unique(unlist(res))
    }
    en_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_gn[grep(rx, names(bsdb_sigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_BSDB_BS_gn[[i]] <- res
    }
    en_BSDB_BS_gn <- bind_rows(en_BSDB_BS_gn)
})
```

## Enrichemnt | Background = TMS + BSDB

Enrichemtn at the genus level:

```{r}
system.time({
    bk_TMS_BSDB_gn <- unique(unlist(c(tms_sigs_gn, bsdb_sigs_gn)))
    en_TMS_BSDB_gn <- map(bsdb_sigs_gn, ~ microbeSetEnrichment(.x, bk_TMS_BSDB_gn, bp_sigs_gn)) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name))
    colnames(en_TMS_BSDB_gn) <- sub("Set", "BSDB", colnames(en_TMS_BSDB_gn))
})
```

Enrichment at the species level:

```{r}
system.time({
    bk_TMS_BSDB_sp <- unique(unlist(c(tms_sigs_sp, bsdb_sigs_sp)))
    en_TMS_BSDB_sp <- map(bsdb_sigs_sp, ~ microbeSetEnrichment(.x, bk_TMS_BSDB_sp, bp_sigs_sp)) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name))
    colnames(en_TMS_BSDB_sp) <- sub("Set", "BSDB", colnames(en_TMS_BSDB_sp))
})
```

## Enrichment | Background = TMS by Body site + BSDB by Body site

Enrichment at the genus level:

```{r}
bk_TMS_BSDB_BS_gn <- map2(
    tms_sigs_gn[body_sites], bk_BSDB_BS_gn[body_sites], ~ unique(c(.x, .y))
)
system.time({
    en_TMS_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_sp[grep(rx, names(bsdb_sigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_TMS_BSDB_BS_gn[[i]] <- res
    }
    en_TMS_BSDB_BS_gn <- bind_rows(en_TMS_BSDB_BS_gn)
})
```

Enrichment at the species level:

```{r}
bk_TMS_BSDB_BS_sp <- map2(
    tms_sigs_sp[body_sites], bk_BSDB_BS_sp[body_sites], ~ unique(c(.x, .y))
)
system.time({
    en_TMS_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_sp[grep(rx, names(bsdb_sigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            bind_rows(.id = "bsdb_sig") |> 
            separate(
                col = "bsdb_sig",
                into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
                sep = "-%-%-", remove = TRUE 
            ) |> 
            mutate(condition = tolower(condition)) |> 
            mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
            mutate_at(
                .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
            ) |> 
            mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name))
        colnames(res) <- sub("Set", "BSDB", colnames(res))
        en_TMS_BSDB_BS_sp[[i]] <- res
    }
    en_TMS_BSDB_BS_sp <- bind_rows(en_TMS_BSDB_BS_sp)
})
```

## Enrichment | Background = TMS intersect with BSDB

Intersection at the genus level:

```{r}
tms_gn_x = unique(unlist(tms_sigs_gn))
bsdb_gn_y = unique(unlist(bsdb_sigs_gn))
tms_bsdb_gn_xy <- intersect(tms_gn_x, bsdb_gn_y)
data.frame(
    tms_genus_only = length(setdiff(tms_gn_x, tms_bsdb_gn_xy)),
    bsdb_genus_only = length(setdiff(bsdb_gn_y, tms_bsdb_gn_xy)),
    tms_bsdb_genus_intersect = length(tms_bsdb_gn_xy)
)
```


Enrichment at the genus level:

```{r}
bk_TMS_BSDB_intersect_gn <- tms_bsdb_gn_xy
system.time({
    en_TMS_BSDB_intersect_gn <- map(
        bsdb_sigs_gn,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_gn, bp_sigs_gn)
        ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name)) |> 
        filter(fdr < 0.1)
    colnames(en_TMS_BSDB_intersect_gn) <- sub(
        "Set", "BSDB", colnames(en_TMS_BSDB_intersect_gn)
    )
})
```

Intersection at the species level

```{r}
tms_sp_x = unique(unlist(tms_sigs_sp))
bsdb_sp_y = unique(unlist(bsdb_sigs_sp))
tms_bsdb_sp_xy <- intersect(tms_sp_x, bsdb_sp_y)
data.frame(
    tms_species_only = length(setdiff(tms_sp_x, tms_bsdb_sp_xy)),
    bsdb_species_only = length(setdiff(bsdb_sp_y, tms_bsdb_sp_xy)),
    tms_bsdb_species_intersect = length(tms_bsdb_sp_xy)
)
```


Enrichment at the species level:


```{r}
bk_TMS_BSDB_intersect_sp <- tms_bsdb_sp_xy
system.time({
    en_TMS_BSDB_intersect_sp <- map(
        bsdb_sigs_sp,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_sp, bp_sigs_sp)
        ) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name)) |> 
        filter(fdr < 0.1)
    colnames(en_TMS_BSDB_intersect_sp) <- sub(
        "Set", "BSDB", colnames(en_TMS_BSDB_intersect_sp)
    )
})
```

## Enrichment | Background = TMS intersect with BSDB by body site

Intersection by body site at the genus level:

```{r}
bk_TMS_BSDB_BS_intersect_gn <- vector("list", length(body_sites))
for (i in seq_along(body_sites)) {
    sigs <- unique(unlist(bsdb_sigs_gn[grep(body_sites[i], names(bsdb_sigs_gn))])
}



tms_sigs_gn

map2()






bk_BSDB_BS_sp <- vector("list", length(body_sites))
    names(bk_BSDB_BS_sp) <- body_sites
    for (i in seq_along(bk_BSDB_BS_sp)) {
        res <- bsdb_sigs_sp[grepl(body_sites[[i]], names(bsdb_sigs_sp))]
        if (is.null(res)) {
            next
        }
        bk_BSDB_BS_sp[[i]] <- unique(unlist(res))
    }




```







```{r}
background_sigs_l <- vector("list", length(body_sites) * length(ranks))
counter <- 1
for (i in seq_along(body_sites)) {
    for (j in seq_along(ranks)) {
        tms_sig_name <- paste0(body_sites[i], "_", ranks[j])
        bsdb_sig_rgx <- paste0("^", body_sites[i], "-%-%-", ranks[j])
        names(background_sigs_l)[counter] <- tms_sig_name
        
        x <- tms_sigs[[tms_sig_name]]
        y <- unique(unlist(bsdb_sigs[grep(bsdb_sig_rgx, names(bsdb_sigs))], use.names = FALSE))
        
        background_sigs_l[[counter]] <- tibble::tribble(
            ~tms, ~bsdb, ~both,
            length(setdiff(x, y)), length(setdiff(y, x)), length(intersect(x, y))
        )
        
        counter <- counter + 1
    }
}
bk_dat <- bind_rows(background_sigs_l, .id = "bodysite_rank")
bk_dat
```

## Enrichment | Background = TMS by Body site + 1 BSDB sig

Background:

```{r}
bk_TMS_1BSDB_BS <- vector("list", length(bsdb_sigs)) 
for (i in seq_along(bk_TMS_1BSDB_BS)) {
    sig_name <- names(bsdb_sigs)[i]
    names(bk_TMS_1BSDB_BS)[i] <- sig_name
    bodysite_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\1", sig_name)
    rank_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\2", sig_name)
    tms_sig_name <- paste0(bodysite_name, "_", rank_name)
    bk_TMS_1BSDB_BS[[i]] <- unique(
        c(as.character(bsdb_sigs[[i]]), as.character(tms_sigs[[tms_sig_name]]))
    )
}
```

Enrichment at the genus level:

```{r}
system.time({
    bk_TMS_1BSDB_BS_gn <- bk_TMS_1BSDB_BS[names(bsdb_sigs_gn)]
    en_TMS_1BSDB_BS_gn <- map2(bsdb_sigs_gn, bk_TMS_1BSDB_BS_gn, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_gn)
    }) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c(
                "body_site", "rank", "direction", "condition", "bsdb_sig"
            ), sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name))
    colnames(en_TMS_1BSDB_BS_gn) <- sub("Set", "BSDB", colnames(en_TMS_1BSDB_BS_gn))
})
```

Enrichment at the species level:

```{r}
system.time({
    bk_TMS_1BSDB_BS_sp <- bk_TMS_1BSDB_BS[names(bsdb_sigs_sp)]
    en_TMS_1BSDB_BS_sp <- map2(bsdb_sigs_sp, bk_TMS_1BSDB_BS_sp, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_sp)
    }) |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c(
                "body_site", "rank", "direction", "condition", "bsdb_sig"
            ), sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"), .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub("^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name))
    colnames(en_TMS_1BSDB_BS_sp) <- sub("Set", "BSDB", colnames(en_TMS_1BSDB_BS_sp))
})
```


## Grouping

```{r}
fname <- system.file(
    'extdata', 'condition2category.tsv', package = 'bugphyzzAnalyses',
    mustWork = TRUE
)
cond2cat <- read.table(fname, header = TRUE, sep = '\t')
```

```{r}
en_tbl <- bind_rows(en_gn_df, en_sp_df) |>
    # group_by(rank) |>
    mutate(
        `BSDB ID` = sub("^(bsdb:[0-9]+/[0-9]+/[0-9]+)_.*", "\\1", bsdb_sig)
    ) |> 
    mutate(
        fdr = round(p.adjust(p_value, method = "fdr"), 3)
    ) |>
    # ungroup() |>
    left_join(cond2cat, by = c("condition" = "Condition")) |> 
    left_join(
        select(
            bsdb, `BSDB ID`,
            control = `Group 0 name`, treatment = `Group 1 name`
        ),
        by = "BSDB ID"
    ) |>
    mutate(
        sig_name = sub("^bugphyzz:(.*)\\|(genus|species)", "\\1", sig_name),
        Category = ifelse(is.na(Category), "other", Category)
    ) |> 
    relocate(`BSDB ID`) |> 
    relocate(control, .after = "condition") |> 
    relocate(treatment, .after = "control") |> 
    relocate(bsdb_sig, .after = last_col())
en_up <- filter(en_tbl, direction == "increased") |> 
    filter(fdr < 0.1)
en_down <- filter(en_tbl, direction == "decreased") |> 
    filter(fdr < 0.1)
```

## Table up

```{r}
length(unique(en_up$bsdb_sig))
length(unique(en_up$sig_name))
count(en_up, Category)
```



```{r}
myDataTable(en_up, page_len = 30)
```

## Heatmap UP

```{r}
dat <- en_tbl |> 
    select(body_site, rank, direction, condition, Category) |> 
    unique() |> 
    arrange()
dat_up <- filter(dat, direction == "increased")
dat_down <- filter(dat, direction == "decreased")
```

Data:

```{r}
## Summary for top column barplot annotations -- condition category
summary_category_up <- dat_up |> 
    filter(!is.na(Category)) |> 
    count(Category, name = 'category_total') |> 
    arrange(-category_total) |> 
    filter(Category %in% en_up$Category)

## Summary for top column barplot annotations -- body site
summary_bodysite_up <- dat_up |> 
    filter(!is.na(body_site)) |> 
    count(body_site, name = 'bodysite_total') |> 
    arrange(-bodysite_total) |> 
    filter(body_site %in% en_up$body_site)

## Frequency for row annotations -- frequency of enriched physiologies (attrbute_group) by genus
summary_up_freq <- en_up |> 
    count(sig_name, rank) |> 
    pivot_wider(
        names_from = 'rank', values_from = 'n', values_fill = 0
    ) |> mutate(freq = genus + species) |>
    arrange(-freq) |> 
    mutate(sig_name = forcats::fct_inorder(sig_name)) |>
    tibble::column_to_rownames(var = 'sig_name') |>
    select(-freq)

## Create first matrix with condition categories
mat_condition_up <- en_up |> 
    select(sig_name, Category, bsdb_sig) |> 
    count(sig_name, Category, name = "n_enrich") |> 
    left_join(summary_category_up, by = "Category") |> 
    mutate(per = round(n_enrich / category_total * 100)) |> 
    select(-n_enrich, -category_total) |> 
    pivot_wider(
        names_from = 'Category', values_from = 'per', values_fill = 0
    ) |> 
    as.data.frame() |> 
    tibble::column_to_rownames(var = 'sig_name') |> 
    as.matrix()
mat_condition_up <- mat_condition_up[,summary_category_up$Category]
mat_condition_up <- mat_condition_up[rownames(summary_up_freq),]
    
## Create second matrix with body sites
mat_bodysite_up <- en_up |> 
    select(sig_name, body_site, bsdb_sig) |> 
    count(sig_name, body_site, name = 'n_enrich') |> 
    left_join(summary_bodysite_up, by = 'body_site') |> 
    mutate(per = round(n_enrich / bodysite_total * 100)) |>
    select(-n_enrich, -bodysite_total) |> 
    pivot_wider(
        names_from = 'body_site', values_from = 'per', values_fill = 0
    ) |> 
    as.data.frame() |> 
    tibble::column_to_rownames(var = 'sig_name') |> 
    as.matrix()
mat_bodysite_up <- mat_bodysite_up[,summary_bodysite_up$body_site]
mat_bodysite_up <- mat_bodysite_up[rownames(summary_up_freq),]
```

Heatmap:

```{r, fig.height=13, fig.width=10}

color_fun <- function(x) {
    circlize::colorRamp2(
        breaks = c(0, seq(1, x, 1)),
        colors = c("white", viridis::viridis(
            n = x
            # n = x, begin = 0, option = "C", direction = -1
        ))
    )
}

anno_width = unit(2, 'cm')
col_anno_category <- columnAnnotation(
    "# bsdb sigs" = anno_barplot(
        summary_category_up$category_total,
        bar_width = 1, gp = gpar(fill = "#009E73"),
        height = anno_width),
    show_annotation_name = TRUE,
    annotation_name_side = "left"
)
col_anno_bodysite <- columnAnnotation(
    "bs" = anno_barplot(
        summary_bodysite_up$bodysite_total, bar_width = 1, 
        gp = gpar(fill = "#009E73"),
        height = anno_width),
    show_annotation_name = FALSE
)
ht1_up <- Heatmap(
    matrix = mat_condition_up,
    cluster_rows = FALSE, cluster_columns = FALSE,
    row_names_side = 'left',
    show_heatmap_legend = FALSE,
    col = color_fun(max(mat_condition_up)),
    column_names_rot = 45,
    column_title = "Condition category",
    row_names_max_width = max_text_width(
        rownames(mat_condition_up),
        gp = gpar(fontsize = 12)
    ),
    top_annotation = col_anno_category,
    border = TRUE,
    rect_gp = gpar(col = "gray50", lwd = 1)
)
ht2_up <- Heatmap(
    matrix = mat_bodysite_up,
    cluster_rows = FALSE, cluster_columns = FALSE,
    row_names_side = 'left',
    show_heatmap_legend = TRUE,
    name = '%',
    col = color_fun(max(mat_bodysite_up)),
    column_names_rot = 45,
    column_title = "Body site",
    row_names_max_width = max_text_width(
        rownames(mat_bodysite_up),
        gp = gpar(fontsize = 12)
    ),
    top_annotation = col_anno_bodysite,
    border = TRUE,
    rect_gp = gpar(col = "gray50", lwd = 1)
)
rank_col <- c(genus = 'gray50', species = 'gray80')

row_anno_up <- rowAnnotation(
    "# bsdb sigs" = anno_barplot(
        summary_up_freq, bar_width = 1,
        gp = gpar(fill = rank_col), width = unit(3, 'cm')),
    show_annotation_name = TRUE 
)
ht_list_up <- ht1_up + ht2_up + row_anno_up
lgd_list <- list(
    Legend(labels = names(rank_col), title = "Rank",
        legend_gp = gpar(fill = rank_col))
)
p1 <- grid.grabExpr(draw(
    ht_list_up, ht_gap = unit(c(1, 0.1), "cm"),
    heatmap_legend_side = 'right',
    heatmap_legend_list = lgd_list
))
grid.arrange(p1)
```

## Table Down

```{r}
length(unique(en_down$bsdb_sig))
length(unique(en_down$sig_name))
count(en_down, Category)
```

```{r}
myDataTable(en_down, page_len = 30)
```

## Heatmap Down

Data:

```{r}
## Summary for top column barplot annotations -- condition category
summary_category_down <- dat_down |> 
    filter(!is.na(Category)) |> 
    count(Category, name = 'category_total') |> 
    arrange(-category_total) |> 
    filter(Category %in% en_down$Category)

## Summary for top column barplot annotations -- body site
summary_bodysite_down <- dat_down |> 
    filter(!is.na(body_site)) |> 
    count(body_site, name = 'bodysite_total') |> 
    arrange(-bodysite_total) |> 
    filter(body_site %in% en_down$body_site)

## Frequency for row annotations -- frequency of enriched physiologies (attrbute_grodown) by genus
summary_down_freq <- en_down |> 
    count(sig_name, rank) |> 
    pivot_wider(
        names_from = 'rank', values_from = 'n', values_fill = 0
    ) |> mutate(freq = genus + species) |>
    arrange(-freq) |> 
    mutate(sig_name = forcats::fct_inorder(sig_name)) |>
    tibble::column_to_rownames(var = 'sig_name') |>
    select(-freq)

## Create first matrix with condition categories
mat_condition_down <- en_down |> 
    select(sig_name, Category, bsdb_sig) |> 
    count(sig_name, Category, name = "n_enrich") |> 
    left_join(summary_category_down, by = "Category") |> 
    mutate(per = round(n_enrich / category_total * 100)) |> 
    select(-n_enrich, -category_total) |> 
    pivot_wider(
        names_from = 'Category', values_from = 'per', values_fill = 0
    ) |> 
    as.data.frame() |> 
    tibble::column_to_rownames(var = 'sig_name') |> 
    as.matrix()
mat_condition_down <- mat_condition_down[,summary_category_down$Category]
mat_condition_down <- mat_condition_down[rownames(summary_down_freq),]
    
## Create second matrix with body sites
mat_bodysite_down <- en_down |> 
    select(sig_name, body_site, bsdb_sig) |> 
    count(sig_name, body_site, name = 'n_enrich') |> 
    left_join(summary_bodysite_down, by = 'body_site') |> 
    mutate(per = round(n_enrich / bodysite_total * 100)) |>
    select(-n_enrich, -bodysite_total) |> 
    pivot_wider(
        names_from = 'body_site', values_from = 'per', values_fill = 0
    ) |> 
    as.data.frame() |> 
    tibble::column_to_rownames(var = 'sig_name') |> 
    as.matrix()
mat_bodysite_down <- mat_bodysite_down[,summary_bodysite_down$body_site]
mat_bodysite_down <- mat_bodysite_down[rownames(summary_down_freq),]
```

Heatmap:

```{r, fig.height=10, fig.width=9}
# lgd <- Legend(col_fun = color_fun, title = "% (col)")
anno_width = unit(2, 'cm')
col_anno_category <- columnAnnotation(
    "# bsdb sigs" = anno_barplot(
        summary_category_down$category_total,
        bar_width = 1, gp = gpar(fill = "#009E73"),
        height = anno_width),
    show_annotation_name = TRUE,
    annotation_name_side = "left"
)
col_anno_bodysite <- columnAnnotation(
    "bs" = anno_barplot(
        summary_bodysite_down$bodysite_total, bar_width = 1,
        gp = gpar(fill = "#009E73"),
        height = anno_width),
    show_annotation_name = FALSE
)
ht1_down <- Heatmap(
    matrix = mat_condition_down,
    cluster_rows = FALSE, cluster_columns = FALSE,
    row_names_side = 'left',
    show_heatmap_legend = FALSE,
    col = color_fun(max(mat_condition_down)),
    column_names_rot = 45,
    column_title = "Condition category",
    row_names_max_width = max_text_width(
        rownames(mat_condition_down),
        gp = gpar(fontsize = 12)
    ),
    top_annotation = col_anno_category,
    border = TRUE,
    rect_gp = gpar(col = "gray50", lwd = 1)
)
ht2_down <- Heatmap(
    matrix = mat_bodysite_down,
    cluster_rows = FALSE, cluster_columns = FALSE,
    row_names_side = 'left',
    show_heatmap_legend = TRUE,
    name = '%',
    col = color_fun(max(mat_condition_down)),
    column_names_rot = 45,
    column_title = "Body site",
    row_names_max_width = max_text_width(
        rownames(mat_bodysite_down),
        gp = gpar(fontsize = 12)
    ),
    top_annotation = col_anno_bodysite,
    border = TRUE,
    rect_gp = gpar(col = "gray50", lwd = 1)
)
row_anno_down <- rowAnnotation(
    "# bsdb sigs" = anno_barplot(
        summary_down_freq, bar_width = 1,
        gp = gpar(fill = rank_col), width = unit(3, 'cm')),
    show_annotation_name = TRUE 
)
ht_list_down <- ht1_down + ht2_down + row_anno_down
p2 <- grid.grabExpr(draw(
    ht_list_down, ht_gap = unit(c(1, 0.1), "cm"),
    heatmap_legend_side = 'right',
    heatmap_legend_list = lgd_list
))
grid.arrange(p2)
```


## Individual examples

Union:

```{r}
bsdb_ <- bsdb_sigs$`feces-%-%-genus-%-%-decreased-%-%-obesity-%-%-bsdb:74/3/2_obesity:high-BMI_vs_low-BMI_DOWN`
tms_ <- tms_sigs$feces_genus
bp_sig_ <- bp_sigs$`bugphyzz:gram stain|gram stain negative|genus`
bk_ <- unique(c(tms_, bsdb_))
mse <- microbeSetEnrichment(set = bsdb_, reference = bk_, sigs = list(bp_sig = bp_sig_))
mse |> 
    select(ends_with("ted"), p_value, odds_ratio) |> 
    as.list()
```


```{r, eval=FALSE, echo=FALSE}
L <- list(
    `bsdb_74_3_2_feces_down` = bsdb_,
    `tms_feces` = tms_,
    `bugphyzz_gram_negative` = bp_sig_
)
display_venn <- function(x, ...){
  grid.newpage()
  venn_object <- venn.diagram(x, filename = NULL, ...)
  grid.draw(venn_object)
}

display_venn(L)
```

```{r, eval=FALSE, echo=FALSE}
v <- venn.diagram(
    x = L, filename = NULL,
    width = 300, height = 300, resolution = 150
    # cat.col = c("blue", "red", "darkgreen"),
    # fill = c("blue", "red", "darkgreen")
)
ggsave(v, filename = "my_plot.svg", device = "svg")

```


Intersection:

```{r}
bsdb_ <- bsdb_sigs$`feces-%-%-genus-%-%-decreased-%-%-obesity-%-%-bsdb:74/1/2_obesity:obese_vs_non-obese_DOWN`
tms_ <- tms_sigs$feces_genus
bp_sig_ <- bp_sigs$`bugphyzz:gram stain|gram stain negative|genus`
bk_ <- unique(intersect(tms_, bsdb_))
mse <- microbeSetEnrichment(set = bsdb_, reference = bk_, sigs = list(bp_sig = bp_sig_))
mse |> 
    select(ends_with("ted"), p_value, odds_ratio) |> 
    as.list()
```

Super BSDB intersect set:

```{r}
bsdb_ <- bsdb_sigs$`feces-%-%-genus-%-%-decreased-%-%-obesity-%-%-bsdb:74/1/2_obesity:obese_vs_non-obese_DOWN`
tms_ <- tms_sigs$feces_genus
bp_sig_ <- bp_sigs$`bugphyzz:gram stain|gram stain negative|genus`
x_ <- unique(unlist(bsdb_sigs[grep("^feces-%-%-genus", names(bsdb_sigs))]))
bk_ <- unique(intersect(tms_, x_))
mse <- microbeSetEnrichment(set = bsdb_, reference = bk_, sigs = list(bp_sig = bp_sig_))
mse |> 
    select(ends_with("ted"), p_value, odds_ratio) |> 
    as.list()
```

Super BSDB union set

```{r}
bsdb_ <- bsdb_sigs$`feces-%-%-genus-%-%-decreased-%-%-obesity-%-%-bsdb:74/1/2_obesity:obese_vs_non-obese_DOWN`
tms_ <- tms_sigs$feces_genus
bp_sig_ <- bp_sigs$`bugphyzz:gram stain|gram stain negative|genus`
x_ <- unique(unlist(bsdb_sigs[grep("^feces-%-%-genus", names(bsdb_sigs))]))
bk_ <- unique(tms_, x_)
mse <- microbeSetEnrichment(set = bsdb_, reference = bk_, sigs = list(bp_sig = bp_sig_))
mse |> 
    select(ends_with("ted"), p_value, odds_ratio) |> 
    as.list()
```

```{r, fig.height=13, fig.width=20}
# x <- c(rep(1, 520), rep(2, 480))
# lay <- matrix(x, ncol = 100, byrow = FALSE)
# lay[9:10,52:100] <- NA
# grid.arrange(p1, p2, layout_matrix = lay)
```


## Session info

```{r}
sessioninfo::session_info()
```
