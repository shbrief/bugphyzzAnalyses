---
title: "High-throughput ORA with BSDB signatures"
output:
    html_document:
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(bugsigdbr)
library(dplyr)
library(purrr)
library(tidyr)
library(ComplexHeatmap)
library(gridExtra)
library(ggplot2)

body_sites <- c("skin", "vagina", "mouth", "feces")
ranks <- c("genus", "species")
directions <- c("increased", "decreased")
```

# Data

TypicalMicrobiomeSignatures (TMS):

```{r, message=FALSE}
tms <- importTMS() |> 
    filter(`Age group` == "adult")
glimpse(tms, 50)
```

BugSigDB:

```{r, message=FALSE}
bsdb_doi <- "10.5281/zenodo.10627578" # v1.2.1
# bsdb_doi <-  "10.5281/zenodo.10407666" #v1.2.0
# bsdb_doi <-  "10.5281/zenodo.6468009" #v1.1.0
bsdb <- importBugSigDB(version = bsdb_doi)
bsdb <- bsdb |> 
    filter(`Host species` == "Homo sapiens") |> 
    filter(!is.na(`Abundance in Group 1`)) |> 
    filter(!is.na(`Body site`)) |> 
    filter(`Study design` == "case-control" ) |> 
    filter(
        !grepl("(child|infant)", `Group 1 name`, ignore.case = TRUE)
    )
dim(bsdb)
```

BugSigDB subsets by body site:

```{r, message=FALSE}
uberon <- getOntology(onto = "uberon")
body_sites <- unique(tms$`Body site`)
bsdb_subsets_by_bodysite <- vector("list", length(body_sites))
names(bsdb_subsets_by_bodysite) <- body_sites
for (i in seq_along(bsdb_subsets_by_bodysite)) {
    if (body_sites[i] == "skin") {
        bsdb_subsets_by_bodysite[[i]] <- bsdb |> 
            filter(grepl(body_sites[i], `Body site`, ignore.case = TRUE))
    } else {
        bsdb_subsets_by_bodysite[[i]] <- subsetByOntology(
            bsdb, column = "Body site", term = body_sites[i], ontology = uberon 
        )
    }
}
```

Bugphyzz:

```{r, message=FALSE}
bp <- importBugphyzz()
names(bp)
```

# Signatures

BugSigDB signatures:

```{r}
bsdb_sigs <- vector(
    mode = "list", 
    length = length(body_sites) * length(ranks) * length(directions)
)
counter <- 1
for (i in seq_along(body_sites)) {
    for (j in seq_along(ranks)) {
        for (k in seq_along(directions)) {
            myDF <- bsdb_subsets_by_bodysite[[i]] |> 
                filter(`Abundance in Group 1` == directions[k])
            sigs <- getSignatures(
                df = myDF,
                tax.id.type = "ncbi", tax.level = ranks[j],
                exact.tax.level = FALSE, min.size = 5
            ) |>  
                discard(~ length(.x) < 5)
            if (!length(sigs)) {
                counter <- counter + 1
                next
            }
            bsdb_id <- sub(
                pattern = "^(bsdb:[0-9]+/[0-9]+/[0-9]+)_.*$",
                replacement = "\\1",
                x = names(sigs)
            )
            
            pos <- map_int(bsdb_id, ~ which(myDF$`BSDB ID` == .x))
            new_sigs_names <- paste0(
                body_sites[i], "-%-%-", ranks[j], "-%-%-", directions[k],
                "-%-%-", tolower(myDF$Condition[pos]), "-%-%-",
                names(sigs)
            )
            names(sigs) <- new_sigs_names
            bsdb_sigs[[counter]] <- sigs
            counter <- counter + 1
        }
    }
}
bsdb_sigs <- list_flatten(bsdb_sigs)
bsdb_sigs <- discard(bsdb_sigs, is.null)
```

Separate BSDB signatures by body site and rank:

```{r}
bsdb_sigs_BS_gn <- vector("list", length(body_sites))
for (i in seq_along(bsdb_sigs_BS_gn)) {
   rx <- paste0("^", body_sites[i], "-%-%-", "genus")
   sigsL <- bsdb_sigs[grep(rx, names(bsdb_sigs))]
   names(sigsL) <- names(bsdb_sigs)[grep(rx, names(bsdb_sigs))]
   if (is.null(sigsL)) {
       next
   }
   bsdb_sigs_BS_gn[[i]] <- sigsL
   names(bsdb_sigs_BS_gn)[i] <- body_sites[i]
}

bsdb_sigs_BS_sp <- vector("list", length(body_sites))
for (i in seq_along(bsdb_sigs_BS_sp)) {
   rx <- paste0("^", body_sites[i], "-%-%-", "species")
   sigsL <- bsdb_sigs[grep(rx, names(bsdb_sigs))]
   names(sigsL) <- names(bsdb_sigs)[grep(rx, names(bsdb_sigs))]
   if (is.null(sigsL)) {
       next
   }
   bsdb_sigs_BS_sp[[i]] <- sigsL
   names(bsdb_sigs_BS_sp)[i] <- body_sites[i]
}
```

bugphyzz signatures:

```{r, warning=FALSE}
bp_sigs_gn <- map(bp, ~ {
    makeSignatures(
        dat = .x, tax_id_type = "NCBI_ID", tax_level = "genus", min_size = 5,
        evidence = c("exp", "igc", "nas", "tas", "tax", "asr")
    )
}) |> 
    discard(is.null) |> 
    list_flatten(name_spec = "{inner}") |> 
    map(as.character)
names(bp_sigs_gn) <- paste0(names(bp_sigs_gn), "|genus")
    
bp_sigs_sp <- map(bp, ~ {
    makeSignatures(
        dat = .x, tax_id_type = "NCBI_ID", tax_level = "species", min_size = 5,
        evidence = c("exp", "igc", "nas", "tas", "tax", "asr")
    )
}) |> 
    discard(is.null) |> 
    list_flatten(name_spec = "{inner}") |> 
    map(as.character)
names(bp_sigs_sp) <- paste0(names(bp_sigs_sp), "|species")
bp_sigs <- c(bp_sigs_gn, bp_sigs_sp)
```

Typical Microbiome Signatures:

```{r}
thrs <- elbows()
tms_sigs <- vector("list", length(body_sites) * length(ranks))
counter <- 1
for (i in seq_along(body_sites)) {
    for (j in seq_along(ranks)) {
        tms_name <- paste0(body_sites[i], "_", ranks[j])
        names(tms_sigs)[counter] <- tms_name
        print(tms_name)
        tms_sigs[[counter]] <- tms |> 
            filter(`Body site` == body_sites[i], Rank == ranks[j]) |> 
            filter(Prevalence >= thrs[tms_name]) |> 
            pull(`NCBI ID`)
        counter <- counter + 1
    }
}

tms_sigs_gn <- tms_sigs[grep("genus", names(tms_sigs))]
tms_sigs_sp <- tms_sigs[grep("species", names(tms_sigs))]

names(tms_sigs_gn) <- sub("_genus", "", names(tms_sigs_gn))
names(tms_sigs_sp) <- sub("_species", "", names(tms_sigs_sp))
```

# Meta-signatures

Meta-signatures:

```{r}
metasigs_gn_up <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "UP", tax.level = "genus",
        min.studies = 1, exact.tax.level = FALSE
    )
}) |> 
    list_flatten(
        name_spec = "{outer}-%-%-genus-%-%-increased-%-%-{inner}"
    ) |> 
    map(~ names(.x))
metasigs_gn_down <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "DOWN",
        tax.level = "genus", exact.tax.level = FALSE, min.studies = 1
    )
}) |> 
    list_flatten(
        name_spec = "{outer}-%-%-genus-%-%-decreased-%-%-{inner}"
    ) |> 
    map(~ names(.x))

metasigs_sp_up <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "UP",
        tax.level = "species", exact.tax.level = FALSE, min.studies = 1
    ) 
}) |> 
    list_flatten(
        name_spec = "{outer}-%-%-species-%-%-increased-%-%-{inner}"
    ) |> 
    map(~ names(.x))

metasigs_sp_down <- map(bsdb_subsets_by_bodysite, ~ {
    getMetaSignatures(
        df = .x, column = "Condition", direction = "DOWN",
        tax.level = "species", exact.tax.level = FALSE, min.studies = 1
    ) 
}) |> 
    list_flatten(
        name_spec = "{outer}-%-%-species-%-%-decreased-%-%-{inner}"
    ) |> 
    map(~ names(.x))
metasigs_gn <- c(metasigs_gn_up, metasigs_gn_down)
metasigs_sp <- c(metasigs_sp_up, metasigs_sp_down)
```

# ORA with BSDB signatures

Define function fo format enrichment results (sigs)

```{r}
formatEnSigs <- function(l) {
    l |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c("body_site", "rank", "direction", "condition", "bsdb_sig"),
            sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        )) |> 
        {\(y) set_names(y, sub("Set", "BSDB", colnames(y)))}()
}
```

## Background: BSDB

BSDB: Union of all BSDB signatures by rank

```{r}
bsdb_sigs_gn <- bsdb_sigs[grep("-%-%-genus-%-%-", names(bsdb_sigs))]
bsdb_sigs_sp <- bsdb_sigs[grep("-%-%-species-%-%-", names(bsdb_sigs))]
bk_BSDB_gn <- unique(unlist(bsdb_sigs_gn))
bk_BSDB_sp <- unique(unlist(bsdb_sigs_sp))
```

ORA at the genus level:

```{r}
system.time({
    en_BSDB_gn <- map(
        .x = bsdb_sigs_gn,
        .f = ~ microbeSetEnrichment(.x, bk_BSDB_gn, bp_sigs_gn)
    ) |> 
        formatEnSigs()
})
```

ORA at the species level:

```{r}
system.time({
    en_BSDB_sp <- map(
        .x = bsdb_sigs_sp,
        .f = ~ microbeSetEnrichment(.x, bk_BSDB_sp, bp_sigs_sp)
    ) |> 
        formatEnSigs()
})
```

Combine results:

```{r}
en_BSDB <- bind_rows(en_BSDB_gn, en_BSDB_sp)
```

## Background: BSDB_BS

BSDB_BS: Union of all BSDB signatures by body site by rank

```{r}
bk_BSDB_BS_gn <- vector("list", length(body_sites))
names(bk_BSDB_BS_gn) <- body_sites
for (i in seq_along(bk_BSDB_BS_gn)) {
    res <- bsdb_sigs_gn[grep(body_sites[[i]], names(bsdb_sigs_gn))]
    if (is.null(res)) {
        next
    }
    bk_BSDB_BS_gn[[i]] <- unique(unlist(res))
}
bk_BSDB_BS_gn <- discard(bk_BSDB_BS_gn, is.null)

bk_BSDB_BS_sp <- vector("list", length(body_sites))
names(bk_BSDB_BS_sp) <- body_sites
for (i in seq_along(bk_BSDB_BS_sp)) {
    res <- bsdb_sigs_sp[grep(body_sites[[i]], names(bsdb_sigs_sp))]
    if (is.null(res)) {
        next
    }
    bk_BSDB_BS_sp[[i]] <- unique(unlist(res))
}
bk_BSDB_BS_sp <- discard(bk_BSDB_BS_sp, is.null)
```

Enrichment at the genus level:

```{r}
system.time({
    en_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_gn[grep(rx, names(bsdb_sigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnSigs()
        en_BSDB_BS_gn[[i]] <- res
    }
    en_BSDB_BS_gn <- bind_rows(en_BSDB_BS_gn)
})
```

Enrichment at the species level:

```{r}
system.time({
    en_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_sp[grep(rx, names(bsdb_sigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnSigs()
        en_BSDB_BS_sp[[i]] <- res
    }
    en_BSDB_BS_sp <- bind_rows(en_BSDB_BS_sp)
})
```

Combine results

```{r}
en_BSDB_BS <- bind_rows(en_BSDB_BS_gn, en_BSDB_BS_sp)
```

## Background: TMS_BSDB

Background: Union of all taxa in BSDB and TMS by rank

```{r}
bk_TMS_BSDB_gn <- unique(unlist(c(tms_sigs_gn, bsdb_sigs_gn)))
bk_TMS_BSDB_sp <- unique(unlist(c(tms_sigs_sp, bsdb_sigs_sp)))
```

Enrichment at the genus level:

```{r}
## TODO investigate warnings
system.time({
    en_TMS_BSDB_gn <- map(
        .x = bsdb_sigs_gn,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_gn, bp_sigs_gn)
    ) |> 
        formatEnSigs()
})
```

Enrichment at the species level:

```{r}
system.time({
    en_TMS_BSDB_sp <- map(
        .x = bsdb_sigs_sp,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_sp, bp_sigs_sp)
        ) |> 
        formatEnSigs()
})
```

Combine results:

```{r}
en_TMS_BSDB <- bind_rows(en_TMS_BSDB_gn, en_TMS_BSDB_sp)
```

## Background: TMS_BSDB_BS

Backgrounds:

```{r}
bk_TMS_BSDB_BS_gn <- map2(
    tms_sigs_gn[body_sites], bk_BSDB_BS_gn[body_sites], ~ unique(c(.x, .y))
)

bk_TMS_BSDB_BS_sp <- map2(
    tms_sigs_sp[body_sites], bk_BSDB_BS_sp[body_sites], ~ unique(c(.x, .y))
)
```

Enrichment at the genus level:

```{r}
system.time({
    en_TMS_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_gn[grep(rx, names(bsdb_sigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnSigs()
        en_TMS_BSDB_BS_gn[[i]] <- res
    }
    en_TMS_BSDB_BS_gn <- bind_rows(en_TMS_BSDB_BS_gn)
})
```

Enrichment at the species level:

```{r}
## TODO investigate warnings
system.time({
    en_TMS_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_sp[grep(rx, names(bsdb_sigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnSigs()
        en_TMS_BSDB_BS_sp[[i]] <- res
    }
    en_TMS_BSDB_BS_sp <- bind_rows(en_TMS_BSDB_BS_sp)
})
```

Combine results:

```{r}
en_TMS_BSDB_BS <- bind_rows(en_TMS_BSDB_gn, en_TMS_BSDB_sp)
```

## Background: TMS_BSDB_intersect

Intersection at the genus level:

```{r}
tms_gn_x = unique(unlist(tms_sigs_gn))
bsdb_gn_y = unique(unlist(bsdb_sigs_gn))
bk_TMS_BSDB_intersect_gn <- intersect(tms_gn_x, bsdb_gn_y)
data.frame(
    tms_genus_only = length(setdiff(tms_gn_x, bk_TMS_BSDB_intersect_gn)),
    bsdb_genus_only = length(setdiff(bsdb_gn_y, bk_TMS_BSDB_intersect_gn)),
    tms_bsdb_genus_intersect = length(bk_TMS_BSDB_intersect_gn)
)
```

Intersection at the species level:

```{r}
tms_sp_x = unique(unlist(tms_sigs_sp))
bsdb_sp_y = unique(unlist(bsdb_sigs_sp))
bk_TMS_BSDB_intersect_sp <- intersect(tms_sp_x, bsdb_sp_y)
data.frame(
    tms_species_only = length(setdiff(tms_sp_x, bk_TMS_BSDB_intersect_sp)),
    bsdb_species_only = length(setdiff(bsdb_sp_y, bk_TMS_BSDB_intersect_sp)),
    tms_bsdb_species_intersect = length(bk_TMS_BSDB_intersect_sp)
)
```

Enrichment at the genus level:

```{r}
system.time({
    en_TMS_BSDB_intersect_gn <- map(
        bsdb_sigs_gn,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_gn, bp_sigs_gn)
        ) |> 
        formatEnSigs()
})
```

Enrichment at the species level:

```{r}
system.time({
    en_TMS_BSDB_intersect_sp <- map(
        bsdb_sigs_sp,
        ~ microbeSetEnrichment(.x, bk_TMS_BSDB_intersect_sp, bp_sigs_sp)
        ) |> 
        formatEnSigs()
})
```

Combine results

```{r}
en_TMS_BSDB_intersect <- bind_rows(
    en_TMS_BSDB_intersect_gn, en_TMS_BSDB_intersect_sp
)
```

## Background: TMS_BSDB_BS_intersect

Intersection by body site at the genus level:

```{r}
l1 <- map(body_sites, ~ {
    x <- unique(unlist(bsdb_sigs_BS_gn[[.x]]))
    y <- tms_sigs_gn[[.x]]
    xy <- intersect(x, y)
    x_ <- setdiff(x, xy)
    y_ <- setdiff(y, xy)
    list(
        bsdb_only = x_,
        tms_only = y_,
        both = xy
    )
}) |> 
    set_names(body_sites)
bk_TMS_BSDB_BS_intersect_gn <- map(l1, ~ .x$both)
l1 |> 
    map(~ as.data.frame(matrix(map_int(.x, length), nrow = 1))) |> 
    bind_rows() |> 
    set_names(c("bsdb_only", "tms_only", "both"))
```

Intersection by body site at the species level:

```{r}
l2 <- map(body_sites, ~ {
    x <- unique(unlist(bsdb_sigs_BS_sp[[.x]]))
    y <- tms_sigs_sp[[.x]]
    xy <- intersect(x, y)
    x_ <- setdiff(x, xy)
    y_ <- setdiff(y, xy)
    list(
        bsdb_only = x_,
        tms_only = y_,
        both = xy
    )
}) |> 
    set_names(body_sites)
bk_TMS_BSDB_BS_intersect_sp <- map(l2, ~ .x$both)
l2 |> 
    map(~ as.data.frame(matrix(map_int(.x, length), nrow = 1))) |> 
    bind_rows() |> 
    set_names(c("bsdb_only", "tms_only", "both"))
```

Enrichment at the genus level:

```{r}
system.time({
    en_TMS_BSDB_BS_intersect_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_intersect_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_gn[grep(rx, names(bsdb_sigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnSigs()
        en_TMS_BSDB_BS_intersect_gn[[i]] <- res
    }
    en_TMS_BSDB_BS_intersect_gn <- bind_rows(en_TMS_BSDB_BS_intersect_gn)
})
```

Enrichment at the species level:

```{r}
system.time({
    en_TMS_BSDB_BS_intersect_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_intersect_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- bsdb_sigs_sp[grep(rx, names(bsdb_sigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnSigs()
        en_TMS_BSDB_BS_intersect_sp[[i]] <- res
    }
    en_TMS_BSDB_BS_intersect_sp <- bind_rows(en_TMS_BSDB_BS_intersect_sp)
})
```

```{r}
en_TMS_BSDB_BS_intersect <- bind_rows(
    en_TMS_BSDB_BS_intersect_gn, en_TMS_BSDB_BS_intersect_sp
)
```

## Background: TMS_1BSDB_BS

Background(s):

```{r}
bk_TMS_1BSDB_BS <- vector("list", length(bsdb_sigs)) 
for (i in seq_along(bk_TMS_1BSDB_BS)) {
    sig_name <- names(bsdb_sigs)[i]
    names(bk_TMS_1BSDB_BS)[i] <- sig_name
    bodysite_name <- sub(
        "^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\1", sig_name
    )
    rank_name <- sub(
        "^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\2", sig_name
    )
    tms_sig_name <- paste0(bodysite_name, "_", rank_name)
    bk_TMS_1BSDB_BS[[i]] <- unique(
        c(as.character(bsdb_sigs[[i]]), as.character(tms_sigs[[tms_sig_name]]))
    )
}
```

Enrichment at the genus level:

```{r}
system.time({
    bk_TMS_1BSDB_BS_gn <- bk_TMS_1BSDB_BS[names(bsdb_sigs_gn)]
    en_TMS_1BSDB_BS_gn <- map2(bsdb_sigs_gn, bk_TMS_1BSDB_BS_gn, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_gn)
    }) |> 
        formatEnSigs()
})
```

Enrichment at the species level:

```{r}
system.time({
    bk_TMS_1BSDB_BS_sp <- bk_TMS_1BSDB_BS[names(bsdb_sigs_sp)]
    en_TMS_1BSDB_BS_sp <- map2(bsdb_sigs_sp, bk_TMS_1BSDB_BS_sp, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_sp)
    }) |> 
        formatEnSigs()
})
```

```{r}
en_TMS_1BSDB_BS <- bind_rows(en_TMS_1BSDB_BS_gn, en_TMS_1BSDB_BS_sp)
```

## Combine ORA results

Store all results in a single list:

```{r}
results <- list(
    BSDB = en_BSDB,
    BSDB_BS = en_BSDB_BS,
    TMS_BSDB = en_TMS_BSDB,
    TMS_BSDB_BS = en_TMS_BSDB_BS,
    TMS_BSDB_intersect = en_TMS_BSDB_intersect,
    TMS_BSDB_BS_intersect = en_TMS_BSDB_BS_intersect,
    TMS_1BSDB_BS = en_TMS_1BSDB_BS 
) |> 
    map(~ mutate(.x, fdr = p.adjust(p_value))) |> 
    map(~ mutate(.x, combination = paste0(
        body_site, "-#-#-", direction, "-#-#-", rank, "-#-#-",
        condition, "-#-#-", sig_name, "-#-#-", bsdb_sig)
    ))
```

Adjust FDR and filter:

```{r}
filtered_results <- map(results, ~ filter(.x, fdr < 0.1))
map(filtered_results, dim)
```

## Visualization

Define functions:

```{r}
createMat <- function(dat, fdr_th = 0.1, dir) {
   dat <- dat |> 
       dplyr::filter(
           .data$fdr < fdr_th, .data$direction == dir 
       )
   output <- dat |> 
       count(
           body_site, direction, condition, sig_name
       ) |> 
       {\(y) split(y, y$direction)}() |> 
       map(~ split(.x, .x$body_site)) |> 
       list_flatten() |>
       discard(~ !nrow(.x)) |>
       bind_rows() |> 
       mutate(sig_name = factor(sig_name), condition = factor(condition)) |> 
       {\(y) split(y, y$body_site)}() |> 
       map(~ {
           mat <- .x |> 
               select(-body_site, -direction) |> 
               complete(sig_name, condition, fill = list(n = 0)) |> 
               pivot_wider(
                   names_from = "condition", values_from = "n", values_fill = 0
               ) |>
               tibble::column_to_rownames(var = "sig_name") |>
               as.matrix()
           select_cols <- which(as.logical(colSums(mat)))
           mat[, select_cols, drop = FALSE]
           
       })
   output
}

createHt <- function(x) {
    lht <- vector("list", length(x))
    for (i in seq_along(x)) {
        xmat <- x[[i]]
        xmat <- xmat[sort(rownames(xmat)),, drop = FALSE]
        xmat <- xmat[,sort(colnames(xmat)), drop = FALSE]
        if (i == length(lht)) {
            lht[[i]] <- Heatmap(
                matrix = xmat,
                col = color_fun,
                show_column_dend = FALSE,
                show_row_dend = FALSE,
                name = "# sigs",
                border = TRUE,
                column_title = names(x)[i],
                row_names_side = "left", 
                column_title_rot = 45,
                column_names_rot = 45,
                row_order = rownames(xmat),
                # column_order = colnames(xmat),
                row_names_max_width = max_text_width(
                    rownames(xmat),
                    gp = gpar(fontsize = 12)
                ),
                rect_gp = gpar(col = "gray70", lwd = 1)
            )
        } else {
            lht[[i]] <- Heatmap(
                matrix = xmat,
                col = color_fun,
                show_column_dend = FALSE,
                show_row_dend = FALSE,
                border = TRUE,
                show_heatmap_legend = FALSE,
                column_title = names(x)[i],
                row_names_side = "left",
                column_title_rot = 45,
                column_names_rot = 45,
                row_order = rownames(xmat),
                # column_order = colnames(xmat),
                row_names_max_width = max_text_width(
                    rownames(xmat),
                    gp = gpar(fontsize = 12)
                ),
                rect_gp = gpar(col = "gray70", lwd = 1)
            )
        }
    }
    reduce(lht, `+`)
}

myFun <- function(x) {
    x |> 
        as.data.frame() |> 
        tibble::rownames_to_column("sig") |> 
        pivot_longer(
            names_to = "condition", values_to = "presence", cols = 2:last_col()
        ) |> 
        filter(presence > 0) |> 
        unite(col = "combination", sep = " |---| ", sig, condition)
}

combinationHt <- function(l) {
    xvar <- l |> 
        map(~ map(.x, function(x) myFun(x))) |> 
        map(~ distinct(bind_rows(.x, .id = "bs"))) |> 
        bind_rows(.id = "bk") |> 
        mutate(
            bs = factor(bs), combination = factor(combination),
            bk = factor(bk)
        ) |> 
        {\(y) split(y, y$bs)}() |> 
        map(~select(.x, -bs)) |> 
        map(~ {
            .x |> 
                complete(combination, bk, fill = list(presence = 0)) |> 
                pivot_wider(
                    names_from = "bk", values_from = "presence", values_fill = 0
                ) |>
                tibble::column_to_rownames(var = "combination") |>
                as.matrix()
        }) |> 
        map(~ {
            select_row <- which(rowSums(.x) > 0)
            .x[select_row, , drop = FALSE]
        }) |>
        imap(~{
            .x <- .x[sort(rownames(.x)), , drop = FALSE]
            order_of_columns <- c(
                "TMS_BSDB", "TMS_BSDB_BS", "BSDB", "BSDB_BS",
                "TMS_1BSDB_BS", "TMS_BSDB_intersect",
                "TMS_BSDB_BS_intersect"
            )
            Heatmap(
                matrix = .x,
                show_row_names = TRUE,
                show_row_dend = FALSE,
                show_column_dend = FALSE,
                row_dend_reorder = FALSE,
                column_dend_reorder = FALSE,
                row_title = .y,
                col = color_fun,
                name = "# sigs",
                row_order = rownames(.x),
                column_order = order_of_columns,
                row_names_max_width = max_text_width(
                    rownames(.x),
                    gp = gpar(fontsize = 12)
                ),
                rect_gp = gpar(col = "gray70", lwd = 1),
                border = TRUE
            )
        })
    reduce(xvar, ~ .x %v% .y)
}
```

Create matrices

```{r}
lmat_down = map(results, ~ createMat(.x, dir = "decreased"))
lmat_up = map(results, ~ createMat(.x, dir = "increased"))

## This variables are used in the functions defined above
max_count <- max(unlist(c(lmat_down, lmat_up)))
color_fun <- circlize::colorRamp2(
    breaks = c(0, seq(1, max_count)), 
    colors = c("white", viridis::viridis(max_count))
)

## Create heatmaps, but don't display them unless it's required
# l_ht_down <- map(lmat_down, createHt)
# l_ht_up <- map(lmat_up, createHt)
```

```{r, fig.height=30, fig.width=10, warning=FALSE}
ht_comb_up <- combinationHt(lmat_up)
draw(ht_comb_up, column_title = "Increased")
```

```{r, fig.height=30, fig.width=10, warning=FALSE}
ht_comb_down <- combinationHt(lmat_down)
draw(ht_comb_down, column_title = "Decreased")
```

# ORA with BSDB meta-signatures

Define funtion for formating enrichemnt results with metasignatures

```{r}
formatEnMetSig <- function(l) {
    l |> 
        bind_rows(.id = "bsdb_sig") |> 
        separate(
            col = "bsdb_sig",
            into = c(
                "body_site", "rank", "direction", "condition"
            ), sep = "-%-%-", remove = TRUE 
        ) |> 
        mutate(condition = tolower(condition)) |> 
        mutate_at(.vars = c("p_value", "fdr"), .funs = ~ round(.x, 3)) |> 
        mutate_at(
            .vars = c("odds_ratio", "upper_ci", "lower_ci"),
            .funs = ~ round(.x, 2)
        ) |> 
        mutate(sig_name = sub(
            "^bugphyzz:(.*)\\|(genus|species)$", "\\1", sig_name
        )) |> 
        {\(y) set_names(y, sub("Set", "BSDB", colnames(y)))}()
}
```

## Background: BSDB

```{r}
system.time({
    en_meta_BSDB_gn <- map(
        metasigs_gn, ~ microbeSetEnrichment(.x, bk_BSDB_gn, bp_sigs_gn)
    ) |> 
        formatEnMetSig()
})
```

```{r}
system.time({
    en_meta_BSDB_sp <- map(
        metasigs_sp, ~ microbeSetEnrichment(.x, bk_BSDB_sp, bp_sigs_sp)
    ) |> 
        formatEnMetSig()
})
```

```{r}
en_meta_BSDB <- bind_rows(en_meta_BSDB_gn, en_meta_BSDB_sp) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```

## Background: BSDB_BS

genus:

```{r}
system.time({
    en_meta_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_gn[grep(rx, names(metasigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnMetSig()
        en_meta_BSDB_BS_gn[[i]] <- res
    }
    en_meta_BSDB_BS_gn <- bind_rows(en_meta_BSDB_BS_gn)
})
```

species:

```{r}
system.time({
    en_meta_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_sp[grep(rx, names(metasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |>  
            formatEnMetSig()
        en_meta_BSDB_BS_sp[[i]] <- res
    }
    en_meta_BSDB_BS_sp <- bind_rows(en_meta_BSDB_BS_sp)
})
```


```{r}
en_meta_BSDB_BS <- bind_rows(en_meta_BSDB_BS_gn, en_meta_BSDB_BS_sp) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```

## Background: TMS_BSDB

```{r}
system.time({
    en_meta_TMS_BSDB_gn <- map(
        .x = metasigs_gn,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_gn, bp_sigs_gn)
    ) |> 
        formatEnMetSig()
})
```

Enrichment at the species level:

```{r}
system.time({
    en_meta_TMS_BSDB_sp <- map(
        .x = metasigs_sp,
        .f = ~ microbeSetEnrichment(.x, bk_TMS_BSDB_sp, bp_sigs_sp)
        ) |> 
        formatEnMetSig()
})
```

```{r}
en_meta_TMS_BSDB <- bind_rows(en_meta_TMS_BSDB_gn, en_meta_TMS_BSDB_sp) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```

## Background: TMS_BSDB_BS

```{r}
system.time({
    en_meta_TMS_BSDB_BS_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_gn[grep(rx, names(metasigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnMetSig()
        en_meta_TMS_BSDB_BS_gn[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_gn <- bind_rows(en_meta_TMS_BSDB_BS_gn)
})

```


```{r}
system.time({
    en_meta_TMS_BSDB_BS_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_TMS_BSDB_BS_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_sp[grep(rx, names(metasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnMetSig()
        en_meta_TMS_BSDB_BS_sp[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_sp <- bind_rows(en_meta_TMS_BSDB_BS_sp)
})
```

```{r}
en_meta_TMS_BSDB_BS <- bind_rows(
    en_meta_TMS_BSDB_BS_gn, en_meta_TMS_BSDB_BS_sp
    ) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```

## Background: TMS_BSDB_intersect

```{r}
meta_bsdb_gn_y = unique(unlist(metasigs_gn))
bk_meta_TMS_BSDB_intersect_gn <- intersect(tms_gn_x, meta_bsdb_gn_y)

meta_bsdb_sp_y = unique(unlist(metasigs_sp))
bk_meta_TMS_BSDB_intersect_sp <- intersect(tms_sp_x, meta_bsdb_sp_y)
```

genus:

```{r}
system.time({
    en_meta_TMS_BSDB_intersect_gn <- map(
        metasigs_gn,
        ~ microbeSetEnrichment(.x, bk_meta_TMS_BSDB_intersect_gn, bp_sigs_gn)
        ) |> 
        formatEnMetSig()
})
```

species:

```{r}
system.time({
    en_meta_TMS_BSDB_intersect_sp <- map(
        metasigs_sp,
        ~ microbeSetEnrichment(.x, bk_meta_TMS_BSDB_intersect_sp, bp_sigs_sp)
        ) |> 
        formatEnMetSig()
})
```

```{r}
en_meta_TMS_BSDB_intersect <- bind_rows(
    en_meta_TMS_BSDB_intersect_gn, en_meta_TMS_BSDB_intersect_sp
    ) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```

## Bacgkround: TMS_BSDB_BS_intersect

```{r}
metasigs_BS_gn <- vector("list", length(body_sites))
for (i in seq_along(metasigs_BS_gn)) {
   rx <- paste0("^", body_sites[i], "-%-%-", "genus")
   sigsL <- metasigs_gn[grep(rx, names(metasigs_gn))]
   names(sigsL) <- names(metasigs_gn)[grep(rx, names(metasigs_gn))]
   if (is.null(sigsL)) {
       next
   }
   metasigs_BS_gn[[i]] <- sigsL
   names(metasigs_BS_gn)[i] <- body_sites[i]
}
metasigs_BS_gn <- discard(metasigs_BS_gn, is.null)
        
metasigs_BS_sp <- vector("list", length(body_sites))
for (i in seq_along(metasigs_BS_sp)) {
   rx <- paste0("^", body_sites[i], "-%-%-", "species")
   sigsL <- metasigs_sp[grep(rx, names(metasigs_sp))]
   names(sigsL) <- names(metasigs_sp)[grep(rx, names(metasigs_sp))]
   if (is.null(sigsL)) {
       next
   }
   metasigs_BS_sp[[i]] <- sigsL
   names(metasigs_BS_sp)[i] <- body_sites[i]
}
metasigs_BS_sp <- discard(metasigs_BS_sp, is.null)
```

Backgrounds

```{r}
bk_meta_TMS_BSDB_BS_intersect_gn <- map(body_sites, ~ {
    x <- unique(unlist(metasigs_BS_gn[[.x]]))
    y <- tms_sigs_gn[[.x]]
    xy <- intersect(x, y)
    x_ <- setdiff(x, xy)
    y_ <- setdiff(y, xy)
    list(
        bsdb_only = x_,
        tms_only = y_,
        both = xy
    )
}) |> 
    set_names(body_sites) |> 
    map(~ .x$both)

bk_meta_TMS_BSDB_BS_intersect_sp <- map(body_sites, ~ {
    x <- unique(unlist(metasigs_BS_sp[[.x]]))
    y <- tms_sigs_sp[[.x]]
    xy <- intersect(x, y)
    x_ <- setdiff(x, xy)
    y_ <- setdiff(y, xy)
    list(
        bsdb_only = x_,
        tms_only = y_,
        both = xy
    )
}) |> 
    set_names(body_sites) |> 
    map(~ .x$both)
```

```{r}
system.time({
    en_meta_TMS_BSDB_BS_intersect_gn <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_meta_TMS_BSDB_BS_intersect_gn[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_gn[grep(rx, names(metasigs_gn))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_gn)) |> 
            formatEnMetSig()
        en_meta_TMS_BSDB_BS_intersect_gn[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_intersect_gn <- bind_rows(
        en_meta_TMS_BSDB_BS_intersect_gn
    )
})
```

```{r}
system.time({
    en_meta_TMS_BSDB_BS_intersect_sp <- vector("list", length(body_sites))
    for (i in seq_along(body_sites)) {
        bk <- bk_meta_TMS_BSDB_BS_intersect_sp[[body_sites[i]]]
        rx <- paste0(body_sites[i], "-%-%-")
        sig_list <- metasigs_sp[grep(rx, names(metasigs_sp))]
        res <- map(sig_list, ~ microbeSetEnrichment(.x, bk, bp_sigs_sp)) |> 
            formatEnMetSig()
        en_meta_TMS_BSDB_BS_intersect_sp[[i]] <- res
    }
    en_meta_TMS_BSDB_BS_intersect_sp <- bind_rows(
        en_meta_TMS_BSDB_BS_intersect_sp
    )
})
```

```{r}
en_meta_TMS_BSDB_BS_intersect <- bind_rows(
    en_meta_TMS_BSDB_BS_intersect_gn, en_meta_TMS_BSDB_BS_intersect_sp
    ) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```

## Background: TMS_1BSDB_BS

```{r}
metasigs <- c(metasigs_gn, metasigs_sp)
bk_meta_TMS_1BSDB_BS <- vector("list", length(metasigs)) 
for (i in seq_along(bk_meta_TMS_1BSDB_BS)) {
    sig_name <- names(metasigs)[i]
    names(bk_meta_TMS_1BSDB_BS)[i] <- sig_name
    bodysite_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\1", sig_name)
    rank_name <- sub("^(\\w+)-%-%-(species|genus)-%-%-.*$", "\\2", sig_name)
    tms_sig_name <- paste0(bodysite_name, "_", rank_name)
    bk_meta_TMS_1BSDB_BS[[i]] <- unique(
        c(as.character(bsdb_sigs[[i]]), as.character(tms_sigs[[tms_sig_name]]))
    )
}
```

Enrichment at the genus level:

```{r}
system.time({
    bk_meta_TMS_1BSDB_BS_gn <- bk_meta_TMS_1BSDB_BS[names(metasigs_gn)]
    en_meta_TMS_1BSDB_BS_gn <- map2(metasigs_gn, bk_meta_TMS_1BSDB_BS_gn, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_gn)
    }) |> 
        formatEnMetSig()
})
```

Enrichment at the species level:

```{r}
system.time({
    bk_meta_TMS_1BSDB_BS_sp <- bk_meta_TMS_1BSDB_BS[names(metasigs_sp)]
    en_meta_TMS_1BSDB_BS_sp <- map2(metasigs_sp, bk_meta_TMS_1BSDB_BS_sp, ~ {
        microbeSetEnrichment(set = .x, reference = .y, sigs = bp_sigs_sp)
    }) |> 
        formatEnMetSig()
})
```

```{r}
en_meta_TMS_1BSDB_BS <- bind_rows(
    en_meta_TMS_1BSDB_BS_gn, en_meta_TMS_1BSDB_BS_sp
    ) |> 
    mutate(fdr = p.adjust(p_value)) |> 
    filter(fdr < 0.1)
```

## Combine ORA results

```{r}
meta_results <- list(
    BSDB = en_meta_BSDB,
    BSDB_BS = en_meta_BSDB_BS,
    TMS_BSDB = en_meta_TMS_BSDB,
    TMS_BSDB_BS = en_meta_TMS_BSDB_BS,
    TMS_BSDB_intersect = en_meta_TMS_BSDB_intersect,
    TMS_BSDB_BS_intersect = en_meta_TMS_BSDB_BS_intersect,
    TMS_1BSDB_BS = en_meta_TMS_1BSDB_BS 
) |> 
    map(~ mutate(.x, combination = paste0(
        body_site, "-#-#-", direction, "-#-#-", rank, "-#-#-",
        condition, "-#-#-", sig_name)
    ))
```

## Visualization

```{r}
meta_lmat_down = map(meta_results, ~ createMat(.x, dir = "decreased"))
meta_lmat_up = map(meta_results, ~ createMat(.x, dir = "increased"))
max_count <- max(unlist(c(meta_lmat_down, meta_lmat_up)))
color_fun <- circlize::colorRamp2(
    breaks = c(0, seq(1, max_count)), 
    colors = c("white", viridis::viridis(max_count))
)
```

```{r, warning=FALSE, fig.height=30, fig.width=10}
meta_ht_comb_up <- combinationHt(meta_lmat_up)
draw(meta_ht_comb_up, column_title = "Increased")
```

```{r, warning=FALSE, fig.height=30, fig.width=10}
meta_ht_comb_down <- combinationHt(meta_lmat_down)
draw(meta_ht_comb_down, column_title = "decreased")
```

# Session info

```{r}
sessioninfo::session_info()
```
