---
title: "Tree summaries"
---

```{r options, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Packages

```{r setup, message=FALSE}
library(data.tree)
library(bugphyzz)
library(taxPPro)
library(purrr)
library(tidyr)
library(dplyr)
library(ggplot2)
```

## Import data

Import bugphyzz, and the LTP and the NCBI trees:

```{r get child taxa for species, message=FALSE}
bp <- importBugphyzz()
ltp <- ltp()
tip_data <- ltp$tip_data
node_data <- ltp$node_data
nodes <- unique(c(tip_data$taxid, node_data$taxid))
data('tree_list')
ncbiTree <- as.Node(tree_list)
```


Number of taxids in the original annotations mapped to the LTP tree before
"taxPool".

```{r}
x <- bp |> 
    filter(Evidence %in% c('exp', 'tas', 'nas', 'igc')) |> 
    {\(y) split(y, factor(y$Attribute_group))}()
y <- map_dbl(x, ~  {
    if (!nrow(.x))
        return(0)
    mean(unique(.x$NCBI_ID) %in% tip_data$taxid) * 100
})
z <- data.frame(Attribute_group = names(y), Per = unname(y))
```

```{r}
x2 <- bp |> 
    filter(Evidence %in% c('exp', 'tas', 'nas', 'igc', 'tax', 'inh')) |> 
    filter(Rank == 'species') |> 
    {\(y) split(y, factor(y$Attribute_group))}()
y2 <- map_dbl(x2, ~ mean(unique(.x$NCBI_ID) %in% tip_data$taxid) * 100)
z2 <- data.frame(Attribute_group = names(y2), Per = unname(y2))

```


Number of genera represented in the tree


```{r}
x <- bp |> 
    filter(Evidence %in% c('exp', 'tas', 'nas', 'igc')) |> 
    {\(y) split(y, factor(y$Attribute_group))}()
```







## Number of child taxa per species

```{r}
childTaxaSp <- ncbiTree$Get(
    attribute = 'children',
    filterFun = function(node) grepl('^s__', node$name)
)
number_children_sp <- map_int(childTaxaSp, ~ {
    sum(!is.na(.x))
})
nChildDF <- data.frame(
    name = names(number_children_sp),
    n_child = unname(number_children_sp) 
) |> 
    mutate(
        cat = case_when(
            n_child == 0 ~ '0',
            n_child > 0 & n_child <= 20 ~ '1-20',
            n_child > 20 ~ '>20'
        )
    )

count(nChildDF, cat)
```

> Less than 6000 species have children (strains). Some of these, like
Staphilococcus aureous have a lot (up to 4628).


```{r}
ncbi_nodes <- ncbiTree$Get(
    attribute = 'name',
    filterFun = function(node) node$name != 'ArcBac',
    simplify = TRUE
) |>
    names() |> 
    {\(y) sub('^\\w__', '', y)}()
```



```{r}
aer <- filter(bp, Attribute_group == 'aerophilicity') |> 
    mutate(input = ifelse(NCBI_ID %in% ncbi_nodes, TRUE, FALSE)) |> 
    mutate(Attribute_source = ifelse(Evidence == 'inh', NA, Attribute_source))
```

```{r}
aer |> 
    filter(!is.na(Attribute_source)) |> 
    count(Rank, Attribute_source, input) |> 
    arrange(Rank, Attribute_source, input)
```

## Genus

```{r}
aerGn <- filter(bp, Attribute_group == 'aerophilicity', Rank == 'genus')
genera <- ncbiTree$Get(
    attribute = 'name',
    filterFun = function(node) grepl('g__', node$name),
    simplify = TRUE
) |> 
    unname() |> 
    {\(y) sub('g__', '', y)}()

g <- count(aerGn, Evidence)
ids <- filter(aer, Evidence %in% c('exp', 'igc', 'tas', 'nas')) |> 
    pull(NCBI_ID)
g2 <- data.frame(Evidence = 'input', n = sum(ids %in% genera))
rbind(g, g2)
```


## Species

```{r}
aerSp <- filter(bp, Attribute_group == 'aerophilicity', Rank == 'species')

species <- ncbiTree$Get(
    attribute = 'name',
    filterFun = function(node) grepl('s__', node$name),
    simplify = TRUE
) |> 
    unname() |> 
    {\(y) sub('s__', '', y)}()

s <- count(aerSp, Evidence)
sp_ids <- filter(aer, Evidence %in% c('exp', 'igc', 'tas', 'nas')) |> 
    pull(NCBI_ID)
s2 <- data.frame(Evidence = 'input', n = sum(sp_ids %in% species))
rbind(s, s2)
```


## Strain

```{r}
aerSt <- filter(bp, Attribute_group == 'aerophilicity', Rank == 'strain')
strains <- ncbiTree$Get(
    attribute = 'name',
    filterFun = function(node) grepl('t__', node$name),
    simplify = TRUE
) |> 
    unname() |> 
    {\(y) sub('t__', '', y)}()

st <- count(aerSt, Evidence)
st_ids <- filter(aer, Evidence %in% c('exp', 'igc', 'tas', 'nas')) |> 
    pull(NCBI_ID)
st2 <- data.frame(Evidence = 'input', n = sum(st_ids %in% strains))
rbind(st, st2)
```

## Session information

```{r session info}
sessioninfo::session_info()
```

