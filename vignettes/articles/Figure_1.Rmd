---
title: "Figure 1 - Completeness of annotations"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(taxPPro)
library(dplyr)
library(tidyr)
library(ComplexHeatmap)
library(purrr)
library(ggplot2)
library(data.tree)
```

# Import bugphzz data

```{r, message=FALSE, warning=FALSE}
exclude_phys <- c(
  'antimicrobial resistance', 'isolation site',
  'COGEM pathogenicity rating', 'growth medium'
)
phys <- physiologies(remove_false = TRUE) |> 
  keep(~ unique(.x$Attribute_type) == 'categorical') |> 
  {\(y) y[!names(y) %in% exclude_phys]}() |> 
  map(preSteps, tax.id.type = 'NCBI_ID', remove_false = TRUE)
before <- map_int(phys, nrow) |> 
  as.data.frame() |> 
  tibble::rownames_to_column(var = 'physiology') |> 
  mutate(group = 'before')
colnames(before)[2] <- 'n'
```

# Run propagation

```{r, message=FALSE, warning=FALSE}
propagation <- vector('list', length(phys))
for (i in seq_along(propagation)) {
    names(propagation)[i] <- names(phys)[i]
    output_ <- tryCatch(
      error = function(e) NULL, {
        propagate(phys[[i]], max.tax.level = 'genus')
      }
    )
    if (!is.null(output_)) {
      propagation[[i]] <- output_
    }
}
names(propagation) <- names(phys)
propagation <- discard(propagation, is.null)
after <- map_int(propagation, nrow) |> 
  as.data.frame() |> 
  tibble::rownames_to_column(var = 'physiology') |> 
  mutate(group = 'after')
colnames(after)[2] <- 'n'
```

## Propagation II

```{r}
data('tree_list')
tree <- as.Node(tree_list)
```

```{r}
aer <- physiologies(
  'aerophilicity', remove_false = TRUE, full_source = FALSE
)[[1]]
aer <- preSteps(aer, tax.id.type = 'NCBI_ID', remove_false = TRUE)
dic <- c('g__', 's__', 't__')
names(dic) <- c('genus', 'species', 'strain')
aer$NCBI_ID <- paste0(dic[aer$Rank], aer$NCBI_ID)
select_cols <- c(
  'NCBI_ID', 'Attribute', 'Evidence', 'Attribute_source', 'Score'
)
aer <- unique(aer[, select_cols])
aer <- aer[which(grepl('^[gs]__', aer$NCBI_ID)),]
```


```{r, message=FALSE}
res <- addAttributes(data_tree = tree, df = aer)
res$Do(asrUpstream, traversal = 'post-order')
res$Do(inhDownstream, traversal = 'pre-order')
```

```{r}
ncbi_taxonomy <- get_ncbi_taxonomy() |> 
  select(-Taxon_name, Parent_NCBI_ID, Rank)
```


```{r}
args1 <- list(x = res, row.names = NULL, optional = FALSE)
attr_cols <- res$attributesAll 
args2 <- as.list(attr_cols)
args <- c(args1, args2)
tbl <- do.call('as.data.frame', args)

attrs <- unique(sub('__.*$', '', attr_cols))

output <- vector('list', length(attrs))
for (i in seq_along(output)) {
  cols <- colnames(tbl)[which(startsWith(colnames(tbl), attrs[i]))]
  cols <- c('levelName', cols)
  output[[i]] <- tbl[, cols]
  names(output)[i] <- attrs[i]
}
output2 <- lapply(output, function(x) {
  x$levelName <- sub('^.*([dpcofgst]__)', '\\1', x$levelName)
  colnames(x)[1] <- 'NCBI_ID'
  colnames(x) <- sub('.*__', '', colnames(x))
  x
})
output3 <- bind_rows(output2, .id = 'Attribute')
output3$NCBI_ID <- sub(' *$', '', output3$NCBI_ID)
output3point5 <- output3
output3point5$NCBI_ID <- sub('.*__', '', output3point5$NCBI_ID)
output4 <- left_join(output3point5, ncbi_taxonomy, by = 'NCBI_ID')
output4 <- output4[which(output4$Score > 0),]
output4 <- output4[which(output4$NCBI_ID != 'ArcBac'),]
```



```{r}
output5 <- split(output4, factor(output4$Rank))
output6 <- lapply(output5, function(x) {
  x |> 
    select(kingdom, phylum, NCBI_ID) |> 
    distinct() |> 
    count(kingdom, phylum, name = 'n') |> 
    arrange(desc(kingdom), -n)
})
```



## Get NCBI summary (reference/denominator numbers)

```{r}
base_numbers <- get_ncbi_taxids('bti') ## base numbers only
all_numbers <- get_ncbi_taxids('all') ## all numbers

## Let's get total by species with base numbers
ncbi_summary_sp <- base_numbers |>
    filter(
      ## This filter is a double check. The get_ncbi_taxids function already
      ## makes this filter.
      NCBI_ID %in% unique(ncbi_taxonomy$NCBI_ID),
      Rank == 'species'
    ) |>
    count(kingdom, phylum, name = 'n_ncbi_sp') |>
    arrange(desc(kingdom), -n_ncbi_sp)

## Let's get totals by genus with base numbers
## Number of genus is the same anyway
ncbi_summary_gn <- base_numbers |>
    filter(
      ## This filter is a double check. The get_ncbi_taxids function already
      ## makes this filter.
      NCBI_ID %in% unique(ncbi_taxonomy$NCBI_ID),
      Rank == 'genus'
    ) |>
    count(kingdom, phylum, name = 'n_ncbi_gn') |>
    arrange(desc(kingdom), -n_ncbi_gn)

## Let's get totals by strain with whole numbers?
ncbi_summary_st <- all_numbers |>
    filter(
      ## This filter is a double check. The get_ncbi_taxids function already
      ## makes this filter.
      NCBI_ID %in% unique(ncbi_taxonomy$NCBI_ID),
      Rank == 'strain'
    ) |>
    count(kingdom, phylum, name = 'n_ncbi_st') |>
    arrange(desc(kingdom), -n_ncbi_st)
```



```{r}
output6$genus <- output6$genus |> 
  rename(n_bp_gn = n)
completeness_gn_2 <- left_join(
  ncbi_summary_gn, output6$genus, by = c('kingdom', 'phylum')
)  |> 
  filter(!is.na(phylum), !grepl('(C|c)andidatus', phylum)) |> 
  mutate(
    n_bp_gn = ifelse(is.na(n_bp_gn), 0, n_bp_gn),
    completeness_gn = n_bp_gn / n_ncbi_gn
  )

output6$species <- output6$species |> 
  rename(n_bp_sp = n)
completeness_sp_2 <- left_join(
  ncbi_summary_sp, output6$species, by = c('kingdom', 'phylum')
)  |> 
  filter(!is.na(phylum), !grepl('(C|c)andidatus', phylum)) |> 
  mutate(
    n_bp_sp = ifelse(is.na(n_bp_sp), 0, n_bp_sp),
    completeness_sp = n_bp_sp / n_ncbi_sp
  )

output6$strain <- output6$strain |> 
  rename(n_bp_st = n)
completeness_st_2 <- left_join(
  ncbi_summary_st, output6$strain, by = c('kingdom', 'phylum')
)  |> 
  filter(!is.na(phylum), !grepl('(C|c)andidatus', phylum)) |> 
  mutate(
    n_bp_st = ifelse(is.na(n_bp_st), 0, n_bp_st),
    completeness_st = n_bp_st / n_ncbi_st
  )
```








# Comparing raw total numbers

```{r, message=FALSE}
df <- bind_rows(before, after) |> 
  mutate(group = factor(group, c('before', 'after')))
p1 <- df |>
  ggplot(aes(physiology, n)) +
  geom_col(aes(fill = group), position = 'dodge') +
  labs(title = 'Annotations (all ranks) before and after propagation (asr/inh)') +
  theme_bw() +
  scale_fill_manual(values = c('dodgerblue', 'firebrick')) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p1
```


# Calculate completeness

## Import ncbi taxonomy. Necessary to add information about phylum, etc.

This is the reference information to filter both the ncbi references and the
bugphyzz data (before and after propagation).

```{r}
# ncbi_taxonomy <- get_ncbi_taxonomy() |> 
#   select(-Taxon_name, Parent_NCBI_ID, Rank)
```


## Calculate completeness before propagation (asr/inheritance)

### Calculate bugphyzz (bp) summaries (numerator)

```{r}
bp_summary_gn <- phys$aerophilicity |> 
  filter(
    NCBI_ID %in% unique(ncbi_taxonomy$NCBI_ID),
    Rank == 'genus'
  ) |> 
  left_join(ncbi_taxonomy, by = 'NCBI_ID') |> 
  select(kingdom, phylum, NCBI_ID) |> 
  distinct() |> 
  count(kingdom, phylum, name = 'n_bp_gn') |> 
  arrange(desc(kingdom), n_bp_gn)

bp_summary_sp <- phys$aerophilicity |> 
  filter(
    NCBI_ID %in% unique(ncbi_taxonomy$NCBI_ID),
    Rank == 'species'
  ) |> 
  left_join(ncbi_taxonomy, by = 'NCBI_ID') |> 
  select(kingdom, phylum, NCBI_ID) |> 
  distinct() |> 
  count(kingdom, phylum, name = 'n_bp_sp') |> 
  arrange(desc(kingdom), n_bp_sp)

bp_summary_st <- phys$aerophilicity |> 
  filter(
    NCBI_ID %in% unique(ncbi_taxonomy$NCBI_ID),
    Rank == 'strain'
  ) |> 
  left_join(ncbi_taxonomy, by = 'NCBI_ID') |> 
  select(kingdom, phylum, NCBI_ID) |> 
  distinct() |> 
  count(kingdom, phylum, name = 'n_bp_st') |> 
  arrange(desc(kingdom), n_bp_st)
```

### Calculate completeness

```{r}
completeness_gn <- left_join(
  ncbi_summary_gn, bp_summary_gn, by = c('kingdom', 'phylum')
)  |> 
  filter(!is.na(phylum), !grepl('(C|c)andidatus', phylum)) |> 
  mutate(
    n_bp_gn = ifelse(is.na(n_bp_gn), 0, n_bp_gn),
    completeness_gn = n_bp_gn / n_ncbi_gn
  )

completeness_sp <- left_join(
  ncbi_summary_sp, bp_summary_sp, by = c('kingdom', 'phylum')
)  |> 
  filter(!is.na(phylum), !grepl('(C|c)andidatus', phylum)) |> 
  mutate(
    n_bp_sp = ifelse(is.na(n_bp_sp), 0, n_bp_sp),
    completeness_sp = n_bp_sp / n_ncbi_sp
  )

completeness_st <- left_join(
  ncbi_summary_st, bp_summary_st, by = c('kingdom', 'phylum')
)  |> 
  filter(!is.na(phylum), !grepl('(C|c)andidatus', phylum)) |> 
  mutate(
    n_bp_st = ifelse(is.na(n_bp_st), 0, n_bp_st),
    completeness_st = n_bp_st / n_ncbi_st
  )
```

### Merge all completeness data for a single physiology

```{r, warning=FALSE, message=FALSE}
completeness <- purrr::reduce(
  list(completeness_gn, completeness_sp, completeness_st), left_join
) |> 
  mutate(group = paste0(kingdom, ' - ', phylum))  |> 
  select(group, starts_with('completeness')) |> 
  rename(
    strain = completeness_st, species = completeness_sp, 
    genus = completeness_gn
  ) |> 
  tibble::column_to_rownames(var = 'group') |> 
  as.matrix()
completeness[is.na(completeness)] <- 0
```


## Completeness after propagation

### Calculate bugphyzz propagated (prop) summaries (numerator)

```{r}
prop_summary_gn <- propagation$aerophilicity |> 
  filter(
    NCBI_ID %in% unique(ncbi_taxonomy$NCBI_ID),
    Rank == 'genus'
  ) |> 
  left_join(ncbi_taxonomy, by = 'NCBI_ID') |> 
  select(kingdom, phylum, NCBI_ID) |> 
  distinct() |> 
  count(kingdom, phylum, name = 'n_prop_gn') |> 
  arrange(desc(kingdom), n_prop_gn)

prop_summary_sp <- propagation$aerophilicity |> 
  filter(
    NCBI_ID %in% (ncbi_taxonomy$NCBI_ID),
    Rank == 'species'
  ) |> 
  left_join(ncbi_taxonomy, by = 'NCBI_ID') |> 
  select(kingdom, phylum, NCBI_ID) |> 
  distinct() |> 
  count(kingdom, phylum, name = 'n_prop_sp') |> 
  arrange(desc(kingdom), n_prop_sp)

prop_summary_st <- propagation$aerophilicity |> 
  filter(
    NCBI_ID %in% unique(ncbi_taxonomy$NCBI_ID),
    Rank == 'strain'
  ) |> 
  left_join(ncbi_taxonomy, by = 'NCBI_ID') |> 
  select(kingdom, phylum, NCBI_ID) |> 
  distinct() |> 
  count(kingdom, phylum, name = 'n_prop_st') |> 
  arrange(desc(kingdom), n_prop_st)
```

### Calculate completeness

```{r}
prop_completeness_gn <- left_join(
  ncbi_summary_gn, prop_summary_gn, by = c('kingdom', 'phylum')
)  |> 
  filter(!is.na(phylum), !grepl('(C|c)andidatus', phylum)) |> 
  mutate(
    n_prop_gn = ifelse(is.na(n_prop_gn), 0, n_prop_gn),
    prop_completeness_gn = n_prop_gn / n_ncbi_gn
  )

prop_completeness_sp <- left_join(
  ncbi_summary_sp, prop_summary_sp, by = c('kingdom', 'phylum')
)  |> 
  filter(!is.na(phylum), !grepl('(C|c)andidatus', phylum)) |> 
  mutate(
    n_prop_sp = ifelse(is.na(n_prop_sp), 0, n_prop_sp),
    prop_completeness_sp = n_prop_sp / n_ncbi_sp
  )

prop_completeness_st <- left_join(
  ncbi_summary_st, prop_summary_st, by = c('kingdom', 'phylum')
)  |> 
  filter(!is.na(phylum), !grepl('(C|c)andidatus', phylum)) |> 
  mutate(
    n_prop_st = ifelse(is.na(n_prop_st), 0, n_prop_st),
    prop_completeness_st = n_prop_st / n_ncbi_st
  )
```



### Merge all completeness data for a single physiology

```{r, warning=FALSE, message=FALSE}
prop_completeness <- purrr::reduce(
  list(prop_completeness_gn, prop_completeness_sp, prop_completeness_st),
  left_join
) |> 
  mutate(group = paste0(kingdom, ' - ', phylum))  |> 
  select(group, starts_with('prop_completeness')) |> 
  rename(
    strain = prop_completeness_st, 
    species = prop_completeness_sp, 
    genus = prop_completeness_gn
  ) |> 
  tibble::column_to_rownames(var = 'group') |> 
  as.matrix()
prop_completeness[is.na(prop_completeness)] <- 0
```


```{r}
completeness_2 <- purrr::reduce(
  list(completeness_gn_2, completeness_sp_2, completeness_st_2), left_join
) |> 
  mutate(group = paste0(kingdom, ' - ', phylum))  |> 
  select(group, starts_with('completeness')) |> 
  rename(
    strain = completeness_st, species = completeness_sp,
    genus = completeness_gn
  ) |>
  tibble::column_to_rownames(var = 'group') |> 
  as.matrix()
completeness_2[is.na(completeness_2)] <- 0
```






# Create a heatmap

```{r}
row_names <- sort(
  intersect(rownames(completeness), rownames(prop_completeness)),
  decreasing = TRUE
)

row_names <- sort(
  intersect(row_names, rownames(completeness_2)),
  decreasing = TRUE
)

colnames(completeness) <- paste0('before_', colnames(completeness)) 
colnames(prop_completeness) <- paste0('after_', colnames(prop_completeness)) 
colnames(completeness_2) <- paste0('after2_', colnames(completeness_2)) 
# mat <- cbind(completeness[row_names,], prop_completeness[row_names,])
# mat[is.na(mat)] <- 0
```

```{r}

# mat <- cbind(completeness[row_names,], prop_completeness[row_names,])

mat <- do.call(
  'cbind', 
  list(completeness[row_names,],
  prop_completeness[row_names,],
  completeness_2[row_names,])
)


mat[is.na(mat)] <- 0

colnames(mat) <- c(
 "before_genus",       "before_species",
 "before_strain",     "after_genus", 
 "after_species", "after_strain",
 "after2_genus",              "after2_species",          
 "after2_strain"
)

```

```{r}
rep1 <- sum(grepl('^Bacteria -', rownames(mat)))
rep2 <- sum(grepl('^Archaea -', rownames(mat)))
row_splits <- c(rep('Bacteria', rep1), rep('Archaea', rep2))
col_splits <- c(rep('Before', 3), rep('After', 3), rep('After_2', 3) )

rownames(mat) <- sub('^(Archaea|Bacteria) - ', '', rownames(mat))
colnames(mat) <- sub('^(before|after|after_2)_', '', colnames(mat))

hp <- Heatmap(
  matrix = mat,
  show_column_dend = FALSE, show_row_dend = FALSE,
  cluster_columns = FALSE, cluster_rows = FALSE,
  name = 'Completeness
  Aerophilicity',
  row_names_side = 'left', column_title_side = 'bottom',
  # row_title = 'Phylum', column_title = 'rank', 
  cell_fun = function(j, i, x, y, width, height, fill) {
        grid.rect(x = x, y = y, width = width, height = height, 
            gp = gpar(col = "black", fill = NA))
  },
  col = viridis::viridis(1020, option = 'C'),
  row_split = factor(row_splits, levels = c('Bacteria', 'Archaea')),
  column_split = factor(col_splits, levels = c('Before', 'After', 'After_2')) 
)
hp
```

```{r, echo=FALSE, eval=FALSE}
png(filename = 'aer-completeness.png', width = 7, height = 8, res = 1020, units = 'in')
hp
dev.off()
```














