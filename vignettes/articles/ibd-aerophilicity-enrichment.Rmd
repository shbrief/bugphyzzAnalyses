---
title: "ibd-aerophilicity-enrichment"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(curatedMetagenomicData)
library(dplyr)
library(tidySummarizedExperiment)
```

For this example, let's use the data of the HMP_2019_bidmdb study:

```{r, message=FALSE, warning=FALSE}
tse <- curatedMetagenomicData(
    pattern = "HMP_2019_ibdmdb.relative_abundance", dryrun = FALSE, rownames = 'NCBI',
    counts = TRUE
)[[1]]
tse 
```

Get data subset

```{r, message=FALSE, warning=FALSE}
rank_cols <- colnames(rowData(tse))
tidy_data <- tidySummarizedExperiment::as_tibble(tse) |> 
    rename(taxon_name = .feature, sample = .sample) 
sample_data <- tidy_data |> 
    select(-rank_cols, -taxon_name, -relative_abundance) |> 
    distinct()
sample_data_split <- split(sample_data, factor(sample_data$disease))
min_n <- min(vapply(sample_data_split, nrow, integer(1)))
samples <- lapply(sample_data_split, function(x) {
    set.seed(1234)
    int_vct <- sample(1:nrow(x), size = min_n)
    x[int_vct,]$sample
}) |> 
    unlist(use.names = FALSE)
tse_subset <- tse[,samples] |> 
    filterTaxa()
```

# Annotations

I'll use benchdamic. So I need the prior_info file.

```{r}
taxa_data <- tidy_data |> 
    dplyr::filter(taxon_name %in% rownames(tse_subset)) |> 
    select(all_of(c('taxon_name', rank_cols))) |> 
    distinct()


aer <- as_tibble(physiologies('aerophilicity')[[1]])
tidy_data
```







# Session Information

```{r}
sessionInfo()
```


```{r, echo=FALSE, include=FALSE, eval=FALSE}
# data('sampleMetadata', package = 'curatedMetagenomicData')
# data <- as_tibble(sampleMetadata)
## Select all studies with IBD information
# ibd_studies <- data |> 
    # dplyr::filter(study_condition == 'IBD' | disease == 'IBD') |> 
    # pull(study_name) |> 
    # unique()

# ibd_metadata <- data |> 
#     dplyr::filter(
#         study_name %in% ibd_studies, disease %in% c('healthy' ,'IBD')
#     ) 
# 
# ibd_data <- returnSamples(ibd_metadata, dataType = 'relative_abundance')
```

