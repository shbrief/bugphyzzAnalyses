---
title: "Data integration and stats"
output:
    html_document:
        code_folding: show 
        toc: true
---

```{r script options, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

## Load packages

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(dplyr)
library(taxPPro)
library(ggplot2)
library(forcats)
library(ggpubr)
library(taxPPro)
library(tidyr)
library(ComplexHeatmap)
library(purrr)
library(forcats)
library(ggbreak)
library(tibble)
library(patchwork)
library(grid)
library(cowplot)
```

## Import data

```{r import bp}
bp <- importBugphyzz() |> 
    filter(!(grepl('--TRUE$', Attribute) & is.na(Attribute_source))) |>
    filter(!is.na(Attribute_group))
```

# General stats

## Non-na plots

Percentage of non-NA values for each column:

```{r non-Nas plot}
na_df <- stack(round(colSums(!is.na(bp))/nrow(bp)*100, 2))
na_df$counts <- colSums(!is.na(bp))
na_df <- na_df[order(na_df$values, decreasing = TRUE),]
na_plot <- na_df |> 
    ggplot(aes(x = fct_rev(fct_reorder(ind, values)), 
               y = counts)) +
    geom_col(fill = 'gray80', color = 'black', linewidth = 0.2) +
    scale_y_continuous(
        # Features of the first axis
        name = "# of Records",
        # Add a second axis and specify its features
        sec.axis = sec_axis(trans = ~ round(./nrow(bp)*100, 2), 
                            name = "Completeness (%)")) +
    labs(x = "Attribute/Column Names",
         title = "Completeness of Curated Attributes/Columns") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
na_plot
```

This should probably be turned into a unit test. Only the Attribute_range, 
Confidence_in_curation, and Attribute_source columns should have NA values.
In the case of Confidence_in_curation and Attribute_source, imputed annotations
don't come from a source and Confidence_in_curation refers to a source.
Attribute range only applies to attribute groups/physiologies that were
transformed from numeric to categorical.

## Basic totals

Number of taxa, annotations, sources, attribute groups (physiologies),
and attributes:

```{r totals}
n_taxa <- length(unique(bp$NCBI_ID))
n_attr_grps <- length(unique(bp$Attribute_group))
n_attr <- length(unique(bp$Attribute))
n_annotations <- nrow(bp)
n_annotations_pred <- bp |> 
    filter(is.na(Attribute_source)) |> 
    nrow()
n_annotations_source <- bp |> 
    filter(!is.na(Attribute_source)) |> 
    nrow()
n_source <- bp |> 
    filter(!is.na(Attribute_source)) |> 
    pull(Attribute_source) |> 
    unique() |> 
    length()

count_summary_tbl <- tibble::tribble(
    ~name, ~n,
    'Taxa', n_taxa,
    'Attribute groups/physiologies', n_attr_grps,
    'Unique attributes', n_attr,
    'Annotations/Records', n_annotations,
    'Annotations from sources', n_annotations_source,
    'Imputed annotatiosn', n_annotations_pred,
    'Sources', n_source
)

DT::datatable(count_summary_tbl)
```

We got totals of `r format(n_annotations, big.mark = ",", scientific = FALSE)`
annotations, `r format(n_taxa, big.mark = ",", scientific = FALSE)` taxa,
`r n_attr_grps` attribute groups (physiologies), and `r n_attr` attributes;
`r format(n_annotations_source, big.mark = ",", scientific = FALSE)`
annotations come from sources and 
`r format(n_annotations_pred, big.mark = ",", scientific = FALSE)` annotations
were imputed/predicted we our propagation method. Total sources were 
`r n_source`.

## Histograms of scores

Annotations with a score of 0 were removed from the final export to keep the
size of the text file smaller. This also reduces the time it takes to import
the main csv text file into R.

```{r histogram of scores}
## Let's create some custom bins:
bp_count <- bp |> 
  mutate(bin = case_when(
    Score >= 0 & Score < 0.1 ~ '0',
    Score >= 0.1 & Score < 0.2 ~ '0.1',
    Score >= 0.2 & Score < 0.3 ~ '0.2',
    Score >= 0.3 & Score < 0.4 ~ '0.3', 
    Score >= 0.4 & Score < 0.5 ~ '0.4',
    Score >= 0.5 & Score < 0.6 ~ '0.5',
    Score >= 0.6 & Score < 0.7 ~ '0.6',
    Score >= 0.7 & Score < 0.8 ~ '0.7',
    Score >= 0.8 & Score < 0.9 ~ '0.8',
    Score >= 0.9 & Score < 1 ~ '0.9',
    Score >= 1 ~ '1'
  )) |>
  count(bin) |> 
  mutate(
    Freq = case_when(
      bin %in% c('0', '0.1', '0.2', '0.3', '0.4') ~ 'rarely',
      bin %in% c('0.5', '0.6', '0.7', '0.8') ~ 'sometimes',
      bin == '0.9' ~ 'usually',
      bin == '1' ~ 'always'
    )
  ) |> 
  mutate(
    Freq = factor(Freq, levels = c('always', 'usually', 'sometimes', 'rarely'))
  )

# scores_hist <- bp |> 
#   mutate(Score = round(Score, digits = 1)) |> 
#     ggplot(aes(as.numeric(Score), fill = Frequency)) +
#     geom_histogram(
#       # breaks = seq(0, 1, 0.05),
#       color = 'black', linewidth = 0.2
#       # fill = 'gray80'
#     ) +
#     labs(x = 'Scores', y = 'Number of annotations') +
#     scale_y_continuous(breaks = scales::pretty_breaks()) +
#     theme_bw()
# scores_hist
bp_count |> 
  ggplot(aes(bin, n, fill = Freq)) +
  geom_col(width = 1, color = 'black', linewidth = 0.2, position = position_nudge(x = 0.5)) +
  geom_vline(xintercept = 6, linetype = 'dotdash', linewidth = 0.3) +
  scale_fill_manual(
    values = c('gray25', 'gray50', 'gray75', 'gray100'),
    labels = c('always', 'usually', 'sometimes', 'rarely'),
    name = 'Frequency'
  ) + 
  labs(
    y = 'Number of annotations', x = 'Score bins',
    title = 'Histogram of scores',
    subtitle = '0s or "never" were removed\nValues to the right of the vertical line should be preferred for analysis'
  ) +
  scale_y_continuous(labels = scales::scientific_format()) +
  theme_classic()
```

## Frequency keywords

This should reflect the histogram of scores above.
See this code for reference: https://github.com/waldronlab/taxPPro/blob/0607575c1bc408b6bdf49d3cad77857851f11f6d/R/utils.R#L23-L42

```{r totals frequency, message=FALSE}
freq_df <- stack(table(bp$Frequency, useNA = "ifany"))
freq_df$ind <- fct_relevel(freq_df$ind, 'always', 'usually', 'sometimes', 'rarely')
freq_df$prop <- round(freq_df$values/sum(freq_df$values)*100, 2)
freq_plot <- freq_df |> 
    ggplot(aes(x = fct_rev(fct_reorder(ind, values)),
               y = values)) +
    geom_col(fill = 'gray80', color = 'black', linewidth = 0.2) +
    theme_bw() +
    scale_y_continuous(name = "# of Annotations",
                       sec.axis = sec_axis(trans = ~ round(./sum(freq_df$values)*100, 2),
                                           name = "Percentage")) +
    labs(x = "Frequency",
         title = "Frequency for Annotations") +
    geom_text(aes(label = prop), vjust = -0.2) +
    theme(axis.text.x = element_text(size = 12, face = "italic"))
freq_plot
```

## Evidence

```{r totals evidence, message=FALSE}
ev_df <- stack(table(bp$Evidence, useNA = "ifany"))
ev_df$prop <- round(ev_df$values/sum(ev_df$values)*100, 2)
ev_plot <- ev_df |> 
    ggplot(aes(x = fct_rev(fct_reorder(ind, values)),
               y = values)) +
    geom_col(fill = 'gray80', linewidth = 0.2, color = 'black') +
    theme_bw() +
    scale_y_continuous(name = "# of Annotations",
                       sec.axis = sec_axis(trans = ~ round(./sum(ev_df$values)*100, 2),
                                           name = "Percentage")) +
    labs(x = "Evidence",
         title = "Evidence Types for Annotations") +
    geom_text(aes(label = prop), vjust = -0.2) +
    theme(axis.text.x = element_text(size = 12, face = "italic"))
ev_plot
```

## Number of annotations by attribute group (physiology)

### Attribute group and rank

```{r n attr per attr grp and rank}
dims <- map_chr(dim(bp), ~ format(.x, big.mark = ','))
total_annotations <- paste0('Total annotations: ', dims[[1]])
valid_ranks <- c(
  'kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species', 'strain'
)
attr_gp_rk_p <- bp |> 
  mutate(Rank = factor(Rank, levels = valid_ranks, ordered = FALSE)) |> 
  count(Attribute_group, Rank) |> 
  group_by(Attribute_group) |> 
  mutate(total = sum(n)) |> 
  ungroup() |> 
  ggplot(aes(reorder(Attribute_group, desc(total)), n)) +
  geom_col(aes(fill = Rank)) +
  labs(x = 'Attribute group', y = 'Number of annotations') +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_brewer(type = 'qual', palette = 'Set2', direction = -1, name = '') +
  # scale_y_cut(breaks = c(100, 30000, 120000)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
     # legend.position = 'bottom'
  )
attr_gp_rk_p
```

## Attribute group and evidence

```{r n attr per attr grp and evidence}
evidence_code <- c('asr', 'tax', 'inh', 'inh2', 'tas', 'nas', 'igc', 'exp')
atr_gp_ev_p <- bp |> 
  mutate(Evidence = factor(Evidence, levels = evidence_code, ordered = FALSE)) |> 
  count(Attribute_group, Evidence) |> 
  group_by(Attribute_group) |> 
  mutate(total = sum(n)) |> 
  ungroup() |> 
  ggplot(aes(reorder(Attribute_group, desc(total)), n)) +
  geom_col(aes(fill = Evidence)) +
  labs(x = 'Attribute group', y = 'Number of annotations') +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_brewer(type = 'qual', palette = 'Set2', direction = 1, name = '') +
  # scale_y_cut(breaks = c(100, 120000)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position = 'right'
  )
atr_gp_ev_p
```

## Attribute group and frequency

```{r n attr per attr grp and freq}
freq_code <- c('always', 'usually', 'sometimes', 'rarely')
atr_gp_fr_p <- bp |> 
  mutate(Frequency = factor(Frequency, levels = freq_code, ordered = FALSE)) |> 
  count(Attribute_group, Frequency) |> 
  group_by(Attribute_group) |> 
  mutate(total = sum(n)) |> 
  ungroup() |> 
  ggplot(aes(reorder(Attribute_group, desc(total)), n)) +
  geom_col(aes(fill = Frequency)) +
  labs(x = 'Attribute group', y = 'Number of annotations') +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_brewer(type = 'qual', palette = 'Set2', direction = 1, name = '') +
  # scale_y_cut(breaks = c(100, 120000)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position = 'right'
  )
atr_gp_fr_p
```

## Combined plot attribute group x Evidence & attribute group x frequency

This could be used for a supplementary figure:

```{r supplementary fig, fig.width=19, fig.height=6}
supp1 <- atr_gp_ev_p / atr_gp_fr_p + plot_layout(ncol = 2) +
    plot_annotation(tag_levels = 'a')
ggsave(
  filename = 'sup1.png', plot = supp1, width = 19, height = 6, 
  units = 'in'
)
supp1
```

## Evidence and frequency

```{r Evidence x Frequency - all annotations}
bp |> 
    count(Evidence, Frequency ) |> 
    group_by(Evidence) |> 
    mutate(total = sum(n)) |> 
    ungroup() |> 
    ggplot(aes(reorder(Evidence, desc(total)), n)) +
    labs(
        x = 'Evidence', y = 'Number of annotations'
    ) +
    geom_col(aes(fill = Frequency)) +
    theme_bw()
```

## Evidence and frequency (removing strains)

The pattern is esentially the same

```{r evidence x frequency - no strains}
bp |> 
    filter(Rank != 'strain') |> 
    count(Evidence, Frequency ) |> 
    group_by(Evidence) |> 
    mutate(total = sum(n)) |> 
    ungroup() |> 
    ggplot(aes(reorder(Evidence, desc(total)), n)) +
    labs(
        x = 'Evidence', y = 'Number of annotations'
    ) +
    geom_col(aes(fill = Frequency)) +
    theme_bw()
```

## Evidence and Frequency (explore for all attribute groups)

```{r evidence x frequency by attribute group - all annotations, fig.width=13.5, fig.height=9.5}
bp |> 
    count(Attribute_group, Evidence, Frequency ) |> 
    group_by(Attribute_group, Evidence) |> 
    mutate(total = sum(n)) |> 
    ungroup() |> 
    ggplot(aes(reorder(Evidence, desc(total)), n)) +
    geom_col(aes(fill = Frequency)) +
    labs(x = 'Evidence', y = 'Number of annotations') +
    facet_wrap(.~Attribute_group, ncol = 5, scales = 'free_y') +
    theme_bw()
```

## Evidence and Frequency (explore for all attribute groups, leaving strains out)

```{r Evidence x Frequency by Attribute group - removing strains, fig.width=13.5, fig.height=9.5}
bp |> 
    filter(Rank != 'strain') |> 
    count(Attribute_group, Evidence, Frequency ) |> 
    group_by(Attribute_group, Evidence) |> 
    mutate(total = sum(n)) |> 
    ungroup() |> 
    ggplot(aes(reorder(Evidence, desc(total)), n)) +
    geom_col(aes(fill = Frequency)) +
    labs(
        x = 'Evidence', y = 'Number of annotations'
    ) +
    facet_wrap(.~Attribute_group, ncol = 5, scales = 'free_y') +
    theme_bw()
```
## Rank and frequency

```{r Rank x Frequency - all annotations}
bp |> 
    count(Rank, Frequency ) |> 
    group_by(Rank) |> 
    mutate(total = sum(n)) |> 
    ungroup() |> 
    ggplot(aes(reorder(Rank, desc(total)), n)) +
    labs(
        x = 'Evidence', y = 'Number of annotations'
    ) +
    geom_col(aes(fill = Frequency)) +
    theme_bw()
```

## Rank and evidence

```{r Rank x Evidence}
bp |> 
    count(Rank, Evidence ) |> 
    group_by(Rank) |> 
    mutate(total = sum(n)) |> 
    ungroup() |> 
    ggplot(aes(reorder(Rank, desc(total)), n)) +
    labs(
        x = 'Evidence', y = 'Number of annotations'
    ) +
    geom_col(aes(fill = Evidence)) +
    theme_bw()
```

## Number of attributes per attribute group

```{r n attr values per attribute group}
attr_n <- bp |> 
    select(Attribute_group, Attribute) |> 
    distinct() |> 
    count(Attribute_group) |> 
    arrange(-n) |> 
    mutate(
        bin = ifelse(n > 2, 'multistate-intersection', 'Binary')
        ) |> 
    mutate(
        bin = case_when(
            Attribute_group %in% c('disease association', 'antimicrobial resistance', 'habitat') ~ 'multistate-union',
            TRUE ~ bin 
        )
    ) |> 
    mutate(bin = fct_relevel(bin, 'multistate-union', 'multistate-intersection'))

attr_n_p <- attr_n |> 
  ggplot(aes(reorder(Attribute_group, desc(n)), n)) +
  geom_col(aes(fill = bin)) +
  scale_y_continuous(
    limits = c(0, 95), breaks = seq(0, 95, 30)
  ) +
  labs(
    x = 'Attribute group', y = 'Number of attributes\n\n'
  ) +
  scale_fill_discrete(name = '') +
  # guides(fill = guide_legend(nrow = 1)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
    # legend.position = 'bottom'
    # panel.grid.major.x = element_blank(), 
  ) 
attr_n_p
```

## Number of annotations per taxon

```{r freq n annotatios per taxon}
freqs <- bp |> 
    filter(Rank %in% c('genus', 'species', 'strain')) |> 
    count(Rank, NCBI_ID)

freqs_p <- freqs |> 
  ggplot(aes(n)) +
  geom_histogram(binwidth = 1, fill = 'gray80', linewidth = 0.2, color = 'black') +
  facet_wrap(~Rank, ncol = 1, scales = 'free') +
  scale_y_continuous(labels = scales::comma) +
  guides(fill = guide_legend(nrow = 1)) +
  labs(
      x = 'Number of annotations per taxon',
      y = 'Frequency'
  ) +
  theme_bw()  +
  theme(
    legend.position = 'bottom'
  )

freqs_p
```


```{r combined plot 1 (Figure candidate), fig.width=12.5, fig.height=8.7}
layout <- '
AAAAC
AAAAC
AAAAC
AAAAC
BBBBC
BBBB#
'
p <- attr_gp_rk_p + attr_n_p + freqs_p + 
  plot_layout(design = layout, guides = 'keep') +
  plot_annotation(tag_levels = 'a', tag_suffix = ')')
  # theme(plot.tag = element_text(size = 8))
ggsave('basic_stats.png', width = 12.5, height = 8.7, units = 'in')
p
```

## Number of annotations per source (including propagation)

```{r source summary, message=FALSE}
summary_source <- bp |> 
  mutate(
    Attribute_source = ifelse(
      is.na(Attribute_source), Evidence, Attribute_source
    )
  ) |> 
  mutate(
    Attribute_source = case_when(
      Attribute_source == 'inh' ~ 'Inheritance',
      Attribute_source == 'inh2' ~ 'Inheritance2',
      Attribute_source == 'asr' ~ 'ASR',
      Attribute_source == 'tax' ~ 'Taxonomic pooling',
      TRUE ~ Attribute_source
    )
  ) |> 
  filter(!grepl(';', Attribute_source)) |> # remove repeated annotations for now
  count(Attribute_source) |> 
  arrange(-n) |> 
  mutate(
    origin = case_when(
      Attribute_source %in% c('ASR', 'Inheritance', 'Inheritance2', 'Taxonomic pooling') ~ 'Propagation',
      TRUE ~ 'Original source'
    )
  )
head(summary_source)
```


```{r summary source origin, message=FALSE}
summary_source_p1 <- summary_source |> 
    mutate(origin = ifelse(origin == 'Original source', 'Source', origin)) |>
    mutate(origin = fct_reorder(origin, desc(n))) |> 
    filter(origin == 'Propagation') |> 
    ggplot(aes(reorder(Attribute_source, -n), n)) +
    geom_col(fill = 'gray80', linewidth = 0.2, color = 'black') +
    labs(
        x = 'Source', y = 'Number of annotations'
    ) +
    scale_fill_discrete(name = '') +
    theme_bw() +
    theme(
        axis.text.x = element_text(angle = 90, hjust = 1)
    )
summary_source_p2 <- summary_source |> 
    mutate(origin = ifelse(origin == 'Original source', 'Source', origin)) |>
    mutate(origin = fct_reorder(origin, desc(n))) |> 
    filter(origin == 'Source') |> 
    ggplot(aes(reorder(Attribute_source, -n), n)) +
    geom_col(fill = 'gray80', linewidth = 0.2, color = 'black') +
    labs(
        x = 'Source', y = 'Number of annotations'
    ) +
    scale_fill_discrete(name = '') +
    theme_bw() +
    theme(
        axis.text.x = element_text(angle = 90, hjust = 1),
    )
summary_source_p <- summary_source_p1 + summary_source_p2 + 
    plot_layout(ncol = 2, widths = c(1, 4))
    # plot_annotation(tag_levels = 'a')
summary_source_p
```

# Completeness

## Completeness tables

+ The `exclude_all` data in the code chunk below is the result of applying
all filters here: https://www.ncbi.nlm.nih.gov/Taxonomy/taxonomyhome.html/index.cgi?chapter=STATISTICS&uncultured=hide&unspecified=hide.
The output does not include any strain.

+ Strains were imported separately and they're contained in the 
`strains` data in the code below. Data was obtained similarly to the 
code above (applying filters).

+ Details here: https://github.com/waldronlab/taxPPro/tree/main/inst/scripts

+ Reference was the combination of `exclude_all` and `strains` in the code
chunk below:

```{r getting reference for completeness, warning=FALSE}
exclude_all_fname <- system.file(
  file.path('extdata', 'proc_exclude_all_07122023.txt'),
  package = 'taxPPro',
  mustWork = TRUE
)
exclude_all <- read.table(exclude_all_fname, col.names = 'taxid')
exclude_all$taxid <- as.character(exclude_all$taxid)
exclude_all$rank <- taxizedb::taxid2rank(exclude_all$taxid, db = 'ncbi')
exclude_all <- exclude_all[which(!is.na(exclude_all$rank)),]
exclude_all$rank <- ifelse(exclude_all$rank == 'superkingdom', 'kingdom', exclude_all$rank)
exclude_all <- exclude_all[exclude_all$rank %in% valid_ranks,]

strains_fname <- system.file(file.path('extdata', 'proc_strains_07122023.txt'), package = 'taxPPro', mustWork = TRUE)
strains <- read.table(strains_fname, col.names = 'taxid')
strains$taxid <- as.character(strains$taxid)
strains$rank <- taxizedb::taxid2rank(strains$taxid, db = 'ncbi')
strains <- strains[strains$rank == 'strain',]

reference_df <- rbind(exclude_all, strains)
reference_summary <- count(reference_df, rank)
colnames(reference_summary) <- c('Rank', 'ref')
reference <- split(reference_df, factor(reference_df$rank)) |> 
  lapply(function(x) unique(x$taxid))
reference_totals <- map_int(reference, length) |> 
    as.data.frame() |> 
    set_names('n') |> 
    tibble::rownames_to_column(var = 'rank') |> 
    arrange(-n)
reference_totals
```

## Completeness table

Define helpful functions and a subset of the data (original) that only comes
from sources:

```{r define functions and set original data}
## Inset means taxa that can be found in the reference
inSet <- function(x, ref) {
  s <- split(x, x$Rank)
  s <- lapply(s, function(x) x$NCBI_ID)
  output <- vector('list', length(s))
  for (i in seq_along(output)) {
    ref_taxids <- unique(ref[[names(s)[i]]])
    target_taxids <- unique(s[[i]])
    output[[i]] <- sum(target_taxids %in% ref_taxids)
    names(output)[i] <- names(s)[i]
  }
  data.frame(
    Rank = names(output),
    inset = unlist(output, use.names = FALSE)
  )
}

## outset means taxa that cannot be found in the reference.
## This could happen because of outdated taxids, or because
## the fitlers used for getting the reference excluded several taxa.
outSet <- function(x, ref) {
  s <- split(x, x$Rank)
  s <- lapply(s, function(x) x$NCBI_ID)
  output <- vector('list', length(s))
  for (i in seq_along(output)) {
    ref_taxids <- unique(ref[[names(s)[i]]])
    target_taxids <- unique(s[[i]])
    output[[i]] <- sum(!target_taxids %in% ref_taxids)
    names(output)[i] <- names(s)[i]
  }
  data.frame(
    Rank = names(output),
    outset = unlist(output, use.names = FALSE)
  )
}
original <- bp |> ## These are annotations from sources only
  filter(Evidence %in% c('tas', 'nas', 'exp', 'igc'))
```

Calculate completeness before propagation:

```{r completeness before propagation}
inset_before <- original |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(inSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
outset_before <- original |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(outSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
completeness_before <- left_join(inset_before, outset_before, by = c('Attribute_group', 'Rank')) |> 
  left_join(reference_summary, by = 'Rank') |> 
  mutate(completeness = (inset / ref) * 100)
DT::datatable(completeness_before)

```

Completeness after propagation:

```{r completeness after propagation}
inset_after <- bp |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(inSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
outset_after <- bp |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(outSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
completeness_after <- left_join(inset_after, outset_after, by = c('Attribute_group', 'Rank')) |> 
  left_join(reference_summary, by = 'Rank') |> 
  mutate(completeness = (inset / ref) * 100)
DT::datatable(completeness_after)
```

## Completenes heatmaps

```{r completeness heatmap}
ordered_rownames <- bp |> 
  filter(Attribute_group != 'antimicrobial resistance') |> 
  count(Attribute_group) |> 
  arrange(-n) |> 
  pull(Attribute_group)

## Create matrices
completeness_mat_before <- completeness_before |>
  select(Attribute_group, Rank, completeness) |>
  pivot_wider(
    names_from = Rank, values_from = completeness, values_fill = 0
  ) |>
  column_to_rownames(var = 'Attribute_group') |>
  relocate(strain, species, genus) |> 
  as.matrix()

completeness_mat_after <- completeness_after |> 
  # filter(Attribute_group != 'antimicrobial sensitivity') |> 
  filter(Attribute_group != 'antimicrobial resistance') |> 
  select(Attribute_group, Rank, completeness) |> 
  pivot_wider(
    names_from = Rank, values_from = completeness, values_fill = 0
  ) |> 
  column_to_rownames(var = 'Attribute_group') |> 
  relocate(
    strain, species, genus, family, order, class, phylum, kingdom
  ) |> 
  as.matrix()


## Create heatmaps
color_fun <- circlize::colorRamp2(
  breaks = c(0, 100), colors = c('white', 'gray40')
)
lgd <- Legend(col_fun = color_fun, title = "Completeness")
ht_b <- Heatmap(
  matrix = completeness_mat_before[ordered_rownames,],
  cluster_rows = FALSE, cluster_columns = FALSE,
  row_names_side = 'left',
  show_heatmap_legend = FALSE,
  col = color_fun,
  column_title = "Before",
  row_names_max_width = max_text_width(
    rownames(completeness_mat_before), 
    gp = gpar(fontsize = 12)
  )
  # cell_fun = function(j, i, x, y, width, height, fill) {
  #       grid.rect(x = x, y = y, width = width, height = height,
  #           gp = gpar(col = "black", fill = NA))
  # }
)

ht_a <- Heatmap(
  matrix = completeness_mat_after[ordered_rownames,],
  cluster_rows = FALSE, cluster_columns = FALSE,
  row_names_side = 'left',
  name = 'Completeness',
  heatmap_legend_param = list(
    at = c(0, 50, 100)
  ),
  col = color_fun,
  column_title = "After",
  row_names_max_width = max_text_width(
    rownames(completeness_mat_after), 
    gp = gpar(fontsize = 12)
  )

  # cell_fun = function(j, i, x, y, width, height, fill) {
  #       grid.rect(x = x, y = y, width = width, height = height,
  #           gp = gpar(col = "black", fill = NA))
  # }
)

## Combine heatmaps
ht <- grid.grabExpr(
  draw(ht_b + ht_a, ht_gap = unit(0.4, "cm"))
)
```

### Combined plot

```{r, fig.width=6.15, fig.height=9.68}
p2 <- plot_grid(
  summary_source_p, ht, 
  # labels = c('a)', 'b)'), 
  ncol = 1, 
  rel_heights = c(0.38, 0.62)
)
ggsave("completeness.png", plot = p2, width = 6.15, height = 9.68, units = 'in')
p2
```

### Relationship between initial ammount of annotations and magnitude of propagation

```{r, fig.width=9.4, fig.height= 6.1}
cols <- c('Attribute_group', 'Rank', 'completeness')
x <- completeness_before |> 
  select(all_of(cols)) |> 
  rename(comp_bef = completeness) |> 
  complete(Attribute_group, Rank, fill = list(comp_bef = 0))
y <- completeness_after |> 
  select(all_of(cols)) |> 
  rename(comp_aft = completeness)
original_summary <- original |> 
  count(Attribute_group)
z <- left_join(x, y, by = c('Attribute_group', 'Rank')) |> 
  mutate(ratio = log((comp_aft + 1) / (comp_bef + 1))) |> 
  left_join(original_summary, by = 'Attribute_group') |> 
  arrange(n, Attribute_group) |> 
  mutate(Attribute_group = fct_inorder(Attribute_group))
p9 <- z |> 
  ggplot(aes(Attribute_group, ratio)) +
  # geom_point(aes(size = comp_bef), shape = 1, alpha = 0.5) +
  geom_point(aes(size = comp_bef, fill = n), shape = 21,  alpha = 0.5) +
  facet_wrap(~Rank, nrow = 1) +
  labs(
      x = 'Attribute group',
      y = 'log2(completeness after propagation + 1 / completeness before propagation + 1)'
  ) +
  scale_fill_viridis_c(name = 'Total starting\nnumber of\nannotations') +
  scale_size(name = 'Completeness\nbefore propagation\nper rank') +
  theme_bw() +
  coord_flip()
ggsave(
  filename = 'sup2.png', 
  plot = p9,
  units = c('in'),
  width = 9.4,
  height = 6.1
)
p9
```
## Dispersion of sources

Import bugphyzz data before propagation and before resolving conflicts, 
agreements, and double annotations.

```{r, fig.width=9, fig.height=11}
data <- original |> 
  count(Attribute_group, Attribute_source, Rank) |> 
  mutate(new_column = paste0(Attribute_group, '|', Rank)) |>
  select(new_column, Attribute_source, n) |> 
  pivot_wider(
    names_from = 'Attribute_source', values_from = 'n', values_fill = 0
  ) |> 
  arrange(new_column) |> 
  tibble::column_to_rownames(var = 'new_column') |> 
  as.matrix()

bar_vct <- sub('^.*\\|', '', rownames(data))
split_vct <- sub('\\|.*$', '', rownames(data))
bar_color <- viridis::viridis(n = 3, option = 'C')
names(bar_color) <- c('genus', 'species', 'strain')
row_ha <- rowAnnotation(
  'Rank' = bar_vct, col = list(Rank = bar_color), 
  show_annotation_name = FALSE
)
# log2_data <- log2(data + 1)
data[data > 0] <- 1

color_fun2 <- circlize::colorRamp2(
  breaks = c(0, 1), colors = c('white', 'gray50')
)
ht_sources <- Heatmap(
  matrix = data,
  cluster_rows = FALSE, cluster_columns = FALSE,
  show_row_names = FALSE,
  row_names_side = 'left',
  name = 'Presence/ausence',
  show_heatmap_legend = TRUE,
  col = color_fun2(c(0, 1)),
  left_annotation = row_ha, 
  row_split = split_vct,
  column_names_rot = 45,
  row_title_rot = 0, gap = unit(0.1, 'inches'),
  cell_fun = function(j, i, x, y, width, height, fill) {
        grid.rect(x = x, y = y, width = width, height = height,
            gp = gpar(col = "gray20", fill = NA))
  }
)

png(filename = 'sup3.png', width = 10, height = 11, units = 'in', res = 300)
draw(ht_sources)
dev.off()
ht_sources
```

# Session information

```{r class.soruce = 'fold-show'}
sessioninfo::session_info()
```

