---
title: "Data integration and stats"
output:
    html_document:
        code_folding: show 
        toc: true
---

```{r script options, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

## Load packages

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(dplyr)
library(taxPPro)
library(ggplot2)
library(forcats)
library(ggpubr)
library(taxPPro)
library(tidyr)
library(ComplexHeatmap)
library(purrr)
library(forcats)
library(ggbreak)
library(tibble)
library(patchwork)
library(grid)
library(cowplot)
```

## Import data

A couple of filters are applied by deault when importing bugphyzz with the
`importBugphyzz` function:

1. Data imputed through ASR must have a validation result higher than 0.5.
2. For discrete attributes, Frequency/Score most be above 0.5 for imputed data (rarely frequency is excluded).

```{r import bp, message=FALSE}
bp <- importBugphyzz() |> 
    map(~ mutate(.x, NCBI_ID = as.character(NCBI_ID)))
```

## Columns with NAs

```{r columns with NAs}
## This is more of a check tha a result
nas_in_cols <- lapply(bp, function(x)  {
    n <- map_int(x, function(y) sum(is.na(y)))
    per <- map_dbl(x, function(y) round(mean(is.na(y)) * 100))
    data.frame(column_name = colnames(x), n = unname(n), per = unname(per))
}) |> 
    bind_rows(.id = "names") |> 
    group_by(column_name) |> 
    summarise(
        n_rows = sum(n),
        per_rows = round(mean(per))
    )
myDataTable(nas_in_cols)
```

## Totals

Number of taxa, annotations, sources, attribute groups (physiologies),
and attributes.

Let's only consider numbers for

```{r totals}
## Number of unique taxa
n_taxa <- map(bp, ~ .x$NCBI_ID) |> 
    unlist(use.names = FALSE) |> 
    unique() |> 
    length()

## Number of annotations
n_annotations <- map_int(bp, nrow) |> 
    sum()

## Number of physiologies/attribute groups
n_attr <- length(bp)

## Number of sources
n_sources <- map(bp, ~ {
    unique(.x$Attribute_source) |> 
        {\(y) y[!is.na(y)]}()
}) |> 
    unlist(recursive = TRUE, use.names = FALSE) |> 
    unique() |> 
    length()

## Number of annotations from sources
n_annotations_source <- map_int(bp, ~ {
    .x |> 
        filter(!is.na(Attribute_source)) |> 
        nrow()
}) |> 
    sum()

## Number of annotations IBD
n_annotations_ibd <- map_int(bp, ~ {
    .x |> 
        filter(Evidence == "tax") |> 
        nrow()
}) |> 
    sum()

## Number of annotations ASR
n_annotations_asr <- map_int(bp, ~ {
    .x |> 
        filter(Evidence == "asr") |> 
        nrow()
}) |> 
    sum()

## Number of 
num_vs_dis_n <- map_chr(bp, ~ {
    unique(.x$Attribute_type)
}) |> 
    table() |> 
    as.data.frame() |> 
    set_names(c("name", "n")) |> 
    mutate(name = ifelse(name == "numeric", "numeric", "discrete")) |> 
    count(name, wt = n)



attr_asr_default_names <- map(bp, ~ {
    unique(.x$Evidence)
}) |> 
    keep(~ "asr" %in% .x) |> 
    names()

attr_asr_default <- length(attr_asr_default_names)

attr_asr_all <- importVal() |>
    filter(rank == "all") |> 
    select(physiology, mcc_mean, r2_mean) |> 
    pull(physiology) |> 
    unique() |> 
    length()

count_summary_tbl <- tibble::tribble(
    ~name, ~n,
    "Number of taxa", n_taxa,
    "Number of annotations", n_annotations,
    "Number of attributes", n_attr,
    "Number of discrete attributes", pull(filter(num_vs_dis_n, name == "discrete"),n),
    "Number of sources", n_sources,
    "Number of annoations from sources", n_annotations_source,
    "Number of IBD annotations", n_annotations_ibd,
    "Number of annotations imputed through ASR", n_annotations_asr,
    "Number of attributes with ASR data (default > 0.5 val)", attr_asr_default,
    "Number of attributes with ASR data (all)", attr_asr_all
)

myDataTable(count_summary_tbl)
```

## Histograms of scores

```{r, message=FALSE}
bp2 <- importBugphyzz(v = 0, exclude_rarely = FALSE)
bp2_discrete <- map(bp2, ~{
    .x |> 
        filter(Evidence == "asr", Attribute_type != "numeric")
}) |> 
    discard(~ !nrow(.x))

scores <- map(bp2_discrete, ~ pull(.x, Score)) |> 
    unlist(recursive = TRUE, use.names = FALSE) |> 
    {\(y) data.frame(x = y)}()
scores |> 
    ggplot(aes(x)) +
    geom_histogram(binwidth = 0.1, fill = "gray80", color = "black", size = 0.2) +
    labs(
        x = "Scores", y = "Frequency",
        title = "Scores of data imputed with ASR (discrete only)"
    ) +
    theme_bw()
```

## Histogram of NSTI

```{r}
bp2_numeric <- map(bp2, ~{
    .x |> 
        filter(
            Evidence == "asr", Attribute_type == "numeric",
        )
}) |> 
    discard(~ !nrow(.x)) |> 
    map(~ filter(.x, !is.na(NSTI)))

nsti <- map(bp2_numeric, ~ pull(.x, NSTI)) |> 
    unlist(recursive = TRUE, use.names = FALSE) |> 
    {\(y) data.frame(x = y)}()
nsti |> 
    ggplot(aes(x)) +
    geom_histogram(binwidth = 0.1, fill = "gray80", color = "black", size = 0.2) +
    labs(
        x = "Scores", y = "Frequency",
        title = "NSTI of data imputed with ASR (tips; numeric only)"
    ) +
    theme_bw()
```

## Summary table

```{r}
evidence_summary <- bp |> 
    map(~ {
        .x |> 
            mutate(
                Evidence = case_when(
                    Evidence %in% c("nas", "tas", "exp", "igc") ~ "source",
                    TRUE ~ Evidence
                    )
            ) |> 
            count(Evidence) |> 
            pivot_wider(
                names_from = "Evidence", values_from = "n"
            )
    }) |>
    bind_rows(.id = "Attribute") |> 
    modify(~ replace_na(.x, 0)) |> 
    relocate(Attribute, source, ibd = tax, asr) |> 
    mutate(total = source + ibd + asr)

number_of_attr_values <- bp |> 
    map(~ {
        attr_type <- unique(.x$Attribute_type)
        if (attr_type %in% c("binary", "numeric")) {
            output <- .x |> 
                select(Attribute, Attribute_type) |> 
                distinct() |> 
                count(Attribute, Attribute_type, name = "Attribute_values") |> 
                mutate(Attribute_values = ifelse(Attribute_type == "binary", 2, Attribute_values))
        } else {
            output <- .x |> 
                select(Attribute, Attribute_value, Attribute_type) |> 
                distinct() |> 
                count(Attribute, Attribute_type, name = "Attribute_values")
        }
        return(output)
    }) |> 
    bind_rows(.id = "Attribute")


references <- bp |> 
    map(~{
        .x |> 
            select(Attribute, Attribute_source) |> 
            drop_na() |> 
            distinct() |> 
            group_by(Attribute) |> 
            mutate(Attribute_source = paste0(sort(Attribute_source), collapse = ", ")) |> 
            ungroup() |> 
            distinct()
    }) |> 
    bind_rows()


tbl <- reduce(list(number_of_attr_values, evidence_summary, references), left_join) |> 
    rename(Type = Attribute_type, `No. Attribute values` = Attribute_values,
           `Annotations from Source` = source, `Annotations from IBD` = ibd,
           `Annotations from ASR` = asr, `Total annotations` = total,
           Sources = Attribute_source
    )
myDataTable(tbl, page_len = nrow(tbl))
```


```{r}
valid_ranks <- c(
    "superkingdom", "phylum", "class", "order", "family",
    "genus", "species", "strain"
)
attr_order <- tbl |> 
    select(Attribute, `Total annotations`) |> 
    distinct() |> 
    arrange(-`Total annotations`) |> 
    pull(Attribute)
counts_rank <- bp |> 
    map(~ count(.x, Attribute, Rank)) |> 
    bind_rows() |> 
    mutate(Attribute = factor(Attribute, levels = attr_order)) |> 
    mutate(Rank = factor(Rank, levels = valid_ranks))
p_counts_rank <- counts_rank |> 
    ggplot(aes(Attribute, n)) +
    geom_col(aes(fill = Rank), position = "stack") +
    scale_fill_discrete(name = "Rank") +
    labs(
        x = "Attribute", y = "No. annotations"
    ) +
    theme_bw() +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1)
    )
p_counts_rank
```


```{r}
p_count_types <- tbl |> 
    mutate(Attribute = factor(Attribute, levels = attr_order)) |> 
    pivot_longer(
        names_to = "count_type", values_to = "n", cols = c(4, 5, 6) 
    ) |>
    ggplot(aes(Attribute, n)) +
    geom_col(aes(fill = count_type), position = "stack") +
    labs(
        x = "Attribute", y = "No. annotations"
    ) +
    scale_fill_discrete(name = "Annotation types") +
    scale_y_continuous(label = scales::comma) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_count_types
```


```{r}
n_annot_tax <- bp |> 
   map(~ {
       attr_type <- unique(.x$Attribute_type)
       .x |> 
           filter(Rank %in% c("strain", "species", "genus")) |> 
           select(Attribute, NCBI_ID, Rank)
   }) |> 
    bind_rows() |> 
    count(NCBI_ID, Rank)
p_n_annot_tax <- n_annot_tax |> 
    ggplot() +
    geom_histogram(aes(x = n)) +
    labs(
        x = "Number of annotations per taxon",
        y = "Frequency"
    ) +
    facet_wrap(~Rank, ncol = 1) +
    theme_bw()
```

```{r}
n_annot_tax |> 
    summary()
```

## Number of annotations per attribute

```{r, fig.height=7, fig.width=11}
p1 <- plot_grid(
  p_count_types, p_counts_rank,
  labels = c('a)', 'b)'),
  ncol = 1, align = "v"
  # rel_widths = c(0.55, 0.45)
)

p2 <- plot_grid(
    p1, p_n_annot_tax,
    labels = c("", "c)"),
    ncol = 2, 
    rel_widths = c(0.75, 0.25)
)
p2
```




## Validation plots

### Discrete

```{r}
val <- importVal()
dis_phys_names <- val |> 
    filter(!is.na(mcc_mean)) |> 
    group_by(physiology) |> 
    slice_max(order_by = mcc_mean, n = 1) |> 
    arrange(-mcc_mean) |> 
    pull(physiology)
pValDis <- val |> 
    filter(!is.na(mcc_mean))  |> 
    mutate(ltp_bp = ifelse(is.na(ltp_bp), ltp_bp_phys, ltp_bp)) |> 
    mutate(physiology = factor(physiology, levels = dis_phys_names)) |>
    mutate(guide_col = ifelse(as.character(physiology) == attribute, as.character(physiology), paste0(as.character(physiology), "|", attribute))) |> 
    arrange(physiology, mcc_mean) |> 
    ggplot(aes(forcats::fct_inorder(guide_col), mcc_mean, group = attribute)) +
    geom_errorbar(
        aes(ymin = mcc_mean - mcc_sd, ymax = mcc_mean + mcc_sd),
        position = position_dodge(0.5),
        width = 0, linewidth = 0.3
        
    ) +
    geom_hline(yintercept = 0.5, color = "red", linetype = "dotdash", linewidth = 0.2) +
    geom_point(
        aes(size = ltp_bp),
        shape = 23, position = position_dodge(0.5), fill = "white"
        # size = 2
    ) +
    scale_size_continuous(name = "tips annotated") +
    scale_y_continuous(
        breaks = round(seq(min(val$mcc_mean - val$mcc_sd, na.rm = TRUE) - 0.1, max(val$mcc_mean + val$mcc_sd, na.rm = TRUE) + 0.1, 0.2), 1)
    ) +
    labs(
        y = "Matthews Correlation Coefficient",
        x = "Attribute|Attribute value"
    ) +
    theme_bw()  +
    theme(
        axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.minor = element_blank()
        
    ) +
    coord_flip()
```

### Numeric

```{r}
num <- val |>
    filter(!is.na(r2_mean))
num_phys_names <- num |> 
    group_by(physiology) |> 
    slice_max(order_by = r2_mean, n = 1) |> 
    arrange(-r2_mean) |> 
    pull(physiology)
pValNum <- val |> 
    filter(!is.na(r2_mean))  |> 
    mutate(ltp_bp = ifelse(is.na(ltp_bp), ltp_bp_phys, ltp_bp)) |> 
    ggplot(aes(reorder(physiology, -r2_mean), r2_mean, group = attribute)) +
    geom_errorbar(
        aes(ymin = r2_mean - r2_sd, ymax = r2_mean + r2_sd),
        position = position_dodge(0.5),
        width = 0, linewidth = 0.3
        
    ) +
    geom_hline(yintercept = 0.5, color = "red", linetype = "dotdash", linewidth = 0.2) +
    geom_point(
        aes(size = ltp_bp),
        shape = 23, position = position_dodge(0.5), fill = "white"
        # size = 2
    ) +
    scale_size_continuous(name = "tips annotated") +
    scale_y_continuous(
        breaks = round(seq(min(val$r2_mean - val$r2_sd, na.rm = TRUE) - 0.1, max(val$r2_mean + val$r2_sd, na.rm = TRUE) + 0.1, 0.2), 1)
        
    ) +
    labs(
        y = "R-squared",
        x = "Attribute"
    ) +
    theme_bw()  +
    theme(
        axis.text.x = element_text(angle = 90, hjust = 1),
        panel.grid.minor = element_blank()
        
    ) +
    coord_flip()
```


```{r, fig.height=10, fig.width=7}
pVal <- plot_grid(
  pValDis, pValNum, 
  # labels = c('a)', 'b)'),
  ncol = 1, 
  align = 'v', rel_heights = c(0.83, 0.17)
)
pVal
```

## Completeness

### Totals before and after data imputation

```{r}
taxids_before <- bp |> 
    map( ~ {
        df <- .x |> 
            filter(Evidence != "asr") |> 
            select(NCBI_ID, Rank) |> 
            distinct()
        # ids <- as.character(df$NCBI_ID)
        # names(ids) <- df$Rank
        return(df)
    }) |> 
    bind_rows() |> 
    distinct() |> 
    count(Rank, name = "before_imputation")

taxids_after <- bp |> 
    map( ~ {
        df <- .x |> 
            # filter(Evidence != "asr") |> 
            select(NCBI_ID, Rank) |> 
            distinct()
        # ids <- as.character(df$NCBI_ID)
        # names(ids) <- df$Rank
        return(df)
    }) |> 
    bind_rows() |> 
    distinct() |> 
    count(Rank, name = "after_imputation")
total_increment_of_taxa <- full_join(taxids_before, taxids_after, by = "Rank")
myDataTable(total_increment_of_taxa)
```

### Completeness tables

```{r getting reference for completeness, warning=FALSE}
valid_ranks <- validRanks()
exclude_all_fname <- system.file(
  file.path('extdata', 'proc_exclude_all_07122023.txt'),
  package = 'taxPPro',
  mustWork = TRUE
)
exclude_all <- read.table(exclude_all_fname, col.names = 'taxid')
exclude_all$taxid <- as.character(exclude_all$taxid)
exclude_all$rank <- taxizedb::taxid2rank(exclude_all$taxid, db = 'ncbi')
exclude_all <- exclude_all[which(!is.na(exclude_all$rank)),]
# exclude_all$rank <- ifelse(exclude_all$rank == 'superkingdom', 'kingdom', exclude_all$rank)
exclude_all <- exclude_all[which(exclude_all$rank %in% valid_ranks),]

strains_fname <- system.file(file.path('extdata', 'proc_strains_07122023.txt'), package = 'taxPPro', mustWork = TRUE)
strains <- read.table(strains_fname, col.names = 'taxid')
strains$taxid <- as.character(strains$taxid)
strains$rank <- taxizedb::taxid2rank(strains$taxid, db = 'ncbi')
strains <- strains[which(strains$rank == 'strain'),]

reference_df <- rbind(exclude_all, strains)
reference_summary <- reference_df |> 
    count(rank, name = "NCBI_ref")

myDataTable(reference_summary)
```

```{r}
inSet <- function(dat, ref) {
    valid_ranks <- c(
        "superkingdom",
        "phylum", "class","order", "family",
        "genus", "species", "strain"
    )
    datByRank <- split(dat, dat$Rank)
    refByRank <- split(ref, ref$rank)
    output <- vector("integer", length(valid_ranks))
    for (i in seq_along(output)) {
        names(output)[i] <- valid_ranks[i]
        if (valid_ranks[i]  %in% names(datByRank)) {
        output[[i]] <- 
            sum(unique(datByRank[[valid_ranks[i]]]$NCBI_ID) %in% refByRank[[valid_ranks[i]]]$taxid)

        }
    }
    df <- data.frame(rank = names(output), inSet = unname(output))
    return(df)
}

outSet <- function(dat, ref) {
    valid_ranks <- c(
        "superkingdom",
        "phylum", "class","order", "family",
        "genus", "species", "strain"
    )
    datByRank <- split(dat, dat$Rank)
    refByRank <- split(ref, ref$rank)
    output <- vector("integer", length(valid_ranks))
    for (i in seq_along(output)) {
        names(output)[i] <- valid_ranks[i]
        if (valid_ranks[i]  %in% names(datByRank)) {
        output[[i]] <- 
            sum(!unique(datByRank[[valid_ranks[i]]]$NCBI_ID) %in% refByRank[[valid_ranks[i]]]$taxid)

        }
    }
    df <- data.frame(rank = names(output), outSet = unname(output))
    return(df)
}
```


### Before imputation

```{r}
insetDataBefore <- bp |> 
    map(~ filter(.x, Evidence != "asr")) |> 
    map(~ inSet(dat = .x, ref = reference_df)) |>
    bind_rows(.id = "Attribute")
outsetDataBefore <- bp |> 
    map(~ outSet(dat = .x, ref = reference_df)) |>
    bind_rows(.id = "Attribute")
completenessBefore <- reduce(list(insetDataBefore, outsetDataBefore, reference_summary), full_join) |> 
    mutate(completeness = round(inSet / NCBI_ref * 100)) |> 
    rename(Rank = rank)
```

### After imputation

```{r}
insetDataAfter <- bp |> 
    map(~ inSet(dat = .x, ref = reference_df)) |>
    bind_rows(.id = "Attribute")
outsetDataAfter <- bp |> 
    map(~ outSet(dat = .x, ref = reference_df)) |>
    bind_rows(.id = "Attribute")
completenessAfter <- reduce(list(insetDataAfter, outsetDataAfter, reference_summary), full_join) |> 
    mutate(completeness = round(inSet / NCBI_ref * 100)) |> 
    rename(Rank = rank)
```

```{r}
completeness <- full_join(
    completenessBefore, completenessAfter, suffix = c("_bef", "_aft"),
    by = c("Attribute", "Rank", "NCBI_ref")
) |> 
    select(Attribute, Rank, starts_with("completeness"))
```

## Completenes heatmaps

```{r completeness heatmap}
## Create matrices
completeness_mat_before <- completenessBefore |>
  select(Attribute, Rank, completeness) |>
  pivot_wider(
    names_from = Rank, values_from = completeness, values_fill = 0
  ) |>
  column_to_rownames(var = 'Attribute') |>
  select(strain, species, genus) |> 
  as.matrix()

completeness_mat_after <- completenessAfter |> 
  select(Attribute, Rank, completeness) |> 
  pivot_wider(
    names_from = Rank, values_from = completeness, values_fill = 0
  ) |> 
  column_to_rownames(var = 'Attribute') |> 
  relocate(
    strain, species, genus, family, order, class, phylum, superkingdom
  ) |> 
  as.matrix()

ordered_rownames <- names(sort(rowSums(completeness_mat_after), decreasing = TRUE))

## Create heatmaps
color_fun <- circlize::colorRamp2(
  breaks = c(0, 100), colors = c('white', 'gray40')
)
lgd <- Legend(col_fun = color_fun, title = "Completeness")
ht_b <- Heatmap(
  matrix = completeness_mat_before[ordered_rownames,],
  cluster_rows = FALSE, cluster_columns = FALSE,
  row_names_side = 'left',
  show_heatmap_legend = FALSE,
  col = color_fun,
  column_title = "No ASR",
  row_names_max_width = max_text_width(
    rownames(completeness_mat_before), 
    gp = gpar(fontsize = 12)
  )
)

ht_a <- Heatmap(
  matrix = completeness_mat_after[ordered_rownames,],
  cluster_rows = FALSE, cluster_columns = FALSE,
  row_names_side = 'left',
  name = 'Completeness',
  heatmap_legend_param = list(
    at = c(0, 50, 100)
  ),
  col = color_fun,
  column_title = "ASR",
  row_names_max_width = max_text_width(
    rownames(completeness_mat_after), 
    gp = gpar(fontsize = 12)
  )
)

## Combine heatmaps
ht <- grid.grabExpr(
  draw(ht_b + ht_a, ht_gap = unit(0.4, "cm"))
)
```

### Combined plot

```{r, fig.width=14, fig.height=10}
p2 <- plot_grid(
  pVal, ht, 
  labels = c('a)', 'b)'),
  ncol = 2, 
  rel_widths = c(0.55, 0.45)
  
  # rel_heights = c(0.38, 0.62)
)
ggsave("completeness.png", plot = p2, width = 6.15, height = 9.68, units = 'in')
p2
```


```{r, fig.width=9, fig.height=15}
x <- bp |> 
    map(~{
        .x |> 
            filter(!is.na(Attribute_source)) |> 
            count(Attribute, Attribute_source, Rank)
    }) |> 
    bind_rows()


m <- x |>
    arrange(Attribute, Rank) |> 
    unite(col = "Attribute|Rank", Attribute, Rank, sep = "|") |> 
    pivot_wider(
        names_from = "Attribute_source", values_from = "n"
    ) |> 
    tibble::column_to_rownames(var = "Attribute|Rank") |> 
    as.data.frame() |> 
    as.matrix()
m[is.na(m)] <- 0

color_fun <- circlize::colorRamp2(
  breaks = c(0, max(m)), colors = c('white', 'gray40')
)



row_colors <- case_when(
    grepl("genus", rownames(m)) ~ "red",
    grepl("species", rownames(m)) ~ "blue",
    grepl("strain", rownames(m)) ~ "orange"
)


row_ha <- rowAnnotation(Rank = sub("^(.*\\|)(\\w+)$", "\\2", rownames(m)))

row_ha <- rowAnnotation(Rank = row_colors)


h <- Heatmap(
    matrix = m,
    cluster_rows = FALSE, cluster_columns = FALSE,
    row_names_side = 'left',
    show_heatmap_legend = TRUE,
    col = color_fun,
    name = "No. Annotations",
    left_annotation = row_ha,
    row_names_max_width = max_text_width(
        rownames(m), 
        gp = gpar(fontsize = 12)
    )
)
h
```

# Session information

```{r class.soruce = 'fold-show'}
sessioninfo::session_info()
```
