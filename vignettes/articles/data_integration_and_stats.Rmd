---
title: "Data integration and stats"
output:
    html_document:
        code_folding: hide
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE
)
```


```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(dplyr)
library(taxPPro)
library(ggplot2)
library(forcats)
library(ggpubr)
library(taxPPro)
library(tidyr)
library(ComplexHeatmap)
library(purrr)
library(forcats)
library(ggbreak)
library(tibble)
```

# Data

```{r, message=FALSE}
bp <- importBugphyzz(version = 'devel', force_download = TRUE)
```

# EDA

Dimensions:

```{r}
map_chr(dim(bp), ~ format(.x, big.mark = ','))
```

Columns with NA in the dataset:

```{r}
df <- data.frame(
    cols = colnames(bp),
    n_na = unname(map_int(bp, ~ sum(is.na(.x))))
)
df |> 
  ggplot(aes(cols, n_na)) +
  geom_col() +
  labs(
    y = 'NA count', x = 'Column name',
    title = 'NA count per column in the main bupphyzz import'
  ) +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

```{r, message=FALSE}
bp |> 
  count(Evidence) |> 
  ggplot(aes(reorder(Evidence, desc(n)), n)) +
  geom_col() +
  labs(
    x = 'Evidence', y = 'Annotaions count'
  ) +
  scale_y_continuous(limits = c(0, 2000000), labels = scales::comma) +
  scale_y_cut(breaks = c(10000, 100000)) +
  theme_bw() +
  theme(
    panel.grid.major.x = element_blank()
  )
```

Frequency

```{r}
bp |> 
  count(Frequency) |> 
  mutate(Frequency = fct_relevel(Frequency, 'always', 'usually', 'sometimes', 'rarely')) |> 
  ggplot(aes(Frequency, n)) +
  geom_col() +
  labs(
    x = 'Frequency keywords', y = 'Count',
  ) +
  scale_y_continuous(limits = c(0, 1e6), labels = scales::comma) +
  scale_y_cut(breaks = c(100000)) +
  theme_bw() +
  theme(
    panel.grid.major.y = element_blank()
  )
```

Histogram of scores

```{r}
bp |> 
  ggplot(aes(Score)) +
  geom_histogram() +
  labs(
    title = 'Distribution of scores in the main bugphyzz import',
    x = 'Scores', y = 'Frequency'
  ) +
  scale_y_continuous(labels = scales::comma) +
  theme_bw()
  
```

# Source data

## Number of original sources

```{r}
bp_source <- filter(bp, !is.na(Attribute_source))
unique_sources <- bp_source |> 
    filter(Evidence  %in% c('exp', 'igc', 'tas', 'nas')) |> 
    pull(Attribute_source) |> 
    unique() |> 
    strsplit(';') |> 
    unlist() |> 
    unique() |> 
    sort()
n_sources <- length(unique_sources)
n_sources
```

# Completeness and 

Here, inheritance and asr are treated as two separate and new sources.
Note that the majority of annotations actually come from the propagation step.

```{r source summary}
summary_source <- bp |> 
  mutate(
    Attribute_source = ifelse(
      is.na(Attribute_source), Evidence, Attribute_source
    )
  ) |> 
  mutate(
    Attribute_source = case_when(
      Attribute_source == 'inh' ~ 'Inheritance',
      Attribute_source == 'asr' ~ 'ASR',
      TRUE ~ Attribute_source
    )
  ) |> 
  filter(!grepl(';', Attribute_source)) |> # remove repeated annotations for now
  count(Attribute_source) |> 
  arrange(-n) |> 
  mutate(
    origin = case_when(
      Attribute_source %in% c('ASR', 'Inheritance') ~ 'Propagation',
      TRUE ~ 'Original source'
    )
  )
  # head(10) # This is to get only the top 10 of the list
  
# summary_source
summary_source_p <- summary_source |> 
  mutate(origin = fct_reorder(origin, desc(n))) |> 
  ggplot(aes(reorder(Attribute_source, -n), n)) +
  geom_col(aes(fill = origin)) +
  labs(
    x = 'Source', y = 'Number of annotations'
  ) +
  scale_y_continuous(limits = c(0, 1500000), labels = scales::comma) +
  scale_y_cut(breaks = c(100, 20000)) +
  scale_fill_discrete(name = '') +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank()
  )
summary_source_p
```

# Completeness

## Get reference sets

```{r}
valid_ranks <- c(
  'superkingdom', 'phylum', 'class', 'order', 'family', 'order', 'genus',
  'species', 'strain'
)
exclude_all_fname <- system.file(
  'extdata/proc_exclude_all_07122023.txt', package = 'taxPPro', 
  mustWork = TRUE
)
exclude_all <- read.table(exclude_all_fname, col.names = 'taxid')
exclude_all$taxid <- as.character(exclude_all$taxid)
exclude_all$rank <- taxizedb::taxid2rank(exclude_all$taxid, db = 'ncbi')
exclude_all <- exclude_all[exclude_all$rank %in% valid_ranks,]

strains_fname <- system.file(
  'extdata/proc_strains_07122023.txt', package = 'taxPPro', mustWork = TRUE
)
strains <- read.table(strains_fname, col.names = 'taxid')
strains$taxid <- as.character(strains$taxid)
strains$rank <- taxizedb::taxid2rank(strains$taxid, db = 'ncbi')
strains <- strains[strains$rank == 'strain',]

reference_df <- rbind(exclude_all, strains)
reference_df$rank <- ifelse(reference_df$rank == 'superkingdom', 'domain', reference_df$rank)
reference_summary <- count(reference_df, rank)
colnames(reference_summary) <- c('Rank', 'ref')
reference <- split(reference_df, factor(reference_df$rank)) |> 
  lapply(function(x) unique(x$taxid))
lapply(reference, length)
```

```{r}
inSet <- function(x, ref) {
  s <- split(x, x$Rank)
  s <- lapply(s, function(x) x$NCBI_ID)
  output <- vector('list', length(s))
  for (i in seq_along(output)) {
    ref_taxids <- unique(ref[[names(s)[i]]])
    target_taxids <- unique(s[[i]])
    output[[i]] <- sum(target_taxids %in% ref_taxids)
    names(output)[i] <- names(s)[i]
  }
  data.frame(
    Rank = names(output),
    inset = unlist(output, use.names = FALSE)
  )
}

outSet <- function(x, ref) {
  s <- split(x, x$Rank)
  s <- lapply(s, function(x) x$NCBI_ID)
  output <- vector('list', length(s))
  for (i in seq_along(output)) {
    ref_taxids <- unique(ref[[names(s)[i]]])
    target_taxids <- unique(s[[i]])
    output[[i]] <- sum(!target_taxids %in% ref_taxids)
    names(output)[i] <- names(s)[i]
  }
  data.frame(
    Rank = names(output),
    outset = unlist(output, use.names = FALSE)
  )
}

```


```{r}
## Attribute_group && Rank
original <- bp |> 
  filter(Evidence %in% c('tas', 'nas', 'exp', 'igc'))
# propagation <- bp |> 
  # filter(Evidence %in% c('asr', 'inh'))
```

```{r}
inset_before <- original |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(inSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
outset_before <- original |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(outSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
completeness_before <- left_join(inset_before, outset_before, by = c('Attribute_group', 'Rank')) |> 
  left_join(reference_summary, by = 'Rank') |> 
  mutate(completeness = (inset / ref) * 100)
completeness_mat_before <- completeness_before |> 
  select(Attribute_group, Rank, completeness) |> 
  pivot_wider(
    names_from = Rank, values_from = completeness, values_fill = 0
  ) |> 
  column_to_rownames(var = 'Attribute_group') |> 
  as.matrix()
```

```{r}
inset_after <- bp |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(inSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
outset_after <- bp |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(outSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
completeness_after <- left_join(inset_after, outset_after, by = c('Attribute_group', 'Rank')) |> 
  left_join(reference_summary, by = 'Rank') |> 
  mutate(completeness = (inset / ref) * 100)
completeness_mat_after <- completeness_after |> 
  filter(Attribute_group != 'antimicrobial sensitivity') |> 
  select(Attribute_group, Rank, completeness) |> 
  pivot_wider(
    names_from = Rank, values_from = completeness, values_fill = 0
  ) |> 
  column_to_rownames(var = 'Attribute_group') |> 
  as.matrix()
```


Create heatmaps

```{r}
color_fun <- circlize::colorRamp2(
  breaks = c(0, 100), colors = c('white', 'dodgerblue4')
)
lgd <- Legend(col_fun = color_fun, title = "completeness")
ht_b <- Heatmap(
  matrix = completeness_mat_before,
  cluster_rows = FALSE, cluster_columns = FALSE,
  row_names_side = 'left',
  show_heatmap_legend = FALSE,
  col = color_fun,
  cell_fun = function(j, i, x, y, width, height, fill) {
        grid.rect(x = x, y = y, width = width, height = height, 
            gp = gpar(col = "black", fill = NA))
  }
)
ht_a <- Heatmap(
  matrix = completeness_mat_after,
  cluster_rows = FALSE, cluster_columns = FALSE,
  row_names_side = 'left',
  name = 'completeness',
  heatmap_legend_param = list(
    at = c(0, 50, 100)
  ),
  col = color_fun,
  cell_fun = function(j, i, x, y, width, height, fill) {
        grid.rect(x = x, y = y, width = width, height = height, 
            gp = gpar(col = "black", fill = NA))
  }
)
ht_list <- ht_b + ht_a
ht <- draw(
  ht_list, 
  ht_gap = unit(0.4, "cm")
)
```




```{r}
cols <- c('Attribute_group', 'Rank', 'completeness')
x <- completeness_before |> 
  select(all_of(cols)) |> 
  rename(comp_bef = completeness) |> 
  complete(Attribute_group, Rank, fill = list(comp_bef = 0))
y <- completeness_after |> 
  select(all_of(cols)) |> 
  rename(comp_aft = completeness)

z <- left_join(x, y, by = c('Attribute_group', 'Rank')) |> 
  mutate(ratio = log((comp_aft + 1) / (comp_bef + 1)))
  
  # mutate_at(.vars = c('comp_bef', 'comp_aft'), .funs =  ~ {
  #   ifelse(is.na(.x), 0, .x)
  # }) |> 
  # mutate(ratio = comp_bef / comp_aft)
p <- z |> 
    ggplot(aes(Attribute_group, ratio)) +
    geom_point(aes(size = comp_bef), shape = 21, fill = 'orange', alpha = 0.5) +
    facet_wrap(~Rank, nrow = 1) +
    labs(
        x = 'Attribute group',
        y = 'log2(completeness after propagation + 1 / completeness before propagation + 1)'
    ) +
    scale_size(name = 'Completeness \nbefore propagation') +
    theme_bw() +
    coord_flip()
p
```


Add confidence of annotations for this figure.
Discuss the meaning of the inference.
Hold out validation. Choose random annotations (10% ~30-100x). Cross-validation.
Hold out positives and negatives.
One rank or physiology at at a time.
Look for a citation for method implemented for validation.
Check Mathews Correlation coefficient for balanced/unbalanced prediction. Matthews correlation coefficient
Try different tissues.

# Dispersion of sources

Import bugphyzz data before propagation and before resolving conflicts, 
agreements, and double annotations.

```{r}
data <- original |> 
  count(Attribute_group, Attribute_source, Rank) |> 
  mutate(new_column = paste0(Attribute_group, '|', Rank)) |>
  select(new_column, Attribute_source, n) |> 
  pivot_wider(
    names_from = 'Attribute_source', values_from = 'n', values_fill = 0
  ) |> 
  arrange(new_column) |> 
  tibble::column_to_rownames(var = 'new_column') |> 
  as.matrix()


bar_vct <- sub('^.*\\|', '', rownames(data))
split_vct <- sub('\\|.*$', '', rownames(data))
bar_color <- viridis::viridis(n = 3, option = 'C')
names(bar_color) <- c('genus', 'species', 'strain')
row_ha <- rowAnnotation(
  'Rank' = bar_vct, col = list(Rank = bar_color), 
  show_annotation_name = FALSE
)
log2_data <- log2(data + 1)
ht_sources <- Heatmap(
  matrix = log2_data,
  cluster_rows = FALSE, cluster_columns = FALSE,
  show_row_names = FALSE,
  row_names_side = 'left',
  name = 'log2(# annotations + 1)',
  show_heatmap_legend = TRUE,
  col = color_fun(c(min(log2_data), max(log2_data))),
  left_annotation = row_ha, 
  row_split = split_vct,
  column_names_rot = 45,
  row_title_rot = 0, gap = unit(0.1, 'inches'),
  cell_fun = function(j, i, x, y, width, height, fill) {
        grid.rect(x = x, y = y, width = width, height = height, 
            gp = gpar(col = "black", fill = NA))
  }
)
ht_sources
```




# Number of taxa

## Top 10 species by number of annotations

This is not really the top ten species since there are a lot of overlaps (ties)
in the number of annotations. So these are the first 10 after arranging
by number of annotations per species and alphabetically.

```{r top 10 species, fig.width=4, fig.height=5}
top10_sp <- bp |> 
  filter(Rank == 'species') |>
  count(NCBI_ID, Taxon_name) |> 
  arrange(-n, Taxon_name) |> 
  head(10)
top10_sp_p <- top10_sp |> 
  ggplot(aes(reorder(Taxon_name, -n), n)) +
  geom_col(fill = 'dodgerblue4', alpha = 0.8) +
  labs(x = 'Top 10 species', y = '# annotations') +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1), 
    panel.grid.major.y = element_line(color = 'black', linewidth = 0.2),
    panel.grid.major.x = element_blank()
  )
top10_sp_p
```

## Frequency of number of annotations per taxon

```{r frequency N annotations}
unknowns <- bp |> 
  filter(Evidence %in% c('asr', 'inh') & Frequency == 'unknown')

normal <- bp |> 
  filter(!(Evidence %in% c('asr', 'inh') & Frequency == 'unknown'))

freq_annot_rank1 <- unknowns |> 
  count(Rank, name = 'n_taxa') |> 
  mutate(n_annot = 0)

freq_annot_rank2 <- bp |> 
  count(Rank, NCBI_ID, name = 'n_annot') |> 
  count(Rank, n_annot, name = 'n_taxa')

freq_annot_rank <- bind_rows(freq_annot_rank1, freq_annot_rank2)

freq_rank_p <- freq_annot_rank |> 
  mutate(Rank = factor(Rank, levels = taxRanks())) |> 
  filter(Rank %in% c('genus', 'species', 'strain')) |>
  ggplot(aes(n_annot, n_taxa)) +
  geom_col(fill = 'dodgerblue4', alpha = 0.8) +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  scale_x_continuous(
    # limits = c(0, 11),
    breaks = scales::pretty_breaks()
  ) +
  labs(x = 'Number of annotaions per taxon', y = 'Frequency') +
  facet_wrap(~Rank, scales = 'free_y') +
  theme_bw() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = 'black', linewidth = 0.1)
  )
freq_rank_p
```

Let's use log

```{r}
freq_rank_p2 <- freq_annot_rank |> 
  mutate(Rank = factor(Rank, levels = taxRanks())) |> 
  mutate(n_taxa = log2(n_taxa + 1)) |> 
  filter(Rank %in% c('genus', 'species', 'strain')) |>
  ggplot(aes(n_annot, n_taxa)) +
  geom_col(fill = 'dodgerblue4', alpha = 0.8) +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  scale_x_continuous(
    # limits = c(0, 11),
    breaks = scales::pretty_breaks()
  ) +
  labs(x = 'Number of annotaions per taxon', y = 'Frequency') +
  facet_wrap(~Rank, scales = 'free_y') +
  theme_bw() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = 'black', linewidth = 0.1)
  )
freq_rank_p2

```

Compare both plots (real numbers and log2)

```{r}
freq_rank_p_combined <- ggarrange(
  freq_rank_p + ggtitle('Real frequencies'), 
  freq_rank_p2 + ggtitle('log2 frequencies'), 
  ncol = 1
)
freq_rank_p_combined 
```




# Numbers per physiology

## Annotations per physiology

```{r, fig.width=4, fig.height=4}
phys_summary <- bp |> 
  count(Attribute_group) |> 
  arrange(-n)
phys_summary_plot <- phys_summary |> 
  ggplot(aes(Attribute_group, n)) +
  geom_col(fill = 'dodgerblue4', alpha = 0.8) +
  labs(y = '# annotations', x = 'Top 10 physiologies') +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(color = 'black', linewidth = 0.2)
  )
phys_summary_plot
```

# Figure 3?

```{r}
fig3 <- ggarrange(
  top10_sp_p,
  phys_summary_plot, labels = c('A)', 'B)'), hjust = 0
)
fig3
```


# Paragraph

Some calculation for paragraphs


```{r}
bp_subset <- bp |> 
  filter(
    !(Frequency == 'unknown' & Evidence %in% c('asr', 'inh'))
  )
n_annotations <- nrow(bp_subset)
n_unique_taxa <- length(unique(bp_subset$NCBI_ID))
n_unique_attr <- length(unique(bp_subset$Attribute))
n_unique_attr_grp <- length(unique(bp_subset$Attribute_group))
n_annotations_sources <- bp_subset |> 
  filter(!Evidence %in% c('asr', 'inh')) |> 
  nrow()
n_annotations_propagation <- bp_subset |> 
  filter(Evidence %in% c('asr', 'inh')) |> 
  nrow()
n_annotations
```

> bugphyzz contains a total of 
`r format(n_annotations, big.mark = ",", scientific = FALSE)` annotations, 
`r format(n_unique_taxa, big.mark = ",", scientific = FALSE)` unique taxa,
`r format(n_unique_attr, big.mark = ",", scientific = FALSE)` unique attributes, 
and `r format(n_unique_attr_grp, big.mark = ",", scientific = FALSE)` unique attributes groups (traits).
`r format(n_annotations_sources, big.mark = ",", scientific = FALSE)`
(`r round((n_annotations_sources / n_annotations) * 100)` %) annotations come directly
from `r format(n_sources, big.mark = ",", scientific = FALSE)` public sources and the remaining 
`r format(n_annotations_propagation, big.mark = ",", scientific = FALSE)`
(`r round((n_annotations_propagation / n_annotations) * 100)` %) were inferred with our
taxonomic propagation approach (see the ‘taxonomic propagation’ section
in methods), increasing our completeness from an average per taxonomic rank of
*** to *** % (Fig. ***).

# Session information

```{r}
sessioninfo::session_info()
```

