---
title: "Data integration and stats"
output:
    html_document:
        code_folding: hide
        toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

Load packages and import data

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(dplyr)
library(taxPPro)
library(ggplot2)
library(forcats)
library(ggpubr)
library(taxPPro)
library(tidyr)
library(ComplexHeatmap)
library(purrr)
library(forcats)
library(ggbreak)
library(tibble)
library(patchwork)
library(grid)
library(cowplot)
```


```{r, message=FALSE}
bp <- importBugphyzz()
```

## Basic stats

Number of taxa, annotations, attribute groups (physiologies), attributes

```{r}
## Totals
n_taxa <- length(unique(bp$NCBI_ID))
n_attr_grps <- length(unique(bp$Attribute_group))
n_attr <- length(unique(bp$Attribute))
n_annotations <- nrow(bp)
n_annotations_pred <- bp |> 
    filter(is.na(Attribute_source)) |> 
    nrow()
n_annotations_source <- bp |> 
    filter(!is.na(Attribute_source)) |> 
    nrow()
n_source <- bp |> 
    filter(!is.na(Attribute_source)) |> 
    pull(Attribute_source) |> 
    unique() |> 
    length()
```

We got totals of `r format(n_annotations, big.mark = ",", scientific = FALSE)`
annotations, `r format(n_taxa, big.mark = ",", scientific = FALSE)` taxa,
`r n_attr_grps` attribute groups (physiologies), and `r n_attr` attributes;
`r format(n_annotations_source, big.mark = ",", scientific = FALSE)`
annotations come from sources and 
`r format(n_annotations_pred, big.mark = ",", scientific = FALSE)` annotations
were imputed/predicted we our propagation method. 

# Histograms of scores

```{r scores hist}
scores_hist <- bp |> 
    ggplot(aes(Score)) +
    geom_histogram(
        binwidth = 0.05, color = 'black', fill = 'gray80', linewidth = 0.2
    ) +
    labs(x = 'Scores', y = 'Number of annotations') +
    scale_y_continuous(breaks = scales::pretty_breaks()) +
    theme_bw()
scores_hist
```

# Basic exploratory stats


## Evidence

```{r, message=FALSE}
bp |> 
  count(Evidence) |> 
  ggplot(aes(reorder(Evidence, desc(n)), n)) +
  geom_col(color = 'black', fill = 'gray80', linewidth = 0.2) +
  labs(
    x = 'Evidence', y = 'Number of annotations'
  ) +
  scale_y_continuous(limits = c(0, 2000000), labels = scales::comma) +
  scale_y_cut(breaks = c(10000, 100000)) +
  theme_bw() +
  theme(
    panel.grid.major.x = element_blank()
  )
```

## Frequency keywords

```{r Frequency, message=FALSE}
bp |> 
  count(Frequency) |> 
  mutate(Frequency = fct_relevel(Frequency, 'always', 'usually', 'sometimes', 'rarely')) |> 
  ggplot(aes(Frequency, n)) +
  geom_col() +
  labs(
    x = 'Frequency keywords', y = 'Number of annotations',
  ) +
  scale_y_continuous(limits = c(0, 1.5e6), labels = scales::comma) +
  scale_y_cut(breaks = c(100000)) +
  theme_bw() +
  theme(
    panel.grid.major.y = element_blank()
  )
```

# Number of annotations by attribute group (physiology)

# By attribute group and rank

```{r n attr per attr grp and rank}
dims <- map_chr(dim(bp), ~ format(.x, big.mark = ','))
total_annotations <- paste0('Total annotations: ', dims[[1]])
valid_ranks <- c(
  'kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species', 'strain'
)
attr_gp_rk_p <- bp |> 
  mutate(Rank = factor(Rank, levels = valid_ranks, ordered = FALSE)) |> 
  count(Attribute_group, Rank) |> 
  group_by(Attribute_group) |> 
  mutate(total = sum(n)) |> 
  ungroup() |> 
  ggplot(aes(reorder(Attribute_group, desc(total)), n)) +
  geom_col(aes(fill = Rank)) +
  labs(x = 'Attribute group', y = 'Number of annotations') +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_brewer(type = 'qual', palette = 'Set2', direction = -1, name = '') +
  scale_y_cut(breaks = c(100, 120000)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
     # legend.position = 'bottom'
  )
attr_gp_rk_p
```

## By attribute group and evidence

```{r n attr per attr grp and evidence}
evidence_code <- c('asr', 'tax', 'inh', 'inh2', 'tas', 'nas', 'igc', 'exp')
atr_gp_ev_p <- bp |> 
  mutate(Evidence = factor(Evidence, levels = evidence_code, ordered = FALSE)) |> 
  count(Attribute_group, Evidence) |> 
  group_by(Attribute_group) |> 
  mutate(total = sum(n)) |> 
  ungroup() |> 
  ggplot(aes(reorder(Attribute_group, desc(total)), n)) +
  geom_col(aes(fill = Evidence)) +
  labs(x = 'Attribute group', y = 'Number of annotations') +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_brewer(type = 'qual', palette = 'Set2', direction = 1, name = '') +
  scale_y_cut(breaks = c(100, 120000)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position = 'right'
  )
atr_gp_ev_p
```

## By attribute group and frequency

```{r n attr per attr grp and freq}
freq_code <- c('always', 'usually', 'sometimes', 'rarely')
atr_gp_fr_p <- bp |> 
  mutate(Frequency = factor(Frequency, levels = freq_code, ordered = FALSE)) |> 
  count(Attribute_group, Frequency) |> 
  group_by(Attribute_group) |> 
  mutate(total = sum(n)) |> 
  ungroup() |> 
  ggplot(aes(reorder(Attribute_group, desc(total)), n)) +
  geom_col(aes(fill = Frequency)) +
  labs(x = 'Attribute group', y = 'Number of annotations') +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_brewer(type = 'qual', palette = 'Set2', direction = 1, name = '') +
  scale_y_cut(breaks = c(100, 120000)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.position = 'right'
  )
atr_gp_fr_p
```

### Supplementary Figure

```{r, fig.width=9.4, fig.height=7.85}
supp1 <- atr_gp_ev_p / atr_gp_fr_p + plot_layout(ncol = 2) +
    plot_annotation(tag_levels = 'a')
ggsave(
  filename = 'sup1.png', plot = supp1, width = 19, height = 6, 
  units = 'in'
)
supp1
```

# Number of attributes per attribute group

```{r n attr values per attribute group}
attr_n <- bp |> 
    select(Attribute_group, Attribute) |> 
    distinct() |> 
    count(Attribute_group) |> 
    arrange(-n) |> 
    mutate(
        bin = ifelse(n > 2, 'multistate-intersection', 'Binary')
        ) |> 
    mutate(
        bin = case_when(
            Attribute_group %in% c('disease association', 'antimicrobial resistance', 'habitat') ~ 'multistate-union',
            TRUE ~ bin 
        )
    ) |> 
    mutate(bin = fct_relevel(bin, 'multistate-union', 'multistate-intersection'))

attr_n_p <- attr_n |> 
  ggplot(aes(reorder(Attribute_group, desc(n)), n)) +
  geom_col(aes(fill = bin)) +
  scale_y_continuous(
    limits = c(0, 95), breaks = seq(0, 95, 30)
  ) +
  labs(
    x = 'Attribute group', y = 'Number of attributes\n\n'
  ) +
  scale_fill_discrete(name = '') +
  # guides(fill = guide_legend(nrow = 1)) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
    # legend.position = 'bottom'
    # panel.grid.major.x = element_blank(), 
  ) 
attr_n_p
```

## Number of annotations per taxon

```{r freq n annotatios per taxon}
freqs <- bp |> 
    filter(Rank %in% c('genus', 'species', 'strain')) |> 
    count(Rank, NCBI_ID)

freqs_p <- freqs |> 
  ggplot(aes(n)) +
  geom_histogram(binwidth = 1, fill = 'gray80', linewidth = 0.2, color = 'black') +
  facet_wrap(~Rank, ncol = 1, scales = 'free') +
  scale_y_continuous(labels = scales::comma) +
  guides(fill = guide_legend(nrow = 1)) +
  labs(
      x = 'Number of annotations per taxon',
      y = 'Frequency'
  ) +
  theme_bw()  +
  theme(
    legend.position = 'bottom'
  )

freqs_p
```


```{r combined plot 1, fig.width=12.5, fig.height=8.7}
layout <- '
AAAAC
AAAAC
AAAAC
AAAAC
BBBBC
BBBB#
'
p <- attr_gp_rk_p + attr_n_p + freqs_p + 
  plot_layout(design = layout, guides = 'keep') +
  plot_annotation(tag_levels = 'a', tag_suffix = ')')
  # theme(plot.tag = element_text(size = 8))
ggsave('basic_stats.png', width = 12.5, height = 8.7, units = 'in')
p
```

# Source and propagation

```{r number of original sources}
bp_source <- filter(bp, !is.na(Attribute_source))
unique_sources <- bp_source |> 
    filter(Evidence  %in% c('exp', 'igc', 'tas', 'nas')) |> 
    pull(Attribute_source) |> 
    unique() |> 
    strsplit(';') |> 
    unlist() |> 
    unique() |> 
    sort()
n_sources <- length(unique_sources)
n_sources
```

## Source sparsity

## Number of annotations per source (including propagation)

Here, inheritance and asr are treated as two separate and new sources.
Note that the majority of annotations actually come from the propagation.

```{r source summary, message=FALSE}
summary_source <- bp |> 
  mutate(
    Attribute_source = ifelse(
      is.na(Attribute_source), Evidence, Attribute_source
    )
  ) |> 
  mutate(
    Attribute_source = case_when(
      Attribute_source == 'inh' ~ 'Inheritance',
      Attribute_source == 'asr' ~ 'ASR',
      TRUE ~ Attribute_source
    )
  ) |> 
  filter(!grepl(';', Attribute_source)) |> # remove repeated annotations for now
  count(Attribute_source) |> 
  arrange(-n) |> 
  mutate(
    origin = case_when(
      Attribute_source %in% c('ASR', 'Inheritance') ~ 'Propagation',
      TRUE ~ 'Original source'
    )
  )
  # head(10) # This is to get only the top 10 of the list
  
# summary_source
summary_source_p <- summary_source |> 
  mutate(origin = ifelse(origin == 'Original source', 'Source', origin)) |>
  mutate(origin = fct_reorder(origin, desc(n))) |> 
  ggplot(aes(reorder(Attribute_source, -n), n)) +
  geom_col(aes(fill = origin)) +
  labs(
    x = 'Source', y = 'Number of annotations'
  ) +
  scale_y_continuous(limits = c(0, 1500000), labels = scales::comma) +
  scale_y_cut(breaks = c(100, 20000)) +
  scale_fill_discrete(name = '') +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank()
  )
summary_source_p <- grid.grabExpr(print(summary_source_p))
```

## Completeness tables

```{r}
valid_ranks2 <- c(
  'superkingdom', 'phylum', 'class', 'order', 'family', 'order', 'genus',
  'species', 'strain'
)
exclude_all_fname <- system.file(
  'extdata/proc_exclude_all_07122023.txt', package = 'taxPPro', 
  mustWork = TRUE
)
exclude_all <- read.table(exclude_all_fname, col.names = 'taxid')
exclude_all$taxid <- as.character(exclude_all$taxid)
exclude_all$rank <- taxizedb::taxid2rank(exclude_all$taxid, db = 'ncbi')
exclude_all <- exclude_all[exclude_all$rank %in% valid_ranks2,]

strains_fname <- system.file(
  'extdata/proc_strains_07122023.txt', package = 'taxPPro', mustWork = TRUE
)
strains <- read.table(strains_fname, col.names = 'taxid')
strains$taxid <- as.character(strains$taxid)
strains$rank <- taxizedb::taxid2rank(strains$taxid, db = 'ncbi')
strains <- strains[strains$rank == 'strain',]

reference_df <- rbind(exclude_all, strains)
reference_df$rank <- ifelse(reference_df$rank == 'superkingdom', 'kingdom', reference_df$rank)
reference_summary <- count(reference_df, rank)
colnames(reference_summary) <- c('Rank', 'ref')
reference <- split(reference_df, factor(reference_df$rank)) |> 
  lapply(function(x) unique(x$taxid))
lapply(reference, length)
```

```{r}
inSet <- function(x, ref) {
  s <- split(x, x$Rank)
  s <- lapply(s, function(x) x$NCBI_ID)
  output <- vector('list', length(s))
  for (i in seq_along(output)) {
    ref_taxids <- unique(ref[[names(s)[i]]])
    target_taxids <- unique(s[[i]])
    output[[i]] <- sum(target_taxids %in% ref_taxids)
    names(output)[i] <- names(s)[i]
  }
  data.frame(
    Rank = names(output),
    inset = unlist(output, use.names = FALSE)
  )
}

outSet <- function(x, ref) {
  s <- split(x, x$Rank)
  s <- lapply(s, function(x) x$NCBI_ID)
  output <- vector('list', length(s))
  for (i in seq_along(output)) {
    ref_taxids <- unique(ref[[names(s)[i]]])
    target_taxids <- unique(s[[i]])
    output[[i]] <- sum(!target_taxids %in% ref_taxids)
    names(output)[i] <- names(s)[i]
  }
  data.frame(
    Rank = names(output),
    outset = unlist(output, use.names = FALSE)
  )
}

```

```{r}
original <- bp |> 
  filter(Evidence %in% c('tas', 'nas', 'exp', 'igc'))
```

### Completenes table before propgation

```{r}
inset_before <- original |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(inSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
outset_before <- original |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(outSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
completeness_before <- left_join(inset_before, outset_before, by = c('Attribute_group', 'Rank')) |> 
  left_join(reference_summary, by = 'Rank') |> 
  mutate(completeness = (inset / ref) * 100)

DT::datatable(completeness_before)
```

### Completeness table after propagation

```{r}
inset_after <- bp |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(inSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
outset_after <- bp |> 
  {\(y) split(y, factor(y$Attribute_group))}() |> 
  map(outSet, reference) |> 
  bind_rows(.id = 'Attribute_group')
completeness_after <- left_join(inset_after, outset_after, by = c('Attribute_group', 'Rank')) |> 
  left_join(reference_summary, by = 'Rank') |> 
  mutate(completeness = (inset / ref) * 100)
DT::datatable(completeness_after)
```

### Completenes heatmaps

```{r}
ordered_rownames <- bp |> 
  filter(Attribute_group != 'antimicrobial resistance') |> 
  count(Attribute_group) |> 
  arrange(-n) |> 
  pull(Attribute_group)

## Create matrices
completeness_mat_before <- completeness_before |>
  select(Attribute_group, Rank, completeness) |>
  pivot_wider(
    names_from = Rank, values_from = completeness, values_fill = 0
  ) |>
  column_to_rownames(var = 'Attribute_group') |>
  relocate(strain, species, genus) |> 
  as.matrix()

completeness_mat_after <- completeness_after |> 
  # filter(Attribute_group != 'antimicrobial sensitivity') |> 
  filter(Attribute_group != 'antimicrobial resistance') |> 
  select(Attribute_group, Rank, completeness) |> 
  pivot_wider(
    names_from = Rank, values_from = completeness, values_fill = 0
  ) |> 
  column_to_rownames(var = 'Attribute_group') |> 
  relocate(
    strain, species, genus, family, order, class, phylum, kingdom
  ) |> 
  as.matrix()


## Create heatmaps
color_fun <- circlize::colorRamp2(
  breaks = c(0, 100), colors = c('white', 'brown')
)
lgd <- Legend(col_fun = color_fun, title = "Completeness")
ht_b <- Heatmap(
  matrix = completeness_mat_before[ordered_rownames,],
  cluster_rows = FALSE, cluster_columns = FALSE,
  row_names_side = 'left',
  show_heatmap_legend = FALSE,
  col = color_fun,
  column_title = "BP",
  row_names_max_width = max_text_width(
    rownames(completeness_mat_before), 
    gp = gpar(fontsize = 12)
  )
  # cell_fun = function(j, i, x, y, width, height, fill) {
  #       grid.rect(x = x, y = y, width = width, height = height,
  #           gp = gpar(col = "black", fill = NA))
  # }
)

ht_a <- Heatmap(
  matrix = completeness_mat_after[ordered_rownames,],
  cluster_rows = FALSE, cluster_columns = FALSE,
  row_names_side = 'left',
  name = 'Completeness',
  heatmap_legend_param = list(
    at = c(0, 50, 100)
  ),
  col = color_fun,
  column_title = "AP",
  row_names_max_width = max_text_width(
    rownames(completeness_mat_after), 
    gp = gpar(fontsize = 12)
  )

  # cell_fun = function(j, i, x, y, width, height, fill) {
  #       grid.rect(x = x, y = y, width = width, height = height,
  #           gp = gpar(col = "black", fill = NA))
  # }
)

## Combine heatmaps
ht <- grid.grabExpr(
  draw(ht_b + ht_a, ht_gap = unit(0.4, "cm"))
)
```

### Combined plot

```{r, fig.width=6.15, fig.height=9.68}
p2 <- plot_grid(
  summary_source_p, ht, 
  labels = c('a)', 'b)'), 
  ncol = 1, 
  rel_heights = c(0.38, 0.62)
)
# ggsave("completeness.png", plot = p2, width = 6.15, height = 9.68, units = 'in')
p2
```

### Relationship between initial ammount of annotations and magnitude of propagation

```{r, fig.width=9.4, fig.height= 6.1}
cols <- c('Attribute_group', 'Rank', 'completeness')
x <- completeness_before |> 
  select(all_of(cols)) |> 
  rename(comp_bef = completeness) |> 
  complete(Attribute_group, Rank, fill = list(comp_bef = 0))
y <- completeness_after |> 
  select(all_of(cols)) |> 
  rename(comp_aft = completeness)
original_summary <- original |> 
  count(Attribute_group)
z <- left_join(x, y, by = c('Attribute_group', 'Rank')) |> 
  mutate(ratio = log((comp_aft + 1) / (comp_bef + 1))) |> 
  left_join(original_summary, by = 'Attribute_group') |> 
  arrange(n, Attribute_group) |> 
  mutate(Attribute_group = fct_inorder(Attribute_group))
p9 <- z |> 
  ggplot(aes(Attribute_group, ratio)) +
  # geom_point(aes(size = comp_bef), shape = 1, alpha = 0.5) +
  geom_point(aes(size = comp_bef, fill = n), shape = 21,  alpha = 0.5) +
  facet_wrap(~Rank, nrow = 1) +
  labs(
      x = 'Attribute group',
      y = 'log2(completeness after propagation + 1 / completeness before propagation + 1) per rank'
  ) +
  scale_fill_viridis_c(name = 'Total starting\nnumber of\nannotations') +
  scale_size(name = 'Completeness\nbefore propagation\nper rank') +
  theme_bw() +
  coord_flip()
ggsave(
  filename = 'sup2.png', 
  plot = p9,
  units = c('in'),
  width = 9.4,
  height = 6.1
)
p9
```


#> Add confidence of annotations for this figure.
#> Discuss the meaning of the inference.
#> Hold out validation. Choose random annotations (10% ~30-100x). Cross-validation.
#> Hold out positives and negatives.
#> One rank or physiology at at a time.
#> Look for a citation for method implemented for validation.
#> Check Mathews Correlation coefficient for balanced/unbalanced prediction. Matthews correlation coefficient
#> Try different tissues.

# Dispersion of sources

Import bugphyzz data before propagation and before resolving conflicts, 
agreements, and double annotations.

```{r, fig.width=10, fig.height=11}
data <- original |> 
  count(Attribute_group, Attribute_source, Rank) |> 
  mutate(new_column = paste0(Attribute_group, '|', Rank)) |>
  select(new_column, Attribute_source, n) |> 
  pivot_wider(
    names_from = 'Attribute_source', values_from = 'n', values_fill = 0
  ) |> 
  arrange(new_column) |> 
  tibble::column_to_rownames(var = 'new_column') |> 
  as.matrix()


bar_vct <- sub('^.*\\|', '', rownames(data))
split_vct <- sub('\\|.*$', '', rownames(data))
bar_color <- viridis::viridis(n = 3, option = 'C')
names(bar_color) <- c('genus', 'species', 'strain')
row_ha <- rowAnnotation(
  'Rank' = bar_vct, col = list(Rank = bar_color), 
  show_annotation_name = FALSE
)
# log2_data <- log2(data + 1)
data[data > 0] <- 1

color_fun2 <- circlize::colorRamp2(
  breaks = c(0, 1), colors = c('white', 'black')
)
ht_sources <- Heatmap(
  matrix = data,
  cluster_rows = FALSE, cluster_columns = FALSE,
  show_row_names = FALSE,
  row_names_side = 'left',
  name = 'Presence/ausence',
  show_heatmap_legend = TRUE,
  col = color_fun2(c(0, 1)),
  left_annotation = row_ha, 
  row_split = split_vct,
  column_names_rot = 45,
  row_title_rot = 0, gap = unit(0.1, 'inches'),
  cell_fun = function(j, i, x, y, width, height, fill) {
        grid.rect(x = x, y = y, width = width, height = height,
            gp = gpar(col = "black", fill = NA))
  }
)

# png(filename = 'sup3.png', width = 10, height = 11, units = 'in', res = 300)
# draw(ht_sources)
# dev.off()

ht_sources
```



# Session information

```{r class.soruce = 'fold-show'}
sessioninfo::session_info()
```

