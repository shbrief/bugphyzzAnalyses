---
title: "BSEA gingival plaque - MicrobiomeBenchmarkData - 35S"
output:
  html_document:
    toc: true
---

```{r include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```

```{r packages, message=FALSE, warning=FALSE}
library(bugphyzzAnalyses)
library(MicrobiomeBenchmarkData)
library(bugphyzz)
library(EnrichmentBrowser)
library(mia)
library(dplyr)
library(DT)
library(purrr)
library(tibble)
library(tidyr)
library(ggplot2)
```

The main purpose of this vignette is to find the expected enrichment results
in a biological dataset with ground truth. The expected result is enrichment
of aerobic taxa in the supragingival plaque and enrichment of anaerobic taxa
in the subgingival plaque. Obtaining the expected results could be interpreted
as an indicative that the bugphyzz annotations are useful for meaningful
bug set enrichemnt analysis (BSEA).

# Microbiome data

```{r import tse data, message=FALSE}
dat_name <- 'HMP_2012_16S_gingival_V35'
tse <- getBenchmarkData(dat_name, dryrun = FALSE)[[1]]
tse_genus <- splitByRanks(tse)$genus
## Filter taxa with at least 1 count as abundance in at least 20% of samples
min_n_samples <- round(ncol(tse_genus) * 0.2)
tse_subset <- tse_genus[rowSums(assay(tse_genus) >= 1) >= min_n_samples,]
tse_subset
```
Number of samples per condition

```{r}
table(tse_subset$body_subsite)
```

# bugphyzz signatures

Signatures at the genus level:

```{r bp signatures genus}
bp <- importBugphyzz()
aer <- bp$aerophilicity
gn_sigs <- makeSignatures(dat = aer, tax_id_type = 'Taxon_name', tax_level = 'genus')
```

# Differential abundance

```{r DA - edgeR}
tse_subset$GROUP <- ifelse(
  tse_subset$body_subsite == 'subgingival_plaque', 0, 1
)
edger <- deAna(
    expr = tse_subset, de.method = 'edgeR', padj.method = 'BH', 
    filter.by.expr = FALSE, 
)
```

# Enrichment (GSEA)

```{r, message=FALSE}
edger <- limmaVoom(edger)
gsea <- sbea(
  method = 'gsea', se = edger, gs = gn_sigs, perm = 1000, padj.method = 'BH',
  alpha = 0.1
  
)
gsea_tbl <- as.data.frame(gsea$res.tbl)
gsea_tbl <- gsea_tbl |> 
  arrange(PVAL) |> 
  mutate(
    GENE.SET = ifelse(ADJ.PVAL < 0.1, paste0(GENE.SET, ' *'), GENE.SET),
    PVAL = format(PVAL, scientific = TRUE),
    ADJ.PVAL = format(ADJ.PVAL, scientific = TRUE)
  ) |> 
  rename(BUG.SET = GENE.SET)


caption1 <- c(
  'Table 1. GSEA results comparing subgingival vs supragingival plaque.
  ES = Enrichment score, NES = Normalized Enrichment Score. Positive and
  negative scores (ES and NES) indicate enrichment in the supragingival and
  subgingival plaque, respectively. Bug sets marked with an asterik (*) 
  indicate significant enrichment results (adjusted p-value < 0.1). 
  Benjamini & Hochberg (BH) was used for P value adjustment.'
)

datatable(
  data = gsea_tbl,
  filter = 'top',
  rownames = FALSE,
  extensions = 'Buttons',
  options = list(
    dom = 'Bft',
    buttons = list('copy', 'print'),
    iDisplayLength = 10,
    keys = TRUE,
    autoWidth = TRUE
  ),
  caption = htmltools::tags$caption(
    style = 'caption-side: top; text-align: left;',
    caption1
  )
)
```

# Enrichment (ORA)

Enriched in supragingival (up):

```{r}
edger_up <- edger
rowData(edger_up)$ADJ.PVAL <- ifelse(
  rowData(edger_up)$FC < 0, 1, rowData(edger_up)$ADJ.PVAL
)
ora_up <- sbea(
  method = 'ora', se = edger_up, gs = gn_sigs, alpha = 0.1, perm = 0, 
  padj.method = 'BH'
)
ora_up_df <- as.data.frame(ora_up$res.tbl)
ora_up_df$BODY.SITE <- 'Supragingival plaque'
```

Enriched in subgingival (down):

```{r}
edger_down <- edger
rowData(edger_down)$ADJ.PVAL <- ifelse(
  rowData(edger_down)$FC > 0, 1, rowData(edger_down)$ADJ.PVAL
)
ora_down <- sbea(
  method = 'ora', se = edger_down, gs = gn_sigs, alpha = 0.1, perm = 0, 
  padj.method = 'BH'
)
ora_down_df <- data.frame(ora_down$res.tbl)
ora_down_df$BODY.SITE <- 'Subgingival plaque'
```

Combine into a single table:

```{r}
ora <- bind_rows(ora_up_df, ora_down_df) |> 
  arrange(BODY.SITE, PVAL) |> 
  relocate(BODY.SITE) |> 
  mutate(
    GENE.SET = ifelse(ADJ.PVAL < 0.1, paste0(GENE.SET, ' *'), GENE.SET),
    PVAL = format(PVAL, scientific = TRUE),
    ADJ.PVAL = format(ADJ.PVAL, scientific = TRUE)
  ) |> 
  dplyr::rename(
    BUG.SET = GENE.SET, NR.BUGS = NR.GENES, NR.SIG.BUGS = NR.SIG.GENES
  )

caption2 <- c(
  'Table 2. ORA results comparing subgingival vs supragingival plaque.
  NR.BUGS = Number of annotated bugs in the reference set, 
  NR.SIG.BUGS = Number of annotated bugs with significant differential
  abundance (FC > 0 & ADJ.PVAL < 0.1). Bug sets marked with an asterisk (*)
  indicate significant enrichment resuts (adjusted p-value < 0.1). 
  Benjamini & Hochberg (BH) was used for P value adjustment.'
)

datatable(
  data = ora,
  filter = 'top',
  rownames = FALSE,
  extensions = 'Buttons',
  options = list(
    dom = 'Bft',
    buttons = list('copy', 'print'),
    iDisplayLength = 10,
    keys = TRUE,
    autoWidth = TRUE
  ),
  caption = htmltools::tags$caption(
    style = 'caption-side: top; text-align: left;',
    caption2
  )
)
```

# Quick checks

Abundance of taxa in the 'down-regulated' set:

```{r}
## Couldn't make tidySummarizedExperiment work.
## Update code later.
counts1 <- assay(edger_down, 'counts')
counts1 <- log2(counts1 + 1)
counts1 <- counts1 |> 
  as.data.frame() |> 
  rownames_to_column(var = 'taxname') |> 
  pivot_longer(
    cols = 2:last_col(), names_to = 'sample', values_to = 'abundance'
  )
row_data1 <- edger_down |> 
  rowData() |> 
  as.data.frame() |> 
  rownames_to_column(var = 'taxname') |> 
  as_tibble()
col_data1 <- edger_down |> 
  colData() |> 
  as.data.frame() |> 
  rownames_to_column(var = 'sample') |> 
  as_tibble()
data1 <- left_join(counts1, row_data1, by = 'taxname') |> 
  left_join(col_data1, by = 'sample')

p1 <- data1 |> 
  filter(ADJ.PVAL < 0.1) |> 
  ggplot(aes(body_subsite, abundance)) +
  labs(
    title = 'Down-regulated supragingival = Up-regulated in subgingival'
  ) +
  geom_boxplot() +
  geom_point()
p1
```

Abundance of taxa in the 'up-regulated' set:

```{r}
## Couldn't make tidySummarizedExperiment work.
## Update code later.
counts2 <- assay(edger_up, 'counts')
counts2 <- log2(counts2 + 1)
counts2 <- counts2 |> 
  as.data.frame() |> 
  rownames_to_column(var = 'taxname') |> 
  pivot_longer(
    cols = 2:last_col(), names_to = 'sample', values_to = 'abundance'
  )
row_data2 <- edger_up |> 
  rowData() |> 
  as.data.frame() |> 
  rownames_to_column(var = 'taxname') |> 
  as_tibble()
col_data2 <- edger_up |> 
  colData() |> 
  as.data.frame() |> 
  rownames_to_column(var = 'sample') |> 
  as_tibble()
data2 <- left_join(counts2, row_data2, by = 'taxname') |> 
  left_join(col_data2, by = 'sample')

p2 <- data2 |> 
  filter(ADJ.PVAL < 0.1) |> 
  ggplot(aes(body_subsite, abundance)) +
  labs(
    title = 'Up-regulated supragingival = Down-regulated in subgingival'
  ) +
  geom_boxplot() +
  geom_point()
p2
```

# Session information

```{r session info}
sessioninfo::session_info()
```
