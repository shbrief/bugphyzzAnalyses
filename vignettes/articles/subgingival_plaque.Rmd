---
title: "BSEA gingival plaque - MicrobiomeBenchmarkData - 35S"
output:
  html_document:
    toc: true
---

```{r include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE
)
```

```{r packages, message=FALSE, warning=FALSE}
library(bugphyzzAnalyses)
library(MicrobiomeBenchmarkData)
library(bugphyzz)
library(EnrichmentBrowser)
library(dplyr)
library(purrr)
library(tibble)
library(mia)
library(bc3net)
```

# Import Data

```{r import tse data, message=FALSE}
dat_name <- 'HMP_2012_16S_gingival_V35'
tse <- getBenchmarkData(dat_name, dryrun = FALSE)[[1]]
colData(tse)$GROUP <- ifelse(
  colData(tse)$body_subsite == 'subgingival_plaque', 0, 1
)
rowData(tse) <- DataFrame(importTaxids())
tse
```

# Agglomerate taxa by genus

```{r filter tse}
tse_genus <- splitByRanks(tse)$genus
tse_subset <- filterTaxa(tse_genus) 
tse_subset
```

Number of samples per condition:

```{r}
table(colData(tse)$body_subsite)
```

# bugphyzz data

Signatures at the genus level:

```{r bp signatures genus}
bp <- importBugphyzz()
bp <- filter(bp, Attribute_group == 'aerophilicity')
gn_sigs <- getBugphyzzSignatures(
  df = bp, tax.id.type = 'NCBI_ID', tax.level = 'genus'
)
```

# Differential abundance

This step should create a couple of sets:

+ increased abundance. More abundance in the supragingival plaque.
+ decreased abundance. More abundance in the subgingival plaque.

```{r DA - edgeR}
edger <- deAna(
    expr = tse_subset, de.method = 'edgeR', padj.method = 'BH', 
     filter.by.expr = FALSE
)
```

# Enrichment with bc3net

Let's separate the sets:

```{r DA sets}
da_res <- as.data.frame(rowData(edger))
da_res <- rownames_to_column(da_res, var = 'otu')
## increased abundance
supragingival <- filter(da_res, FC > 0, ADJ.PVAL < 0.1)$otu
## descreased bundance
subgingival <- filter(da_res, FC < 0, ADJ.PVAL < 0.1)$otu
ref <- da_res$otu
```

Run enrichment (supragingival):

```{r supragingival ora}
supg_ora <- enrichment(
  genes = supragingival,
  reference = ref,
  genesets = gn_sigs,
  adj = 'BH',
  verbose = FALSE
)
arrange(supg_ora, padj)
```

Run enrichment (subgingival):

```{r subgingival ora}
subg_ora <- enrichment(
  genes = subgingival,
  reference = ref,
  genesets = gn_sigs,
  adj = 'BH',
  verbose = FALSE
)
arrange(subg_ora, padj)
```

> Above, we got the expected results. Enrichment of anaerobic taxa in the
subgingival plaque and enrichment of aerobic taxa in the supragingival plaque.

Let's combine both sets into a single one:

```{r}
both_set <- c(subgingival, supragingival)
both_ora <- enrichment(
  genes = both_set,
  reference = ref,
  genesets = gn_sigs,
  adj = 'BH',
  verbose = FALSE
)
arrange(both_ora, padj)
```

> When both sets are combined, no significant enrichment is found.
The output is the same as EnrichmentBrowser (below).

# ORA (EnrichmentBrowser)

```{r}
res <- sbea(
  method = 'ora', se = edger, gs = gn_sigs, perm = 0, padj.method = 'BH',
  alpha = 0.1
  
)
enr <- as.data.frame(gsRanking(res, signif.only = FALSE))
arrange(enr, ADJ.PVAL)
```

> This result is the same as above.

# Session information

```{r}
sessioninfo::session_info()
```

