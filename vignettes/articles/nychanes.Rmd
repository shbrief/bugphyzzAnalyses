---
title: "Reproducibility of a published result - NYCHANES study - bugphyzz"
output:
  html_document:
    toc:
      true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE
)
```

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(mia)
library(dplyr)
library(EnrichmentBrowser)
library(purrr)
```

# Expected results

Direct quotes from [Tobacco exposure associated with oral microbiota oxygen utilization in the New York City Health and Nutrition Examination Study](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6548637/)

**ORA**

>"... differentially abundant OTUs between current smokers and
never smokers to be over-represented in aerobic OTUs (Hypergeometric test,
p = 0.004)."
higthroughout
**GSEA**

>"...aerobic OTUs were significantly depleted among current smokers relative to never
smokers (Enrichment Score test statistic ES = −0.75, p = 0.002, GSEA permutation
test)."

>"Anaerobic OTUs were enriched in smokers relative to never smokers but the
difference was not statistically significant (ES = 0.36, p = 0.14, GSEA 
permutation test)."

>"... enrichment of facultative anaerobic OTUs
among never smokers compared to current smokers but this result was not
statistically significant (ES = −0.29, p = 0.48, GSEA permutation test)."

# Analysis at the genus level with bugphyzz signatures

## Microbiome data

Data used here is a subset of the original data used for the
[NYCHANES study](https://pubmed.ncbi.nlm.nih.gov/31076212/).
Full data can be found on [GitHub](https://github.com/waldronlab/nychanesmicrobiome).
Signatures from this study have been published on [BugSigDB](https://bugsigdb.org/Study_727). 

The data subset presented here only contains abundance values for
"Never smoker" vs "Cigarette" samples ("smokingstatus" column in metadata).

```{r import nychanes data, message=FALSE}
tse <- importNYCHANES()
tse_gn <- splitByRanks(tse)$Genus
## Filter taxa with at least 1 count as abundance in at least 20% of samples
# min_n_samples <- round(ncol(tse_gn) * 0.2)
# tse_gn_subset <- tse_gn[rowSums(assay(tse_gn) >= 1) >= min_n_samples,]
tse_gn
```

```{r nychanes genus summary}
table(tse_gn$smokingstatus)
```

## Bugphyzz data

```{r, message=FALSE}
bp <- importBugphyzz()
aer <- bp$aerophilicity
gn_sigs <- makeSignatures(dat = aer, tax_id_type = 'Taxon_name', tax_level = 'genus') |> 
    list_flatten(name_spec = "{inner") |> 
    discard(is.null)
lapply(gn_sigs, head)
```

## Differential expression

```{r}
tse_gn$GROUP <- ifelse(
  tse_gn$smokingstatus == 'Never smoker', 0, 1
)
edger_gn <- deAna(
    expr = tse_gn, de.method = 'edgeR', padj.method = 'BH', 
    filter.by.expr = FALSE, 
)
```

## Enrichment GSEA

```{r}
edger_gn <- limmaVoom(edger_gn)
gsea_gn <- sbea(
  method = 'gsea', se = edger_gn, gs = gn_sigs, perm = 1000, padj.method = 'BH',
  alpha = 0.1
  
)
gsea_gn_res <- as.data.frame(gsea_gn$res.tbl)
myDT(gsea_gn_res)
```

## Enrichment ORA

### Significant (mixed) vs Non-Significant

```{r}
ora_gn <- sbea(
  method = 'ora', se = edger_gn, gs = gn_sigs, perm = 0, 
  padj.method = 'BH', alpha = 0.1
)
ora_gn_res <- as.data.frame(ora_gn$res.tbl)
myDT(ora_gn_res)
```

### Significant over-abundant vs Reference

```{r}
edger_gn_up <- edger_gn
rowData(edger_gn_up)$ADJ.PVAL <- ifelse(
  rowData(edger_gn_up)$FC < 0, 1, rowData(edger_gn_up)$ADJ.PVAL
)
ora_gn_up <- sbea(
  method = 'ora', se = edger_gn_up, gs = gn_sigs, alpha = 0.1, perm = 0, 
  padj.method = 'BH'
)
ora_gn_up_res <- as.data.frame(ora_gn_up$res.tbl)
myDT(ora_gn_up_res)
```


### Significant under-abundant vs Reference

```{r}
edger_gn_down <- edger_gn
rowData(edger_gn_down)$ADJ.PVAL <- ifelse(
  rowData(edger_gn_down)$FC < 1, 0, rowData(edger_gn_down)$ADJ.PVAL
)
ora_gn_down <- sbea(
  method = 'ora', se = edger_gn_down, gs = gn_sigs, alpha = 0.1, perm = 0, 
  padj.method = 'BH'
)
ora_gn_down_res <- as.data.frame(ora_gn_down$res.tbl)
myDT(ora_gn_down_res)
```

# Analysis at the OTU level with bugphyzz signatures

## otu signatures (bugphyzz)

```{r}
genera <- rowData(tse)$Genus 
names(genera) <- rownames(tse)
otu_sigs <- lapply(gn_sigs, function(x) names(genera)[which(genera %in% x)])
lapply(otu_sigs, head)
```

## Differential abundance

```{r}
tse$GROUP <- ifelse(
  tse$smokingstatus == 'Never smoker', 0, 1
)
edger <- deAna(
  expr = tse, de.method = 'edgeR', padj.method = 'BH', 
  filter.by.expr = FALSE
)
```

## Enrichment (GSEA)

```{r}
edger <- limmaVoom(edger)
gsea <- sbea(
  method = 'gsea', se = edger, gs = otu_sigs, perm = 1000, padj.method = 'BH',
  alpha = 0.1
)
gsea_res <- as.data.frame(gsea$res.tbl)
myDT(gsea_res)
```

## Enrichment (ORA)

### Significant (mixed) vs Non-Significant

```{r, message=FALSE}
ora <- sbea(
  method = 'ora', se = edger, gs = otu_sigs, perm = 0, 
  padj.method = 'BH', alpha = 0.1
)
ora_res <- as.data.frame(ora$res.tbl)
myDT(ora_res, 'caption')
```


### Significant over-abundant vs Reference

```{r}
edger_up <- edger
rowData(edger_up)$ADJ.PVAL <- ifelse(
  rowData(edger_up)$FC < 0, 1, rowData(edger_up)$ADJ.PVAL
)
ora_up <- sbea(
  method = 'ora', se = edger_up, gs = otu_sigs, alpha = 0.1, perm = 0, 
  padj.method = 'BH'
)
ora_up_res <- as.data.frame(ora_up$res.tbl)
myDT(ora_up_res)
```

### Significant under-abundant vs Reference

```{r}
edger_down <- edger
rowData(edger_down)$ADJ.PVAL <- ifelse(
  rowData(edger_down)$FC < 1, 0, rowData(edger_down)$ADJ.PVAL
)
ora_down <- sbea(
  method = 'ora', se = edger_down, gs = otu_sigs, alpha = 0.1, perm = 0, 
  padj.method = 'BH'
)
ora_down_res <- as.data.frame(ora_down$res.tbl)
myDT(ora_down_res)
```


```{r}
biosis <- importBiosis() |> 
  {\(y) split(y, factor(y$Attribute))}() |> 
  lapply(function(x) unique(x$Genus))
```


```{r}
taxa_names <- rownames(tse_gn)
df1 <- map_dbl(biosis, function(x) mean(taxa_names %in% x) * 100) |> 
  as.data.frame() |> 
  tibble::rownames_to_column() |> 
  set_names(c('Attribute', 'n'))
df2 <- map_dbl(gn_sigs, function(x) mean(taxa_names %in% x) * 100) |> 
  as.data.frame() |> 
  tibble::rownames_to_column() |> 
  set_names(c('Attribute', 'n'))
df <- rbind(df1, df2)
df
```

```{r}
## Annotated
x <- map(biosis, function(x) taxa_names[which(taxa_names %in% x)])
y <- map(gn_sigs, function(x) taxa_names[which(taxa_names %in% x)])

z <- map2(x, y, ~ {
  inboth <- intersect(.x, .y)
  inbio <- setdiff(.x, .y)
  inbp <- setdiff(.y, .x)
  return(
    list(both = inboth, bp = inbp, bio = inbio)
  )
})

## just in biosis
justInBio <- map(z, ~ .x$bio)


```

#> Differentes due to irregular names
#> Mislabelled attributes




# Session information

```{r}
sessioninfo::session_info()
```
