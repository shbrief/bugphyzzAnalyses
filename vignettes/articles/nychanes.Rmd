---
title: "nychanes2.Rmd"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE
)
```

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(mia)
library(dplyr)
library(EnrichmentBrowser)
```

## Analysis at the genus level with bugphyzz signatures

# Microbiome data

```{r, message=FALSE}
tse <- importNYCHANES()
tse_genus <- splitByRanks(tse)$Genus
## Filter taxa with at least 1 count as abundance in at least 20% of samples
min_n_samples <- round(ncol(tse_genus) * 0.2)
tse_subset <- tse_genus[rowSums(assay(tse_genus) >= 1) >= min_n_samples,]
tse_subset
```

```{r}
table(tse_subset$smokingstatus)
```

# Bugphyzz data

```{r, message=FALSE}
bp <- importBugphyzz()
aer <- filter(bp, Attribute_group == 'aerophilicity')
gn_sigs <- getBugphyzzSignatures(
    df = aer, tax.id.type = 'Taxon_name', tax.level = 'genus', 
    frequency = c('always', 'usually', 'sometimes')
)
lapply(gn_sigs, head)
```

# Differential expression


```{r}
tse_subset$GROUP <- ifelse(
  tse_subset$smokingstatus == 'Never smoker', 0, 1
)
edger <- deAna(
    expr = tse_subset, de.method = 'edgeR', padj.method = 'BH', 
    filter.by.expr = FALSE, 
)
```


# Enrichment GSEA

```{r}
gsea <- sbea(
  method = 'gsea', se = edger, gs = gn_sigs, perm = 1000, padj.method = 'BH',
  alpha = 0.1
  
)
```

# Analysis at the OTU level with bugphyzz signatures

## Microbiome data

```{r}
min_n_samples <- round(ncol(tse) * 0.2)
tse_subset <- tse[rowSums(assay(tse) >= 1) >= min_n_samples,]
```

## otu signatures (bugphyzz)

```{r}
genera <- rowData(tse)$Genus 
names(genera) <- rownames(tse)
otu_sigs <- lapply(gn_sigs, function(x) names(genera)[which(genera %in% x)])
```


## Differential abundance

```{r}
tse_subset$GROUP <- ifelse(
  tse_subset$smokingstatus == 'Never smoker', 0, 1
)
edger_subset <- deAna(
  expr = tse_subset, de.method = 'edgeR', padj.method = 'BH', 
  filter.by.expr = FALSE
)

```

## Enrichment 




#> Analysis at the genus level with nychanes signatures
#? Analyiss at the OTU level with nychanes signatures



# Session information

```{r}
sessioninfo::session_info()
```


