---
title: "Analysis of the NYCHANES signatures"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE
)
```

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugsigdbr)
library(bugphyzz)
library(nychanesmicrobiome)
library(dplyr)
library(purrr)
library(EnrichmentBrowser)
library(tibble)
```

Analysis of a previous bsea study: 

# Import data

```{r, message=FALSE, results='hide'}
## Bugphyzz 
bp <- importBugphyzz(version = 'devel')

## BugSigDB
bsdb <- importBugSigDB(version = 'devel')

## TypicalMicrobiomeSignatures
tms <- importTidyTMS()

## NYC HANES TreeSummarizedExperiment
nh <- importNYCHANES()

## NYC HANES - manually curated signatures
biosis_tsv <- system.file('extdata/biosis.tsv', package = 'nychanesmicrobiome')
biosis <- read.table(biosis_tsv, sep = '\t', header = TRUE)
colnames(biosis) <- c('Genus', 'aer')
```

# Analyses using bugphyzz signatures

## Using BSDB signtaures (Study 727) 

+ Study 727 corresponds to the NYCHANES public study.
+ Signature 1 is decreased abundance in smokers.
+ Signature 2 is increased abundance in smokers.

```{r}
study_727 <- filter(bsdb, `BSDB ID` %in% c('bsdb:727/1/1', 'bsdb:727/1/2'))
sigs727 <- study_727 |> 
  bugsigdbr::getSignatures(tax.id.type = 'ncbi', tax.level = 'mixed')
decreased <- sigs727$`bsdb:727/1/1_Tobacco-smoke-exposure-measurement:Current-cigarette-smokers_vs_Never-smokers_DOWN`
increased <- sigs727$`bsdb:727/1/2_Tobacco-smoke-exposure-measurement:Current-cigarette-smokers_vs_Never-smokers_UP`
df <- data.frame(
  NCBI_ID = c(increased, decreased),
  Abundance = c(rep('increased', length(increased)), rep('decreased', length(decreased)))
)
head(df)
```

```{r}
aer <- bp |> 
  filter(Attribute_group == 'aerophilicity') |> 
  select(NCBI_ID, Attribute) |> 
  mutate(Attribute = sub('^.*:', '', Attribute)) |> 
  distinct()
head(aer)
```

### Chi-square 

Remove taxa marked in both groups

```{r}
tbl <- left_join(df, aer, by = 'NCBI_ID')
dups <- tbl$NCBI_ID[which(duplicated(tbl$NCBI_ID))]
# taxizedb::taxid2name(dups)
# tbl[tbl$NCBI_ID %in% dups,]
tbl <- tbl[!tbl$NCBI_ID %in% dups, ]
any(duplicated(tbl$NCBI_ID))
```

Contingency table

```{r}
cont <- epitools::epitable(tbl$Attribute, tbl$Abundance)
cont
```

Chi-square. Test of independence. Using three atribute values: aerobic, 
anaerobic, and facultatively_anaerobic

> H0: There is no relationship between smoking and aerophilicity in DA microbes.  
H1: There is a relationship between smoking and aerophilicity in DA microbes.

```{r}
chi_res <- chisq.test(tbl$Attribute, tbl$Abundance, simulate.p.value = TRUE)
chi_res
```

Chi-square. Test of independence. Using two atribute values: aerobic and
anaerobic

```{r}
tbl2 <- filter(tbl, Attribute %in% c('aerobic', 'anaerobic'))
cont2 <- epitools::epitable(tbl2$Attribute, tbl2$Abundance)
cont2
```

```{r}
chi_res2 <- chisq.test(tbl2$Attribute, tbl2$Abundance, simulate.p.value = TRUE)
chi_res2
```

>It looks like the facultatively anaerobic microbes make the difference between
smokers (cigarette) and never smokers. 

### ORA

For ORA, we need a background. Let's use the TypicalMicrobiomeSignatures.
The body site of choice will be oral cavity.

```{r}
oc <- filter(tms, body_site == 'oralcavity', rank == 'genus')
increased_bkg <- unique(c(increased, oc$taxid))
decreased_bkg <- unique(c(decreased, oc$taxid))
bp_sigs <- bp |> 
  filter(Attribute_group == 'aerophilicity') |> 
  getBugphyzzSignatures(tax.id.type = 'NCBI_ID', tax.level = 'genus')
```

```{r}
en_res <- runEnrichment(
  bsdb = bsdb,
  bsdb_sets = list(`bsdb:727/1/1` = decreased, `bsdb:727/1/2` = increased),
  background_sets = list(`bsdb:727/1/1` = decreased_bkg, `bsdb:727/1/2` = increased_bkg),
  bp_sigs = bp_sigs
)

en_res
```

No signatures were significantly enriched.

## Using NYCHANES original data

### Chi-square

### ORA

Prepare dataset (NYCHANES) and signatures:

```{r}
colData(nh)$GROUP <- ifelse(colData(nh)$smokingstatus == 'Never smoker', 0, 1)
table(nh$GROUP)
```

Convert signatures of taxids to signatures of OTUs (mapping at the genus level):

```{r}
aer <- filter(bp, Attribute_group == 'aerophilicity')
aer_sig <- getBugphyzzSignatures(
  df = aer, tax.id.type = 'NCBI_ID', tax.level = 'genus'
)
x <- rowData(nh)$GenusID
names(x) <- rownames(nh)
x <- x[!is.na(x)]
new_sig <- map(aer_sig, ~ names(x)[which(x %in% .x)])
```

DA:

```{r, message=FALSE}
edger <- deAna(
    expr = nh, de.method = 'edgeR', padj.method = 'BH', assay = 'counts'
)
```

ORA:

```{r}
edger_ora <- sbea(
    method = 'ora', se = edger, gs = new_sig, alpha = 0.1, perm = 0,
    padj.method = 'BH', assay = 'counts'
)
gsRanking(res = edger_ora, signif.only = FALSE)
```

### GSEA

```{r}
edger_gsea <- sbea(
    method = 'gsea', se = edger, gs = new_sig, alpha = 0.1, perm = 0,
    padj.method = 'BH'
)
gsRanking(res = edger_gsea, signif.only = FALSE)
```

### ORA 2
```{r}
colData(nh)$GROUP <- ifelse(colData(nh)$smokingstatus == 'Never smoker', 1, 0)
table(nh$GROUP)
```

DA:

```{r, message=FALSE}
edger2 <- deAna(
    expr = nh, de.method = 'edgeR', padj.method = 'BH', assay = 'counts'
)
```

ORA:

```{r, message=FALSE}
edger_ora2 <- sbea(
    method = 'ora', se = edger, gs = new_sig, alpha = 0.1, perm = 0,
    padj.method = 'BH', assay = 'counts'
)
gsRanking(res = edger_ora2, signif.only = FALSE)
```

### GSEA 2

```{r, message=FALSE}
edger_gsea2 <- sbea(
    method = 'gsea', se = edger2, gs = new_sig, alpha = 0.1, perm = 0,
    padj.method = 'BH'
)
gsRanking(res = edger_gsea2, signif.only = FALSE)
```


## Comparison of FC

```{r}
a <- rownames_to_column(head(arrange(as.data.frame(rowData(edger)), FC)))
b <- rownames_to_column(head(arrange(as.data.frame(rowData(edger2)), -FC)))
a2 <- a[, c('rowname', 'FC')]
b2 <- b[, c('rowname', 'FC')]
colnames(a2) <- paste0('res1_', colnames(a2))
colnames(b2) <- paste0('res2_', colnames(b2))
c <- cbind(a2, b2)
c
```

# Analysis using original manually-curated signatures in NYCHANES

## Using BSDB signatures (Study 727)

### Chi-square

### ORA

## Using NYCHANES original data

### Chi-square

### ORA

### GSEA

### PADOG

# Session information

```{r}
sessioninfo::session_info()
```
