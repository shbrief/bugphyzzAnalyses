---
title: "Reproducibility of a published result - NYCHANES study - biosis"
output:
  html_document:
    toc:
      true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE
)
```

```{r setup, message=FALSE}
library(bugphyzzAnalyses)
library(bugphyzz)
library(mia)
library(dplyr)
library(EnrichmentBrowser)
```

> For the sake of reproducibility, I'm running this analysis with the
original annotations from the NYCHANES study.

# Expected results

+ Enrichment of anaerobic taxa in smokers.
+ Enrichment of aerobic taxa in control (never smoker).

> For the sake of reproducibility, taxa won't be filtered based on abundance and
the matrix will be transformed with limma.

# Analysis at the genus level with biosis signatures

## Microbiome data

Data used here is a subset of the original data used for the
[NYCHANES study](https://pubmed.ncbi.nlm.nih.gov/31076212/).
Full data can be found on [GitHub](https://github.com/waldronlab/nychanesmicrobiome).
Signatures from this study have been published on [BugSigDB](https://bugsigdb.org/Study_727). 

The data subset presented here only contains abundance values for
"Never smoker" vs "Cigarette" samples ("smokingstatus" column in metadata).

```{r import nychanes data, message=FALSE}
tse <- importNYCHANES()
tse_gn <- splitByRanks(tse)$Genus
tse_gn
```

```{r nychanes genus summary}
table(tse_gn$smokingstatus)
```

## Biosis data


```{r}
biosis <- importBiosis()
gn_sigs <- split(biosis, factor(biosis$Attribute)) |> 
  lapply(function(x) unique(x$Genus))
lapply(gn_sigs, head)
```
## Differential expression

```{r}
tse_gn$GROUP <- ifelse(
  tse_gn$smokingstatus == 'Never smoker', 0, 1
)
edger_gn <- deAna(
    expr = tse_gn, de.method = 'edgeR', padj.method = 'BH', 
    filter.by.expr = FALSE, 
)
```

## Enrichment GSEA

```{r}
design1 <- model.matrix(~ smokingstatus, data = data.frame(colData(tse_gn)))
assay.voom1 <- limma::voom(
  SummarizedExperiment::assay(edger_gn), design = design1, plot = FALSE
)
SummarizedExperiment::assay(edger_gn) <- assay.voom1$E
class(SummarizedExperiment::assay(edger_gn)) <- "matrix"

gsea_gn <- sbea(
  method = 'gsea', se = edger_gn, gs = gn_sigs, perm = 1000,
  padj.method = 'BH',  alpha = 0.1
  
)
gsea_gn_res <- as.data.frame(gsea_gn$res.tbl)
caption1 <- 'caption1'
myDT(gsea_gn_res, caption1)
```

# Analysis at the OTU level with biosis signatures

## Microbiome data

```{r}
tse
```

## otu signatures (biosis)

```{r}
genera <- rowData(tse)$Genus 
names(genera) <- rownames(tse)
otu_sigs <- lapply(gn_sigs, function(x) names(genera)[which(genera %in% x)])
lapply(otu_sigs, head)
```

## Differential abundance

```{r}
tse$GROUP <- ifelse(
  tse$smokingstatus == 'Never smoker', 0, 1
)
edger <- deAna(
  expr = tse, de.method = 'edgeR', padj.method = 'BH', 
  filter.by.expr = FALSE
)

```

## Enrichment (GSEA)

```{r}
design2 = model.matrix(~smokingstatus, data = data.frame(colData(tse)))
assay.voom2 <- limma::voom(
  SummarizedExperiment::assay(edger), design = design2, plot = FALSE
)
SummarizedExperiment::assay(edger) <- assay.voom2$E
class(SummarizedExperiment::assay(edger)) <- "matrix"

gsea <- sbea(
  method = 'gsea', se = edger, gs = otu_sigs, perm = 1000, padj.method = 'BH',
  alpha = 0.1
)
gsea_res <- as.data.frame(gsea$res.tbl)
myDT(gsea_res, 'caption2')
```

# Session information

```{r}
sessioninfo::session_info()
```


